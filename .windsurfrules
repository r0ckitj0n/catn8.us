# .windsurfrules (catn8.us)

This is the consolidated **portable** ruleset for this repo.

## Tech Stack

### Languages
- PHP (shell pages + `/api` endpoints)
- TypeScript (ES modules; Vite-built React front-end)
- JavaScript (ES modules; tooling/scripts and any non-TS legacy code)
- CSS (Vite-managed)

### Front-end / Build
- Vite `^7.0.6` (build to `dist/`, `manifest: true`, entry points in `src/entries/`)
- React `^18`
- React Router `^6.26.2`
- Chart.js `^4.5.0`
- SortableJS `^1.15.6`

### Server / Runtime
- PHP dependencies via Composer:
  - `phpmailer/phpmailer` `^6.9`
  - `phpunit/phpunit` `^12.2` (dev)
- Local MySQL config exists in `config/my.cnf` (utf8mb4 / `utf8mb4_unicode_ci`)
- Local development database is **MySQL**; site accounts/auth data is stored in MySQL.
- PHP `/api/*` endpoints connect to MySQL using `CATN8_DB_LOCAL_*` variables from `.env.local`.
- Node-side DB tooling present:
  - `drizzle-orm` `^0.44.7`
  - `@neondatabase/serverless` `^1.0.2`

### AI & Voice Services (Game Specific)
- **Generative Model:** Google Gemini 2.0 (Flash-Exp / Pro) via `src/core/ai/GeminiProvider.ts`.
- **Text-to-Speech:** Google Cloud TTS via `src/core/ai/TTSProvider.ts`.
- **Image Generation:** Google Vertex AI / Imagen.

### Tooling
- Repo rules are documented here and synced into `.windsurfrules` by `scripts/dev.sh`.

## Coding Guidelines

### Type Safety (Required)
- **No Explicit Any:** Avoid using `any` in TypeScript. Define interfaces in `src/types/`.
- **Strict Interfaces:** Game entities (Suspects, Clues) must have strict definitions to prevent AI hallucinations.
- **Type Definitions:** Maintain strict interfaces for Game Objects in `src/types/game.d.ts`.

### Constants & Magic Values (Strict)
- **No Magic Strings:** Do not use hardcoded string literals for status or types (e.g., `status === "interrogating"`).
  - **Requirement:** Define constants in `src/core/constants.ts` or enums in `src/types/` (e.g., `GAME_STATE.INTERROGATING`).
- **No Magic Numbers:** Replace unexplained numbers with named constants (e.g., `MAX_ALIBI_LENGTH`).

### Semantic HTML & Accessibility
- **Interactive Elements:** Use `<button>` for actions and `<a>` for links. Do NOT use `<div>` or `<span>` with `onClick`.
- **Images:** All `<img>` tags must have an `alt` attribute. Use `loading="lazy"` for any image below the fold.

### JavaScript / Modules
- **Use ES modules** (`import`/`export`).
- **No raw HTTP calls**. Use `ApiClient` only.
- **Console Hygiene:** Do not commit `console.log` statements. Use a dedicated logger or remove debug logs before finishing a task.

## Critical Constraints (Never Do)
- **No Direct Fetch:** Never use `fetch()` or `axios` in UI components; use `src/core/ApiClient.ts`.
- **No Inline Styles:** Avoid `style={{...}}`; use Vite-managed CSS classes.
- **No Hardcoded IDs:** Do not hardcode MySQL IDs in front-end logic.
- **No Logic in App.tsx:** `App.tsx` is for composition only.

## Component Architecture & File Limits (Strict)

### The "Conductor" Pattern
- **App.tsx Limitation:** `App.tsx` must act **only** as a composition layer.
- **Refactor Trigger:** If a React component file exceeds **250 lines**, it must be proactively refactored:
  - Extract UI sub-sections into `src/components/`.
  - Extract state logic into custom hooks in `src/hooks/`.

### Modal Architecture
- **Isolation:** Every Modal must reside in its own file in `src/components/modals/`.
- **Props vs Context:** Avoid prop-drilling > 2 levels. Use `GameContext` for deep data.

### Feature Creation Workflow
- **First:** Create the file (e.g., `src/components/tools/NewTool.tsx`).
- **Second:** Import it into `App.tsx`.
- **Never:** Write code inline in `App.tsx`.

## CSS Architecture & Limits (Strict)

- **Colocation Strategy:**
  - Create a dedicated `.css` file next to its component (e.g., `DossierModal.css`).
  - **Limit:** 200 lines per file.
- **Global Styles (`app.css`):**
  - **Limit:** 300 lines. Content restricted to Global Variables, Resets, and Fonts.
- **Theme Tokens (Noir):**
  - Use `var(--catn8-color-noir-...)` variables.
  - **Accent Gold:** `#d4af37`, **Accent Blood:** `#8a0303`

### Z-Index & Stacking Hierarchy (Strict)
- **No Magic Numbers:** Usage of raw integer values (e.g., `z-index: 99`) is strictly prohibited.
- **Approved Tokens:** Use `var(--catn8-z-...)` defined in `app.css`:
  - `--catn8-z-negative`: -1 (Background)
  - `--catn8-z-base`: 0 (Default)
  - `--catn8-z-elevated`: 10 (Cards/Hover)
  - `--catn8-z-sticky`: 100 (Headers)
  - `--catn8-z-backdrop`: 200 (Dimmer)
  - `--catn8-z-modal`: 300 (Active Modal)
  - `--catn8-z-toast`: 400 (Notifications)
  - `--catn8-z-cursor`: 999 (Drag Proxy)
- **Stacking Context:** Do not increase z-index arbitrarily. Check parent stacking contexts (opacity/transform) first.

## PHP Architecture & Limits (Strict)

- **Authoritative Source:** MySQL is the **only** valid storage for dynamic data.
- **Role of PHP:** PHP files in the root must act ONLY as **Shells**.
- **File Size Triggers:**
  - **Shell Files (`/*.php`):** Limit **150 lines**.
  - **API Endpoints (`/api/*.php`):** Limit **300 lines**.
  - **Classes (`/includes/*.php`):** Limit **500 lines**.

## Game Data & AI Architecture (Required)
- **Single Source of Truth:** The "Master Narrative" must be stored in MySQL.
- **AI Abstraction:** All calls to Gemini/TTS must go through `src/core/ai/*`.
- **Prompt Isolation:** Store prompts in `src/data/prompts/`.
- **Schema Maintenance:** Immediately update `src/data/database_schema.md` when DB structure changes.

## Codebase Navigation & Map (Context Guide)

### Directory Responsibilities
- **`src/entries/`**: The "Entry Points." Contains `App.tsx` (The Conductor) and global styles.
- **`src/components/modals/`**: The "Major Views." Each file here represents a full-screen game interface.
- **`src/components/ui/`**: "Dumb Components" (buttons, inputs) with no game logic.
- **`src/hooks/`**: "The Brains." All state logic (timers, suspect data) lives here.
- **`src/core/`**: "The Plumbing." Static utilities, API wrappers (`ApiClient.ts`), and AI Providers.
- **`src/types/`**: "The Dictionary." TypeScript definitions.
- **`src/data/database_schema.md`**: **SQL Truth.** The authoritative definition of all MySQL tables. Read this before writing SQL.

### Key Architectural Flows
1.  **Game State:** `GameContext` flows *down* from `App.tsx`.
2.  **AI Requests:** UI -> `useVoiceAPI` -> `GeminiProvider` -> Google Cloud.
3.  **Data Persistence:** Frontend State -> `ApiClient` -> PHP Endpoints -> MySQL.