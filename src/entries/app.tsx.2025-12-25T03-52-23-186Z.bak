import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { createRoot } from 'react-dom/client';
import './app.css';

import stories from '../data/stories.json';
import arcade from '../data/arcade.json';
import games from '../data/games.json';
import { createBootstrapModal, isBootstrapModalReady } from '../core/bootstrapModal';
import { ApiClient } from '../core/ApiClient';
import { GeminiLiveClient } from '../core/GeminiLiveClient';

function normalizeText(value) {
  return String(value || '').trim().toLowerCase();
}

function AIVoiceCommunicationModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const cleanSnapshotRef = useRef('');

  const [hasMysteryServiceAccount, setHasMysteryServiceAccount] = useState(0);
  const [hasMysteryTtsKey, setHasMysteryTtsKey] = useState(0);
  const [hasMysteryGeminiKey, setHasMysteryGeminiKey] = useState(0);
  const [mysteryServiceAccountJson, setMysteryServiceAccountJson] = useState('');
  const [mysteryTtsApiKey, setMysteryTtsApiKey] = useState('');
  const [mysteryGeminiApiKey, setMysteryGeminiApiKey] = useState('');
  const [mysteryGeminiKeyName, setMysteryGeminiKeyName] = useState('');
  const [mysteryGeminiProjectName, setMysteryGeminiProjectName] = useState('');
  const [mysteryGeminiProjectNumber, setMysteryGeminiProjectNumber] = useState('');

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');
    setMysteryServiceAccountJson('');
    setMysteryTtsApiKey('');
    setMysteryGeminiApiKey('');
    setMysteryGeminiKeyName('');
    setMysteryGeminiProjectName('');
    setMysteryGeminiProjectNumber('');

    Promise.all([
      ApiClient.get('/api/settings/mystery_gcp.php'),
      ApiClient.get('/api/settings/mystery_gemini.php'),
    ])
      .then(([resGcp, resGemini]) => {
        setHasMysteryServiceAccount(Number(resGcp?.has_service_account_json || 0));
        setHasMysteryTtsKey(Number(resGcp?.has_tts_api_key || 0));
        setHasMysteryGeminiKey(Number(resGemini?.has_api_key || 0));
        const nextKeyName = String(resGemini?.key_name || '');
        const nextProjectName = String(resGemini?.project_name || '');
        const nextProjectNumber = String(resGemini?.project_number || '');
        setMysteryGeminiKeyName(nextKeyName);
        setMysteryGeminiProjectName(nextProjectName);
        setMysteryGeminiProjectNumber(nextProjectNumber);
        cleanSnapshotRef.current = JSON.stringify({
          mysteryServiceAccountJson: '',
          mysteryTtsApiKey: '',
          mysteryGeminiApiKey: '',
          mysteryGeminiKeyName: nextKeyName,
          mysteryGeminiProjectName: nextProjectName,
          mysteryGeminiProjectNumber: nextProjectNumber,
        });
      })
      .catch((e) => setError(e?.message || 'Failed to load voice configuration'))
      .finally(() => setBusy(false));
  }, [open]);

  const isDirty = useMemo(() => {
    const cur = JSON.stringify({
      mysteryServiceAccountJson: String(mysteryServiceAccountJson || ''),
      mysteryTtsApiKey: String(mysteryTtsApiKey || ''),
      mysteryGeminiApiKey: String(mysteryGeminiApiKey || ''),
      mysteryGeminiKeyName: String(mysteryGeminiKeyName || ''),
      mysteryGeminiProjectName: String(mysteryGeminiProjectName || ''),
      mysteryGeminiProjectNumber: String(mysteryGeminiProjectNumber || ''),
    });
    return String(cleanSnapshotRef.current || '') !== cur;
  }, [
    mysteryServiceAccountJson,
    mysteryTtsApiKey,
    mysteryGeminiApiKey,
    mysteryGeminiKeyName,
    mysteryGeminiProjectName,
    mysteryGeminiProjectNumber,
  ]);

  const testGeminiLiveToken = async () => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/gemini_ephemeral_token.php');
      const tokenName = String(res?.token?.name || '').trim();
      if (!tokenName) {
        throw new Error('Token request succeeded but response was missing token name');
      }
      setMessage('Gemini Live token OK: ' + tokenName);
    } catch (e) {
      setError(e?.message || 'Failed to request Gemini Live token');
    } finally {
      setBusy(false);
    }
  };

  const testMysteryGcpServiceAccount = async () => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/settings/mystery_gcp_test.php?mode=service_account');
      const httpStatus = Number(res?.http_status || 0);
      const voiceCount = Number(res?.voice_count || 0);
      setMessage('GCP service account OK (HTTP ' + httpStatus + ', voices: ' + voiceCount + ')');
    } catch (e) {
      setError(e?.message || 'Failed to test GCP service account');
    } finally {
      setBusy(false);
    }
  };

  const testMysteryGcpTtsApiKey = async () => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/settings/mystery_gcp_test.php?mode=tts_api_key');
      const httpStatus = Number(res?.http_status || 0);
      const voiceCount = Number(res?.voice_count || 0);
      setMessage('GCP TTS API key OK (HTTP ' + httpStatus + ', voices: ' + voiceCount + ')');
    } catch (e) {
      setError(e?.message || 'Failed to test GCP TTS API key');
    } finally {
      setBusy(false);
    }
  };

  const save = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const geminiPayload: any = {};
      if (mysteryGeminiApiKey.trim()) geminiPayload.api_key = mysteryGeminiApiKey;
      if (mysteryGeminiKeyName.trim()) geminiPayload.key_name = mysteryGeminiKeyName;
      if (mysteryGeminiProjectName.trim()) geminiPayload.project_name = mysteryGeminiProjectName;
      if (mysteryGeminiProjectNumber.trim()) geminiPayload.project_number = mysteryGeminiProjectNumber;

      const [resGcp, resGemini] = await Promise.all([
        mysteryServiceAccountJson.trim() || mysteryTtsApiKey.trim()
          ? ApiClient.post('/api/settings/mystery_gcp.php', {
              service_account_json: mysteryServiceAccountJson,
              tts_api_key: mysteryTtsApiKey,
            })
          : Promise.resolve(null),
        Object.keys(geminiPayload).length > 0 ? ApiClient.post('/api/settings/mystery_gemini.php', geminiPayload) : Promise.resolve(null),
      ]);

      if (resGcp) {
        setHasMysteryServiceAccount(Number(resGcp?.has_service_account_json || 0));
        setHasMysteryTtsKey(Number(resGcp?.has_tts_api_key || 0));
      }
      if (resGemini) {
        setHasMysteryGeminiKey(Number(resGemini?.has_api_key || 0));
        setMysteryGeminiKeyName(String(resGemini?.key_name || ''));
        setMysteryGeminiProjectName(String(resGemini?.project_name || ''));
        setMysteryGeminiProjectNumber(String(resGemini?.project_number || ''));
      }
      setMysteryServiceAccountJson('');
      setMysteryTtsApiKey('');
      setMysteryGeminiApiKey('');
      cleanSnapshotRef.current = JSON.stringify({
        mysteryServiceAccountJson: '',
        mysteryTtsApiKey: '',
        mysteryGeminiApiKey: '',
        mysteryGeminiKeyName: String(resGemini?.key_name || mysteryGeminiKeyName || ''),
        mysteryGeminiProjectName: String(resGemini?.project_name || mysteryGeminiProjectName || ''),
        mysteryGeminiProjectNumber: String(resGemini?.project_number || mysteryGeminiProjectNumber || ''),
      });
      setMessage('Saved.');
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  const refreshSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M8 3a5 5 0 1 0 4.546 2.916.75.75 0 1 1 1.366-.52A6.5 6.5 0 1 1 8 1.5c1.38 0 2.656.43 3.706 1.164V1.75a.75.75 0 0 1 1.5 0V5a.75.75 0 0 1-.75.75H9.25a.75.75 0 0 1 0-1.5h1.9A4.97 4.97 0 0 0 8 3Z"
      />
    </svg>
  );

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-lg">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">AI Voice Configuration</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                onClick={save}
                disabled={busy || !isDirty}
                aria-label="Save"
                title={isDirty ? 'Save changes' : 'No changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <form onSubmit={save}>
              <div className="border rounded p-3 mb-3">
                <div className="fw-semibold mb-2">Mystery: Google Cloud (TTS / Service Account)</div>
                <div className="row g-3">
                  <div className="col-12">
                    <label className="form-label" htmlFor="mystery-gcp-service-account-json">Service account JSON {hasMysteryServiceAccount ? '(saved)' : '(not set)'}</label>
                    <textarea
                      id="mystery-gcp-service-account-json"
                      className="form-control"
                      rows={6}
                      value={mysteryServiceAccountJson}
                      onChange={(e) => setMysteryServiceAccountJson(e.target.value)}
                      disabled={busy}
                      placeholder={hasMysteryServiceAccount ? 'Paste JSON to replace existing value' : 'Paste service account JSON'}
                      autoComplete="off"
                    />
                  </div>

                  <div className="col-12">
                    <label className="form-label" htmlFor="mystery-gcp-tts-api-key">Google Cloud TTS API key (optional) {hasMysteryTtsKey ? '(saved)' : '(not set)'}</label>
                    <input
                      id="mystery-gcp-tts-api-key"
                      className="form-control"
                      value={mysteryTtsApiKey}
                      onChange={(e) => setMysteryTtsApiKey(e.target.value)}
                      disabled={busy}
                      placeholder={hasMysteryTtsKey ? 'Paste to replace existing key' : 'Paste API key'}
                      autoComplete="off"
                    />
                  </div>

                  <div className="col-12">
                    <div className="d-flex justify-content-end gap-2">
                      <button
                        type="button"
                        className="btn btn-sm btn-outline-secondary"
                        disabled={busy || !hasMysteryServiceAccount}
                        onClick={testMysteryGcpServiceAccount}
                      >
                        Test service account
                      </button>
                      <button
                        type="button"
                        className="btn btn-sm btn-outline-secondary"
                        disabled={busy || !hasMysteryTtsKey}
                        onClick={testMysteryGcpTtsApiKey}
                      >
                        Test TTS API key
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div className="border rounded p-3">
                <div className="fw-semibold mb-2">Mystery: Gemini Live (AI Studio)</div>
                <div className="row g-3">
                  <div className="col-12">
                    <label className="form-label" htmlFor="mystery-gemini-api-key">API Key {hasMysteryGeminiKey ? '(saved)' : '(not set)'}</label>
                    <input
                      id="mystery-gemini-api-key"
                      className="form-control"
                      value={mysteryGeminiApiKey}
                      onChange={(e) => setMysteryGeminiApiKey(e.target.value)}
                      disabled={busy}
                      placeholder={hasMysteryGeminiKey ? 'Enter to replace existing key' : 'Enter API key'}
                      autoComplete="off"
                    />
                    <div className="form-text">This API key is used server-side to mint ephemeral tokens; it is not sent to the browser.</div>
                  </div>

                  <div className="col-md-6">
                    <label className="form-label" htmlFor="mystery-gemini-key-name">Name</label>
                    <input
                      id="mystery-gemini-key-name"
                      className="form-control"
                      value={mysteryGeminiKeyName}
                      onChange={(e) => setMysteryGeminiKeyName(e.target.value)}
                      disabled={busy}
                      placeholder="Mystery_Game_Gemini_Live"
                      autoComplete="off"
                    />
                  </div>

                  <div className="col-md-6">
                    <label className="form-label" htmlFor="mystery-gemini-project-name">Project Name</label>
                    <input
                      id="mystery-gemini-project-name"
                      className="form-control"
                      value={mysteryGeminiProjectName}
                      onChange={(e) => setMysteryGeminiProjectName(e.target.value)}
                      disabled={busy}
                      placeholder="projects/928442808422"
                      autoComplete="off"
                    />
                  </div>

                  <div className="col-md-6">
                    <label className="form-label" htmlFor="mystery-gemini-project-number">Project Number</label>
                    <input
                      id="mystery-gemini-project-number"
                      className="form-control"
                      value={mysteryGeminiProjectNumber}
                      onChange={(e) => setMysteryGeminiProjectNumber(e.target.value)}
                      disabled={busy}
                      placeholder="928442808422"
                      autoComplete="off"
                    />
                  </div>

                  <div className="col-12">
                    <div className="d-flex justify-content-end">
                      <button type="button" className="btn btn-sm btn-outline-secondary" disabled={busy || !hasMysteryGeminiKey} onClick={testGeminiLiveToken}>
                        Test Gemini Live token
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

const AI_IMAGE_PROVIDER_CHOICES = [
  { value: 'openai', label: 'OpenAI' },
  { value: 'azure_openai', label: 'Azure OpenAI' },
  { value: 'google_vertex_ai', label: 'Google Vertex AI' },
  { value: 'aws_bedrock', label: 'AWS Bedrock' },
  { value: 'stability_ai', label: 'Stability AI' },
  { value: 'replicate', label: 'Replicate' },
  { value: 'together_ai', label: 'Together AI' },
  { value: 'fireworks_ai', label: 'Fireworks AI' },
  { value: 'huggingface', label: 'Hugging Face' },
];

const AI_IMAGE_MODEL_CHOICES_BY_PROVIDER = {
  openai: [
    { value: 'gpt-image-1', label: 'gpt-image-1' },
    { value: 'dall-e-3', label: 'dall-e-3' },
    { value: 'dall-e-2', label: 'dall-e-2' },
  ],
  azure_openai: [
    { value: 'gpt-image-1', label: 'gpt-image-1 (Azure deployment)' },
    { value: 'dall-e-3', label: 'dall-e-3 (Azure deployment)' },
  ],
  google_vertex_ai: [
    { value: 'imagen-3.0-generate-001', label: 'imagen-3.0-generate-001' },
    { value: 'imagen-3.0-fast-generate-001', label: 'imagen-3.0-fast-generate-001' },
    { value: 'imagen-2.0-generate-001', label: 'imagen-2.0-generate-001' },
  ],
  aws_bedrock: [
    { value: 'amazon.titan-image-generator-v2:0', label: 'amazon.titan-image-generator-v2:0' },
    { value: 'amazon.titan-image-generator-v1', label: 'amazon.titan-image-generator-v1' },
    { value: 'stability.stable-diffusion-xl-v1', label: 'stability.stable-diffusion-xl-v1' },
  ],
  stability_ai: [
    { value: 'stable-image-ultra', label: 'stable-image-ultra' },
    { value: 'stable-image-core', label: 'stable-image-core' },
    { value: 'stable-diffusion-3-large', label: 'stable-diffusion-3-large' },
  ],
  replicate: [
    { value: 'black-forest-labs/flux-1.1-pro', label: 'black-forest-labs/flux-1.1-pro' },
    { value: 'black-forest-labs/flux-1.1-pro-ultra', label: 'black-forest-labs/flux-1.1-pro-ultra' },
    { value: 'stability-ai/stable-diffusion-3', label: 'stability-ai/stable-diffusion-3' },
  ],
  together_ai: [
    { value: 'black-forest-labs/FLUX.1-schnell', label: 'black-forest-labs/FLUX.1-schnell' },
    { value: 'black-forest-labs/FLUX.1.1-pro', label: 'black-forest-labs/FLUX.1.1-pro' },
  ],
  fireworks_ai: [
    { value: 'playground-v2.5-1024px-aesthetic', label: 'playground-v2.5-1024px-aesthetic' },
    { value: 'stable-diffusion-xl-1024-v1-0', label: 'stable-diffusion-xl-1024-v1-0' },
  ],
  huggingface: [
    { value: 'black-forest-labs/FLUX.1-schnell', label: 'black-forest-labs/FLUX.1-schnell' },
    { value: 'stabilityai/stable-diffusion-3.5-large', label: 'stabilityai/stable-diffusion-3.5-large' },
  ],
};

function aiImageGetModelChoices(provider) {
  const key = normalizeText(provider);
  return AI_IMAGE_MODEL_CHOICES_BY_PROVIDER[key] || [];
}

function aiImageDefaultParams(provider, model) {
  const p = normalizeText(provider);
  const m = normalizeText(model);
  if (p === 'openai' && (m === 'dall-e-3' || m === 'dall-e-2')) {
    return { size: '1024x1024', quality: m === 'dall-e-3' ? 'standard' : 'standard', style: m === 'dall-e-3' ? 'vivid' : 'natural', n: 1 };
  }
  if (p === 'google_vertex_ai') {
    return { aspect_ratio: '1:1', quality: 'standard', style: 'photorealistic', n: 1 };
  }
  if (p === 'aws_bedrock' || p === 'stability_ai' || p === 'replicate' || p === 'together_ai' || p === 'fireworks_ai' || p === 'huggingface') {
    return { aspect_ratio: '1:1', quality: 'standard', style: 'none', n: 1 };
  }
  return { size: '1024x1024', quality: 'standard', style: 'natural', n: 1 };
}

function aiImageParamOptions(provider) {
  const p = normalizeText(provider);
  if (p === 'openai' || p === 'azure_openai') {
    return {
      size: ['1024x1024', '1024x1536', '1536x1024', '512x512', '256x256'],
      quality: ['standard', 'hd'],
      style: ['natural', 'vivid'],
      n: [1, 2, 3, 4],
    };
  }
  return {
    aspect_ratio: ['1:1', '16:9', '9:16', '4:3', '3:4'],
    quality: ['standard', 'high'],
    style: ['none', 'photorealistic', 'cinematic', 'illustration'],
    n: [1, 2, 3, 4],
  };
}

const AI_PROVIDER_CHOICES = [
  { value: 'openai', label: 'OpenAI' },
  { value: 'anthropic', label: 'Anthropic' },
  { value: 'google_ai_studio', label: 'Google AI Studio' },
  { value: 'google_vertex_ai', label: 'Google Vertex AI' },
  { value: 'azure_openai', label: 'Azure OpenAI' },
  { value: 'aws_bedrock', label: 'AWS Bedrock' },
  { value: 'together_ai', label: 'Together AI' },
  { value: 'fireworks_ai', label: 'Fireworks AI' },
  { value: 'huggingface', label: 'Hugging Face' },
];

const AI_MODEL_CHOICES_BY_PROVIDER = {
  openai: [
    { value: 'gpt-4o-mini', label: 'gpt-4o-mini' },
    { value: 'gpt-4o', label: 'gpt-4o' },
    { value: 'gpt-5.2-low', label: 'gpt-5.2-low (low reasoning)' },
  ],
  anthropic: [
    { value: 'claude-3-5-sonnet-latest', label: 'claude-3-5-sonnet-latest' },
    { value: 'claude-3-5-haiku-latest', label: 'claude-3-5-haiku-latest' },
  ],
  google_ai_studio: [
    { value: 'gemini-2.0-flash-001', label: 'gemini-2.0-flash-001' },
    { value: 'gemini-2.0-flash-lite-001', label: 'gemini-2.0-flash-lite-001' },
    { value: 'gemini-2.5-flash', label: 'gemini-2.5-flash' },
    { value: 'gemini-2.5-pro', label: 'gemini-2.5-pro' },
    { value: 'gemini-3.0-flash', label: 'gemini-3.0-flash' },
  ],
  google_vertex_ai: [
    { value: 'publishers/google/models/gemini-2.0-flash-001', label: 'publishers/google/models/gemini-2.0-flash-001' },
    { value: 'publishers/google/models/gemini-2.0-flash-lite-001', label: 'publishers/google/models/gemini-2.0-flash-lite-001' },
    { value: 'publishers/google/models/gemini-2.5-flash', label: 'publishers/google/models/gemini-2.5-flash' },
    { value: 'publishers/google/models/gemini-2.5-pro', label: 'publishers/google/models/gemini-2.5-pro' },
    { value: 'publishers/google/models/gemini-3.0-flash', label: 'publishers/google/models/gemini-3.0-flash' },
  ],
  azure_openai: [
    { value: 'gpt-4o-mini', label: 'gpt-4o-mini (Azure deployment)' },
    { value: 'gpt-4o', label: 'gpt-4o (Azure deployment)' },
    { value: 'gpt-5.2-low', label: 'gpt-5.2-low (Azure deployment)' },
  ],
  aws_bedrock: [
    { value: 'anthropic.claude-3-5-sonnet-20240620-v1:0', label: 'anthropic.claude-3-5-sonnet-20240620-v1:0' },
    { value: 'anthropic.claude-3-5-haiku-20241022-v1:0', label: 'anthropic.claude-3-5-haiku-20241022-v1:0' },
  ],
  together_ai: [
    { value: 'meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo', label: 'meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo' },
    { value: 'mistralai/Mixtral-8x7B-Instruct-v0.1', label: 'mistralai/Mixtral-8x7B-Instruct-v0.1' },
  ],
  fireworks_ai: [
    { value: 'accounts/fireworks/models/llama-v3p1-70b-instruct', label: 'accounts/fireworks/models/llama-v3p1-70b-instruct' },
    { value: 'accounts/fireworks/models/qwen2p5-72b-instruct', label: 'accounts/fireworks/models/qwen2p5-72b-instruct' },
  ],
  huggingface: [
    { value: 'meta-llama/Llama-3.1-70B-Instruct', label: 'meta-llama/Llama-3.1-70B-Instruct' },
    { value: 'mistralai/Mistral-7B-Instruct-v0.3', label: 'mistralai/Mistral-7B-Instruct-v0.3' },
  ],
};

function aiGetModelChoices(provider) {
  const key = normalizeText(provider);
  return AI_MODEL_CHOICES_BY_PROVIDER[key] || [];
}

function AIImageConfigJsonModal({ open, onClose, value, onSave, busy }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [error, setError] = useState('');
  const [text, setText] = useState('{}');
  const cleanTextRef = useRef('');

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setError('');
    const safeValue = value && typeof value === 'object' && !Array.isArray(value) ? value : {};
    const nextText = JSON.stringify(safeValue, null, 2);
    cleanTextRef.current = nextText;
    setText(nextText);
  }, [open, value]);

  const isDirty = String(cleanTextRef.current || '') !== String(text || '');

  const save = async (e) => {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    setError('');
    try {
      const parsed = JSON.parse(String(text || '{}'));
      if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
        throw new Error('JSON must be an object');
      }
      if (typeof onSave === 'function') {
        await onSave(parsed);
      }
      const modal = modalApiRef.current;
      if (modal) modal.hide();
    } catch (err) {
      setError(err?.message || 'Invalid JSON');
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-lg">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">AI Image Config JSON Editor</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                onClick={save}
                disabled={Boolean(busy) || !isDirty}
                aria-label="Save"
                title={isDirty ? 'Save changes' : 'No changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            <form onSubmit={save}>
              <label className="form-label" htmlFor="ai-image-config-json">Config JSON</label>
              <textarea
                id="ai-image-config-json"
                className="form-control"
                rows={12}
                value={text}
                onChange={(e) => setText(e.target.value)}
                disabled={Boolean(busy)}
                spellCheck={false}
              />
              <button type="submit" className="btn btn-primary w-100 mt-3" disabled={Boolean(busy)}>
                Apply JSON
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function AIConfigJsonModal({ open, onClose, value, onSave, busy }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [error, setError] = useState('');
  const [text, setText] = useState('{}');
  const cleanTextRef = useRef('');

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setError('');
    const safeValue = value && typeof value === 'object' && !Array.isArray(value) ? value : {};
    const nextText = JSON.stringify(safeValue, null, 2);
    cleanTextRef.current = nextText;
    setText(nextText);
  }, [open, value]);

  const isDirty = String(cleanTextRef.current || '') !== String(text || '');

  const save = async (e) => {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    setError('');
    try {
      const parsed = JSON.parse(String(text || '{}'));
      if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
        throw new Error('JSON must be an object');
      }
      if (typeof onSave === 'function') {
        await onSave(parsed);
      }
      const modal = modalApiRef.current;
      if (modal) modal.hide();
    } catch (err) {
      setError(err?.message || 'Invalid JSON');
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-lg">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">AI Config JSON Editor</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                onClick={save}
                disabled={Boolean(busy) || !isDirty}
                aria-label="Save"
                title={isDirty ? 'Save changes' : 'No changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            <form onSubmit={save}>
              <label className="form-label" htmlFor="ai-config-json">Config JSON</label>
              <textarea
                id="ai-config-json"
                className="form-control"
                rows={12}
                value={text}
                onChange={(e) => setText(e.target.value)}
                disabled={Boolean(busy)}
                spellCheck={false}
              />
              <button type="submit" className="btn btn-primary w-100 mt-3" disabled={Boolean(busy)}>
                Apply JSON
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function DbConfigModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');

  const emptyCfg = useMemo(() => ({ host: '', db: '', user: '', pass: '', port: 3306, socket: '' }), []);
  const [cfgByProfile, setCfgByProfile] = useState({ dev: emptyCfg, live: emptyCfg });
  const [selectedProfile, setSelectedProfile] = useState('dev');
  const [activeProfile, setActiveProfile] = useState('dev');
  const [source, setSource] = useState('env');

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (open) load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  const load = async () => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/settings/db.php?action=get');
      const profiles = res?.profiles || {};
      setSource(String(res?.source || 'env'));
      const ap = String(res?.active_profile || 'dev');
      setActiveProfile(ap);

      setCfgByProfile({
        dev: {
          host: String(profiles?.dev?.host || ''),
          db: String(profiles?.dev?.db || ''),
          user: String(profiles?.dev?.user || ''),
          pass: '',
          port: Number(profiles?.dev?.port || 3306),
          socket: String(profiles?.dev?.socket || ''),
        },
        live: {
          host: String(profiles?.live?.host || ''),
          db: String(profiles?.live?.db || ''),
          user: String(profiles?.live?.user || ''),
          pass: '',
          port: Number(profiles?.live?.port || 3306),
          socket: String(profiles?.live?.socket || ''),
        },
      });

      setSelectedProfile(ap === 'live' ? 'live' : 'dev');
    } catch (e) {
      setError(e?.message || 'Failed to load DB config');
    } finally {
      setBusy(false);
    }
  };

  const test = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const cfg = cfgByProfile[selectedProfile] || emptyCfg;
      const res = await ApiClient.post('/api/settings/db.php?action=test', {
        host: cfg.host,
        db: cfg.db,
        user: cfg.user,
        pass: cfg.pass,
        port: Number(cfg.port || 0) || 3306,
        socket: cfg.socket,
      });
      setMessage(String(res?.message || 'Connection successful'));
    } catch (err) {
      setError(err?.message || 'Connection failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-lg">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Database Connection</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <div className="alert alert-info" role="alert">
              <div className="fw-bold">Test-only</div>
              This tool tests a database connection but does not save credentials.
              <div>Current source: {source}.</div>
              <div>Active profile (auto-selected): <span className="fw-bold">{activeProfile}</span>.</div>
            </div>

            <form onSubmit={test}>
              <div className="mb-3">
                <label className="form-label" htmlFor="db-profile">Profile to test</label>
                <select
                  id="db-profile"
                  className="form-select"
                  value={selectedProfile}
                  onChange={(e) => setSelectedProfile(e.target.value)}
                  disabled={busy}
                >
                  <option value="dev">Dev</option>
                  <option value="live">Live</option>
                </select>
              </div>

              <div className="row g-3">
                <div className="col-md-6">
                  <label className="form-label" htmlFor="db-host">Host</label>
                  <input
                    id="db-host"
                    className="form-control"
                    value={(cfgByProfile[selectedProfile] || emptyCfg).host}
                    onChange={(e) =>
                      setCfgByProfile((all) => ({
                        ...all,
                        [selectedProfile]: { ...(all[selectedProfile] || emptyCfg), host: e.target.value },
                      }))
                    }
                    disabled={busy}
                    placeholder="127.0.0.1"
                  />
                </div>
                <div className="col-md-6">
                  <label className="form-label" htmlFor="db-socket">Socket (optional)</label>
                  <input
                    id="db-socket"
                    className="form-control"
                    value={(cfgByProfile[selectedProfile] || emptyCfg).socket}
                    onChange={(e) =>
                      setCfgByProfile((all) => ({
                        ...all,
                        [selectedProfile]: { ...(all[selectedProfile] || emptyCfg), socket: e.target.value },
                      }))
                    }
                    disabled={busy}
                    placeholder="/tmp/mysql.sock"
                  />
                </div>
                <div className="col-md-6">
                  <label className="form-label" htmlFor="db-name">Database</label>
                  <input
                    id="db-name"
                    className="form-control"
                    value={(cfgByProfile[selectedProfile] || emptyCfg).db}
                    onChange={(e) =>
                      setCfgByProfile((all) => ({
                        ...all,
                        [selectedProfile]: { ...(all[selectedProfile] || emptyCfg), db: e.target.value },
                      }))
                    }
                    disabled={busy}
                  />
                </div>
                <div className="col-md-6">
                  <label className="form-label" htmlFor="db-port">Port</label>
                  <input
                    id="db-port"
                    className="form-control"
                    type="number"
                    value={String((cfgByProfile[selectedProfile] || emptyCfg).port)}
                    onChange={(e) =>
                      setCfgByProfile((all) => ({
                        ...all,
                        [selectedProfile]: { ...(all[selectedProfile] || emptyCfg), port: e.target.value },
                      }))
                    }
                    disabled={busy}
                  />
                </div>
                <div className="col-md-6">
                  <label className="form-label" htmlFor="db-user">User</label>
                  <input
                    id="db-user"
                    className="form-control"
                    value={(cfgByProfile[selectedProfile] || emptyCfg).user}
                    onChange={(e) =>
                      setCfgByProfile((all) => ({
                        ...all,
                        [selectedProfile]: { ...(all[selectedProfile] || emptyCfg), user: e.target.value },
                      }))
                    }
                    disabled={busy}
                  />
                </div>
                <div className="col-md-6">
                  <label className="form-label" htmlFor="db-pass">Password</label>
                  <input
                    id="db-pass"
                    className="form-control"
                    type="password"
                    value={(cfgByProfile[selectedProfile] || emptyCfg).pass}
                    onChange={(e) =>
                      setCfgByProfile((all) => ({
                        ...all,
                        [selectedProfile]: { ...(all[selectedProfile] || emptyCfg), pass: e.target.value },
                      }))
                    }
                    disabled={busy}
                    placeholder="(not loaded)"
                  />
                </div>
              </div>

              <div className="d-flex justify-content-end gap-2 mt-3">
                <button type="button" className="btn btn-outline-secondary" onClick={load} disabled={busy}>
                  Reload
                </button>
                <button type="submit" className="btn btn-primary" disabled={busy}>
                  Test Connection
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  );

}

function AIImageConfigModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const jsonModalApiRef = useRef(null);
  const jsonModalRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const cleanSnapshotRef = useRef('');

  const suppressCloseRef = useRef(false);
  const pendingJsonOpenRef = useRef(false);

  type AiLooseObject = Record<string, any>;
  type AIImageConfigState = {
    provider: string;
    model: string;
    base_url: string;
    params: AiLooseObject;
    provider_config: AiLooseObject;
  };
  type AIImageSavePayload = {
    provider: string;
    model: string;
    base_url: string;
    params: AiLooseObject;
    provider_config: AiLooseObject;
    secrets?: AiLooseObject;
  };

  const [config, setConfig] = useState<AIImageConfigState>({
    provider: 'openai',
    model: 'gpt-image-1',
    base_url: '',
    params: {},
    provider_config: {},
  });
  const [hasSecrets, setHasSecrets] = useState<Record<string, AiLooseObject>>({});
  const [secretsByProvider, setSecretsByProvider] = useState<Record<string, AiLooseObject>>({});
  const [jsonEditorOpen, setJsonEditorOpen] = useState(false);

  const providerKey = normalizeText(config.provider);
  const modelChoices = useMemo(() => aiImageGetModelChoices(config.provider), [config.provider]);
  const paramOptions = useMemo(() => aiImageParamOptions(config.provider), [config.provider]);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');

    ApiClient.get('/api/settings/ai_image.php')
      .then((res) => {
        const cfg = res?.config || {};
        const params = (cfg && typeof cfg === 'object' && cfg.params && typeof cfg.params === 'object') ? cfg.params : {};
        const providerConfig = (cfg && typeof cfg === 'object' && cfg.provider_config && typeof cfg.provider_config === 'object') ? cfg.provider_config : {};
        setConfig({
          provider: String(cfg.provider || 'openai'),
          model: String(cfg.model || 'gpt-image-1'),
          base_url: String(cfg.base_url || ''),
          params,
          provider_config: providerConfig,
        });
        setHasSecrets((res && typeof res === 'object' && res.has_secrets && typeof res.has_secrets === 'object') ? res.has_secrets : {});
      })
      .catch((e) => setError(e?.message || 'Failed to load image AI configuration'))
      .finally(() => setBusy(false));
  }, [open]);

  useEffect(() => {
    if (!open) return;
    if (!config || typeof config !== 'object') return;
    if (!config.provider) return;
    const choices = aiImageGetModelChoices(config.provider);
    if (!choices.length) return;
    const current = String(config.model || '');
    if (choices.some((m) => String(m.value) === current)) return;
    setConfig((c) => ({ ...c, model: String(choices[0].value || '') }));
  }, [open, config.provider, config.model]);

  const openJsonEditor = () => {
    const modal = modalApiRef.current;
    if (!modal) {
      setJsonEditorOpen(true);
      return;
    }
    suppressCloseRef.current = true;
    pendingJsonOpenRef.current = true;
    modal.hide();
  };

  const closeJsonEditor = () => {
    setJsonEditorOpen(false);
    window.setTimeout(() => {
      const modal = modalApiRef.current;
      if (modal && open) modal.show();
    }, 0);
  };

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  const buildSnapshot = () => {
    const cfg = (config && typeof config === 'object') ? (config as any) : {};
    const providerNorm = normalizeText(cfg.provider);
    const secrets = (secretsByProvider && typeof secretsByProvider === 'object' && providerNorm && secretsByProvider[providerNorm] && typeof secretsByProvider[providerNorm] === 'object')
      ? secretsByProvider[providerNorm]
      : {};
    return JSON.stringify({ cfg, secrets });
  };

  useEffect(() => {
    if (!open) return;
    cleanSnapshotRef.current = buildSnapshot();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  const isDirty = String(cleanSnapshotRef.current || '') !== buildSnapshot();

  const save = async (e) => {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const params = config?.params;
      if (!params || typeof params !== 'object' || Array.isArray(params)) throw new Error('Params must be an object');
      const providerConfig = config?.provider_config;
      if (providerConfig && (typeof providerConfig !== 'object' || Array.isArray(providerConfig))) throw new Error('Provider config must be an object');
      const payload: AIImageSavePayload = {
        provider: String(config.provider || '').trim(),
        model: String(config.model || '').trim(),
        base_url: String(config.base_url || '').trim(),
        params: params as AiLooseObject,
        provider_config: (providerConfig || {}) as AiLooseObject,
      };
      const providerNorm = normalizeText(config.provider);
      const providerSecrets = secretsByProvider[providerNorm] && typeof secretsByProvider[providerNorm] === 'object' ? secretsByProvider[providerNorm] : null;
      if (providerSecrets) {
        payload.secrets = providerSecrets;
      }

      const res = await ApiClient.post('/api/settings/ai_image.php', payload);
      const cfg = res?.config || {};
      const nextParams = (cfg && typeof cfg === 'object' && cfg.params && typeof cfg.params === 'object') ? cfg.params : {};
      const nextProviderConfig = (cfg && typeof cfg === 'object' && cfg.provider_config && typeof cfg.provider_config === 'object') ? cfg.provider_config : {};
      setConfig({
        provider: String(cfg.provider || payload.provider || 'openai'),
        model: String(cfg.model || payload.model || 'gpt-image-1'),
        base_url: String(cfg.base_url || payload.base_url || ''),
        params: nextParams,
        provider_config: nextProviderConfig,
      });
      setHasSecrets((res && typeof res === 'object' && res.has_secrets && typeof res.has_secrets === 'object') ? res.has_secrets : {});
      setSecretsByProvider((all) => {
        const next = { ...(all || {}) };
        if (providerNorm) next[providerNorm] = {};
        return next;
      });
      setMessage('Saved.');
      cleanSnapshotRef.current = buildSnapshot();
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  const providerHas = (hasSecrets && typeof hasSecrets === 'object' && hasSecrets[providerKey] && typeof hasSecrets[providerKey] === 'object') ? hasSecrets[providerKey] : {};
  const providerSecrets = (secretsByProvider && typeof secretsByProvider === 'object' && secretsByProvider[providerKey] && typeof secretsByProvider[providerKey] === 'object') ? secretsByProvider[providerKey] : {};

  return (
    <>
      <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
        <div className="modal-dialog modal-dialog-centered modal-lg">
          <div className="modal-content">
            <div className="modal-header">
              <h5 className="modal-title">AI Image Configuration</h5>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                  onClick={save}
                  disabled={busy || !isDirty}
                  aria-label="Save"
                  title={isDirty ? 'Save changes' : 'No changes to save'}
                >
                  {saveSvg}
                </button>
                <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">
              {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
              {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

              <form onSubmit={save}>
                <div className="row g-3">
                  <div className="col-md-6">
                    <label className="form-label" htmlFor="ai-image-provider">Provider</label>
                    <select
                      id="ai-image-provider"
                      className="form-select"
                      value={config.provider}
                      onChange={(e) => {
                        const nextProvider = e.target.value;
                        const choices = aiImageGetModelChoices(nextProvider);
                        const nextModel = choices.length ? String(choices[0].value || '') : '';
                        setConfig((c) => ({
                          ...c,
                          provider: nextProvider,
                          model: nextModel,
                          params: aiImageDefaultParams(nextProvider, nextModel),
                          provider_config: {},
                        }));
                      }}
                      disabled={busy}
                    >
                      {AI_IMAGE_PROVIDER_CHOICES.map((p) => (
                        <option key={p.value} value={p.value}>{p.label}</option>
                      ))}
                    </select>
                  </div>
                  <div className="col-md-6">
                    <label className="form-label" htmlFor="ai-image-model">Model</label>
                    <select
                      id="ai-image-model"
                      className="form-select"
                      value={config.model}
                      onChange={(e) => {
                        const nextModel = e.target.value;
                        setConfig((c) => ({ ...c, model: nextModel }));
                      }}
                      disabled={busy || !modelChoices.length}
                    >
                      {modelChoices.map((m) => (
                        <option key={m.value} value={m.value}>{m.label}</option>
                      ))}
                    </select>
                  </div>

                  <div className="col-12">
                    {providerKey === 'openai' || providerKey === 'together_ai' || providerKey === 'fireworks_ai' ? (
                      <>
                        <label className="form-label" htmlFor="ai-image-base-url">Base URL</label>
                        <input
                          id="ai-image-base-url"
                          className="form-control"
                          value={config.base_url}
                          onChange={(e) => setConfig((c) => ({ ...c, base_url: e.target.value }))}
                          disabled={busy}
                          placeholder=""
                        />
                      </>
                    ) : null}
                  </div>

                  {providerKey === 'azure_openai' ? (
                    <>
                      <div className="col-12">
                        <label className="form-label" htmlFor="ai-image-azure-endpoint">Endpoint</label>
                        <input
                          id="ai-image-azure-endpoint"
                          className="form-control"
                          value={String((config.provider_config as AiLooseObject).azure_endpoint || '')}
                          onChange={(e) =>
                            setConfig((c) => ({
                              ...c,
                              provider_config: { ...(c.provider_config || {}), azure_endpoint: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder="https://{resource}.openai.azure.com"
                        />
                      </div>
                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-azure-deployment">Deployment</label>
                        <input
                          id="ai-image-azure-deployment"
                          className="form-control"
                          value={String((config.provider_config as AiLooseObject).azure_deployment || '')}
                          onChange={(e) =>
                            setConfig((c) => ({
                              ...c,
                              provider_config: { ...(c.provider_config || {}), azure_deployment: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder=""
                        />
                      </div>
                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-azure-api-version">API Version</label>
                        <input
                          id="ai-image-azure-api-version"
                          className="form-control"
                          value={String((config.provider_config as AiLooseObject).azure_api_version || '')}
                          onChange={(e) =>
                            setConfig((c) => ({
                              ...c,
                              provider_config: { ...(c.provider_config || {}), azure_api_version: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder=""
                        />
                      </div>
                    </>
                  ) : null}

                  {providerKey === 'google_vertex_ai' ? (
                    <>
                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-gcp-project-id">GCP project ID</label>
                        <input
                          id="ai-image-gcp-project-id"
                          className="form-control"
                          value={String((config.provider_config as AiLooseObject).gcp_project_id || '')}
                          onChange={(e) =>
                            setConfig((c) => ({
                              ...c,
                              provider_config: { ...(c.provider_config || {}), gcp_project_id: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder="my-project-id"
                        />
                      </div>
                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-gcp-region">GCP region</label>
                        <input
                          id="ai-image-gcp-region"
                          className="form-control"
                          value={String((config.provider_config as AiLooseObject).gcp_region || '')}
                          onChange={(e) =>
                            setConfig((c) => ({
                              ...c,
                              provider_config: { ...(c.provider_config || {}), gcp_region: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder="us-central1"
                        />
                      </div>

                      <div className="col-12">
                        <label className="form-label" htmlFor="ai-image-location-reference-model">Location reference model</label>
                        <input
                          id="ai-image-location-reference-model"
                          className="form-control"
                          value={String((config.provider_config as AiLooseObject).location_reference_model || '')}
                          onChange={(e) =>
                            setConfig((c) => ({
                              ...c,
                              provider_config: { ...(c.provider_config || {}), location_reference_model: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder="imagen-3.0-capability-001"
                        />
                        <div className="form-text">Used when transforming a real location photo into a noir crime scene via Imagen edit (REFERENCE_TYPE_RAW).</div>
                      </div>

                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-google-places-key">Google Places API key {Number(providerHas.google_places_api_key || 0) ? '(saved)' : '(not set)'}</label>
                        <input
                          id="ai-image-google-places-key"
                          className="form-control"
                          value={String(providerSecrets.google_places_api_key || '')}
                          onChange={(e) => setSecretsByProvider((all) => ({
                            ...(all || {}),
                            [providerKey]: { ...(all?.[providerKey] || {}), google_places_api_key: e.target.value },
                          }))}
                          disabled={busy}
                          placeholder={Number(providerHas.google_places_api_key || 0) ? 'Enter to replace existing key' : 'Enter API key'}
                          autoComplete="off"
                        />
                        <div className="form-text">Used server-side to retrieve a real reference photo for location-based image generation.</div>
                      </div>

                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-google-streetview-key">Google Street View API key {Number(providerHas.google_street_view_api_key || 0) ? '(saved)' : '(not set)'}</label>
                        <input
                          id="ai-image-google-streetview-key"
                          className="form-control"
                          value={String(providerSecrets.google_street_view_api_key || '')}
                          onChange={(e) => setSecretsByProvider((all) => ({
                            ...(all || {}),
                            [providerKey]: { ...(all?.[providerKey] || {}), google_street_view_api_key: e.target.value },
                          }))}
                          disabled={busy}
                          placeholder={Number(providerHas.google_street_view_api_key || 0) ? 'Enter to replace existing key' : 'Enter API key'}
                          autoComplete="off"
                        />
                        <div className="form-text">Optional fallback if Places photos are unavailable.</div>
                      </div>
                    </>
                  ) : null}

                  {providerKey === 'aws_bedrock' ? (
                    <div className="col-12">
                      <label className="form-label" htmlFor="ai-image-aws-region">Region</label>
                      <input
                        id="ai-image-aws-region"
                        className="form-control"
                        value={String((config.provider_config as AiLooseObject).aws_region || '')}
                        onChange={(e) =>
                          setConfig((c) => ({
                            ...c,
                            provider_config: { ...(c.provider_config || {}), aws_region: e.target.value },
                          }))
                        }
                        disabled={busy}
                        placeholder="us-east-1"
                      />
                    </div>
                  ) : null}

                  {providerKey === 'openai' || providerKey === 'azure_openai' || providerKey === 'together_ai' || providerKey === 'fireworks_ai' || providerKey === 'stability_ai' || providerKey === 'replicate' || providerKey === 'huggingface' ? (
                    <div className="col-12">
                      <label className="form-label" htmlFor="ai-image-provider-api-key">
                        {providerKey === 'replicate' || providerKey === 'huggingface' ? 'API Token' : 'API Key'}
                        {providerHas.api_key ? ' (saved)' : ' (not set)'}
                      </label>
                      <input
                        id="ai-image-provider-api-key"
                        className="form-control"
                        value={String(providerSecrets.api_key || '')}
                        onChange={(e) =>
                          setSecretsByProvider((all) => ({
                            ...(all || {}),
                            [providerKey]: { ...((all || {})[providerKey] || {}), api_key: e.target.value },
                          }))
                        }
                        disabled={busy}
                        placeholder={providerHas.api_key ? 'Enter to replace existing token' : 'Enter token'}
                        autoComplete="off"
                      />
                    </div>
                  ) : null}

                  {providerKey === 'google_vertex_ai' ? (
                    <div className="col-12">
                      <label className="form-label" htmlFor="ai-image-provider-service-account">
                        Service Account JSON
                        {providerHas.service_account_json ? ' (saved)' : ' (not set)'}
                      </label>
                      <textarea
                        id="ai-image-provider-service-account"
                        className="form-control"
                        rows={6}
                        value={String(providerSecrets.service_account_json || '')}
                        onChange={(e) =>
                          setSecretsByProvider((all) => ({
                            ...(all || {}),
                            [providerKey]: { ...((all || {})[providerKey] || {}), service_account_json: e.target.value },
                          }))
                        }
                        disabled={busy}
                        spellCheck={false}
                      />
                    </div>
                  ) : null}

                  {providerKey === 'aws_bedrock' ? (
                    <>
                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-aws-access-key-id">
                          AWS Access Key ID
                          {providerHas.aws_access_key_id ? ' (saved)' : ' (not set)'}
                        </label>
                        <input
                          id="ai-image-aws-access-key-id"
                          className="form-control"
                          value={String(providerSecrets.aws_access_key_id || '')}
                          onChange={(e) =>
                            setSecretsByProvider((all) => ({
                              ...(all || {}),
                              [providerKey]: { ...((all || {})[providerKey] || {}), aws_access_key_id: e.target.value },
                            }))
                          }
                          disabled={busy}
                          autoComplete="off"
                        />
                      </div>
                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-image-aws-secret-access-key">
                          AWS Secret Access Key
                          {providerHas.aws_secret_access_key ? ' (saved)' : ' (not set)'}
                        </label>
                        <input
                          id="ai-image-aws-secret-access-key"
                          className="form-control"
                          value={String(providerSecrets.aws_secret_access_key || '')}
                          onChange={(e) =>
                            setSecretsByProvider((all) => ({
                              ...(all || {}),
                              [providerKey]: { ...((all || {})[providerKey] || {}), aws_secret_access_key: e.target.value },
                            }))
                          }
                          disabled={busy}
                          autoComplete="off"
                        />
                      </div>
                      <div className="col-12">
                        <label className="form-label" htmlFor="ai-image-aws-session-token">
                          AWS Session Token
                          {providerHas.aws_session_token ? ' (saved)' : ' (not set)'}
                        </label>
                        <input
                          id="ai-image-aws-session-token"
                          className="form-control"
                          value={String(providerSecrets.aws_session_token || '')}
                          onChange={(e) =>
                            setSecretsByProvider((all) => ({
                              ...(all || {}),
                              [providerKey]: { ...((all || {})[providerKey] || {}), aws_session_token: e.target.value },
                            }))
                          }
                          disabled={busy}
                          autoComplete="off"
                        />
                      </div>
                    </>
                  ) : null}

                  <div className="col-12">
                    <div className="d-flex justify-content-between align-items-end gap-2">
                      <div className="flex-grow-1">
                        <label className="form-label" htmlFor="ai-image-param-preset">Image Preset</label>
                        <select
                          id="ai-image-param-preset"
                          className="form-select"
                          value=""
                          onChange={(e) => {
                            const v = e.target.value;
                            if (!v) return;
                            const next =
                              v === 'standard'
                                ? aiImageDefaultParams(config.provider, config.model)
                                : v === 'hq'
                                  ? { ...aiImageDefaultParams(config.provider, config.model), quality: providerKey === 'openai' ? 'hd' : 'high' }
                                  : v === 'wide'
                                    ? { ...aiImageDefaultParams(config.provider, config.model), size: '1536x1024', aspect_ratio: '16:9' }
                                    : { ...aiImageDefaultParams(config.provider, config.model), size: '1024x1536', aspect_ratio: '9:16' };
                            setConfig((c) => ({ ...c, params: { ...(c.params || {}), ...next } }));
                          }}
                          disabled={busy}
                        >
                          <option value="">Select a preset</option>
                          <option value="standard">Standard</option>
                          <option value="hq">High quality</option>
                          <option value="wide">Wide</option>
                          <option value="tall">Tall</option>
                        </select>
                      </div>
                      <button type="button" className="btn btn-outline-secondary" onClick={openJsonEditor} disabled={busy}>
                        Edit JSON
                      </button>
                    </div>
                  </div>

                  {paramOptions.size ? (
                    <div className="col-md-4">
                      <label className="form-label" htmlFor="ai-image-param-size">Size</label>
                      <select
                        id="ai-image-param-size"
                        className="form-select"
                        value={String((config.params as AiLooseObject).size || '')}
                        onChange={(e) => setConfig((c) => ({ ...c, params: { ...(c.params || {}), size: e.target.value } }))}
                        disabled={busy}
                      >
                        {paramOptions.size.map((v) => (
                          <option key={v} value={v}>{v}</option>
                        ))}
                      </select>
                    </div>
                  ) : null}

                  {paramOptions.aspect_ratio ? (
                    <div className="col-md-4">
                      <label className="form-label" htmlFor="ai-image-param-aspect">Aspect Ratio</label>
                      <select
                        id="ai-image-param-aspect"
                        className="form-select"
                        value={String((config.params as AiLooseObject).aspect_ratio || '')}
                        onChange={(e) => setConfig((c) => ({ ...c, params: { ...(c.params || {}), aspect_ratio: e.target.value } }))}
                        disabled={busy}
                      >
                        {paramOptions.aspect_ratio.map((v) => (
                          <option key={v} value={v}>{v}</option>
                        ))}
                      </select>
                    </div>
                  ) : null}

                  <div className="col-md-4">
                    <label className="form-label" htmlFor="ai-image-param-quality">Quality</label>
                    <select
                      id="ai-image-param-quality"
                      className="form-select"
                      value={String((config.params as AiLooseObject).quality || '')}
                      onChange={(e) => setConfig((c) => ({ ...c, params: { ...(c.params || {}), quality: e.target.value } }))}
                      disabled={busy}
                    >
                      {paramOptions.quality.map((v) => (
                        <option key={v} value={v}>{v}</option>
                      ))}
                    </select>
                  </div>

                  <div className="col-md-4">
                    <label className="form-label" htmlFor="ai-image-param-style">Style</label>
                    <select
                      id="ai-image-param-style"
                      className="form-select"
                      value={String((config.params as AiLooseObject).style || '')}
                      onChange={(e) => setConfig((c) => ({ ...c, params: { ...(c.params || {}), style: e.target.value } }))}
                      disabled={busy}
                    >
                      {paramOptions.style.map((v) => (
                        <option key={v} value={v}>{v}</option>
                      ))}
                    </select>
                  </div>

                  <div className="col-md-4">
                    <label className="form-label" htmlFor="ai-image-param-n">Images</label>
                    <select
                      id="ai-image-param-n"
                      className="form-select"
                      value={String((config.params as AiLooseObject).n ?? 1)}
                      onChange={(e) => setConfig((c) => ({ ...c, params: { ...(c.params || {}), n: Number(e.target.value) } }))}
                      disabled={busy}
                    >
                      {paramOptions.n.map((v) => (
                        <option key={v} value={String(v)}>{String(v)}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

          <AIImageConfigJsonModal
      open={jsonEditorOpen}
      onClose={closeJsonEditor}
      value={config}
      busy={busy}
      onSave={async (next) => {
        const nextParams = next?.params && typeof next.params === 'object' && !Array.isArray(next.params) ? next.params : {};
        const nextProviderConfig = next?.provider_config && typeof next.provider_config === 'object' && !Array.isArray(next.provider_config) ? next.provider_config : {};
        const nextProvider = String(next?.provider || 'openai');
        const nextModel = String(next?.model || 'gpt-image-1');
        setConfig({
          provider: nextProvider,
          model: nextModel,
          base_url: String(next?.base_url || ''),
          params: nextParams,
          provider_config: nextProviderConfig,
        });
      }}
    />
  </>
);
}

function ToastOverlay({ toast, onClose }) {
  useEffect(() => {
    if (!toast) return undefined;
    const t = window.setTimeout(() => {
      if (typeof onClose === 'function') onClose();
    }, 30000);
    return () => window.clearTimeout(t);
  }, [toast, onClose]);

  if (!toast) return null;

  const rawTone = String(toast?.tone || '').trim();
  const tone = (rawTone === 'success' || rawTone === 'error' || rawTone === 'info')
    ? rawTone
    : 'error';
  const title = String(toast?.title || (
    tone === 'success'
      ? 'Success'
      : (tone === 'info'
        ? 'Info'
        : 'Error')
  ));
  const message = String(toast?.message || '');
  const extraClassName = String(toast?.className || '').trim();
  const extraOverlayClassName = String(toast?.overlayClassName || '').trim();

  return (
    <div
      className={'catn8-toast-overlay' + (extraOverlayClassName ? (' ' + extraOverlayClassName) : '')}
      role="presentation"
      onClick={() => {
        if (typeof onClose === 'function') onClose();
      }}
    >
      <div
        className={'catn8-toast catn8-toast-' + tone + (extraClassName ? (' ' + extraClassName) : '')}
        role="alert"
        aria-live="polite"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="catn8-toast-header">
          <div className="catn8-toast-title">{title}</div>
          <button
            type="button"
            className="catn8-toast-close"
            aria-label="Close"
            onClick={() => {
              if (typeof onClose === 'function') onClose();
            }}
          >
            
          </button>
        </div>
        {message ? <div className="catn8-toast-body">{message}</div> : null}
      </div>
    </div>
  );
}

type MysteryPageProps = {
  viewer: any;
  onLoginClick: any;
  onLogout: any;
  onAccountClick: any;
  onToast: any;
  onOpenAiImageConfig: any;
  onOpenAiConfig: any;
  onOpenAiVoiceConfig: any;
};

function MysteryPage({ viewer, onLoginClick, onLogout, onAccountClick, onToast, onOpenAiImageConfig, onOpenAiConfig, onOpenAiVoiceConfig }) {
  const isAuthed = Boolean(viewer && viewer.id);
  const isAdmin = Number(viewer?.is_admin || 0) === 1;
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const modalOpenSeqRef = useRef(0);
  const voiceToastDedupRef = useRef({ key: '', at: 0 });
  const voiceMapAutoFillKeyRef = useRef('');
  const foundationAutoLinkKeyRef = useRef('');

  const showMysteryToast = useCallback((t) => {
    if (typeof onToast !== 'function') return;
    const cls = String(t?.className || '').trim();
    const overlayCls = String(t?.overlayClassName || '').trim();
    onToast({
      ...(t || {}),
      className: (cls ? (cls + ' ') : '') + 'catn8-toast-mystery',
      overlayClassName: (overlayCls ? (overlayCls + ' ') : '') + 'catn8-toast-overlay-mystery',
    });
  }, [onToast]);

  useEffect(() => {
    if (!error) return;
    showMysteryToast({ tone: 'error', message: String(error) });
    setError('');
  }, [error, showMysteryToast]);

  useEffect(() => {
    if (!message) return;
    showMysteryToast({ tone: 'success', message: String(message) });
    setMessage('');
  }, [message, showMysteryToast]);

  const showVoiceToast = useCallback((t) => {
    const title = String(t?.title || 'Voice');
    const msg = String(t?.message || '').trim();
    if (!msg) return;

    const key = title + '|' + msg;
    const now = Date.now();
    const last = voiceToastDedupRef.current || { key: '', at: 0 };
    if (last.key === key && (now - Number(last.at || 0)) < 5000) return;
    voiceToastDedupRef.current = { key, at: now };
    showMysteryToast({ tone: 'error', title, message: msg });
  }, [showMysteryToast]);

  const cleanupModalArtifactsIfNoOpenModals = useCallback(() => {
    try {
      if (document.querySelector('.modal.show')) return;
    } catch (_err) {
      return;
    }

    try {
      document.querySelectorAll('.modal-backdrop').forEach((el) => el.remove());
    } catch (_err) {
    }

    try {
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('padding-right');
      document.body.style.removeProperty('overflow');
    } catch (_err) {
    }

    try {
      document.querySelectorAll('.catn8-stacked-modal').forEach((el) => el.classList.remove('catn8-mystery-modal-obscured'));
    } catch (_err) {
    }
  }, []);

  const syncStackedMysteryModalDimming = useCallback(() => {
    try {
      const open = (Array.from(document.querySelectorAll('.catn8-stacked-modal.show')) as HTMLElement[])
        .sort((a, b) => {
          const aSeq = Number(a?.dataset?.catn8OpenSeq || 0);
          const bSeq = Number(b?.dataset?.catn8OpenSeq || 0);
          return aSeq - bSeq;
        });
      const top = open.length ? open[open.length - 1] : null;
      for (let i = 0; i < open.length; i += 1) {
        const el = open[i];
        const layer = Math.min(i, 9);

        try {
          for (const c of Array.from(el.classList)) {
            if (String(c || '').startsWith('catn8-modal-layer-')) el.classList.remove(c);
          }
        } catch (_err) {
        }
        el.classList.add('catn8-modal-layer-' + String(layer));

        if (el === top) el.classList.remove('catn8-mystery-modal-obscured');
        else el.classList.add('catn8-mystery-modal-obscured');
      }

      const anyStackedOpen = open.length > 0;
      if (!anyStackedOpen) {
        cleanupModalArtifactsIfNoOpenModals();
        return;
      }

      const backdrops = Array.from(document.querySelectorAll('.modal-backdrop'));
      const shownBackdrop = backdrops.find((b) => b.classList.contains('show')) || null;

      try {
        document.body.classList.add('modal-open');
      } catch (_err) {
      }

      if (!shownBackdrop) {
        const bd = document.createElement('div');
        bd.className = 'modal-backdrop fade show';
        document.body.appendChild(bd);
      }

      const nonStackedOpen = Boolean(document.querySelector('.modal.show:not(.catn8-stacked-modal)'));
      if (!nonStackedOpen) {
        const after = Array.from(document.querySelectorAll('.modal-backdrop'));
        for (let i = 1; i < after.length; i += 1) after[i].remove();
      }
    } catch (_err) {
    }
  }, [cleanupModalArtifactsIfNoOpenModals]);

  const showModalNow = (ref, apiRef) => {
    const el = ref?.current;
    if (!el) return;
    if (!isBootstrapModalReady()) {
      setError('Bootstrap modal is not ready.');
      return;
    }
    const Modal = window.bootstrap?.Modal;
    if (!Modal) {
      setError('Bootstrap JS is not loaded (window.bootstrap.Modal missing).');
      return;
    }

    try {
      modalOpenSeqRef.current += 1;
      el.dataset.catn8OpenSeq = String(modalOpenSeqRef.current);
    } catch (_err) {
    }

    const instance = apiRef.current || createBootstrapModal(el);
    apiRef.current = instance;
    instance.show();
    window.setTimeout(syncStackedMysteryModalDimming, 0);
  };

  const pencilSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M12.854.146a.5.5 0 0 1 .707 0l2.293 2.293a.5.5 0 0 1 0 .707l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l9.5-9.5zM11.207 2L3 10.207V13h2.793L14 4.793 11.207 2z"
      />
    </svg>
  );

  const lockSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M8 1a2 2 0 0 0-2 2v3h4V3a2 2 0 0 0-2-2z"
      />
      <path
        fill="currentColor"
        d="M3 6a1 1 0 0 0-1 1v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7a1 1 0 0 0-1-1H3z"
      />
    </svg>
  );

  const unlockSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M11 1a2 2 0 0 0-2 2v3H5V3a3 3 0 0 1 6 0v2h-1V3a2 2 0 0 0-2-2z"
      />
      <path
        fill="currentColor"
        d="M3 7a1 1 0 0 1 1-1h8a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"
      />
    </svg>
  );

  const cogSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.012.88l-.314-.156c-1.283-.636-2.576.657-1.94 1.94l.156.314a1.464 1.464 0 0 1-.88 2.012l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .88 2.012l-.156.314c-.636 1.283.657 2.576 1.94 1.94l.314-.156a1.464 1.464 0 0 1 2.012.88l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.012-.88l.314.156c1.283.636 2.576-.657 1.94-1.94l-.156-.314a1.464 1.464 0 0 1 .88-2.012l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.88-2.012l.156-.314c.636-1.283-.657-2.576-1.94-1.94l-.314.156a1.464 1.464 0 0 1-2.012-.88l-.1-.34zM8 10.93a2.93 2.93 0 1 1 0-5.86 2.93 2.93 0 0 1 0 5.86z"
      />
    </svg>
  );

  const refreshSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M8 3a5 5 0 1 0 4.546 2.916.75.75 0 1 1 1.366-.52A6.5 6.5 0 1 1 8 1.5c1.38 0 2.656.43 3.706 1.164V1.75a.75.75 0 0 1 1.5 0V5a.75.75 0 0 1-.75.75H9.25a.75.75 0 0 1 0-1.5h1.9A4.97 4.97 0 0 0 8 3Z"
      />
    </svg>
  );

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  const trashSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M6.5 1h3a.5.5 0 0 1 .5.5V2h3a.5.5 0 0 1 0 1h-.5l-.6 10.2A2 2 0 0 1 9.91 15H6.09a2 2 0 0 1-1.99-1.8L3.5 3H3a.5.5 0 0 1 0-1h3v-.5a.5.5 0 0 1 .5-.5zM6 2v.0h4V2H6zM4.5 3l.59 10.1a1 1 0 0 0 1 .9h3.82a1 1 0 0 0 1-.9L11.5 3h-7z"
      />
      <path
        fill="currentColor"
        d="M6.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"
      />
    </svg>
  );

  const openStartResumeTab = (tab) => {
    const t = String(tab || 'home');
    const normalized = (t === 'home')
      ? 'start'
      : t;
    setStartResumeTab(normalized);
    setStartResumeOpen(true);
    showModalNow(startResumeRef, startResumeApiRef);
  };

  const transitionToModal = (fromRef, toRef, toApiRef, setToOpen) => {
    const toEl = toRef?.current;
    if (!toEl) return;

    const showTarget = () => {
      setToOpen(true);
      showModalNow(toRef, toApiRef);
    };

    const fromEl = fromRef?.current;
    if (!fromEl) {
      showTarget();
      return;
    }

    const onHidden = () => {
      try {
        fromEl.removeEventListener('hidden.bs.modal', onHidden);
      } catch (_err) {
      }
      window.setTimeout(showTarget, 0);
    };

    try {
      fromEl.addEventListener('hidden.bs.modal', onHidden);
    } catch (_err) {
      showTarget();
      return;
    }

    try {
      const Modal = window.bootstrap?.Modal;
      const inst = Modal?.getInstance(fromEl);
      if (inst) {
        inst.hide();
      } else {
        fromEl.classList.remove('show');
        cleanupModalArtifactsIfNoOpenModals();
        onHidden();
      }
    } catch (_err) {
      cleanupModalArtifactsIfNoOpenModals();
      onHidden();
    }
  };

  useEffect(() => {
    const onKeyDown = (e) => {
      if (e?.key !== 'Escape') return;

      try {
        const Modal = window.bootstrap?.Modal;
        if (Modal) {
          document.querySelectorAll('.modal.show').forEach((el) => {
            const inst = Modal.getInstance(el);
            if (inst) inst.hide();
            else el.classList.remove('show');
          });
        }
      } catch (_err) {
      }

      cleanupModalArtifactsIfNoOpenModals();
      window.setTimeout(syncStackedMysteryModalDimming, 0);
    };

    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [cleanupModalArtifactsIfNoOpenModals, syncStackedMysteryModalDimming]);

  const [mysteries, setMysteries] = useState([]);
  const [mysteryId, setMysteryId] = useState('');
  const [cases, setCases] = useState([]);
  const [caseId, setCaseId] = useState('');

  const [scenarios, setScenarios] = useState([]);
  const [scenarioId, setScenarioId] = useState('');
  const [scenario, setScenario] = useState(null);
  const [constraintsDraft, setConstraintsDraft] = useState('{}');

  const [deleteScenarioArmed, setDeleteScenarioArmed] = useState(false);

  const [storyLongDraft, setStoryLongDraft] = useState('');
  const [storyAnnotationsDraft, setStoryAnnotationsDraft] = useState('[]');
  const [storyLongSaved, setStoryLongSaved] = useState('');
  const [storyAnnotationsSaved, setStoryAnnotationsSaved] = useState('[]');
  const [coldHardFactsUpdatedAt, setColdHardFactsUpdatedAt] = useState('');

  const [storyGenSync, setStoryGenSync] = useState({
    active: false,
    status: '',
    error: '',
    crimeStatus: '',
    storyStatus: '',
  });

  const [coldHardFactsAudit, setColdHardFactsAudit] = useState<any>(null);
  const [coldHardFactsAuditOpen, setColdHardFactsAuditOpen] = useState(false);
  const [coldHardFactsAuditBusy, setColdHardFactsAuditBusy] = useState(false);
  const [applyAllFixesArmed, setApplyAllFixesArmed] = useState(false);
  const [applyAllFixesBusy, setApplyAllFixesBusy] = useState(false);

  const [newAnnotation, setNewAnnotation] = useState({
    paragraph: '1',
    type: 'weapon',
    entity_id: '',
    lie_id: '',
    case_note_id: '',
    value: '',
    note: '',
  });

  const [characters, setCharacters] = useState<any[]>([]);

  const [newCase, setNewCase] = useState({ title: '' });
  const [newScenario, setNewScenario] = useState({ title: '' });
  const [newCharacter, setNewCharacter] = useState({ name: '' });

  const [scenarioEntities, setScenarioEntities] = useState<any[]>([]);
  const [attachEntityId, setAttachEntityId] = useState('');
  const [attachRole, setAttachRole] = useState('suspect');
  const [attachOverrideText, setAttachOverrideText] = useState('{}');

  const [interrogationEvents, setInterrogationEvents] = useState([]);
  const [interviewEntityId, setInterviewEntityId] = useState('');
  const [interviewQuestion, setInterviewQuestion] = useState('');
  const [interviewAnswer, setInterviewAnswer] = useState('');
  const [interviewAudioUrl, setInterviewAudioUrl] = useState('');
  const [interviewMeta, setInterviewMeta] = useState(null);
  const [interviewTtsEnabled, setInterviewTtsEnabled] = useState(true);
  const interviewAudioRef = useRef(null);

  const disableTtsWithToast = useCallback((errMessage) => {
    setInterviewTtsEnabled(false);

    const msg = String(errMessage || '').trim();
    showVoiceToast({
      title: 'Voice disabled',
      message: msg ? (msg + ' Continuing in text-only mode.') : 'Voice is not configured. Continuing in text-only mode.',
    });
  }, [showVoiceToast]);

  const [jobs, setJobs] = useState([]);
  const [jobAction, setJobAction] = useState('regenerate');
  const [jobSpecText, setJobSpecText] = useState('{}');
  const [deleteJobArmedId, setDeleteJobArmedId] = useState(0);
  const [clearQueueArmed, setClearQueueArmed] = useState(false);
  const [clearQueueScenarioOnly, setClearQueueScenarioOnly] = useState(false);

  const [jobScopeCharacter, setJobScopeCharacter] = useState(true);
  const [jobScopeLocation, setJobScopeLocation] = useState(true);
  const [jobScopeWeapon, setJobScopeWeapon] = useState(true);
  const [jobScopeMotive, setJobScopeMotive] = useState(true);

  const [playTemplates, setPlayTemplates] = useState([]);
  const [playResumables, setPlayResumables] = useState([]);
  const [playBusy, setPlayBusy] = useState(false);
  const [playError, setPlayError] = useState('');
  const [playTemplateCaseId, setPlayTemplateCaseId] = useState('');
  const [playNewCaseTitle, setPlayNewCaseTitle] = useState('');

  useEffect(() => {
    if (!playError) return;
    showMysteryToast({ tone: 'error', message: String(playError) });
    setPlayError('');
  }, [playError, showMysteryToast]);

  const [startResumeOpen, setStartResumeOpen] = useState(false);
  const [startResumeTab, setStartResumeTab] = useState('home');
  const [gameMgmtOpen, setGameMgmtOpen] = useState(false);
  const [scenariosModalOpen, setScenariosModalOpen] = useState(false);
  const [mysteriesModalOpen, setMysteriesModalOpen] = useState(false);
  const [seedStoryModalOpen, setSeedStoryModalOpen] = useState(false);
  const [advancedModalOpen, setAdvancedModalOpen] = useState(false);
  const [caseboardOpen, setCaseboardOpen] = useState(false);
  const [toolsOpen, setToolsOpen] = useState(false);
  const [interrogationOpen, setInterrogationOpen] = useState(false);
  const [, setRapSheetOpen] = useState(false);
  const [assetLibraryOpen, setAssetLibraryOpen] = useState(false);
  const [masterAssetDetailsOpen, setMasterAssetDetailsOpen] = useState(false);
  const [mysterySettingsOpen, setMysterySettingsOpen] = useState(false);
  const [mysterySettingsEditorOpen, setMysterySettingsEditorOpen] = useState(false);

  const storyGenSyncScenarioIdRef = useRef(0);
  const mysterySettingsLoadSeqRef = useRef(0);
  const startResumeRef = useRef(null);
  const startResumeApiRef = useRef(null);
  const gameMgmtRef = useRef(null);
  const gameMgmtApiRef = useRef(null);
  const scenariosModalRef = useRef(null);
  const scenariosModalApiRef = useRef(null);
  const mysteriesModalRef = useRef(null);
  const mysteriesModalApiRef = useRef(null);
  const seedStoryModalRef = useRef(null);
  const seedStoryModalApiRef = useRef(null);
  const advancedModalRef = useRef(null);
  const advancedModalApiRef = useRef(null);
  const caseboardRef = useRef(null);
  const caseboardApiRef = useRef(null);
  const toolsRef = useRef(null);
  const toolsApiRef = useRef(null);
  const interrogationRef = useRef(null);
  const interrogationApiRef = useRef(null);
  const rapSheetRef = useRef(null);
  const rapSheetApiRef = useRef(null);
  const assetLibraryRef = useRef(null);
  const assetLibraryApiRef = useRef(null);
  const masterDeleteConfirmRef = useRef(null);
  const masterDeleteConfirmApiRef = useRef(null);
  const masterAssetDetailsRef = useRef(null);
  const masterAssetDetailsApiRef = useRef(null);
  const masterAssetJsonRef = useRef(null);
  const masterAssetJsonApiRef = useRef(null);
  const jsonPreviewRef = useRef(null);
  const jsonPreviewApiRef = useRef(null);
  const mysterySettingsRef = useRef(null);
  const mysterySettingsApiRef = useRef(null);
  const mysterySettingsEditorRef = useRef(null);
  const mysterySettingsEditorApiRef = useRef(null);
  const modalInitTimerRef = useRef(0);
  const movedModalsRef = useRef([]);
  const sheriffLiveGuidanceToastShownRef = useRef(false);

  useEffect(() => {
    if (!startResumeOpen) return;
    if (startResumeTab !== 'sheriff_live') return;
    if (sheriffLiveGuidanceToastShownRef.current) return;
    sheriffLiveGuidanceToastShownRef.current = true;
    showMysteryToast({
      tone: 'info',
      title: 'Sheriff Live',
      message: 'Prepare a Gemini Live session token, then start streaming from your microphone. Text-only transcripts are saved to the Investigation Log.',
    });
  }, [startResumeOpen, startResumeTab, showMysteryToast]);

  useEffect(() => {
    let stopped = false;

    const init = () => {
      if (stopped) return;

      const els = [
        { el: startResumeRef.current, apiRef: startResumeApiRef },
        { el: gameMgmtRef.current, apiRef: gameMgmtApiRef },
        { el: scenariosModalRef.current, apiRef: scenariosModalApiRef },
        { el: mysteriesModalRef.current, apiRef: mysteriesModalApiRef },
        { el: seedStoryModalRef.current, apiRef: seedStoryModalApiRef },
        { el: advancedModalRef.current, apiRef: advancedModalApiRef },
        { el: caseboardRef.current, apiRef: caseboardApiRef },
        { el: toolsRef.current, apiRef: toolsApiRef },
        { el: interrogationRef.current, apiRef: interrogationApiRef },
        { el: rapSheetRef.current, apiRef: rapSheetApiRef },
        { el: assetLibraryRef.current, apiRef: assetLibraryApiRef },
        { el: masterDeleteConfirmRef.current, apiRef: masterDeleteConfirmApiRef },
        { el: masterAssetDetailsRef.current, apiRef: masterAssetDetailsApiRef },
        { el: mysterySettingsRef.current, apiRef: mysterySettingsApiRef },
        { el: mysterySettingsEditorRef.current, apiRef: mysterySettingsEditorApiRef },
      ];

      for (const x of els) {
        if (!x.el) {
          modalInitTimerRef.current = window.setTimeout(init, 50);
          return;
        }
      }

      if (!isBootstrapModalReady()) {
        modalInitTimerRef.current = window.setTimeout(init, 50);
        return;
      }

      if (startResumeRef.current && !startResumeApiRef.current) {
        startResumeApiRef.current = createBootstrapModal(startResumeRef.current);
      }
      if (gameMgmtRef.current && !gameMgmtApiRef.current) {
        gameMgmtApiRef.current = createBootstrapModal(gameMgmtRef.current);
      }
      if (scenariosModalRef.current && !scenariosModalApiRef.current) {
        scenariosModalApiRef.current = createBootstrapModal(scenariosModalRef.current);
      }
      if (mysteriesModalRef.current && !mysteriesModalApiRef.current) {
        mysteriesModalApiRef.current = createBootstrapModal(mysteriesModalRef.current);
      }
      if (seedStoryModalRef.current && !seedStoryModalApiRef.current) {
        seedStoryModalApiRef.current = createBootstrapModal(seedStoryModalRef.current);
      }
      if (advancedModalRef.current && !advancedModalApiRef.current) {
        advancedModalApiRef.current = createBootstrapModal(advancedModalRef.current);
      }
      if (caseboardRef.current && !caseboardApiRef.current) {
        caseboardApiRef.current = createBootstrapModal(caseboardRef.current);
      }
      if (toolsRef.current && !toolsApiRef.current) {
        toolsApiRef.current = createBootstrapModal(toolsRef.current);
      }
      if (interrogationRef.current && !interrogationApiRef.current) {
        interrogationApiRef.current = createBootstrapModal(interrogationRef.current);
      }
      if (rapSheetRef.current && !rapSheetApiRef.current) {
        rapSheetApiRef.current = createBootstrapModal(rapSheetRef.current);
      }
      if (assetLibraryRef.current && !assetLibraryApiRef.current) {
        assetLibraryApiRef.current = createBootstrapModal(assetLibraryRef.current);
      }
      if (masterDeleteConfirmRef.current && !masterDeleteConfirmApiRef.current) {
        masterDeleteConfirmApiRef.current = createBootstrapModal(masterDeleteConfirmRef.current);
      }
      if (masterAssetDetailsRef.current && !masterAssetDetailsApiRef.current) {
        masterAssetDetailsApiRef.current = createBootstrapModal(masterAssetDetailsRef.current);
      }
      if (masterAssetJsonRef.current && !masterAssetJsonApiRef.current) {
        masterAssetJsonApiRef.current = createBootstrapModal(masterAssetJsonRef.current);
      }
      if (jsonPreviewRef.current && !jsonPreviewApiRef.current) {
        jsonPreviewApiRef.current = createBootstrapModal(jsonPreviewRef.current);
      }
      if (mysterySettingsRef.current && !mysterySettingsApiRef.current) {
        mysterySettingsApiRef.current = createBootstrapModal(mysterySettingsRef.current);
      }
      if (mysterySettingsEditorRef.current && !mysterySettingsEditorApiRef.current) {
        mysterySettingsEditorApiRef.current = createBootstrapModal(mysterySettingsEditorRef.current);
      }
    };

    init();

    return () => {
      stopped = true;

      try {
        if (modalInitTimerRef.current) window.clearTimeout(modalInitTimerRef.current);
      } catch (_err) {
      }
      modalInitTimerRef.current = 0;
    };
  }, []);

  useEffect(() => {
    const bind = (ref, onClose) => {
      const el = ref.current;
      if (!el) return () => {};
      const handler = () => onClose(false);
      el.addEventListener('hidden.bs.modal', handler);
      return () => el.removeEventListener('hidden.bs.modal', handler);
    };

    const un0 = bind(startResumeRef, setStartResumeOpen);
    const un1 = bind(gameMgmtRef, setGameMgmtOpen);
    const un1b = bind(scenariosModalRef, setScenariosModalOpen);
    const unMysteries = bind(mysteriesModalRef, setMysteriesModalOpen);
    const unAdvanced = bind(advancedModalRef, setAdvancedModalOpen);
    const un2 = bind(caseboardRef, setCaseboardOpen);
    const un3 = bind(toolsRef, setToolsOpen);
    const unInterrogation = bind(interrogationRef, setInterrogationOpen);
    const unRapSheet = bind(rapSheetRef, setRapSheetOpen);
    const un4 = bind(assetLibraryRef, setAssetLibraryOpen);
    const un4b = bind(masterAssetDetailsRef, setMasterAssetDetailsOpen);
    const un4c = bind(masterAssetJsonRef, setMasterAssetJsonOpen);
    const un4d = bind(jsonPreviewRef, setJsonPreviewOpen);
    const un5 = bind(mysterySettingsRef, setMysterySettingsOpen);
    const un6 = bind(mysterySettingsEditorRef, setMysterySettingsEditorOpen);

    const onAnyMysteryModalEvent = (e) => {
      const el = e?.target;
      if (!el) return;
      if (!el.classList || !el.classList.contains('catn8-stacked-modal')) return;
      window.setTimeout(syncStackedMysteryModalDimming, 0);
    };

    try {
      document.addEventListener('shown.bs.modal', onAnyMysteryModalEvent);
      document.addEventListener('hidden.bs.modal', onAnyMysteryModalEvent);
    } catch (_err) {
    }

    return () => {
      un0();
      un1();
      un1b();
      unMysteries();
      unAdvanced();
      un2();
      un3();
      unInterrogation();
      unRapSheet();
      un4();
      un4b();
      un5();
      un6();

      try {
        document.removeEventListener('shown.bs.modal', onAnyMysteryModalEvent);
        document.removeEventListener('hidden.bs.modal', onAnyMysteryModalEvent);
      } catch (_err) {
      }
    };
  }, [syncStackedMysteryModalDimming]);

  const [conversationEvents, setConversationEvents] = useState([]);
  const [conversationEventsBusy, setConversationEventsBusy] = useState(false);
  const [conversationEventsError, setConversationEventsError] = useState('');
  const investigationLogScrollRef = useRef(null);

  const loadConversationEvents = async ({ silent = false } = {}) => {
    const sid = Number(scenarioId);
    if (!sid) {
      setConversationEvents([]);
      setConversationEventsError('');
      return;
    }
    setConversationEventsBusy(true);
    setConversationEventsError('');
    try {
      const res = await ApiClient.get('/api/mystery/conversation_log.php?scenario_id=' + String(sid) + '&limit=200');
      setConversationEvents(Array.isArray(res?.events) ? res.events : []);
    } catch (e) {
      const msg = e?.message || 'Failed to load investigation log';
      setConversationEventsError(msg);
      if (!silent) setError(msg);
    } finally {
      setConversationEventsBusy(false);
    }
  };

  useEffect(() => {
    if (!isAuthed) return;
    if (!scenarioId) {
      setConversationEvents([]);
      setConversationEventsError('');
      return;
    }
    loadConversationEvents({ silent: true });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isAuthed, scenarioId]);

  const entityNameById = useMemo(() => {
    const map = new Map();
    for (const se of (Array.isArray(scenarioEntities) ? scenarioEntities : [])) {
      const id = Number(se?.entity_id || 0);
      if (!id) continue;
      map.set(id, String(se?.entity_name || '').trim());
    }
    return map;
  }, [scenarioEntities]);

  const scenarioConstraintsParsed = useMemo(() => {
    if (scenario && typeof scenario === 'object' && scenario.constraints && typeof scenario.constraints === 'object' && !Array.isArray(scenario.constraints)) {
      return scenario.constraints;
    }

    try {
      const parsed = JSON.parse(String(constraintsDraft || '{}'));
      if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) return parsed;
    } catch (_err) {
    }
    return {};
  }, [scenario, constraintsDraft]);

  const scenarioCrimeScene = useMemo(() => {
    const s: any = scenario && typeof scenario === 'object' ? scenario : null;
    const murdererIds = Array.isArray(s?.murderer_ids) ? s.murderer_ids : [];
    return {
      weapon: String(s?.crime_scene_weapon || '').trim(),
      motive: String(s?.crime_scene_motive || '').trim(),
      location: String(s?.crime_scene_location || '').trim(),
      murderer_ids: murdererIds.map((n: any) => Number(n)).filter((n: any) => Number.isFinite(n) && n > 0),
    };
  }, [scenario]);

  const agentIdByEntityId = useMemo(() => {
    const map = new Map();
    for (const c of (Array.isArray(characters) ? characters : [])) {
      const id = Number(c?.id || 0);
      if (!id) continue;
      const aid = Number(c?.data?.agent_id || 0);
      if (!aid) continue;
      map.set(id, aid);
    }
    return map;
  }, [characters]);

  const ensureTtsVoiceMaps = useCallback((s: any) => {
    if (!s || typeof s !== 'object') return s;
    if (!s.tts || typeof s.tts !== 'object') s.tts = {};
    const tts: any = s.tts;
    if (!tts.voice_maps || typeof tts.voice_maps !== 'object') tts.voice_maps = {};
    if (!tts.voice_maps.google || typeof tts.voice_maps.google !== 'object') tts.voice_maps.google = {};
    if (!tts.voice_maps.live || typeof tts.voice_maps.live !== 'object') tts.voice_maps.live = {};
    if (!tts.voice_maps.google.voice_map || typeof tts.voice_maps.google.voice_map !== 'object') tts.voice_maps.google.voice_map = {};
    if (!tts.voice_maps.google.voice_map_locks || typeof tts.voice_maps.google.voice_map_locks !== 'object') tts.voice_maps.google.voice_map_locks = {};
    if (!tts.voice_maps.live.voice_map || typeof tts.voice_maps.live.voice_map !== 'object') tts.voice_maps.live.voice_map = {};
    if (!tts.voice_maps.live.voice_map_locks || typeof tts.voice_maps.live.voice_map_locks !== 'object') tts.voice_maps.live.voice_map_locks = {};

    const active = String(tts.voice_map_active || '').trim().toLowerCase();
    if (active !== 'google' && active !== 'live') {
      tts.voice_map_active = 'google';
    }

    // Legacy migration: if we still have tts.voice_map but google voice_map is empty, copy it.
    // This is not silent: we surface a toast once so you know to Save.
    const legacy = (tts.voice_map && typeof tts.voice_map === 'object') ? tts.voice_map : null;
    const legacyLocks = (tts.voice_map_locks && typeof tts.voice_map_locks === 'object') ? tts.voice_map_locks : null;
    const googleVm = tts.voice_maps.google.voice_map;
    const googleLocks = tts.voice_maps.google.voice_map_locks;
    const legacyHas = legacy ? Object.keys(legacy).length : 0;
    const googleHas = googleVm ? Object.keys(googleVm).length : 0;
    if (legacy && legacyHas > 0 && googleHas === 0) {
      tts.voice_maps.google.voice_map = normalizeRecord(legacy);
      if (legacyLocks) tts.voice_maps.google.voice_map_locks = normalizeRecord(legacyLocks);
      if (!tts.voice_map_active) tts.voice_map_active = 'google';
      // leave legacy fields in place until you Save (explicit, not hidden)
    }

    return s;
  }, [normalizeRecord]);

  const legacyVoiceMapMigrationWarnedRef = useRef(false);
  const mysterySettingsObjRef = useRef<any>({});

  const getActiveVoiceMapProvider = useCallback(() => {
    const s = mysterySettingsObjRef.current;
    const raw = String(s?.tts?.voice_map_active || 'google').trim().toLowerCase();
    return (raw === 'live') ? 'live' : 'google';
  }, []);

  const setActiveVoiceMapProvider = (provider) => {
    const p = String(provider || '').trim().toLowerCase();
    applyMysterySettingsUpdate((s) => {
      ensureTtsVoiceMaps(s);
      s.tts.voice_map_active = (p === 'live') ? 'live' : 'google';
      return s;
    });
  };

  const getActiveVoiceMap = useCallback((settings) => {
    const s = (settings && typeof settings === 'object') ? settings : {};
    ensureTtsVoiceMaps(s);
    const tts = (s.tts && typeof s.tts === 'object') ? s.tts : {};
    const active = String(tts.voice_map_active || 'google').trim().toLowerCase();
    const slot = active === 'live' ? tts.voice_maps.live : tts.voice_maps.google;
    return {
      provider: active === 'live' ? 'live' : 'google',
      voice_map: (slot && typeof slot === 'object' && slot.voice_map && typeof slot.voice_map === 'object') ? slot.voice_map : {},
      voice_map_locks: (slot && typeof slot === 'object' && slot.voice_map_locks && typeof slot.voice_map_locks === 'object') ? slot.voice_map_locks : {},
    };
  }, [ensureTtsVoiceMaps]);

  const scenarioCast = useMemo(() => {
    const list = Array.isArray(scenarioEntities) ? scenarioEntities : [];
    const out = [];
    for (const se of list) {
      if (!se || typeof se !== 'object') continue;
      const role = String(se?.role || '').trim();
      if (role !== 'sheriff' && role !== 'suspect' && role !== 'killer' && role !== 'witness' && role !== 'bystander' && role !== 'victim') {
        continue;
      }

      const eid = Number(se?.entity_id || 0);
      if (!eid) continue;
      const aid = Number(agentIdByEntityId.get(eid) || 0);
      const name = String(se?.entity_name || '').trim() || (eid ? ('Character #' + String(eid)) : 'Character');

      let thumbUrl = '';
      if (aid >= 1 && aid <= 99) thumbUrl = '/images/mystery/agent' + String(aid) + '.png';
      else if (aid === 100) thumbUrl = '/images/mystery/sheriff.png';
      else thumbUrl = '/images/mystery/interrogation_room_empty.png';

      out.push({ entityId: eid, role, name, agentId: aid, thumbUrl });
    }

    out.sort((a, b) => {
      if (a.role === 'sheriff' && b.role !== 'sheriff') return -1;
      if (a.role !== 'sheriff' && b.role === 'sheriff') return 1;
      return a.name.localeCompare(b.name);
    });

    return out;
  }, [agentIdByEntityId, scenarioEntities]);

  const investigationLogEvents = useMemo(() => {
    const list = Array.isArray(conversationEvents) ? conversationEvents : [];
    return list.filter((ev) => {
      if (!ev || typeof ev !== 'object') return false;
      const ch = String(ev.channel || '');
      if (ch !== 'suspect_chat' && ch !== 'suspect_live' && ch !== 'sheriff_live') return false;
      if (String(ev.role || '') !== 'assistant') return false;
      return true;
    });
  }, [conversationEvents]);

  useEffect(() => {
    const el = investigationLogScrollRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
  }, [scenarioId, investigationLogEvents.length]);

  const [sheriffLiveModel, setSheriffLiveModel] = useState('');
  const [sheriffLiveTokenName, setSheriffLiveTokenName] = useState('');
  const [sheriffLiveEntityId, setSheriffLiveEntityId] = useState(0);
  const [sheriffLiveSystemInstruction, setSheriffLiveSystemInstruction] = useState('');
  const [sheriffLiveStatus, setSheriffLiveStatus] = useState('idle');
  const [sheriffLiveInputText, setSheriffLiveInputText] = useState('');
  const [sheriffLiveOutputText, setSheriffLiveOutputText] = useState('');
  const sheriffLiveClientRef = useRef(null);
  const sheriffLiveLastInputRef = useRef('');
  const sheriffLiveLastOutputRef = useRef('');

  const [interrogationEntityId, setInterrogationEntityId] = useState(0);
  const [interrogationEntityName, setInterrogationEntityName] = useState('');
  const [interrogationAgentId, setInterrogationAgentId] = useState(0);
  const [interrogationStatus, setInterrogationStatus] = useState('idle');
  const [interrogationInputText, setInterrogationInputText] = useState('');
  const [interrogationOutputText, setInterrogationOutputText] = useState('');
  const [interrogationTypedQuestion, setInterrogationTypedQuestion] = useState('');
  const [interrogationTypedAudioUrl, setInterrogationTypedAudioUrl] = useState('');
  const interrogationTypedAudioRef = useRef(null);
  const interrogationClientRef = useRef(null);
  const interrogationLastInputRef = useRef('');
  const interrogationLastOutputRef = useRef('');

  const [rapSheetBusy, setRapSheetBusy] = useState(false);
  const [rapSheetError, setRapSheetError] = useState('');
  const [rapSheet, setRapSheet] = useState(null);

  useEffect(() => {
    if (!rapSheetError) return;
    showMysteryToast({ tone: 'error', message: String(rapSheetError) });
    setRapSheetError('');
  }, [rapSheetError, showMysteryToast]);
  const loadRapSheet = useCallback(async (sid, eid, { silent = false } = {}) => {
    const scenario = Number(sid);
    const entity = Number(eid);
    if (!scenario || !entity) {
      setRapSheet(null);
      setRapSheetError('Select a scenario and suspect first.');
      return;
    }

    setRapSheetBusy(true);
    setRapSheetError('');
    try {
      const res = await ApiClient.get(
        '/api/mystery/rap_sheet.php?scenario_id=' + String(scenario) + '&entity_id=' + String(entity)
      );
      setRapSheet(res?.rap_sheet || null);
    } catch (e) {
      const msg = e?.message || 'Failed to load rap sheet';
      setRapSheetError(msg);
      if (!silent) setError(msg);
    } finally {
      setRapSheetBusy(false);
    }
  }, []);

  const interrogationImageUrl = useMemo(() => {
    const aid = Number(interrogationAgentId || 0);
    if (aid >= 1 && aid <= 99) return '/images/mystery/agent' + String(aid) + '_ir.png';
    if (aid === 100) {
      return '/images/mystery/sheriff.png';
    }
    return '/images/mystery/interrogation_room_empty.png';
  }, [interrogationAgentId]);

  const [interrogationIrUrls, setInterrogationIrUrls] = useState<string[]>([]);
  const [interrogationIrIndex, setInterrogationIrIndex] = useState(0);

  useEffect(() => {
    const aid = Number(interrogationAgentId || 0);
    if (!(aid >= 1 && aid <= 99)) {
      setInterrogationIrUrls([]);
      setInterrogationIrIndex(0);
      return;
    }
    let stopped = false;
    (async () => {
      try {
        const res = await ApiClient.get('/api/mystery/admin.php?action=list_agent_images&agent_id=' + String(aid));
        if (stopped) return;
        if (res && typeof res === 'object' && res.success === true) {
          const urls = Array.isArray((res as any).ir_urls) ? (res as any).ir_urls.map((x) => String(x || '')).filter(Boolean) : [];
          setInterrogationIrUrls(urls);
          setInterrogationIrIndex(0);
          return;
        }
      } catch (_e) {
      }
      if (stopped) return;
      setInterrogationIrUrls([]);
      setInterrogationIrIndex(0);
    })();
    return () => {
      stopped = true;
    };
  }, [interrogationAgentId]);

  useEffect(() => {
    const urls = Array.isArray(interrogationIrUrls) ? interrogationIrUrls : [];
    if (urls.length <= 1) return;
    const timer = window.setInterval(() => {
      setInterrogationIrIndex((prev) => {
        const next = (Number(prev || 0) + 1) % urls.length;
        return next;
      });
    }, 8000);
    return () => {
      try { window.clearInterval(timer); } catch (_e) {}
    };
  }, [interrogationIrUrls]);

  const interrogationImageUrlFinal = useMemo(() => {
    const urls = Array.isArray(interrogationIrUrls) ? interrogationIrUrls : [];
    if (urls.length > 0) {
      const idx = Math.max(0, Math.min(Number(interrogationIrIndex || 0), urls.length - 1));
      return urls[idx];
    }
    return interrogationImageUrl;
  }, [interrogationImageUrl, interrogationIrIndex, interrogationIrUrls]);

  const stopSheriffLiveStreaming = async () => {
    const client = sheriffLiveClientRef.current;
    sheriffLiveClientRef.current = null;
    if (client) {
      try {
        await client.disconnect();
      } catch (e) {
        showVoiceToast({ title: 'Sheriff Live', message: e?.message || 'Failed to stop Sheriff Live' });
      }
    }
    setSheriffLiveStatus('idle');
    setSheriffLiveInputText('');
    setSheriffLiveOutputText('');
  };

  const startSheriffLiveSession = async () => {
    if (getActiveVoiceMapProvider() !== 'live') {
      showVoiceToast({ title: 'Sheriff Live', message: 'Active voice provider is Google TTS. Switch Communications  Active voice map to Gemini Live to use Live streaming.' });
      return;
    }
    const sid = Number(scenarioId);
    if (!sid) {
      showMysteryToast({ tone: 'error', message: 'Select a scenario first.' });
      return;
    }
    setBusy(true);
    setMessage('');
    try {
      await stopSheriffLiveStreaming();

      await ApiClient.post('/api/mystery/admin.php?action=ensure_default_scenario_for_case', {
        case_id: Number(caseId) || 0,
        scenario_id: sid,
        min_suspects: 8,
      });

      const seRes = await ApiClient.get('/api/mystery/admin.php?action=list_scenario_entities&scenario_id=' + String(sid));
      const seList = Array.isArray(seRes?.scenario_entities) ? seRes.scenario_entities : [];
      setScenarioEntities(seList);

      const sheriffSe = seList.find((se) => String(se?.role || '').trim() === 'sheriff');
      const sheriffEntityId = Number(sheriffSe?.entity_id || 0);
      if (!sheriffEntityId) {
        throw new Error('Sheriff is not attached to this scenario');
      }

      const res = await ApiClient.get('/api/mystery/entity_live_bootstrap.php?scenario_id=' + String(sid) + '&entity_id=' + String(sheriffEntityId));
      const model = String(res?.model || '').trim();
      const tokenName = String(res?.token?.name || '').trim();
      const sys = String(res?.system_instruction || '');
      if (!tokenName) {
        throw new Error('Sheriff Live bootstrap succeeded but token name was missing');
      }
      setSheriffLiveModel(model);
      setSheriffLiveTokenName(tokenName);
      setSheriffLiveEntityId(sheriffEntityId);
      setSheriffLiveSystemInstruction(sys);
      sheriffLiveLastInputRef.current = '';
      sheriffLiveLastOutputRef.current = '';
      setSheriffLiveInputText('');
      setSheriffLiveOutputText('');

      await ApiClient.post('/api/mystery/conversation_log.php', {
        scenario_id: sid,
        entity_id: sheriffEntityId,
        channel: 'sheriff_live',
        provider: 'gemini_live',
        role: 'system',
        content_text: 'Sheriff Live session prepared.',
        meta: { model, token_name: tokenName },
      });
      setMessage('Sheriff Live session prepared.');
    } catch (e) {
      showVoiceToast({ title: 'Sheriff Live', message: e?.message || 'Failed to prepare Sheriff Live session' });
    } finally {
      setBusy(false);
    }
  };

  const startSheriffLiveStreaming = async () => {
    if (getActiveVoiceMapProvider() !== 'live') {
      showVoiceToast({ title: 'Sheriff Live', message: 'Active voice provider is Google TTS. Switch Communications  Active voice map to Gemini Live to use Live streaming.' });
      return;
    }
    const sid = Number(scenarioId);
    if (!sid) {
      showMysteryToast({ tone: 'error', message: 'Select a scenario first.' });
      return;
    }
    const tokenName = String(sheriffLiveTokenName || '').trim();
    if (!tokenName) {
      showMysteryToast({ tone: 'error', message: 'Prepare the session first.' });
      return;
    }

    setBusy(true);
    setError('');
    setMessage('');

    try {
      await stopSheriffLiveStreaming();
      setSheriffLiveStatus('connecting');

      const entityId = Number(sheriffLiveEntityId || 0);
      const client = new GeminiLiveClient({
        tokenName,
        model: sheriffLiveModel,
        systemInstruction: sheriffLiveSystemInstruction,
        onState: (s) => {
          const st = String((s as any)?.status || '').trim();
          if (st) setSheriffLiveStatus(st);
        },
        onTranscript: async (t) => {
          const kind = String((t as any)?.kind || '').trim();
          const text = String((t as any)?.text || '').trim();
          if (!text) return;

          if (kind === 'input') {
            if (text === sheriffLiveLastInputRef.current) return;
            sheriffLiveLastInputRef.current = text;
            setSheriffLiveInputText(text);
          } else if (kind === 'output') {
            if (text === sheriffLiveLastOutputRef.current) return;
            sheriffLiveLastOutputRef.current = text;
            setSheriffLiveOutputText(text);
          }

          try {
            await ApiClient.post('/api/mystery/conversation_log.php', {
              scenario_id: sid,
              entity_id: entityId > 0 ? entityId : 0,
              channel: 'sheriff_live',
              provider: 'gemini_live',
              role: kind === 'input' ? 'user' : 'assistant',
              content_text: text,
              meta: { transcript_kind: kind },
            });
          } catch (err) {
            setError((err as any)?.message || 'Failed to write transcript event');
          }
        },
        onError: (err) => {
          showVoiceToast({ title: 'Sheriff Live', message: (err as any)?.message || 'Sheriff Live streaming error' });
          setSheriffLiveStatus('idle');
        },
      });

      sheriffLiveClientRef.current = client;
      await client.connect();
      setMessage('Sheriff Live streaming started.');
    } catch (e) {
      showVoiceToast({ title: 'Sheriff Live', message: e?.message || 'Failed to start Sheriff Live streaming' });
      setSheriffLiveStatus('idle');
    } finally {
      setBusy(false);
    }
  };

  useEffect(() => {
    if (startResumeOpen) return;
    stopSheriffLiveStreaming();
  }, [startResumeOpen]);

  useEffect(() => {
    if (!interrogationTypedAudioUrl) return;
    const el = interrogationTypedAudioRef.current;
    if (!el) return;
    try {
      el.pause();
      el.currentTime = 0;
    } catch (_err) {
    }
    try {
      const p = el.play();
      if (p && typeof p.catch === 'function') p.catch(() => {});
    } catch (_err) {
    }
  }, [interrogationTypedAudioUrl]);

  const stopInterrogationStreaming = useCallback(async () => {
    const client = interrogationClientRef.current;
    interrogationClientRef.current = null;
    if (client) {
      try {
        await client.disconnect();
      } catch (e) {
        setError(e?.message || 'Failed to stop interrogation');
      }
    }
    setInterrogationStatus('idle');
  }, []);

  const ensureInterrogationLiveClient = useCallback(async ({ enableMic }) => {
    const sid = Number(scenarioId);
    const eid = Number(interrogationEntityId);
    if (!sid || !eid) {
      throw new Error('Select a scenario and suspect first.');
    }

    const existing = interrogationClientRef.current;
    if (existing) return existing;

    setInterrogationStatus('connecting');

    const res = await ApiClient.get(
      '/api/mystery/entity_live_bootstrap.php?scenario_id=' + String(sid) + '&entity_id=' + String(eid)
    );
    const model = String(res?.model || '').trim();
    const tokenName = String(res?.token?.name || '').trim();
    const sys = String(res?.system_instruction || '');
    if (!tokenName) {
      throw new Error('Interrogation bootstrap succeeded but token name was missing');
    }

    interrogationLastInputRef.current = '';
    interrogationLastOutputRef.current = '';
    setInterrogationInputText('');
    setInterrogationOutputText('');

    const client = new GeminiLiveClient({
      tokenName,
      model,
      systemInstruction: sys,
      enableMic: Boolean(enableMic),
      onState: (s) => {
        const st = String((s as any)?.status || '').trim();
        if (st) setInterrogationStatus(st);
      },
      onTranscript: async (t) => {
        const kind = String((t as any)?.kind || '').trim();
        const text = String((t as any)?.text || '').trim();
        if (!text) return;

        if (kind === 'input') {
          if (text === interrogationLastInputRef.current) return;
          interrogationLastInputRef.current = text;
          setInterrogationInputText(text);
        } else if (kind === 'output') {
          if (text === interrogationLastOutputRef.current) return;
          interrogationLastOutputRef.current = text;
          setInterrogationOutputText(text);
        }

        try {
          await ApiClient.post('/api/mystery/conversation_log.php', {
            scenario_id: sid,
            entity_id: eid,
            channel: 'suspect_live',
            provider: 'gemini_live',
            role: kind === 'input' ? 'user' : 'assistant',
            content_text: text,
            meta: { transcript_kind: kind },
          });
        } catch (err) {
          setError((err as any)?.message || 'Failed to write transcript event');
        }
      },
      onError: (err) => {
        showVoiceToast({ title: 'Voice talk', message: (err as any)?.message || 'Interrogation streaming error' });
        setInterrogationStatus('idle');
      },
    });

    interrogationClientRef.current = client;
    await client.connect();
    return client;
  }, [interrogationEntityId, scenarioId, showVoiceToast]);

  const startInterrogationStreaming = useCallback(async () => {
    if (getActiveVoiceMapProvider() !== 'live') {
      showVoiceToast({ title: 'Voice talk', message: 'Active voice provider is Google TTS. Switch Communications  Active voice map to Gemini Live to use Live streaming.' });
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');

    try {
      await stopInterrogationStreaming();
      await ensureInterrogationLiveClient({ enableMic: true });
      setMessage('Interrogation started.');
    } catch (e) {
      showVoiceToast({ title: 'Voice talk', message: e?.message || 'Failed to start interrogation' });
      setInterrogationStatus('idle');
    } finally {
      setBusy(false);
    }
  }, [ensureInterrogationLiveClient, getActiveVoiceMapProvider, showVoiceToast, stopInterrogationStreaming]);

  const askInterrogationTyped = useCallback(async (e) => {
    e.preventDefault();

    const sid = Number(scenarioId);
    const eid = Number(interrogationEntityId);
    const q = String(interrogationTypedQuestion || '').trim();

    if (!sid || !eid || !q) {
      setError('Select a scenario and suspect first, then type a question.');
      return;
    }

    setBusy(true);
    setError('');
    setMessage('');
    setInterrogationTypedAudioUrl('');

    try {
      if (getActiveVoiceMapProvider() === 'live') {
        try {
          const client = await ensureInterrogationLiveClient({ enableMic: false });

          setInterrogationInputText(q);
          setInterrogationTypedQuestion('');

          try {
            await ApiClient.post('/api/mystery/conversation_log.php', {
              scenario_id: sid,
              entity_id: eid,
              channel: 'suspect_live',
              provider: 'gemini_live',
              role: 'user',
              content_text: q,
              meta: { transcript_kind: 'typed' },
            });
          } catch (err) {
            setError(err?.message || 'Failed to write transcript event');
          }

          client.sendTextTurn(q);
          setMessage('Live question sent.');
          return;
        } catch (liveErr) {
          showVoiceToast({ title: 'Interrogation', message: (liveErr?.message || 'Gemini Live failed; falling back to text.').trim() });
        }
      }

      const wantTts = Boolean(interviewTtsEnabled);
      const res = await ApiClient.post('/api/mystery/interrogate.php', {
        scenario_id: sid,
        entity_id: eid,
        question_text: q,
        tts_enabled: wantTts ? 1 : 0,
      });

      const answer = String(res?.answer_text || '');
      const ttsErr = String(res?.meta?.tts_error || '').trim();
      const audioUrl = (wantTts && !ttsErr) ? String(res?.audio_url || '') : '';

      setInterrogationInputText(q);
      setInterrogationOutputText(answer);
      setInterrogationTypedAudioUrl(audioUrl);
      setInterrogationTypedQuestion('');

      await loadConversationEvents({ silent: true });
      setMessage(ttsErr ? 'Interrogation recorded (text only).' : 'Interrogation recorded.');
    } catch (err) {
      setError(err?.message || 'Failed to interrogate suspect');
    } finally {
      setBusy(false);
    }
  }, [ensureInterrogationLiveClient, getActiveVoiceMapProvider, interrogationEntityId, interrogationTypedQuestion, interviewTtsEnabled, loadConversationEvents, scenarioId, showVoiceToast]);

  useEffect(() => {
    if (interrogationOpen) return;
    stopInterrogationStreaming();
    setInterrogationTypedQuestion('');
    setInterrogationTypedAudioUrl('');
  }, [interrogationOpen, stopInterrogationStreaming]);

  useEffect(() => {
    if (!interrogationOpen) return undefined;

    const onKeyDown = (e) => {
      if (e?.key !== 'Enter') return;
      const tag = String(e?.target?.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
      e.preventDefault();
      if (interrogationStatus === 'idle' || interrogationStatus === 'closed') {
        startInterrogationStreaming();
      } else {
        stopInterrogationStreaming();
      }
    };

    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [interrogationOpen, interrogationStatus, startInterrogationStreaming, stopInterrogationStreaming]);

  const [mysterySettingsDraft, setMysterySettingsDraft] = useState('{}');
  const [mysterySettingsObj, setMysterySettingsObj] = useState<any>({});
  const [mysterySettingsUpdatedAt, setMysterySettingsUpdatedAt] = useState('');
  const mysterySettingsCleanDraftRef = useRef('');

  const defaultImageStyleMaster = 'A gritty, black and white photograph in a film noir style. The lighting is harsh and directional, creating deep shadows.';
  const defaultLocationImageStyle = 'Film noir street photography. Black and white. High contrast. Wet pavement reflections. Dramatic shadows. Wide angle establishing shot. If an address is provided, use the real-world exterior/interior cues of that address as reference (street layout, architecture, signage, materials). If you cannot retrieve or view a real photo of the address, do not claim you did; instead approximate based on typical architecture for that place.';
  const defaultMugshotImageStyle = 'Film noir mugshot. Black and white. Harsh flash lighting. Plain background. Slight grain. Police booking photo framing.';
  const defaultWeaponImageStyle = 'Film noir product photo. Black and white. High contrast. Macro details. Dramatic shadows. Minimal background.';

  const getImageStyleSettings = useCallback(() => {
    const s = (mysterySettingsObjRef.current && typeof mysterySettingsObjRef.current === 'object') ? mysterySettingsObjRef.current : {};
    const st = (s.image_styles && typeof s.image_styles === 'object' && !Array.isArray(s.image_styles)) ? s.image_styles : {};
    return {
      master: String(st.master || '').trim() || defaultImageStyleMaster,
      location: String(st.location || '').trim() || defaultLocationImageStyle,
      mugshot: String(st.mugshot || '').trim() || defaultMugshotImageStyle,
      weapon: String(st.weapon || '').trim() || defaultWeaponImageStyle,
    };
  }, []);

  const buildStyledImagePrompt = useCallback(({ promptText, kind }: { promptText: string, kind: 'location' | 'mugshot' | 'weapon' | 'generic' }) => {
    const p = String(promptText || '').trim();
    const st = getImageStyleSettings();
    const parts: string[] = [];
    if (String(st.master || '').trim()) parts.push(String(st.master).trim());
    if (kind === 'location' && String(st.location || '').trim()) parts.push(String(st.location).trim());
    if (kind === 'mugshot' && String(st.mugshot || '').trim()) parts.push(String(st.mugshot).trim());
    if (kind === 'weapon' && String(st.weapon || '').trim()) parts.push(String(st.weapon).trim());
    if (p) parts.push(p);
    return parts.join('\n\n').trim();
  }, [getImageStyleSettings]);

  const saveImageStyleSetting = useCallback(async ({ key, value }: { key: 'master' | 'location' | 'mugshot' | 'weapon', value: string }) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) return;
    const v = String(value || '');
    const base = (mysterySettingsObjRef.current && typeof mysterySettingsObjRef.current === 'object')
      ? safeJsonClone(mysterySettingsObjRef.current)
      : {};
    const curStyles = (base.image_styles && typeof base.image_styles === 'object' && !Array.isArray(base.image_styles)) ? base.image_styles : {};
    base.image_styles = { ...curStyles, [key]: v };

    setMysterySettingsObj(base);
    setMysterySettingsDraft(JSON.stringify(base, null, 2));

    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=update_mystery_settings', {
        mystery_id: mid,
        settings: base,
      });
      setMysterySettingsUpdatedAt(String(res?.updated_at || ''));
    } catch (e) {
      setError(e?.message || 'Failed to save image styles');
    }
  }, [isAdmin, mysteryId]);

  const [imageStyleMasterDraft, setImageStyleMasterDraft] = useState(defaultImageStyleMaster);
  const [locationImageStyleDraft, setLocationImageStyleDraft] = useState(defaultLocationImageStyle);
  const [mugshotImageStyleDraft, setMugshotImageStyleDraft] = useState(defaultMugshotImageStyle);
  const [weaponImageStyleDraft, setWeaponImageStyleDraft] = useState(defaultWeaponImageStyle);

  useEffect(() => {
    if (!startResumeOpen) return;
    if (startResumeTab !== 'tools') return;
    const st = getImageStyleSettings();
    setImageStyleMasterDraft(String(st.master || ''));
    setLocationImageStyleDraft(String(st.location || ''));
    setMugshotImageStyleDraft(String(st.mugshot || ''));
    setWeaponImageStyleDraft(String(st.weapon || ''));
  }, [getImageStyleSettings, startResumeOpen, startResumeTab]);

  useEffect(() => {
    mysterySettingsObjRef.current = mysterySettingsObj;
  }, [mysterySettingsObj]);

  const [masterCharacterAccentBySlug, setMasterCharacterAccentBySlug] = useState({});
  const [masterCharacterAccentLoadedAt, setMasterCharacterAccentLoadedAt] = useState('');
  const [accentDraftByVoiceId, setAccentDraftByVoiceId] = useState({});

  const mysterySettingsLastWriteRef = useRef({ by: '', at: 0, voiceNames: 0 });
  const lastVoiceNameCountRef = useRef(0);
  const voiceMapHadNonZeroThisOpenRef = useRef(false);

  function normalizeRecord(v) {
    if (!v || typeof v !== 'object') return {};
    const out = {};
    if (v instanceof Map) {
      for (const [k, vv] of v.entries()) {
        out[String(k)] = vv;
      }
      return out;
    }
    for (const k of Object.keys(v)) {
      out[k] = v[k];
    }
    return out;
  }

  const safeJsonClone = (v) => {
    if (v === null || typeof v === 'undefined') return null;
    if (typeof v !== 'object') return v;
    if (Array.isArray(v)) {
      const keys = Object.keys(v);
      const isIndexKey = (k) => /^(0|[1-9]\d*)$/.test(String(k));
      const hasNonIndexKey = keys.some((k) => k !== 'toJSON' && !isIndexKey(k));
      if (hasNonIndexKey) {
        const out = {};
        for (const k of keys) {
          if (k === 'toJSON') continue;
          out[k] = safeJsonClone(v[k]);
        }
        return out;
      }
      return v.map((x) => safeJsonClone(x));
    }
    if (v instanceof Map) {
      const out = {};
      for (const [k, vv] of v.entries()) {
        out[String(k)] = safeJsonClone(vv);
      }
      return out;
    }
    const out = {};
    for (const k of Object.keys(v)) {
      if (k === 'toJSON') continue;
      out[k] = safeJsonClone(v[k]);
    }
    return out;
  };

  const buildMysterySettingsClientDebug = (settings) => {
    const s = (settings && typeof settings === 'object') ? settings : {};
    const tts = (s.tts && typeof s.tts === 'object') ? s.tts : null;
    const vm = (tts && typeof tts === 'object') ? tts.voice_map : null;
    const vmKeys = (vm && typeof vm === 'object') ? Object.keys(vm) : [];
    const vmCtor = (vm && typeof vm === 'object' && vm && vm.constructor && vm.constructor.name) ? String(vm.constructor.name) : '';
    let vmJson = '';
    try {
      vmJson = JSON.stringify(vm);
    } catch (_e) {
      vmJson = '';
    }
    return {
      tts_type: tts === null ? 'null' : Array.isArray(tts) ? 'array' : typeof tts,
      voice_map_type: vm === null ? 'null' : Array.isArray(vm) ? 'array' : typeof vm,
      voice_map_ctor: vmCtor,
      voice_map_keys_count: vmKeys.length,
      voice_map_keys_sample: vmKeys.slice(0, 10),
      voice_map_json_len: typeof vmJson === 'string' ? vmJson.length : 0,
      voice_map_json_prefix: typeof vmJson === 'string' ? vmJson.slice(0, 60) : '',
    };
  };

  const countVoiceMapVoiceNames = (settings) => {
    const tts = (settings?.tts && typeof settings.tts === 'object') ? settings.tts : {};
    const legacy = (tts.voice_map && typeof tts.voice_map === 'object') ? tts.voice_map : {};
    const maps = (tts.voice_maps && typeof tts.voice_maps === 'object') ? tts.voice_maps : {};
    const google = (maps.google && typeof maps.google === 'object' && maps.google.voice_map && typeof maps.google.voice_map === 'object') ? maps.google.voice_map : {};
    const live = (maps.live && typeof maps.live === 'object' && maps.live.voice_map && typeof maps.live.voice_map === 'object') ? maps.live.voice_map : {};

    const all = [legacy, google, live];
    let count = 0;
    for (const vm of all) {
      for (const k of Object.keys(vm)) {
        const entry = vm[k];
        const vn = (entry && typeof entry === 'object') ? String(entry.voice_name || '').trim() : '';
        if (vn) count += 1;
      }
    }
    return count;
  };

  const [mysterySettingsTab, setMysterySettingsTab] = useState('voice');
  const [mysterySettingsEditorTarget, setMysterySettingsEditorTarget] = useState('tts');
  const [mysterySettingsEditorText, setMysterySettingsEditorText] = useState('{}');
  const [mysterySettingsEditorError, setMysterySettingsEditorError] = useState('');
  const mysterySettingsEditorCleanTextRef = useRef('');
  const [newVoiceMapId, setNewVoiceMapId] = useState('');

  useEffect(() => {
    if (!mysterySettingsEditorError) return;
    showMysteryToast({ tone: 'error', message: String(mysterySettingsEditorError) });
    setMysterySettingsEditorError('');
  }, [mysterySettingsEditorError, showMysteryToast]);

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    mysterySettingsCleanDraftRef.current = String(mysterySettingsDraft || '');
  }, [mysterySettingsOpen]);

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    lastVoiceNameCountRef.current = countVoiceMapVoiceNames(mysterySettingsObj);
    voiceMapHadNonZeroThisOpenRef.current = lastVoiceNameCountRef.current > 0;
  }, [mysterySettingsOpen]);

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    const active = getActiveVoiceMap(mysterySettingsObj);
    const vm = (active.voice_map && typeof active.voice_map === 'object') ? active.voice_map : {};
    let count = 0;
    for (const k of Object.keys(vm)) {
      const entry = vm[k];
      const vn = (entry && typeof entry === 'object') ? String(entry.voice_name || '').trim() : '';
      if (vn) count += 1;
    }

    const prev = Number(lastVoiceNameCountRef.current || 0);
    lastVoiceNameCountRef.current = count;

    if (count > 0) {
      voiceMapHadNonZeroThisOpenRef.current = true;
    }

    if (prev > 0 && count === 0 && voiceMapHadNonZeroThisOpenRef.current) {
      const meta = mysterySettingsLastWriteRef.current || { by: '', at: 0, voiceNames: 0 };
      showMysteryToast({
        tone: 'error',
        message: 'Voice map voice_name values were cleared (' + String(prev) + ' -> 0). Last settings update: ' + String(meta.by || 'unknown'),
      });

      setMasterCharacterMugshotUrl('');
      setMasterCharacterIrUrls([]);
      setMasterCharacterIrIndex(0);
    }
  }, [mysterySettingsObj, mysterySettingsOpen, showMysteryToast]);

  const [agentProfiles, setAgentProfiles] = useState<any[]>([]);
  const [agentProfilesError, setAgentProfilesError] = useState('');
  const [agentProfilesLoadedAt, setAgentProfilesLoadedAt] = useState('');

  const [ttsVoices, setTtsVoices] = useState<any[]>([]);
  const [ttsVoicesError, setTtsVoicesError] = useState('');
  const [ttsVoicesLoadedAt, setTtsVoicesLoadedAt] = useState('');

  useEffect(() => {
    if (!ttsVoicesError) return;
    showVoiceToast({ title: 'Voice disabled', message: String(ttsVoicesError) });
    setTtsVoicesError('');
  }, [showVoiceToast, ttsVoicesError]);

  const [ttsVoiceTierFilter, setTtsVoiceTierFilter] = useState('all');
  const [ttsVoiceGenderFilter, setTtsVoiceGenderFilter] = useState('all');

  const ttsVoiceTierOptions = useMemo(() => {
    const order = ['Journey', 'Studio', 'Neural2', 'Wavenet', 'Standard', 'Other'];
    const seen = new Set<string>();
    for (const v of (Array.isArray(ttsVoices) ? ttsVoices : [])) {
      const t = String(v?.tier || '').trim();
      if (t) seen.add(t);
    }
    const tiers = Array.from(seen);
    tiers.sort((a, b) => {
      const ia = order.indexOf(a);
      const ib = order.indexOf(b);
      if (ia === -1 && ib === -1) return a.localeCompare(b);
      if (ia === -1) return 1;
      if (ib === -1) return -1;
      return ia - ib;
    });
    return tiers;
  }, [ttsVoices]);

  const ttsVoiceGenderOptions = useMemo(() => {
    const order = ['FEMALE', 'MALE', 'NEUTRAL'];
    const seen = new Set<string>();
    for (const v of (Array.isArray(ttsVoices) ? ttsVoices : [])) {
      const g = String(v?.ssml_gender || '').trim().toUpperCase();
      if (!g || g === 'SSML_VOICE_GENDER_UNSPECIFIED') continue;
      seen.add(g);
    }
    const genders = Array.from(seen);
    genders.sort((a, b) => {
      const ia = order.indexOf(a);
      const ib = order.indexOf(b);
      if (ia === -1 && ib === -1) return a.localeCompare(b);
      if (ia === -1) return 1;
      if (ib === -1) return -1;
      return ia - ib;
    });
    return genders;
  }, [ttsVoices]);

  const filteredTtsVoices = useMemo(() => {
    const list = Array.isArray(ttsVoices) ? ttsVoices : [];
    const tier = String(ttsVoiceTierFilter || 'all').trim();
    const gender = String(ttsVoiceGenderFilter || 'all').trim();
    return list.filter((v) => {
      if (!v || typeof v !== 'object') return false;
      if (tier !== 'all' && String(v.tier || '').trim() !== tier) return false;
      if (gender !== 'all') {
        const g = String(v.ssml_gender || '').trim().toUpperCase();
        if (g !== gender) return false;
      }
      return true;
    });
  }, [ttsVoices, ttsVoiceTierFilter, ttsVoiceGenderFilter]);

  const ttsVoiceByName = useMemo(() => {
    const m = new Map();
    for (const v of (Array.isArray(ttsVoices) ? ttsVoices : [])) {
      const name = String(v?.name || '').trim();
      if (!name) continue;
      m.set(name, v);
    }
    return m;
  }, [ttsVoices]);

  const describeVoiceTier = (voiceName) => {
    const name = String(voiceName || '').trim();
    if (!name) return '';
    const v = ttsVoiceByName.get(name);
    if (!v) return '';
    const tier = String(v?.tier || '').trim();
    const gender = String(v?.ssml_gender || '').trim();
    const langs = Array.isArray(v?.language_codes) ? v.language_codes.join(', ') : '';
    const parts = [tier, gender, langs].map((x) => String(x || '').trim()).filter(Boolean);
    return parts.join('  ');
  };

  const voiceIdToEntityIds = useMemo(() => {
    const m = new Map();
    for (const c of (Array.isArray(characters) ? characters : [])) {
      const eid = Number(c?.id || 0);
      if (!eid) continue;
      const vid = String(c?.data?.voice_id || '').trim();
      if (!vid) continue;
      if (!m.has(vid)) m.set(vid, []);
      m.get(vid).push(eid);
    }
    return m;
  }, [characters]);

  const voiceIdToSlugs = useMemo(() => {
    const m = new Map<string, string[]>();
    for (const c of (Array.isArray(characters) ? characters : [])) {
      const vid = String(c?.data?.voice_id || '').trim();
      if (!vid) continue;
      const masterSlug = String(c?.data?.master_slug || '').trim();
      const slug = masterSlug || String(c?.slug || '').trim();
      if (!slug) continue;
      if (!m.has(vid)) m.set(vid, []);
      m.get(vid).push(slug);
    }
    for (const [k, v] of m.entries()) {
      const uniq = Array.from(new Set(v.map((x) => String(x || '').trim()).filter(Boolean))) as string[];
      uniq.sort((a, b) => a.localeCompare(b));
      m.set(k, uniq);
    }
    return m;
  }, [characters]);

  const voiceIdToAccentPreference = useMemo(() => {
    const m = new Map<string, string>();
    const active = getActiveVoiceMap(mysterySettingsObj);
    const vm = (active.voice_map && typeof active.voice_map === 'object') ? active.voice_map : {};
    const ids = new Set<string>();
    for (const k of Object.keys(vm)) ids.add(k);
    for (const k of voiceIdToSlugs.keys()) ids.add(k);

    for (const vid of Array.from(ids)) {
      const slugs = voiceIdToSlugs.get(vid) || [];
      for (const slug of slugs) {
        const ap = String(masterCharacterAccentBySlug[String(slug)] || '').trim();
        if (!ap) continue;
        m.set(vid, ap);
        break;
      }
    }
    return m;
  }, [masterCharacterAccentBySlug, voiceIdToSlugs, mysterySettingsObj]);

  const setAccentPreferenceForVoiceId = async (voiceId, accentPreference) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first to save accent preferences.');
      return;
    }
    const vid = String(voiceId || '').trim();
    if (!vid) return;
    const ap = String(accentPreference || '').trim();

    const slugs = voiceIdToSlugs.get(vid) || [];
    if (!slugs.length) {
      setError('No master character slug found for voice_id: ' + vid);
      return;
    }

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=bulk_update_master_character_accent_preference', {
        mystery_id: mid,
        slugs,
        accent_preference: ap,
      });
      setMasterCharacterAccentBySlug((prev) => {
        const base = (prev && typeof prev === 'object') ? prev : {};
        const next = { ...base };
        for (const s of slugs) next[String(s)] = ap;
        return next;
      });
      setMessage('Accent preference saved for ' + String(slugs.length) + ' master character(s).');
    } catch (e) {
      setError(e?.message || 'Failed to save accent preference');
    } finally {
      setBusy(false);
    }
  };

  const loadMasterCharacterAccents = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) return;
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_master_characters&mystery_id=' + String(mid) + '&include_archived=1');
      const rows = Array.isArray(res?.characters) ? res.characters : [];
      const next = {};
      for (const r of rows) {
        const slug = String(r?.slug || '').trim();
        if (!slug) continue;
        next[slug] = String(r?.accent_preference || '').trim();
      }
      setMasterCharacterAccentBySlug(next);
      setMasterCharacterAccentLoadedAt(new Date().toISOString());
    } catch (_e) {
      // ignore
    }
  }, [isAdmin, mysteryId]);

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    if (!isAuthed || !isAdmin) return;
    loadMasterCharacterAccents();
  }, [mysterySettingsOpen, isAuthed, isAdmin, loadMasterCharacterAccents]);

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    setAccentDraftByVoiceId((prev) => {
      const base = (prev && typeof prev === 'object') ? prev : {};
      const next = { ...base };
      const active = getActiveVoiceMap(mysterySettingsObj);
      const vm = (active.voice_map && typeof active.voice_map === 'object') ? active.voice_map : {};
      const ids = new Set<string>();
      for (const k of Object.keys(vm)) ids.add(k);
      for (const k of voiceIdToSlugs.keys()) ids.add(k);

      for (const vidRaw of Array.from(ids)) {
        const vid = String(vidRaw || '').trim();
        if (!vid) continue;
        if (Object.prototype.hasOwnProperty.call(next, vid)) continue;
        const ap = String(voiceIdToAccentPreference.get(vid) || '').trim();
        if (ap) (next as any)[vid] = ap;
      }
      return next;
    });
  }, [mysterySettingsOpen, voiceIdToAccentPreference, mysterySettingsObj, voiceIdToSlugs, masterCharacterAccentLoadedAt]);

  const voiceIdSuggestions = useMemo(() => {
    const ids = new Set<string>();
    for (const c of (Array.isArray(characters) ? characters : [])) {
      const vid = String(c?.data?.voice_id || '').trim();
      if (vid) ids.add(vid);
    }
    return Array.from(ids).sort();
  }, [characters]);

  const voiceMapRowIds = useMemo(() => {
    const ids = new Set<string>();
    const active = getActiveVoiceMap(mysterySettingsObj);
    const vm = (active.voice_map && typeof active.voice_map === 'object') ? active.voice_map : {};
    for (const k of Object.keys(vm)) ids.add(k);
    for (const k of (Array.isArray(voiceIdSuggestions) ? voiceIdSuggestions : [])) ids.add(k);
    return Array.from(ids).sort();
  }, [getActiveVoiceMap, mysterySettingsObj, voiceIdSuggestions]);

  const voiceIdToCharacters = useMemo(() => {
    const m = new Map<string, string[]>();
    for (const c of (Array.isArray(characters) ? characters : [])) {
      const vid = String(c?.data?.voice_id || '').trim();
      if (!vid) continue;
      const name = String(c?.name || '').trim();
      const slug = String(c?.slug || '').trim();
      const label = name || slug || String(c?.id || '').trim();
      if (!label) continue;
      if (!m.has(vid)) m.set(vid, []);
      m.get(vid).push(label);
    }
    for (const [k, v] of m.entries()) {
      v.sort((a, b) => a.localeCompare(b));
    }
    return m;
  }, [characters]);

  const toggleVoiceMapLock = (voiceId) => {
    const vid = String(voiceId || '').trim();
    if (!vid) return;
    applyMysterySettingsUpdate((s) => {
      ensureTtsVoiceMaps(s);
      const tts = s.tts;
      const active = String(tts.voice_map_active || 'google').trim().toLowerCase();
      const slot = active === 'live' ? tts.voice_maps.live : tts.voice_maps.google;
      const locks = slot.voice_map_locks;
      const cur = Number(locks[vid] || 0) ? 1 : 0;
      if (cur) delete locks[vid];
      else locks[vid] = 1;
      return s;
    });
  };

  const ensureAiModelSync = (s) => {
    if (!s.ai_model_sync || typeof s.ai_model_sync !== 'object') s.ai_model_sync = {};
    const sync = s.ai_model_sync;
    if (!sync.voice_ids || typeof sync.voice_ids !== 'object') sync.voice_ids = {};
    if (!sync.foundations || typeof sync.foundations !== 'object') sync.foundations = {};
    if (!sync.locks || typeof sync.locks !== 'object') sync.locks = {};
    if (!sync.foundation_locks || typeof sync.foundation_locks !== 'object') sync.foundation_locks = {};
    return sync;
  };

  const toggleAiSyncVoiceIdLock = (voiceId) => {
    const vid = String(voiceId || '').trim();
    if (!vid) return;
    applyMysterySettingsUpdate((s) => {
      const sync = ensureAiModelSync(s);
      const cur = Number(sync.locks[vid] || 0) ? 1 : 0;
      if (cur) delete sync.locks[vid];
      else sync.locks[vid] = 1;
      return s;
    });
  };

  const toggleAiSyncFoundationLock = (foundationId) => {
    const fid = String(foundationId || '').trim();
    if (!fid) return;
    applyMysterySettingsUpdate((s) => {
      const sync = ensureAiModelSync(s);
      const cur = Number(sync.foundation_locks[fid] || 0) ? 1 : 0;
      if (cur) delete sync.foundation_locks[fid];
      else sync.foundation_locks[fid] = 1;
      return s;
    });
  };

  const setAiSyncVoiceIdFoundation = (voiceId, foundationId) => {
    const vid = String(voiceId || '').trim();
    const fid = Number(foundationId || 0);
    if (!vid) return;
    applyMysterySettingsUpdate((s) => {
      const sync = ensureAiModelSync(s);
      if (Number(sync.locks[vid] || 0)) return s;
      if (!sync.voice_ids[vid] || typeof sync.voice_ids[vid] !== 'object') sync.voice_ids[vid] = {};
      if (fid > 0) sync.voice_ids[vid].foundation_id = fid;
      else delete sync.voice_ids[vid].foundation_id;
      return s;
    });
  };

  const updateAiSyncFoundationGoogleField = (foundationId, field, value) => {
    const fid = String(foundationId || '').trim();
    const k = String(field || '').trim();
    if (!fid || !k) return;
    applyMysterySettingsUpdate((s) => {
      const sync = ensureAiModelSync(s);
      if (Number(sync.foundation_locks[fid] || 0)) return s;
      if (!sync.foundations[fid] || typeof sync.foundations[fid] !== 'object') sync.foundations[fid] = {};
      if (!sync.foundations[fid].google_cloud_tts || typeof sync.foundations[fid].google_cloud_tts !== 'object') sync.foundations[fid].google_cloud_tts = {};
      sync.foundations[fid].google_cloud_tts[k] = value;
      return s;
    });
  };

  const pickDefaultGoogleVoiceName = ({ desiredGender, voices, langPref }) => {
    const list = Array.isArray(voices) ? voices : (Array.isArray(ttsVoices) ? ttsVoices : []);
    const order = ['Journey', 'Studio', 'Neural2', 'Wavenet', 'Standard', 'Other'];
    const desiredLang = String(langPref || '').trim() || 'en-US';
    const gender = String(desiredGender || '').trim().toUpperCase();
    const scored = [];
    for (const v of list) {
      const name = String(v?.name || '').trim();
      if (!name) continue;
      const tier = String(v?.tier || 'Other').trim();
      const g = String(v?.ssml_gender || '').trim().toUpperCase();
      const langs = Array.isArray(v?.language_codes) ? v.language_codes : [];
      const langOk = langs.includes(desiredLang) || name.startsWith(desiredLang + '-');
      const base = desiredLang.split('-')[0];
      const baseOk = base ? (langs.includes(base) || name.startsWith(base + '-')) : false;
      if (!langOk && !baseOk) continue;
      if (gender && gender !== 'ALL' && g && g !== 'SSML_VOICE_GENDER_UNSPECIFIED' && g !== gender) continue;
      const tierScore = order.indexOf(tier) === -1 ? 999 : order.indexOf(tier);
      scored.push({ name, tierScore });
    }
    scored.sort((a, b) => (a.tierScore - b.tierScore) || a.name.localeCompare(b.name));
    return scored.length ? scored[0].name : '';
  };

  const stableHashInt = (raw) => {
    const s = String(raw || '');
    let h = 2166136261;
    for (let i = 0; i < s.length; i += 1) {
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  };

  const getCandidateGoogleVoiceNames = ({ desiredGender, voices, langPref }) => {
    const list = Array.isArray(voices) ? voices : (Array.isArray(ttsVoices) ? ttsVoices : []);
    const order = ['Journey', 'Studio', 'Neural2', 'Wavenet', 'Standard', 'Other'];
    const desiredLangRaw = String(langPref || '').trim() || 'en-US';
    const desiredLang = desiredLangRaw.toLowerCase();
    const base = desiredLang.split('-')[0];
    const gender = String(desiredGender || '').trim().toUpperCase();

    const compute = ({ allowGender, allowLang }) => {
      const scored = [];
      for (const v of list) {
        const nameRaw = String(v?.name || '').trim();
        if (!nameRaw) continue;
        const name = nameRaw.toLowerCase();
        const tier = String(v?.tier || 'Other').trim();
        const g = String(v?.ssml_gender || '').trim().toUpperCase();
        const langsRaw = Array.isArray(v?.language_codes) ? v.language_codes : [];
        const langs = langsRaw.map((x) => String(x || '').trim().toLowerCase()).filter(Boolean);

        if (allowLang) {
          const langOk = langs.includes(desiredLang) || name.startsWith(desiredLang + '-');
          const baseOk = base ? (langs.includes(base) || name.startsWith(base + '-')) : false;
          if (!langOk && !baseOk) continue;
        }

        if (allowGender) {
          if (gender && gender !== 'ALL' && g && g !== 'SSML_VOICE_GENDER_UNSPECIFIED' && g !== gender) continue;
        }

        const tierScore = order.indexOf(tier) === -1 ? 999 : order.indexOf(tier);
        scored.push({ name: nameRaw, tierScore });
      }
      scored.sort((a, b) => (a.tierScore - b.tierScore) || a.name.localeCompare(b.name));
      return scored.map((x) => x.name);
    };

    let out = compute({ allowGender: true, allowLang: true });
    if (out.length <= 1) out = compute({ allowGender: false, allowLang: true });
    if (out.length <= 1) out = compute({ allowGender: false, allowLang: false });
    return out;
  };

  const autoAssignVoiceMapBestMatchAndSave = async () => {
    if (!isAdmin) return;

    // Cancel/ignore any in-flight settings load that could overwrite our local edits.
    mysterySettingsLoadSeqRef.current += 1;

    setBusy(true);
    setError('');
    setMessage('');

    try {
      const cid = Number(caseId);

      const roleByEntityId = new Map();
      for (const se of (Array.isArray(scenarioEntities) ? scenarioEntities : [])) {
        const eid = Number(se?.entity_id || 0);
        if (!eid) continue;
        const role = String(se?.role || '').trim();
        if (role) roleByEntityId.set(eid, role);
      }

      const missingVoiceIdUpdates = [];
      for (const c of (Array.isArray(characters) ? characters : [])) {
        const id = Number(c?.id || 0);
        if (!id) continue;
        const slug = String(c?.slug || '').trim();
        if (!slug) continue;
        const data = (c?.data && typeof c.data === 'object') ? c.data : {};
        const curVoiceId = String(data?.voice_id || '').trim();
        if (curVoiceId) continue;

        const role = String(roleByEntityId.get(id) || '').trim();
        const aid = Number(data?.agent_id || 0);

        let prefix = 'suspect';
        if (role === 'sheriff') prefix = 'sheriff';
        else if (role === 'suspect' || role === 'killer' || role === 'witness' || role === 'bystander' || role === 'victim') prefix = role;
        else if (aid === 100) prefix = 'sheriff';

        const voiceId = prefix + '_' + slug;
        const nextData = safeJsonClone(data);
        nextData.voice_id = voiceId;
        missingVoiceIdUpdates.push({ id, data: nextData, voice_id: voiceId });
      }

      if (cid && missingVoiceIdUpdates.length) {
        for (const u of missingVoiceIdUpdates) {
          await ApiClient.post('/api/mystery/admin.php?action=update_entity', { id: u.id, data: u.data });
        }
        await loadCharacters(cid);
      }

      let voicesForPick = Array.isArray(ttsVoices) ? ttsVoices : [];
      if (!voicesForPick.length) {
        const lang = encodeURIComponent(String(mysterySettingsObj?.tts?.language_code || 'en-US').trim() || 'en-US');
        const res = await ApiClient.get(`/api/mystery/admin.php?action=list_tts_voices&lang=${lang}`);
        voicesForPick = Array.isArray(res?.voices) ? res.voices : [];
        setTtsVoices(voicesForPick);
        setTtsVoicesLoadedAt(new Date().toISOString());
      }

      const base = (mysterySettingsObj && typeof mysterySettingsObj === 'object')
        ? safeJsonClone(mysterySettingsObj)
        : {};
      if (Array.isArray(base)) {
        throw new Error('Internal error: Mystery settings is an array; refusing to auto-assign voices.');
      }
      if (!base.tts || typeof base.tts !== 'object') base.tts = {};
      ensureTtsVoiceMaps(base);

      const activeProvider = String(base.tts.voice_map_active || 'google').trim().toLowerCase();
      if (activeProvider !== 'google') {
        throw new Error('Auto-assign is only supported for Google Cloud TTS voice maps right now. Switch Active Voice Map to Google.');
      }

      const activeSlot = base.tts.voice_maps.google;
      activeSlot.voice_map = normalizeRecord(activeSlot.voice_map);
      activeSlot.voice_map_locks = normalizeRecord(activeSlot.voice_map_locks);

      const sync = (base.ai_model_sync && typeof base.ai_model_sync === 'object') ? base.ai_model_sync : {};
      const syncVoiceIds = (sync.voice_ids && typeof sync.voice_ids === 'object') ? sync.voice_ids : {};
      const syncFoundations = (sync.foundations && typeof sync.foundations === 'object') ? sync.foundations : {};

      const idsToConsider = new Set();
      for (const vid of Object.keys(activeSlot.voice_map)) idsToConsider.add(vid);
      for (const vid of (Array.isArray(voiceIdSuggestions) ? voiceIdSuggestions : [])) idsToConsider.add(String(vid));
      for (const u of missingVoiceIdUpdates) idsToConsider.add(String(u?.voice_id || ''));
      const ids = Array.from(idsToConsider).map((x) => String(x || '').trim()).filter(Boolean).sort();

      const used = new Set();
      let changedCount = 0;

      for (const vid of ids) {
        if (Number(activeSlot.voice_map_locks[vid] || 0)) continue;
        if (!activeSlot.voice_map[vid] || typeof activeSlot.voice_map[vid] !== 'object') activeSlot.voice_map[vid] = {};
        const vm = activeSlot.voice_map[vid];

        const curVoiceName = String(vm.voice_name || '').trim();
        if (curVoiceName) continue;

        const mapping = (syncVoiceIds[vid] && typeof syncVoiceIds[vid] === 'object') ? syncVoiceIds[vid] : {};
        const foundationId = Number(mapping.foundation_id || 0);
        const fKey = foundationId ? String(foundationId) : '';
        const foundation = (fKey && syncFoundations[fKey] && typeof syncFoundations[fKey] === 'object') ? syncFoundations[fKey] : {};
        const foundationVoiceKey = String(foundation.foundation_voice_id || '').trim().toLowerCase();

        let desiredGender = '';
        if (foundationVoiceKey.startsWith('female_')) desiredGender = 'FEMALE';
        else if (foundationVoiceKey.startsWith('male_')) desiredGender = 'MALE';

        const foundationG = (foundation.google_cloud_tts && typeof foundation.google_cloud_tts === 'object') ? foundation.google_cloud_tts : {};
        const foundationPreferred = String(foundationG.voice_name || '').trim();

        const accentPref = String(voiceIdToAccentPreference.get(vid) || '').trim();
        const desiredLang = accentPref || String(foundationG.language_code || '').trim() || String(base.tts.language_code || '').trim() || 'en-US';

        let picked = '';
        const candidates = getCandidateGoogleVoiceNames({ desiredGender, voices: voicesForPick, langPref: desiredLang });

        if (foundationPreferred && candidates.includes(foundationPreferred) && !used.has(foundationPreferred)) {
          picked = foundationPreferred;
        } else if (candidates.length) {
          const windowSize = Math.min(8, candidates.length);
          const startIdx = stableHashInt(vid) % windowSize;
          for (let i = 0; i < windowSize; i += 1) {
            const nm = candidates[(startIdx + i) % candidates.length];
            if (!used.has(nm)) {
              picked = nm;
              break;
            }
          }
          if (!picked) picked = candidates[startIdx % candidates.length];
        } else {
          const fallback = String(base.tts.voice_name || '').trim();
          if (fallback) picked = fallback;
        }

        if (picked) {
          vm.voice_name = picked;
          used.add(picked);
          changedCount += 1;
        }

        if (!String(vm.language_code || '').trim()) {
          vm.language_code = desiredLang;
        }
      }

      const expectedNonEmpty = countVoiceMapVoiceNames(base);

      mysterySettingsLastWriteRef.current = {
        by: 'autoAssignVoiceMapBestMatchAndSave:optimistic',
        at: Date.now(),
        voiceNames: expectedNonEmpty,
      };
      setMysterySettingsObj(base);
      setMysterySettingsDraft(JSON.stringify(base, null, 2));

      const payloadSettings = safeJsonClone(base);
      const saveRes = await ApiClient.post('/api/mystery/admin.php?action=update_mystery_settings', {
        settings: payloadSettings,
        client_debug: buildMysterySettingsClientDebug(payloadSettings),
      });
      if (!saveRes || typeof saveRes !== 'object') {
        throw new Error('Save failed: invalid server response (not JSON)');
      }
      if (saveRes.success !== true) {
        throw new Error(saveRes?.error || 'Save failed');
      }
      const saved = (saveRes?.settings && typeof saveRes.settings === 'object') ? saveRes.settings : null;
      if (saved) {
        const savedNonEmpty = countVoiceMapVoiceNames(saved);
        if (expectedNonEmpty > 0 && savedNonEmpty < expectedNonEmpty) {
          const dbg = (saveRes?.debug && typeof saveRes.debug === 'object') ? saveRes.debug : null;
          const cd = (dbg?.client_debug && typeof dbg.client_debug === 'object') ? dbg.client_debug : null;
          const dbgStr = dbg
            ? (' Server debug: client_header=' + String(dbg.client_header ?? '')
              + ', client_payload_len_header=' + String(dbg.client_payload_len_header ?? '')
              + ', raw_body_len=' + String(dbg.raw_body_len ?? '')
              + ', raw_body_prefix=' + String(dbg.raw_body_prefix ?? '').slice(0, 120)
              + ', raw_body_json_error=' + String(dbg.raw_body_json_error ?? '')
              + ', raw_body_json_error_msg=' + String(dbg.raw_body_json_error_msg ?? '')
              + ', incoming_voice_map_entries=' + String(dbg.incoming_voice_map_entries ?? '')
              + ', incoming_voice_map_voice_name_non_empty=' + String(dbg.incoming_voice_map_voice_name_non_empty ?? '')
              + ', incoming_tts_is_array=' + String(dbg.incoming_tts_is_array ?? '')
              + ', incoming_voice_map_is_array=' + String(dbg.incoming_voice_map_is_array ?? '')
              + ', incoming_voice_map_sample_keys=' + String(Array.isArray(dbg.incoming_voice_map_sample_keys) ? dbg.incoming_voice_map_sample_keys.join('|') : '')
              + ', voice_map_entries=' + String(dbg.voice_map_entries ?? '')
              + ', voice_map_voice_name_non_empty=' + String(dbg.voice_map_voice_name_non_empty ?? ''))
            : '';
          const cdStr = cd
            ? (' Client debug: tts_type=' + String(cd.tts_type ?? '')
              + ', voice_map_type=' + String(cd.voice_map_type ?? '')
              + ', voice_map_keys_count=' + String(cd.voice_map_keys_count ?? '')
              + ', voice_map_json_len=' + String(cd.voice_map_json_len ?? '')
              + ', voice_map_json_prefix=' + String(cd.voice_map_json_prefix ?? ''))
            : '';
          throw new Error('Save response lost voice_name values (expected >= ' + String(expectedNonEmpty) + ', got ' + String(savedNonEmpty) + '). Not applying server response.' + dbgStr + cdStr);
        }
        mysterySettingsLastWriteRef.current = {
          by: 'autoAssignVoiceMapBestMatchAndSave:setSaved',
          at: Date.now(),
          voiceNames: savedNonEmpty,
        };
        setMysterySettingsObj(saved);
        setMysterySettingsDraft(JSON.stringify(saved, null, 2));
        setMysterySettingsUpdatedAt(String(saveRes?.updated_at || ''));
      } else {
        await loadMysterySettings();
      }

      const finalNonEmpty = saved ? countVoiceMapVoiceNames(saved) : expectedNonEmpty;

      setMessage(
        'Assigned voice names for ' + String(changedCount)
        + ' voice_id values and saved. (' + String(finalNonEmpty) + ' voice_map entries now have voice_name)'
      );
    } catch (e) {
      setError(e?.message || 'Failed to auto-assign voices');
    } finally {
      setBusy(false);
    }
  };

  const autofillVoiceMapFromAiSync = ({ voices }) => {
    const list = Array.isArray(voices) ? voices : (Array.isArray(ttsVoices) ? ttsVoices : []);
    applyMysterySettingsUpdate((s) => {
      ensureTtsVoiceMaps(s);
      const tts = s.tts;
      const active = String(tts.voice_map_active || 'google').trim().toLowerCase();
      if (active !== 'google') return s;
      const slot = tts.voice_maps.google;

      const sync = ensureAiModelSync(s);
      const voiceIds = (sync.voice_ids && typeof sync.voice_ids === 'object') ? sync.voice_ids : {};
      const foundations = (sync.foundations && typeof sync.foundations === 'object') ? sync.foundations : {};

      let changed = false;

      const idsToConsider = new Set();
      for (const vid of Object.keys(slot.voice_map)) idsToConsider.add(vid);
      for (const vid of (Array.isArray(voiceIdSuggestions) ? voiceIdSuggestions : [])) idsToConsider.add(String(vid));

      for (const vidRaw of Array.from(idsToConsider)) {
        const vid = String(vidRaw || '').trim();
        if (!vid) continue;
        if (Number(slot.voice_map_locks[vid] || 0)) continue;

        if (!slot.voice_map[vid] || typeof slot.voice_map[vid] !== 'object') {
          slot.voice_map[vid] = {};
        }
        const vm = slot.voice_map[vid];

        const curVoiceName = String(vm.voice_name || '').trim();
        if (curVoiceName) continue;

        const mapping = (voiceIds[vid] && typeof voiceIds[vid] === 'object') ? voiceIds[vid] : {};
        const foundationId = Number(mapping.foundation_id || 0);
        const fKey = foundationId ? String(foundationId) : '';
        const foundation = (fKey && foundations[fKey] && typeof foundations[fKey] === 'object') ? foundations[fKey] : {};
        const g = (foundation.google_cloud_tts && typeof foundation.google_cloud_tts === 'object') ? foundation.google_cloud_tts : {};

        const accentPref = String(voiceIdToAccentPreference.get(vid) || '').trim();
        let lang = accentPref || String(g.language_code || '').trim();
        if (!lang) lang = String(s.tts.language_code || 'en-US');
        if (!String(vm.language_code || '').trim() && lang) {
          vm.language_code = lang;
          changed = true;
        }

        let voiceName = String(g.voice_name || '').trim();
        if (!voiceName) {
          const voiceKey = String(foundation.foundation_voice_id || '').trim().toLowerCase();
          let desiredGender = '';
          if (voiceKey.startsWith('female_')) desiredGender = 'FEMALE';
          else if (voiceKey.startsWith('male_')) desiredGender = 'MALE';
          voiceName = pickDefaultGoogleVoiceName({ desiredGender, voices: list, langPref: lang });
        }

        if (!voiceName) {
          const defaultVoice = String(s.tts.voice_name || '').trim();
          if (defaultVoice) {
            voiceName = defaultVoice;
          }
        }

        if (!voiceName && Array.isArray(list) && list.length) {
          voiceName = pickDefaultGoogleVoiceName({ desiredGender: '', voices: list, langPref: lang });
        }

        if (voiceName) {
          vm.voice_name = voiceName;
          changed = true;
        }

        if ((vm.speaking_rate === '' || vm.speaking_rate === null || typeof vm.speaking_rate === 'undefined')
          && Object.prototype.hasOwnProperty.call(g, 'speaking_rate') && g.speaking_rate !== '' && g.speaking_rate !== null) {
          const sr = Number(g.speaking_rate);
          if (Number.isFinite(sr)) {
            vm.speaking_rate = sr;
            changed = true;
          }
        }

        if ((vm.pitch === '' || vm.pitch === null || typeof vm.pitch === 'undefined')
          && Object.prototype.hasOwnProperty.call(g, 'pitch') && g.pitch !== '' && g.pitch !== null) {
          const p = Number(g.pitch);
          if (Number.isFinite(p)) {
            vm.pitch = p;
            changed = true;
          }
        }
      }

      return changed ? s : s;
    });
  };

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    if (!isAdmin) return;

    loadMysterySettings();
    if (!agentProfilesLoadedAt) loadAgentProfiles();
    if (!ttsVoicesLoadedAt) loadTtsVoices();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isAdmin, mysterySettingsOpen]);

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    if (!isAdmin) return;
    const k = String(mysterySettingsUpdatedAt || '') + '|' + String(ttsVoicesLoadedAt || '');
    if (k && voiceMapAutoFillKeyRef.current === k) return;

    voiceMapAutoFillKeyRef.current = k;
    autofillVoiceMapFromAiSync({ voices: ttsVoices });
  }, [autofillVoiceMapFromAiSync, isAdmin, mysterySettingsOpen, mysterySettingsUpdatedAt, ttsVoices, ttsVoicesLoadedAt]);

  const assignCharacterVoiceIdsAndSync = async () => {
    if (!isAdmin) return;
    const cid = Number(caseId);
    if (!cid) {
      setError('Select a case first.');
      return;
    }

    let voicesForAutoPick = Array.isArray(ttsVoices) ? ttsVoices : [];
    if (!voicesForAutoPick.length) {
      try {
        const lang = encodeURIComponent(String(mysterySettingsObj?.tts?.language_code || 'en-US').trim() || 'en-US');
        const res = await ApiClient.get(`/api/mystery/admin.php?action=list_tts_voices&lang=${lang}`);
        voicesForAutoPick = Array.isArray(res?.voices) ? res.voices : [];
        setTtsVoices(voicesForAutoPick);
        setTtsVoicesLoadedAt(new Date().toISOString());
      } catch (_e) {
        voicesForAutoPick = [];
      }
    }

    const roleByEntityId = new Map();
    for (const se of (Array.isArray(scenarioEntities) ? scenarioEntities : [])) {
      const eid = Number(se?.entity_id || 0);
      if (!eid) continue;
      const role = String(se?.role || '').trim();
      if (role) roleByEntityId.set(eid, role);
    }

    const profiles = Array.isArray(agentProfiles) ? agentProfiles : [];
    const profileById = new Map();
    const profileByName = new Map();
    for (const p of profiles) {
      const id = Number(p?.id || 0);
      if (!id) continue;
      profileById.set(id, p);
      const nm = String(p?.name || '').trim().toLowerCase();
      if (nm) profileByName.set(nm, p);
    }

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const updates = [];
      for (const c of (Array.isArray(characters) ? characters : [])) {
        const id = Number(c?.id || 0);
        if (!id) continue;
        const slug = String(c?.slug || '').trim();
        if (!slug) continue;

        const role = String(roleByEntityId.get(id) || '').trim();
        const aid = Number(c?.data?.agent_id || 0);

        let prefix = 'suspect';
        if (role === 'sheriff') prefix = 'sheriff';
        else if (role === 'suspect' || role === 'killer' || role === 'witness' || role === 'bystander' || role === 'victim') prefix = role;
        else if (aid === 100) prefix = 'sheriff';

        const voiceId = prefix + '_' + slug;

        const nextData = (c?.data && typeof c.data === 'object') ? safeJsonClone(c.data) : {};
        const curVoiceId = String(nextData.voice_id || '').trim();
        if (curVoiceId !== voiceId) {
          nextData.voice_id = voiceId;
          updates.push({ id, data: nextData, voice_id: voiceId, agent_id: aid, name: String(c?.name || '').trim(), accent_preference: String(c?.accent_preference || '').trim() });
        } else {
          updates.push({ id, data: nextData, voice_id: voiceId, agent_id: aid, name: String(c?.name || '').trim(), accent_preference: String(c?.accent_preference || '').trim() });
        }
      }

      for (const u of updates) {
        await ApiClient.post('/api/mystery/admin.php?action=update_entity', { id: u.id, data: u.data });
      }

      applyMysterySettingsUpdate((s) => {
        ensureTtsVoiceMaps(s);
        const tts = s.tts;
        const slot = tts.voice_maps.google;
        if (!slot.voice_map || typeof slot.voice_map !== 'object') slot.voice_map = {};
        if (!slot.voice_map_locks || typeof slot.voice_map_locks !== 'object') slot.voice_map_locks = {};

        const sync = ensureAiModelSync(s);

        const inferFoundationLang = (voiceKey) => {
          const k = String(voiceKey || '').trim().toLowerCase();
          if (!k) return '';
          if (k.includes('british')) return 'en-GB';
          return 'en-US';
        };

        for (const p of profiles) {
          const pid = Number(p?.id || 0);
          if (!pid) continue;
          const key = String(pid);
          if (!sync.foundations[key] || typeof sync.foundations[key] !== 'object') sync.foundations[key] = {};
          if (!sync.foundations[key].name) sync.foundations[key].name = String(p?.name || '').trim();
          if (!sync.foundations[key].foundation_voice_id) sync.foundations[key].foundation_voice_id = String(p?.voice_id || '').trim();
          if (!sync.foundations[key].google_cloud_tts || typeof sync.foundations[key].google_cloud_tts !== 'object') {
            const voiceKey = String(p?.voice_id || '').trim().toLowerCase();
            let desiredGender = '';
            if (voiceKey.startsWith('female_')) desiredGender = 'FEMALE';
            else if (voiceKey.startsWith('male_')) desiredGender = 'MALE';
            const lang = inferFoundationLang(voiceKey) || 'en-US';
            const candidates = getCandidateGoogleVoiceNames({ desiredGender, voices: voicesForAutoPick, langPref: lang });
            let voiceName = '';
            if (candidates.length) {
              voiceName = candidates[stableHashInt('foundation:' + key) % candidates.length];
            } else {
              voiceName = pickDefaultGoogleVoiceName({ desiredGender, voices: voicesForAutoPick, langPref: lang });
            }
            sync.foundations[key].google_cloud_tts = {
              language_code: lang,
              voice_name: voiceName,
              speaking_rate: 1.0,
              pitch: 0.0,
            };
          }
        }

        for (const u of updates) {
          const vid = String(u.voice_id || '').trim();
          if (!vid) continue;
          if (Number(sync.locks[vid] || 0)) continue;
          if (!sync.voice_ids[vid] || typeof sync.voice_ids[vid] !== 'object') sync.voice_ids[vid] = {};

          let foundationId = Number(u.agent_id || 0);
          if (!foundationId) {
            const nm = String(u.name || '').trim().toLowerCase();
            const match = nm ? profileByName.get(nm) : null;
            if (match) foundationId = Number(match?.id || 0);
          }
          if (foundationId && profileById.has(foundationId)) {
            sync.voice_ids[vid].foundation_id = foundationId;
          }
        }

        for (const u of updates) {
          const vid = String(u.voice_id || '').trim();
          if (!vid) continue;
          if (Number(slot.voice_map_locks[vid] || 0)) continue;

          if (!slot.voice_map[vid] || typeof slot.voice_map[vid] !== 'object') slot.voice_map[vid] = {};
          const vm = slot.voice_map[vid];

          const curVoiceName = String(vm.voice_name || '').trim();
          if (curVoiceName) continue;

          const mapping = (sync.voice_ids[vid] && typeof sync.voice_ids[vid] === 'object') ? sync.voice_ids[vid] : {};
          const foundationId = Number(mapping.foundation_id || 0);
          const fKey = foundationId ? String(foundationId) : '';
          const foundation = fKey && sync.foundations && typeof sync.foundations === 'object' && sync.foundations[fKey] && typeof sync.foundations[fKey] === 'object'
            ? sync.foundations[fKey]
            : {};
          const g = (foundation.google_cloud_tts && typeof foundation.google_cloud_tts === 'object') ? foundation.google_cloud_tts : {};

          const accentPref = String(u.accent_preference || '').trim() || String(voiceIdToAccentPreference.get(vid) || '').trim();
          let lang = accentPref || String(g.language_code || '').trim();
          if (!lang) lang = 'en-US';

          let voiceName = String(g.voice_name || '').trim();
          if (!voiceName) {
            const voiceKey = String(foundation.foundation_voice_id || '').trim().toLowerCase();
            let desiredGender = '';
            if (voiceKey.startsWith('female_')) desiredGender = 'FEMALE';
            else if (voiceKey.startsWith('male_')) desiredGender = 'MALE';
            voiceName = pickDefaultGoogleVoiceName({ desiredGender, voices: voicesForAutoPick, langPref: lang });
          }

          vm.language_code = lang;
          if (voiceName) vm.voice_name = voiceName;

          if (Object.prototype.hasOwnProperty.call(g, 'speaking_rate') && g.speaking_rate !== '' && g.speaking_rate !== null) {
            const sr = Number(g.speaking_rate);
            if (Number.isFinite(sr)) vm.speaking_rate = sr;
          }
          if (Object.prototype.hasOwnProperty.call(g, 'pitch') && g.pitch !== '' && g.pitch !== null) {
            const p = Number(g.pitch);
            if (Number.isFinite(p)) vm.pitch = p;
          }
        }
        return s;
      });

      await loadCharacters(cid);
      setMessage('Voice IDs assigned and AI Model Sync updated. Don\'t forget to Save.');
    } catch (e) {
      setError(e?.message || 'Failed to assign voice IDs');
    } finally {
      setBusy(false);
    }
  };

  const applyMysterySettingsUpdate = (updater) => {
    setMysterySettingsObj((prev) => {
      const base = (prev && typeof prev === 'object') ? prev : {};
      const clone = safeJsonClone(base);
      if (Array.isArray(clone)) {
        setError('Internal error: settings became an array; ignoring update.');
        return base;
      }
      const out = (typeof updater === 'function') ? updater(clone) : null;
      const next = (out && typeof out === 'object') ? out : clone;

      if (Array.isArray(next)) {
        setError('Internal error: settings update returned an array; ignoring.');
        return base;
      }

      ensureTtsVoiceMaps(next);
      if (next?.tts?.voice_maps?.google) {
        next.tts.voice_maps.google.voice_map = normalizeRecord(next.tts.voice_maps.google.voice_map);
        next.tts.voice_maps.google.voice_map_locks = normalizeRecord(next.tts.voice_maps.google.voice_map_locks);
      }
      if (next?.tts?.voice_maps?.live) {
        next.tts.voice_maps.live.voice_map = normalizeRecord(next.tts.voice_maps.live.voice_map);
        next.tts.voice_maps.live.voice_map_locks = normalizeRecord(next.tts.voice_maps.live.voice_map_locks);
      }
      if (!out || typeof out !== 'object') {
        setError('Internal error: settings update returned an invalid value; ignoring.');
      }

      mysterySettingsLastWriteRef.current = {
        by: 'applyMysterySettingsUpdate',
        at: Date.now(),
        voiceNames: countVoiceMapVoiceNames(next),
      };
      setMysterySettingsDraft(JSON.stringify(next, null, 2));
      return next;
    });
  };

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    if (!isAdmin) return;
    if (!mysterySettingsUpdatedAt) return;
    if (!agentProfilesLoadedAt) return;

    const k = String(mysterySettingsUpdatedAt || '') + '|' + String(agentProfilesLoadedAt || '');
    if (k && foundationAutoLinkKeyRef.current === k) return;
    foundationAutoLinkKeyRef.current = k;

    applyMysterySettingsUpdate((s) => {
      const sync = ensureAiModelSync(s);
      const profiles = Array.isArray(agentProfiles) ? agentProfiles : [];
      if (!profiles.length) return s;

      const profileNameToId = new Map();
      for (const p of profiles) {
        const name = String(p?.name || '').trim().toLowerCase();
        const id = Number(p?.id || 0);
        if (!name || id <= 0) continue;
        if (!profileNameToId.has(name)) profileNameToId.set(name, id);
      }

      let changed = 0;
      for (const vid of voiceMapRowIds) {
        const voiceId = String(vid || '').trim();
        if (!voiceId) continue;
        if (!sync.voice_ids[voiceId] || typeof sync.voice_ids[voiceId] !== 'object') sync.voice_ids[voiceId] = {};
        if (Number(sync.voice_ids[voiceId].foundation_id || 0) > 0) continue;

        const chars = voiceIdToCharacters.get(voiceId) || [];
        let matchId = 0;
        for (const c of chars) {
          const cname = String(c || '').trim().toLowerCase();
          const pid = Number(profileNameToId.get(cname) || 0);
          if (pid > 0) {
            matchId = pid;
            break;
          }
        }
        if (matchId > 0) {
          sync.voice_ids[voiceId].foundation_id = matchId;
          changed += 1;
        }
      }

      if (!changed) return s;
      return s;
    });
  }, [agentProfiles, agentProfilesLoadedAt, isAdmin, mysterySettingsOpen, mysterySettingsUpdatedAt, voiceIdToCharacters, voiceMapRowIds]);

  const loadMysterySettings = async () => {
    if (!isAdmin) return;
    mysterySettingsLoadSeqRef.current += 1;
    const mySeq = mysterySettingsLoadSeqRef.current;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_mystery_settings');
      if (mySeq !== mysterySettingsLoadSeqRef.current) return;
      if (!res || typeof res !== 'object') {
        throw new Error('Failed to load Mystery settings: invalid server response (not JSON)');
      }
      if (res.success !== true) {
        throw new Error(String(res?.error || 'Failed to load Mystery settings'));
      }
      if (!res.settings || typeof res.settings !== 'object') {
        throw new Error('Failed to load Mystery settings: missing settings payload');
      }

      const normalized = safeJsonClone(res.settings);
      if (Array.isArray(normalized)) {
        throw new Error('Failed to load Mystery settings: payload is an array (expected object)');
      }
      if (!normalized.tts || typeof normalized.tts !== 'object') normalized.tts = {};
      ensureTtsVoiceMaps(normalized);
      normalized.tts.voice_maps.google.voice_map = normalizeRecord(normalized.tts.voice_maps.google.voice_map);
      normalized.tts.voice_maps.google.voice_map_locks = normalizeRecord(normalized.tts.voice_maps.google.voice_map_locks);
      normalized.tts.voice_maps.live.voice_map = normalizeRecord(normalized.tts.voice_maps.live.voice_map);
      normalized.tts.voice_maps.live.voice_map_locks = normalizeRecord(normalized.tts.voice_maps.live.voice_map_locks);

      mysterySettingsLastWriteRef.current = {
        by: 'loadMysterySettings',
        at: Date.now(),
        voiceNames: countVoiceMapVoiceNames(normalized),
      };
      setMysterySettingsObj(normalized);
      setMysterySettingsDraft(JSON.stringify(normalized, null, 2));
      setMysterySettingsUpdatedAt(String(res?.updated_at || ''));
    } catch (e) {
      if (mySeq !== mysterySettingsLoadSeqRef.current) return;
      setError(e?.message || 'Failed to load Mystery settings');
    } finally {
      if (mySeq !== mysterySettingsLoadSeqRef.current) return;
      setBusy(false);
    }
  };

  const loadTtsVoices = async () => {
    if (!isAdmin) return;
    setTtsVoicesError('');
    try {
      const lang = encodeURIComponent(String(mysterySettingsObj?.tts?.language_code || 'en-US').trim() || 'en-US');
      const res = await ApiClient.get(`/api/mystery/admin.php?action=list_tts_voices&lang=${lang}`);
      setTtsVoices(Array.isArray(res?.voices) ? res.voices : []);
      setTtsVoicesLoadedAt(new Date().toISOString());
    } catch (e) {
      setTtsVoices([]);
      setTtsVoicesError(e?.message || 'Failed to load TTS voices');
    }
  };

  const loadAgentProfiles = async () => {
    if (!isAdmin) {
      setAgentProfiles([]);
      return;
    }
    setAgentProfilesError('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_agent_profiles');
      setAgentProfiles(Array.isArray(res?.profiles) ? res.profiles : []);
      setAgentProfilesLoadedAt(new Date().toISOString());
    } catch (e) {
      setAgentProfiles([]);
      setAgentProfilesError(e?.message || 'Failed to load agent profiles');
    }
  };

  const saveMysterySettings = async () => {
    if (!isAdmin) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const parsed = JSON.parse(String(mysterySettingsDraft || '{}'));
      const next = (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) ? parsed : {};
      const expectedNonEmpty = countVoiceMapVoiceNames(next);
      mysterySettingsLastWriteRef.current = {
        by: 'saveMysterySettings:draftParse',
        at: Date.now(),
        voiceNames: expectedNonEmpty,
      };
      setMysterySettingsObj(next);

      const payloadSettings = safeJsonClone(next);
      const saveRes = await ApiClient.post('/api/mystery/admin.php?action=update_mystery_settings', {
        settings: payloadSettings,
        client_debug: buildMysterySettingsClientDebug(payloadSettings),
      });
      if (!saveRes || typeof saveRes !== 'object') {
        throw new Error('Save failed: invalid server response (not JSON)');
      }
      if (saveRes.success !== true) {
        throw new Error(saveRes?.error || 'Save failed');
      }
      const saved = (saveRes?.settings && typeof saveRes.settings === 'object') ? saveRes.settings : null;
      if (saved) {
        const savedNonEmpty = countVoiceMapVoiceNames(saved);
        if (expectedNonEmpty > 0 && savedNonEmpty < expectedNonEmpty) {
          const dbg = (saveRes?.debug && typeof saveRes.debug === 'object') ? saveRes.debug : null;
          const cd = (dbg?.client_debug && typeof dbg.client_debug === 'object') ? dbg.client_debug : null;
          const dbgStr = dbg
            ? (' Server debug: client_header=' + String(dbg.client_header ?? '')
              + ', client_payload_len_header=' + String(dbg.client_payload_len_header ?? '')
              + ', raw_body_len=' + String(dbg.raw_body_len ?? '')
              + ', raw_body_prefix=' + String(dbg.raw_body_prefix ?? '').slice(0, 120)
              + ', raw_body_json_error=' + String(dbg.raw_body_json_error ?? '')
              + ', raw_body_json_error_msg=' + String(dbg.raw_body_json_error_msg ?? '')
              + ', incoming_voice_map_entries=' + String(dbg.incoming_voice_map_entries ?? '')
              + ', incoming_voice_map_voice_name_non_empty=' + String(dbg.incoming_voice_map_voice_name_non_empty ?? '')
              + ', voice_map_entries=' + String(dbg.voice_map_entries ?? '')
              + ', voice_map_voice_name_non_empty=' + String(dbg.voice_map_voice_name_non_empty ?? ''))
            : '';
          const cdStr = cd
            ? (' Client debug: tts_type=' + String(cd.tts_type ?? '')
              + ', voice_map_type=' + String(cd.voice_map_type ?? '')
              + ', voice_map_keys_count=' + String(cd.voice_map_keys_count ?? '')
              + ', voice_map_json_len=' + String(cd.voice_map_json_len ?? '')
              + ', voice_map_json_prefix=' + String(cd.voice_map_json_prefix ?? ''))
            : '';
          throw new Error('Save response lost voice_name values (expected >= ' + String(expectedNonEmpty) + ', got ' + String(savedNonEmpty) + '). Not applying server response.' + dbgStr + cdStr);
        }
        mysterySettingsLastWriteRef.current = {
          by: 'saveMysterySettings:setSaved',
          at: Date.now(),
          voiceNames: savedNonEmpty,
        };
        setMysterySettingsObj(saved);
        setMysterySettingsDraft(JSON.stringify(saved, null, 2));
        setMysterySettingsUpdatedAt(String(saveRes?.updated_at || ''));
      } else {
        await loadMysterySettings();
      }
      setMessage('Mystery settings saved.');
      mysterySettingsCleanDraftRef.current = String(mysterySettingsDraft || '');
    } catch (e) {
      setError(e?.message || 'Failed to save Mystery settings (invalid JSON?)');
    } finally {
      setBusy(false);
    }
  };

  const saveMysterySettingsObject = async (settingsObj) => {
    if (!isAdmin) return;
    let next = (settingsObj && typeof settingsObj === 'object') ? safeJsonClone(settingsObj) : {};
    if (!next || typeof next !== 'object' || Array.isArray(next)) next = {};
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const expectedNonEmpty = countVoiceMapVoiceNames(next);
      mysterySettingsLastWriteRef.current = {
        by: 'saveMysterySettingsObject:optimistic',
        at: Date.now(),
        voiceNames: expectedNonEmpty,
      };
      setMysterySettingsObj(next);
      setMysterySettingsDraft(JSON.stringify(next, null, 2));

      const payloadSettings = safeJsonClone(next);
      const saveRes = await ApiClient.post('/api/mystery/admin.php?action=update_mystery_settings', {
        settings: payloadSettings,
        client_debug: buildMysterySettingsClientDebug(payloadSettings),
      });
      if (!saveRes || typeof saveRes !== 'object') {
        throw new Error('Save failed: invalid server response (not JSON)');
      }
      if (saveRes.success !== true) {
        throw new Error(saveRes?.error || 'Save failed');
      }
      const saved = (saveRes?.settings && typeof saveRes.settings === 'object') ? saveRes.settings : null;
      if (saved) {
        const savedNonEmpty = countVoiceMapVoiceNames(saved);
        if (expectedNonEmpty > 0 && savedNonEmpty < expectedNonEmpty) {
          const dbg = (saveRes?.debug && typeof saveRes.debug === 'object') ? saveRes.debug : null;
          const cd = (dbg?.client_debug && typeof dbg.client_debug === 'object') ? dbg.client_debug : null;
          const dbgStr = dbg
            ? (' Server debug: client_header=' + String(dbg.client_header ?? '')
              + ', client_payload_len_header=' + String(dbg.client_payload_len_header ?? '')
              + ', raw_body_len=' + String(dbg.raw_body_len ?? '')
              + ', raw_body_prefix=' + String(dbg.raw_body_prefix ?? '').slice(0, 120)
              + ', raw_body_json_error=' + String(dbg.raw_body_json_error ?? '')
              + ', raw_body_json_error_msg=' + String(dbg.raw_body_json_error_msg ?? '')
              + ', incoming_voice_map_entries=' + String(dbg.incoming_voice_map_entries ?? '')
              + ', incoming_voice_map_voice_name_non_empty=' + String(dbg.incoming_voice_map_voice_name_non_empty ?? '')
              + ', voice_map_entries=' + String(dbg.voice_map_entries ?? '')
              + ', voice_map_voice_name_non_empty=' + String(dbg.voice_map_voice_name_non_empty ?? ''))
            : '';
          const cdStr = cd
            ? (' Client debug: tts_type=' + String(cd.tts_type ?? '')
              + ', voice_map_type=' + String(cd.voice_map_type ?? '')
              + ', voice_map_keys_count=' + String(cd.voice_map_keys_count ?? '')
              + ', voice_map_json_len=' + String(cd.voice_map_json_len ?? '')
              + ', voice_map_json_prefix=' + String(cd.voice_map_json_prefix ?? ''))
            : '';
          throw new Error('Save response lost voice_name values (expected >= ' + String(expectedNonEmpty) + ', got ' + String(savedNonEmpty) + '). Not applying server response.' + dbgStr + cdStr);
        }
        mysterySettingsLastWriteRef.current = {
          by: 'saveMysterySettingsObject:setSaved',
          at: Date.now(),
          voiceNames: savedNonEmpty,
        };
        setMysterySettingsObj(saved);
        setMysterySettingsDraft(JSON.stringify(saved, null, 2));
        setMysterySettingsUpdatedAt(String(saveRes?.updated_at || ''));
      } else {
        await loadMysterySettings();
      }
      setMessage('Mystery settings saved.');
    } catch (e) {
      setError(e?.message || 'Failed to save Mystery settings');
    } finally {
      setBusy(false);
    }
  };

  const updateTtsField = (field, value) => {
    const k = String(field || '').trim();
    if (!k) return;
    applyMysterySettingsUpdate((s) => {
      if (!s.tts || typeof s.tts !== 'object') s.tts = {};
      s.tts[k] = value;
      return s;
    });
  };

  const updateVoiceMapEntry = (voiceId, field, value) => {
    const vid = String(voiceId || '').trim();
    const k = String(field || '').trim();
    if (!vid || !k) return;
    applyMysterySettingsUpdate((s) => {
      ensureTtsVoiceMaps(s);
      const tts = s.tts;
      const active = String(tts.voice_map_active || 'google').trim().toLowerCase();
      const slot = active === 'live' ? tts.voice_maps.live : tts.voice_maps.google;
      if (slot.voice_map_locks && typeof slot.voice_map_locks === 'object' && Number(slot.voice_map_locks[vid] || 0)) {
        return s;
      }
      if (!slot.voice_map || typeof slot.voice_map !== 'object') slot.voice_map = {};
      if (!slot.voice_map[vid] || typeof slot.voice_map[vid] !== 'object') slot.voice_map[vid] = {};
      slot.voice_map[vid][k] = value;
      return s;
    });
  };

  const deleteVoiceMapEntry = (voiceId) => {
    const vid = String(voiceId || '').trim();
    if (!vid) return;
    applyMysterySettingsUpdate((s) => {
      ensureTtsVoiceMaps(s);
      const tts = s.tts;
      const active = String(tts.voice_map_active || 'google').trim().toLowerCase();
      const slot = active === 'live' ? tts.voice_maps.live : tts.voice_maps.google;
      if (slot?.voice_map_locks && typeof slot.voice_map_locks === 'object' && Number(slot.voice_map_locks[vid] || 0)) {
        return s;
      }
      if (slot?.voice_map && typeof slot.voice_map === 'object' && slot.voice_map[vid]) {
        delete slot.voice_map[vid];
      }
      return s;
    });
  };

  const addVoiceMapEntry = (voiceId) => {
    const vid = String(voiceId || '').trim();
    if (!vid) return;
    applyMysterySettingsUpdate((s) => {
      ensureTtsVoiceMaps(s);
      const tts = s.tts;
      const active = String(tts.voice_map_active || 'google').trim().toLowerCase();
      const slot = active === 'live' ? tts.voice_maps.live : tts.voice_maps.google;
      if (slot.voice_map_locks && typeof slot.voice_map_locks === 'object' && Number(slot.voice_map_locks[vid] || 0)) {
        return s;
      }
      if (!slot.voice_map || typeof slot.voice_map !== 'object') slot.voice_map = {};
      if (!slot.voice_map[vid] || typeof slot.voice_map[vid] !== 'object') {
        if (active === 'live') {
          slot.voice_map[vid] = { voice_name: '' };
        } else {
          const dl = String(tts.language_code || 'en-US');
          const dv = String(tts.voice_name || '');
          const dsr = Number.isFinite(Number(tts.speaking_rate)) ? Number(tts.speaking_rate) : 1.0;
          const dp = Number.isFinite(Number(tts.pitch)) ? Number(tts.pitch) : 0.0;
          slot.voice_map[vid] = { language_code: dl, voice_name: dv, speaking_rate: dsr, pitch: dp };
        }
      }
      return s;
    });
  };

  const addMissingVoiceIdsFromCharacters = () => {
    applyMysterySettingsUpdate((s) => {
      ensureTtsVoiceMaps(s);
      const tts = s.tts;
      const active = String(tts.voice_map_active || 'google').trim().toLowerCase();
      const slot = active === 'live' ? tts.voice_maps.live : tts.voice_maps.google;
      if (!slot.voice_map || typeof slot.voice_map !== 'object') slot.voice_map = {};
      const existing = slot.voice_map;
      for (const vid of voiceIdSuggestions) {
        if (!existing[vid]) {
          if (active === 'live') {
            existing[vid] = { voice_name: '' };
          } else {
            const dl = String(tts.language_code || 'en-US');
            const dv = String(tts.voice_name || '');
            const dsr = Number.isFinite(Number(tts.speaking_rate)) ? Number(tts.speaking_rate) : 1.0;
            const dp = Number.isFinite(Number(tts.pitch)) ? Number(tts.pitch) : 0.0;
            existing[vid] = { language_code: dl, voice_name: dv, speaking_rate: dsr, pitch: dp };
          }
        }
      }
      slot.voice_map = existing;
      return s;
    });
  };

  const openMysterySettingsEditor = () => {
    setMysterySettingsEditorError('');
    const s = (mysterySettingsObj && typeof mysterySettingsObj === 'object') ? mysterySettingsObj : {};
    let nextText = '{}';
    if (mysterySettingsEditorTarget === 'full') {
      nextText = JSON.stringify(s, null, 2);
    } else if (mysterySettingsEditorTarget === 'tts_voice_map') {
      ensureTtsVoiceMaps(s);
      const active = getActiveVoiceMap(s);
      const vm = (active.voice_map && typeof active.voice_map === 'object') ? active.voice_map : {};
      nextText = JSON.stringify(vm, null, 2);
    } else if (mysterySettingsEditorTarget === 'tts_voice_map_google') {
      ensureTtsVoiceMaps(s);
      const vm = (s?.tts?.voice_maps?.google?.voice_map && typeof s.tts.voice_maps.google.voice_map === 'object') ? s.tts.voice_maps.google.voice_map : {};
      nextText = JSON.stringify(vm, null, 2);
    } else if (mysterySettingsEditorTarget === 'tts_voice_map_live') {
      ensureTtsVoiceMaps(s);
      const vm = (s?.tts?.voice_maps?.live?.voice_map && typeof s.tts.voice_maps.live.voice_map === 'object') ? s.tts.voice_maps.live.voice_map : {};
      nextText = JSON.stringify(vm, null, 2);
    } else {
      const tts = (s?.tts && typeof s.tts === 'object') ? s.tts : {};
      nextText = JSON.stringify(tts, null, 2);
    }
    mysterySettingsEditorCleanTextRef.current = String(nextText || '');
    setMysterySettingsEditorText(nextText);
    setMysterySettingsEditorOpen(true);
    showModalNow(mysterySettingsEditorRef, mysterySettingsEditorApiRef);
  };

  const applyMysterySettingsEditor = async ({ saveToServer }) => {
    setMysterySettingsEditorError('');
    try {
      const parsed = JSON.parse(String(mysterySettingsEditorText || '{}'));
      if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
        throw new Error('JSON must be an object');
      }

      let next = (mysterySettingsObj && typeof mysterySettingsObj === 'object') ? safeJsonClone(mysterySettingsObj) : {};
      if (!next || typeof next !== 'object' || Array.isArray(next)) next = {};

      if (mysterySettingsEditorTarget === 'full') {
        next = parsed;
      } else if (mysterySettingsEditorTarget === 'tts') {
        if (!next.tts || typeof next.tts !== 'object') next.tts = {};
        next.tts = { ...next.tts, ...parsed };
      } else if (mysterySettingsEditorTarget === 'tts_voice_map') {
        ensureTtsVoiceMaps(next);
        const active = getActiveVoiceMap(next);
        const slot = active.provider === 'live' ? next.tts.voice_maps.live : next.tts.voice_maps.google;
        slot.voice_map = parsed;
      } else if (mysterySettingsEditorTarget === 'tts_voice_map_google') {
        ensureTtsVoiceMaps(next);
        next.tts.voice_maps.google.voice_map = parsed;
      } else if (mysterySettingsEditorTarget === 'tts_voice_map_live') {
        ensureTtsVoiceMaps(next);
        next.tts.voice_maps.live.voice_map = parsed;
      } else {
        throw new Error('Unknown editor target');
      }

      if (!next || typeof next !== 'object' || Array.isArray(next)) {
        throw new Error('Settings JSON must be an object, not an array');
      }
      ensureTtsVoiceMaps(next);
      next.tts.voice_maps.google.voice_map = normalizeRecord(next.tts.voice_maps.google.voice_map);
      next.tts.voice_maps.google.voice_map_locks = normalizeRecord(next.tts.voice_maps.google.voice_map_locks);
      next.tts.voice_maps.live.voice_map = normalizeRecord(next.tts.voice_maps.live.voice_map);
      next.tts.voice_maps.live.voice_map_locks = normalizeRecord(next.tts.voice_maps.live.voice_map_locks);

      mysterySettingsLastWriteRef.current = {
        by: 'applyMysterySettingsEditor',
        at: Date.now(),
        voiceNames: countVoiceMapVoiceNames(next),
      };

      setMysterySettingsObj(next);
      setMysterySettingsDraft(JSON.stringify(next, null, 2));
      if (saveToServer) {
        await saveMysterySettingsObject(next);
        mysterySettingsEditorCleanTextRef.current = String(mysterySettingsEditorText || '');
      } else {
        setMessage('Advanced JSON applied (not yet saved).');
      }
    } catch (e) {
      setMysterySettingsEditorError(e?.message || 'Invalid JSON');
    }
  };

  const isMysterySettingsEditorDirty = useMemo(() => {
    return String(mysterySettingsEditorCleanTextRef.current || '') !== String(mysterySettingsEditorText || '');
  }, [mysterySettingsEditorText]);

  const isMysterySettingsDirty = useMemo(() => {
    return String(mysterySettingsCleanDraftRef.current || '') !== String(mysterySettingsDraft || '');
  }, [mysterySettingsDraft]);

  const [cloneTemplateCaseId, setCloneTemplateCaseId] = useState('');
  const [cloneNewTitle, setCloneNewTitle] = useState('');

  const setCaseTemplateFlag = async ({ case_id, is_template }) => {
    const cid = Number(case_id);
    if (!cid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=set_case_template', { case_id: cid, is_template: is_template ? 1 : 0 });
      await loadCases(mysteryId);
      setMessage('Template flag updated.');
    } catch (e) {
      setError(e?.message || 'Failed to update template flag');
    } finally {
      setBusy(false);
    }
  };

  const cloneFromTemplate = async (e) => {
    e.preventDefault();
    const templateCaseId = Number(cloneTemplateCaseId);
    const newTitle = String(cloneNewTitle || '').trim();
    if (!templateCaseId || !newTitle) {
      setError('Template and new title are required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=clone_case_from_template', {
        template_case_id: templateCaseId,
        new_title: newTitle,
      });
      await loadCases(mysteryId);
      if (res?.case_id) setCaseId(String(res.case_id));
      setCloneNewTitle('');
      setMessage('Case cloned from template.');
    } catch (err) {
      setError(err?.message || 'Failed to clone case');
    } finally {
      setBusy(false);
    }
  };

  const [masterCharacters, setMasterCharacters] = useState([]);
  const [masterLocations, setMasterLocations] = useState([]);
  const [masterWeapons, setMasterWeapons] = useState([]);
  const [masterMotives, setMasterMotives] = useState([]);
  const [newMasterCharacter, setNewMasterCharacter] = useState({ name: '' });
  const [newMasterLocation, setNewMasterLocation] = useState({ name: '' });
  const [newMasterWeapon, setNewMasterWeapon] = useState({ name: '' });
  const [newMasterMotive, setNewMasterMotive] = useState({ name: '' });

  const [storyBookEntries, setStoryBookEntries] = useState<any[]>([]);
  const [storyBookIncludeArchived, setStoryBookIncludeArchived] = useState(false);
  const [storyBookSelectedId, setStoryBookSelectedId] = useState('');
  const [storyBookTitleDraft, setStoryBookTitleDraft] = useState('');
  const [storyBookSlugDraft, setStoryBookSlugDraft] = useState('');
  const [storyBookSourceDraft, setStoryBookSourceDraft] = useState('');
  const [storyBookMetaDraft, setStoryBookMetaDraft] = useState('{}');
  const [storyBookBusy, setStoryBookBusy] = useState(false);
  const [storyBookError, setStoryBookError] = useState('');

  const loadStoryBookEntries = useCallback(async () => {
    const mid = Number(mysteryId);
    if (!mid) {
      setStoryBookEntries([]);
      return;
    }
    setStoryBookBusy(true);
    setStoryBookError('');
    try {
      const res = await ApiClient.get(
        '/api/mystery/admin.php?action=list_story_book_entries&mystery_id=' + String(mid) + '&include_archived=' + String(storyBookIncludeArchived ? 1 : 0)
      );
      setStoryBookEntries(Array.isArray(res?.entries) ? res.entries : []);
    } catch (e) {
      setStoryBookError((e as any)?.message || 'Failed to load Story Book');
    } finally {
      setStoryBookBusy(false);
    }
  }, [mysteryId, storyBookIncludeArchived]);

  const loadStoryBookEntry = useCallback(async (id: any) => {
    const mid = Number(mysteryId);
    const rid = Number(id || 0);
    if (!mid || !rid) {
      setStoryBookSelectedId('');
      setStoryBookTitleDraft('');
      setStoryBookSlugDraft('');
      setStoryBookSourceDraft('');
      setStoryBookMetaDraft('{}');
      return;
    }
    setStoryBookBusy(true);
    setStoryBookError('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_story_book_entry&id=' + String(rid));
      const entry = res?.entry;
      if (!entry || typeof entry !== 'object') {
        setStoryBookError('Story Book entry not found.');
        return;
      }
      setStoryBookSelectedId(String(entry.id || ''));
      setStoryBookTitleDraft(String(entry.title || ''));
      setStoryBookSlugDraft(String(entry.slug || ''));
      setStoryBookSourceDraft(String(entry.source_text || ''));
      const meta = (entry as any).meta;
      setStoryBookMetaDraft(JSON.stringify((meta && typeof meta === 'object') ? meta : {}, null, 2));
    } catch (e) {
      setStoryBookError((e as any)?.message || 'Failed to load Story Book entry');
    } finally {
      setStoryBookBusy(false);
    }
  }, [mysteryId]);

  const createNewStoryBookEntry = useCallback(() => {
    setStoryBookSelectedId('');
    setStoryBookTitleDraft('');
    setStoryBookSlugDraft('');
    setStoryBookSourceDraft('');
    setStoryBookMetaDraft('{}');
    setStoryBookError('');
  }, []);

  const saveStoryBookEntry = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setStoryBookError('Select a mystery first.');
      return;
    }
    const title = String(storyBookTitleDraft || '').trim();
    if (!title) {
      setStoryBookError('Title is required.');
      return;
    }
    let meta = {} as any;
    try {
      meta = JSON.parse(String(storyBookMetaDraft || '{}'));
    } catch (_err) {
      setStoryBookError('Meta must be valid JSON.');
      return;
    }
    if (!meta || typeof meta !== 'object' || Array.isArray(meta)) {
      setStoryBookError('Meta must be a JSON object.');
      return;
    }
    setStoryBookBusy(true);
    setStoryBookError('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=upsert_story_book_entry', {
        id: Number(storyBookSelectedId || 0) || 0,
        mystery_id: mid,
        title,
        slug: String(storyBookSlugDraft || '').trim(),
        source_text: String(storyBookSourceDraft || ''),
        meta,
        is_archived: 0,
      });
      const newId = String(res?.id || '');
      if (newId) {
        await loadStoryBookEntries();
        await loadStoryBookEntry(newId);
      } else {
        await loadStoryBookEntries();
      }
    } catch (e) {
      setStoryBookError((e as any)?.message || 'Failed to save Story Book entry');
    } finally {
      setStoryBookBusy(false);
    }
  }, [isAdmin, loadStoryBookEntries, loadStoryBookEntry, mysteryId, storyBookMetaDraft, storyBookSelectedId, storyBookSlugDraft, storyBookSourceDraft, storyBookTitleDraft]);

  const archiveStoryBookEntry = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const id = Number(storyBookSelectedId || 0);
    if (!mid || !id) return;
    setStoryBookBusy(true);
    setStoryBookError('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=archive_story_book_entry', {
        mystery_id: mid,
        id,
        is_archived: 1,
      });
      createNewStoryBookEntry();
      await loadStoryBookEntries();
    } catch (e) {
      setStoryBookError((e as any)?.message || 'Failed to archive Story Book entry');
    } finally {
      setStoryBookBusy(false);
    }
  }, [createNewStoryBookEntry, isAdmin, loadStoryBookEntries, mysteryId, storyBookSelectedId]);

  const [masterAssetsIncludeArchived, setMasterAssetsIncludeArchived] = useState(false);

  const [masterAssetNameDrafts, setMasterAssetNameDrafts] = useState({});

  const [pendingMasterDelete, setPendingMasterDelete] = useState(null);

  const [masterAssetDetailsType, setMasterAssetDetailsType] = useState('');
  const [masterAssetDetailsItem, setMasterAssetDetailsItem] = useState<any>(null);
  const [masterAssetDetailsName, setMasterAssetDetailsName] = useState('');
  const [masterAssetDetailsFields, setMasterAssetDetailsFields] = useState<any>({});
  const [masterAssetDetailsData, setMasterAssetDetailsData] = useState<any>({ description: '', items: [], image: null });
  const [masterAssetDetailsLocks, setMasterAssetDetailsLocks] = useState<any>({});
  const [masterAssetDetailsRapport, setMasterAssetDetailsRapport] = useState<any>({ likes: [], dislikes: [], quirks: [], fun_facts: [] });
  const [masterAssetDetailsFavorites, setMasterAssetDetailsFavorites] = useState<any>({ color: '', snack: '', drink: '', music: '', hobby: '', pet: '' });

  const [masterCharacterImageUrl, setMasterCharacterImageUrl] = useState('');
  const [masterCharacterMugshotUrl, setMasterCharacterMugshotUrl] = useState('');
  const [masterCharacterIrUrls, setMasterCharacterIrUrls] = useState<string[]>([]);
  const [masterCharacterIrIndex, setMasterCharacterIrIndex] = useState(0);

  const masterCharacterIrEmotions = useMemo(() => {
    return ['angry', 'afraid', 'amused', 'anxious', 'defiant', 'exhausted', 'guilty', 'smug', 'suspicious', 'tearful'];
  }, []);

  const [masterCharacterIrEmotionEnabled, setMasterCharacterIrEmotionEnabled] = useState<Record<string, boolean>>({});

  const [masterAssetJsonOpen, setMasterAssetJsonOpen] = useState(false);
  const [masterAssetJsonText, setMasterAssetJsonText] = useState('');
  const [masterAssetJsonError, setMasterAssetJsonError] = useState('');
  const [masterAssetJsonTitle, setMasterAssetJsonTitle] = useState('JSON');

  const [jsonPreviewOpen, setJsonPreviewOpen] = useState(false);
  const [jsonPreviewText, setJsonPreviewText] = useState('');
  const [jsonPreviewTitle, setJsonPreviewTitle] = useState('JSON');

  const openJsonPreview = useCallback(({ title, payload }: { title: any; payload: any }) => {
    const t = String(title || 'JSON');
    let text = '';
    try {
      if (typeof payload === 'string') {
        text = payload;
      } else {
        text = JSON.stringify(payload ?? null, null, 2);
      }
    } catch (_err) {
      text = String(payload ?? '');
    }
    setJsonPreviewTitle(t);
    setJsonPreviewText(text);
    setJsonPreviewOpen(true);
    showModalNow(jsonPreviewRef, jsonPreviewApiRef);
  }, []);

  const loadMasterCharacterImages = useCallback(async ({ mystery_id, id }) => {
    const mid = Number(mystery_id || 0);
    const rid = Number(id || 0);
    if (!mid || !rid) {
      setMasterCharacterImageUrl('');
      setMasterCharacterMugshotUrl('');
      setMasterCharacterIrUrls([]);
      setMasterCharacterIrIndex(0);
      return;
    }
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_master_character_images&mystery_id=' + String(mid) + '&id=' + String(rid));
      if (res && typeof res === 'object' && res.success === true) {
        setMasterCharacterImageUrl(String((res as any).character_url || ''));
        setMasterCharacterMugshotUrl(String(res.mugshot_url || ''));
        setMasterCharacterIrUrls(Array.isArray(res.ir_urls) ? res.ir_urls.map((x) => String(x || '')).filter(Boolean) : []);
        setMasterCharacterIrIndex(0);
        return;
      }
    } catch (_e) {
    }
    setMasterCharacterImageUrl('');
    setMasterCharacterMugshotUrl('');
    setMasterCharacterIrUrls([]);
    setMasterCharacterIrIndex(0);
  }, []);

  const uploadMasterCharacterImage = useCallback(async ({ kind, file }: { kind: 'character' | 'mugshot' | 'ir', file: File }) => {
    const mid = Number(mysteryId);
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const fd = new FormData();
      fd.append('mystery_id', String(mid));
      fd.append('id', String(id));
      fd.append('kind', kind);
      fd.append('file', file);
      const res = await ApiClient.postFormData('/api/mystery/admin.php?action=upload_master_character_image', fd);
      if (!res || typeof res !== 'object' || (res as any).success !== true) {
        throw new Error(String((res as any)?.error || 'Upload failed'));
      }
      setMasterCharacterImageUrl(String((res as any).character_url || ''));
      setMasterCharacterMugshotUrl(String((res as any).mugshot_url || ''));
      setMasterCharacterIrUrls(Array.isArray((res as any).ir_urls) ? (res as any).ir_urls.map((x) => String(x || '')).filter(Boolean) : []);
      setMasterCharacterIrIndex(0);
      setMessage('Uploaded.');
    } catch (e) {
      setError((e as any)?.message || 'Upload failed');
    } finally {
      setBusy(false);
    }
  }, [masterAssetDetailsItem, mysteryId]);

  const deleteMasterCharacterImage = useCallback(async ({ kind, url }: { kind: 'character' | 'mugshot' | 'ir', url?: string }) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const payload: any = { mystery_id: mid, id, kind };
      if (kind === 'ir') payload.url = String(url || '');
      const res = await ApiClient.post('/api/mystery/admin.php?action=delete_master_character_image', payload);
      if (!res || typeof res !== 'object' || (res as any).success !== true) {
        throw new Error(String((res as any)?.error || 'Delete failed'));
      }
      setMasterCharacterImageUrl(String((res as any).character_url || ''));
      setMasterCharacterMugshotUrl(String((res as any).mugshot_url || ''));
      setMasterCharacterIrUrls(Array.isArray((res as any).ir_urls) ? (res as any).ir_urls.map((x) => String(x || '')).filter(Boolean) : []);
      setMasterCharacterIrIndex(0);
      setMessage('Deleted.');
    } catch (e) {
      setError((e as any)?.message || 'Delete failed');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetDetailsItem, mysteryId]);

  const openMasterCharacterImagePrompt = useCallback(async ({ kind }: { kind: 'character' | 'mugshot' | 'ir' }) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;

    setBusy(true);
    setError('');
    setMessage('');
    setMasterAssetJsonError('');
    setMasterAssetJsonText('');
    setMasterAssetJsonTitle(kind === 'character' ? 'Character Prompt' : (kind === 'mugshot' ? 'Mugshot Prompt' : 'Interrogation Room Prompt'));
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_master_character_image_prompt_json&mystery_id=' + String(mid) + '&id=' + String(id));
      if (!res || typeof res !== 'object' || (res as any).success !== true) {
        throw new Error(String((res as any)?.error || 'Failed to load prompt JSON'));
      }
      const pj: any = (res as any).prompt_json ?? {};

      let block: any = {};
      if (kind === 'character') block = pj?.character;
      else if (kind === 'mugshot') block = pj?.mugshot;
      else block = pj?.interrogation_room;

      const style = String(block?.style_instruction || '').trim();
      const prompt = String(block?.prompt || '').trim();
      const text = (style !== '' ? ('STYLE INSTRUCTION\n' + style + '\n\n') : '') + 'PROMPT\n' + prompt;

      setMasterAssetJsonText(text);
      setMasterAssetJsonOpen(true);
      showModalNow(masterAssetJsonRef, masterAssetJsonApiRef);
    } catch (e) {
      setMasterAssetJsonError((e as any)?.message || 'Failed to load prompt JSON');
      setMasterAssetJsonOpen(true);
      showModalNow(masterAssetJsonRef, masterAssetJsonApiRef);
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetDetailsItem, mysteryId]);

  const copyMasterAssetJsonText = useCallback(async () => {
    const text = String(masterAssetJsonText || '');
    if (!text) return;
    setMasterAssetJsonError('');
    try {
      if (!navigator.clipboard || !window.isSecureContext) {
        throw new Error('Clipboard is not available in this context');
      }
      await navigator.clipboard.writeText(text);
    } catch (e) {
      setMasterAssetJsonError((e as any)?.message || 'Failed to copy');
    }
  }, [masterAssetJsonText]);

  const generateMasterCharacterImages = useCallback(async ({ kind }: { kind: 'character' | 'mugshot' | 'ir' }) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;

    if (kind === 'ir') {
      const enabled = (masterCharacterIrEmotionEnabled && typeof masterCharacterIrEmotionEnabled === 'object') ? masterCharacterIrEmotionEnabled : {};

      const selected = masterCharacterIrEmotions.filter((e) => enabled[e] !== false);
      const existing = new Set<string>();
      for (const u of (Array.isArray(masterCharacterIrUrls) ? masterCharacterIrUrls : [])) {
        const s = String(u || '');
        const m = s.match(/_ir_([a-z0-9_-]+)\.(png|jpe?g|webp)(?:\?.*)?$/i);
        if (m && m[1]) existing.add(String(m[1]).toLowerCase());
      }
      const missing = selected.filter((e) => !existing.has(e));
      if (!missing.length) {
        setMessage('All selected emotions already exist.');
        return;
      }

      setBusy(true);
      setError('');
      setMessage('');
      try {
        const res = await ApiClient.post('/api/mystery/admin.php?action=generate_master_character_images', {
          mystery_id: mid,
          id,
          kind: 'ir',
          emotions: missing,
        });
        if (!res || typeof res !== 'object' || (res as any).success !== true) {
          throw new Error(String((res as any)?.error || 'Failed to generate images'));
        }
        setMasterCharacterMugshotUrl(String((res as any).mugshot_url || ''));
        setMasterCharacterIrUrls(Array.isArray((res as any).ir_urls) ? (res as any).ir_urls.map((x) => String(x || '')).filter(Boolean) : []);
        setMasterCharacterIrIndex(0);
        setMessage('Generated missing interrogation room images.');
      } catch (e) {
        setError((e as any)?.message || 'Failed to generate images');
      } finally {
        setBusy(false);
      }
      return;
    }

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=generate_master_character_images', {
        mystery_id: mid,
        id,
        kind,
      });
      if (!res || typeof res !== 'object' || (res as any).success !== true) {
        throw new Error(String((res as any)?.error || 'Failed to generate images'));
      }
      setMasterCharacterImageUrl(String((res as any).character_url || ''));
      setMasterCharacterMugshotUrl(String((res as any).mugshot_url || ''));
      setMasterCharacterIrUrls(Array.isArray((res as any).ir_urls) ? (res as any).ir_urls.map((x) => String(x || '')).filter(Boolean) : []);
      setMasterCharacterIrIndex(0);
      setMessage(kind === 'character' ? 'Generated character image.' : 'Generated mugshot.');
    } catch (e) {
      setError((e as any)?.message || 'Failed to generate images');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetDetailsItem, masterCharacterIrEmotionEnabled, masterCharacterIrEmotions, masterCharacterIrUrls, mysteryId]);

  const generateAllMissingMasterCharacterImages = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      // 1) Baseline character image
      const r1 = await ApiClient.post('/api/mystery/admin.php?action=generate_master_character_images', { mystery_id: mid, id, kind: 'character' });
      if (!r1 || typeof r1 !== 'object' || (r1 as any).success !== true) {
        throw new Error(String((r1 as any)?.error || 'Failed to generate character image'));
      }

      // 2) Mugshot
      const r2 = await ApiClient.post('/api/mystery/admin.php?action=generate_master_character_images', { mystery_id: mid, id, kind: 'mugshot' });
      if (!r2 || typeof r2 !== 'object' || (r2 as any).success !== true) {
        throw new Error(String((r2 as any)?.error || 'Failed to generate mugshot'));
      }

      // 3) Interrogation room images for selected emotions (only missing ones are created by the server)
      const enabled = (masterCharacterIrEmotionEnabled && typeof masterCharacterIrEmotionEnabled === 'object') ? masterCharacterIrEmotionEnabled : {};
      const selected = masterCharacterIrEmotions.filter((e) => enabled[e] !== false);
      const existing = new Set<string>();
      for (const u of (Array.isArray(masterCharacterIrUrls) ? masterCharacterIrUrls : [])) {
        const s = String(u || '');
        const m = s.match(/_ir_([a-z0-9_-]+)\.(png|jpe?g|webp)(?:\?.*)?$/i);
        if (m && m[1]) existing.add(String(m[1]).toLowerCase());
      }
      const missing = selected.filter((e) => !existing.has(e));
      if (missing.length) {
        const r3 = await ApiClient.post('/api/mystery/admin.php?action=generate_master_character_images', {
          mystery_id: mid,
          id,
          kind: 'ir',
          emotions: missing,
        });
        if (!r3 || typeof r3 !== 'object' || (r3 as any).success !== true) {
          throw new Error(String((r3 as any)?.error || 'Failed to generate interrogation room images'));
        }
      }

      // Refresh URLs from server.
      await loadMasterCharacterImages({ mystery_id: mid, id });
      setMessage('Generated all missing character images.');
    } catch (e) {
      setError((e as any)?.message || 'Failed to generate images');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, loadMasterCharacterImages, masterAssetDetailsItem, masterCharacterIrEmotionEnabled, masterCharacterIrEmotions, masterCharacterIrUrls, mysteryId]);

  const uploadMasterAssetImage = useCallback(async ({ file }: { file: File }) => {
    const mid = Number(mysteryId);
    const t = String(masterAssetDetailsType || '').trim();
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;
    if (t !== 'location' && t !== 'weapon' && t !== 'motive') return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const fd = new FormData();
      fd.append('mystery_id', String(mid));
      fd.append('type', t);
      fd.append('id', String(id));
      fd.append('file', file);
      const res = await ApiClient.postFormData('/api/mystery/admin.php?action=upload_master_asset_image', fd);
      if (!res || typeof res !== 'object' || (res as any).success !== true) {
        throw new Error(String((res as any)?.error || 'Upload failed'));
      }

      const img = ((res as any).image && typeof (res as any).image === 'object') ? (res as any).image : null;
      if (img) {
        setMasterAssetDetailsData((prev) => {
          const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : { description: '', items: [], image: null };
          const curImg = (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) ? base.image : {};
          return { ...base, image: { ...curImg, ...img } };
        });
      }
      setMessage('Uploaded.');
    } catch (e) {
      setError((e as any)?.message || 'Upload failed');
    } finally {
      setBusy(false);
    }
  }, [masterAssetDetailsItem, masterAssetDetailsType, mysteryId]);

  const generateMasterAssetPrimaryImage = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const t = String(masterAssetDetailsType || '').trim();
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;
    if (t !== 'location' && t !== 'weapon') return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=generate_master_asset_image', {
        mystery_id: mid,
        type: t,
        id,
      });
      if (!res || typeof res !== 'object' || (res as any).success !== true) {
        throw new Error(String((res as any)?.error || 'Failed to generate image'));
      }
      const img = ((res as any).image && typeof (res as any).image === 'object') ? (res as any).image : null;
      if (img) {
        setMasterAssetDetailsData((prev) => {
          const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : { description: '', items: [], image: null };
          const curImg = (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) ? base.image : {};
          return { ...base, image: { ...curImg, ...img } };
        });
      }
      setMessage('Generated image.');
    } catch (e) {
      setError((e as any)?.message || 'Failed to generate image');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetDetailsItem, masterAssetDetailsType, mysteryId]);

  const deleteMasterAssetPrimaryImage = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const t = String(masterAssetDetailsType || '').trim();
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;
    if (t !== 'location' && t !== 'weapon') return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=delete_master_asset_image', {
        mystery_id: mid,
        type: t,
        id,
      });
      if (!res || typeof res !== 'object' || (res as any).success !== true) {
        throw new Error(String((res as any)?.error || 'Failed to delete image'));
      }
      const img = ((res as any).image && typeof (res as any).image === 'object') ? (res as any).image : null;
      setMasterAssetDetailsData((prev) => {
        const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : { description: '', items: [], image: null };
        const curImg = (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) ? base.image : {};
        const nextUrl = img ? String((img as any).url || '') : '';
        return { ...base, image: { ...curImg, ...(img || {}), url: nextUrl } };
      });
      setMessage('Deleted image file.');
    } catch (e) {
      setError((e as any)?.message || 'Failed to delete image');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetDetailsItem, masterAssetDetailsType, mysteryId]);

  const [voiceProfiles, setVoiceProfiles] = useState([]);

  const masterAssetDetailsDataText = useMemo(() => {
    const t = String(masterAssetDetailsType || '').trim();
    if (t === 'character') return '{}';
    const base = (masterAssetDetailsData && typeof masterAssetDetailsData === 'object') ? masterAssetDetailsData : { description: '', items: [], image: null };
    return JSON.stringify({
      description: String(base.description || ''),
      items: Array.isArray(base.items) ? base.items : [],
      image: (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) ? base.image : null,
    }, null, 2);
  }, [masterAssetDetailsType, masterAssetDetailsData]);

  const updateMasterAssetDetailsDataObject = (updater) => {
    setMasterAssetDetailsData((prev) => {
      const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : { description: '', items: [], image: null };
      const next = (typeof updater === 'function') ? updater(base) : base;
      if (!next || typeof next !== 'object' || Array.isArray(next)) return base;
      return next;
    });
  };

  const getMasterAssetDataObject = () => {
    const t = String(masterAssetDetailsType || '').trim();
    if (t === 'character') return {};
    const parsed = masterAssetDetailsData;
    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) return parsed;
    return { description: '', items: [], image: null };
  };

  const masterAssetDetailsCleanSnapshotRef = useRef('');

  const buildMasterAssetDetailsSnapshot = useCallback(() => {
    const t = String(masterAssetDetailsType || '').trim();
    const baseItem = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(baseItem?.id || 0);
    const slug = String(baseItem?.slug || '');
    const name = String(masterAssetDetailsName || '');
    const fields = (masterAssetDetailsFields && typeof masterAssetDetailsFields === 'object') ? masterAssetDetailsFields : {};
    const dataObj = getMasterAssetDataObject();

    if (t === 'character') {
      const rp = (masterAssetDetailsRapport && typeof masterAssetDetailsRapport === 'object') ? masterAssetDetailsRapport : { likes: [], dislikes: [], quirks: [], fun_facts: [] };
      const fav = (masterAssetDetailsFavorites && typeof masterAssetDetailsFavorites === 'object') ? masterAssetDetailsFavorites : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' };
      return JSON.stringify({
        t,
        id,
        slug,
        name,
        fields,
        rapport: rp,
        favorites: fav,
      });
    }

    return JSON.stringify({
      t,
      id,
      slug,
      name,
      fields,
      data: dataObj,
    });
  }, [
    getMasterAssetDataObject,
    masterAssetDetailsFavorites,
    masterAssetDetailsFields,
    masterAssetDetailsItem,
    masterAssetDetailsName,
    masterAssetDetailsRapport,
    masterAssetDetailsType,
  ]);

  const isMasterAssetDetailsDirty = useMemo(() => {
    const clean = String(masterAssetDetailsCleanSnapshotRef.current || '');
    if (!clean) return false;
    return clean !== buildMasterAssetDetailsSnapshot();
  }, [buildMasterAssetDetailsSnapshot]);

  const getMasterAssetFieldLocks = () => {
    const v = (masterAssetDetailsLocks && typeof masterAssetDetailsLocks === 'object' && !Array.isArray(masterAssetDetailsLocks)) ? masterAssetDetailsLocks : {};
    return v;
  };

  const isMasterAssetFieldLocked = (lockKey) => {
    const k = String(lockKey || '').trim();
    if (!k) return false;
    const locks = getMasterAssetFieldLocks();
    return Number(locks[k] || 0) ? true : false;
  };

  const loadMasterAssetFieldLocks = useCallback(async ({ mystery_id, type, id }) => {
    const mid = Number(mystery_id || 0);
    const t = String(type || '').trim();
    const rid = Number(id || 0);
    if (!mid || !rid || !t) {
      setMasterAssetDetailsLocks({});
      return;
    }
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_master_asset_field_locks&mystery_id=' + String(mid) + '&type=' + encodeURIComponent(t) + '&id=' + String(rid));
      if (res && typeof res === 'object' && res.success === true) {
        const locks = (res.locks && typeof res.locks === 'object' && !Array.isArray(res.locks)) ? res.locks : {};
        setMasterAssetDetailsLocks(locks);
      }
    } catch (_e) {
      setMasterAssetDetailsLocks({});
    }
  }, []);

  const toggleMasterAssetFieldLock = async (lockKey) => {
    const k = String(lockKey || '').trim();
    if (!k) return;

    const t = String(masterAssetDetailsType || '').trim();
    const mid = Number(mysteryId);
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id || !t) return;

    const curLocks = (masterAssetDetailsLocks && typeof masterAssetDetailsLocks === 'object' && !Array.isArray(masterAssetDetailsLocks)) ? masterAssetDetailsLocks : {};
    const isLocked = Number(curLocks[k] || 0) ? 1 : 0;
    const nextLocked = isLocked ? 0 : 1;

    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=set_master_asset_field_lock', {
        mystery_id: mid,
        type: t,
        id,
        lock_key: k,
        is_locked: nextLocked,
      });
      if (!res || typeof res !== 'object' || res.success !== true) {
        throw new Error(String(res?.error || 'Failed to update lock'));
      }
      setMasterAssetDetailsLocks((prev) => {
        const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : {};
        const next = { ...base };
        if (nextLocked) next[k] = 1;
        else delete next[k];
        return next;
      });
    } catch (e) {
      setError(e?.message || 'Failed to update lock');
    }
  };

  const openMasterAssetDerivedJson = async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const id = Number(it?.id || 0);
    if (!mid || !id) return;
    const t = String(masterAssetDetailsType || '').trim();
    if (!t) return;

    let action = '';
    if (t === 'character') action = 'get_master_character_profile_json';
    else if (t === 'location') action = 'get_master_location_profile_json';
    else if (t === 'weapon') action = 'get_master_weapon_profile_json';
    else if (t === 'motive') action = 'get_master_motive_profile_json';
    else return;

    setMasterAssetJsonError('');
    setMasterAssetJsonText('');
    setBusy(true);
    try {
      const res = await ApiClient.get(
        '/api/mystery/admin.php?action=' + action + '&mystery_id=' + String(mid) + '&id=' + String(id)
      );
      if (!res || typeof res !== 'object' || res.success !== true) {
        throw new Error(String(res?.error || 'Failed to load JSON'));
      }
      const pj = res.profile_json;
      setMasterAssetJsonText(JSON.stringify(pj ?? {}, null, 2));
      setMasterAssetJsonOpen(true);
      showModalNow(masterAssetJsonRef, masterAssetJsonApiRef);
    } catch (e) {
      setMasterAssetJsonError(e?.message || 'Failed to load JSON');
      setMasterAssetJsonOpen(true);
      showModalNow(masterAssetJsonRef, masterAssetJsonApiRef);
    } finally {
      setBusy(false);
    }
  };

  const applyMasterAssetGeneratedPatch = (patch) => {
    const p = (patch && typeof patch === 'object' && !Array.isArray(patch)) ? patch : {};
    const locks = getMasterAssetFieldLocks();
    updateMasterAssetDetailsDataObject((prev) => {
      const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : { description: '', items: [], image: null };
      const next: any = { ...base };

      if (!Number(locks.description || 0) && Object.prototype.hasOwnProperty.call(p, 'description')) {
        next.description = String(p.description || '');
      }

      if (Object.prototype.hasOwnProperty.call(p, 'items') && Array.isArray(p.items)) {
        const incoming = p.items;
        const cur = Array.isArray(base.items) ? base.items : [];
        const out: any[] = [];
        const max = Math.max(cur.length, incoming.length);
        for (let i = 0; i < max; i += 1) {
          const curItem = (cur[i] && typeof cur[i] === 'object' && !Array.isArray(cur[i])) ? cur[i] : {};
          const incItem = (incoming[i] && typeof incoming[i] === 'object' && !Array.isArray(incoming[i])) ? incoming[i] : null;
          if (!incItem) {
            out.push(curItem);
            continue;
          }
          const nextItem: any = { ...curItem };
          const titleKey = 'items.' + String(i) + '.title';
          const textKey = 'items.' + String(i) + '.text';
          if (!Number(locks[titleKey] || 0) && Object.prototype.hasOwnProperty.call(incItem, 'title')) {
            nextItem.title = String(incItem.title || '');
          }
          if (!Number(locks[textKey] || 0) && Object.prototype.hasOwnProperty.call(incItem, 'text')) {
            nextItem.text = String(incItem.text || '');
          }
          out.push(nextItem);
        }
        next.items = out;
      }

      if (Object.prototype.hasOwnProperty.call(p, 'image') && p.image && typeof p.image === 'object' && !Array.isArray(p.image)) {
        const curImg = (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) ? base.image : {};
        const incImg = p.image;
        const nextImg: any = { ...curImg };
        const imageKeys = ['title', 'url', 'alt_text', 'prompt_text', 'negative_prompt_text', 'provider', 'model'];
        for (const k of imageKeys) {
          const lk = 'image.' + k;
          if (Number(locks[lk] || 0)) continue;
          if (!Object.prototype.hasOwnProperty.call(incImg, k)) continue;
          nextImg[k] = String(incImg[k] || '');
        }
        next.image = nextImg;
      }

      return next;
    });
  };

  const generateMasterAssetContent = async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const t = String(masterAssetDetailsType || '').trim();
    const item = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    if (!item) return;
    const id = Number(item.id || 0);
    if (!id) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=generate_master_asset_content', {
        mystery_id: mid,
        type: t,
        id,
      });
      if (!res || typeof res !== 'object') {
        throw new Error('Generate failed: invalid server response');
      }
      if (res.success !== true) {
        throw new Error(String(res?.error || 'Generate failed'));
      }

      const fieldsPatch = (res.fields_patch && typeof res.fields_patch === 'object' && !Array.isArray(res.fields_patch)) ? res.fields_patch : {};
      const rapportPatch = (res.rapport_patch && typeof res.rapport_patch === 'object' && !Array.isArray(res.rapport_patch)) ? res.rapport_patch : {};
      const favoritesPatch = (res.favorites_patch && typeof res.favorites_patch === 'object' && !Array.isArray(res.favorites_patch)) ? res.favorites_patch : {};

      if (t === 'character') {
        const locks = getMasterAssetFieldLocks();
        const isLocked = (k) => Number(locks?.[k] || 0) ? 1 : 0;
        const setIfUnlocked = (k, v) => {
          if (!k) return;
          if (isLocked(k)) return;
          setMasterAssetDetailsFields((prev) => ({
            ...(prev && typeof prev === 'object' ? prev : {}),
            [k]: v,
          }));
        };

        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'dob')) setIfUnlocked('dob', String(fieldsPatch.dob || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'age')) setIfUnlocked('age', Number(fieldsPatch.age || 0) || 0);
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'hometown')) setIfUnlocked('hometown', String(fieldsPatch.hometown || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'address')) setIfUnlocked('address', String(fieldsPatch.address || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'ethnicity')) setIfUnlocked('ethnicity', String(fieldsPatch.ethnicity || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'zodiac')) setIfUnlocked('zodiac', String(fieldsPatch.zodiac || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'mbti')) setIfUnlocked('mbti', String(fieldsPatch.mbti || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'height')) setIfUnlocked('height', String(fieldsPatch.height || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'weight')) setIfUnlocked('weight', String(fieldsPatch.weight || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'eye_color')) setIfUnlocked('eye_color', String(fieldsPatch.eye_color || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'hair_color')) setIfUnlocked('hair_color', String(fieldsPatch.hair_color || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'distinguishing_marks')) setIfUnlocked('distinguishing_marks', String(fieldsPatch.distinguishing_marks || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'education')) setIfUnlocked('education', String(fieldsPatch.education || ''));
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'criminal_record')) setIfUnlocked('criminal_record', String(fieldsPatch.criminal_record || ''));

        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'aliases')) {
          const a = Array.isArray(fieldsPatch.aliases) ? fieldsPatch.aliases.map((x) => String(x || '').trim()).filter(Boolean) : [];
          setIfUnlocked('aliases', a);
        }
        if (Object.prototype.hasOwnProperty.call(fieldsPatch, 'employment')) {
          const a = Array.isArray(fieldsPatch.employment) ? fieldsPatch.employment.map((x) => String(x || '').trim()).filter(Boolean) : [];
          setIfUnlocked('employment', a);
        }

        const listKeys = ['likes', 'dislikes', 'quirks', 'fun_facts'];
        setMasterAssetDetailsRapport((prev) => {
          const base = (prev && typeof prev === 'object') ? prev : { likes: [], dislikes: [], quirks: [], fun_facts: [] };
          const next = { ...base };
          for (const k of listKeys) {
            const lk = 'static_profile.rapport.' + k;
            if (isLocked(lk)) continue;
            if (!Object.prototype.hasOwnProperty.call(rapportPatch, k)) continue;
            const arr = Array.isArray(rapportPatch[k]) ? rapportPatch[k].map((x) => String(x || '').trim()).filter(Boolean) : [];
            if (!arr.length) continue;
            const cur = Array.isArray(base[k]) ? base[k] : [];
            if (cur.length) continue;
            next[k] = arr;
          }
          return next;
        });

        setMasterAssetDetailsFavorites((prev) => {
          const base = (prev && typeof prev === 'object') ? prev : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' };
          const next = { ...base };
          const favKeys = ['color', 'snack', 'drink', 'music', 'hobby', 'pet'];
          for (const k of favKeys) {
            const lk = 'static_profile.rapport.favorites.' + k;
            if (isLocked(lk)) continue;
            if (!Object.prototype.hasOwnProperty.call(favoritesPatch, k)) continue;
            const v = String(favoritesPatch[k] || '');
            if (String(base[k] || '').trim() !== '') continue;
            if (v.trim() === '') continue;
            next[k] = v;
          }
          return next;
        });
      }

      if (t !== 'character') {
        const dataPatch = (res.data_patch && typeof res.data_patch === 'object' && !Array.isArray(res.data_patch)) ? res.data_patch : {};
        applyMasterAssetGeneratedPatch(dataPatch);
      }
      setMessage('Generated content applied (not yet saved).');
    } catch (e) {
      setError(e?.message || 'Failed to generate content');
    } finally {
      setBusy(false);
    }
  };

  const clearMasterAssetFields = async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const t = String(masterAssetDetailsType || '').trim();
    const item = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    if (!item) return;
    const id = Number(item.id || 0);
    if (!id) return;

    const ok = window.confirm('Clear all generated/profile fields for this asset? This will wipe curated DB fields and clear any derived/profile data so you can Generate Content again.');
    if (!ok) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=clear_master_asset_fields', {
        mystery_id: mid,
        type: t,
        id,
      });
      if (!res || typeof res !== 'object') {
        throw new Error('Clear failed: invalid server response');
      }
      if (res.success !== true) {
        throw new Error(String(res?.error || 'Clear failed'));
      }

      if (t === 'character') {
        setMasterAssetDetailsFields((prev) => ({
          ...(prev && typeof prev === 'object' ? prev : {}),
          dob: '',
          age: 0,
          hometown: '',
          address: '',
          aliases: [],
          ethnicity: '',
          zodiac: '',
          mbti: '',
          height: '',
          weight: '',
          eye_color: '',
          hair_color: '',
          distinguishing_marks: '',
          education: '',
          employment: [],
          criminal_record: '',
        }));

        setMasterAssetDetailsRapport({ likes: [], dislikes: [], quirks: [], fun_facts: [] });
        setMasterAssetDetailsFavorites({ color: '', snack: '', drink: '', music: '', hobby: '', pet: '' });
        setMasterAssetDetailsData({ description: '', items: [], image: null });
      } else {
        setMasterAssetDetailsFields((prev) => {
          const base = (prev && typeof prev === 'object') ? prev : {};
          const next = { ...base } as any;
          next.description = '';
          if (t === 'location') {
            next.location_id = '';
            next.address_line1 = '';
            next.address_line2 = '';
            next.city = '';
            next.region = '';
            next.postal_code = '';
            next.country = '';
            next.base_image_prompt = '';
            next.overlay_asset_prompt = '';
            next.overlay_trigger = '';
          }
          if (t === 'weapon') {
            next.fingerprints = [];
          }
          return next;
        });

        setMasterAssetDetailsData({ description: '', items: [], image: null });
      }

      setMasterAssetDetailsItem((p) => {
        if (!p || typeof p !== 'object') return p;
        if (Number(p.id || 0) !== id) return p;
        return { ...p, is_regen_locked: 0 };
      });

      setMessage('Cleared. You can now regenerate.');
    } catch (e) {
      setError(e?.message || 'Clear failed');
    } finally {
      setBusy(false);
    }
  };

  const masterCharacterRapport = useMemo(() => {
    if (String(masterAssetDetailsType || '').trim() !== 'character') return null;
    const rp = (masterAssetDetailsRapport && typeof masterAssetDetailsRapport === 'object') ? masterAssetDetailsRapport : { likes: [], dislikes: [], quirks: [], fun_facts: [] };
    const fav = (masterAssetDetailsFavorites && typeof masterAssetDetailsFavorites === 'object') ? masterAssetDetailsFavorites : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' };
    const cleanList = (v) => Array.isArray(v) ? v.map((x) => String(x || '').trim()).filter(Boolean) : [];
    return {
      likes: cleanList(rp.likes),
      dislikes: cleanList(rp.dislikes),
      quirks: cleanList(rp.quirks),
      fun_facts: cleanList(rp.fun_facts),
      favorites: {
        color: String(fav.color || ''),
        snack: String(fav.snack || ''),
        drink: String(fav.drink || ''),
        music: String(fav.music || ''),
        hobby: String(fav.hobby || ''),
        pet: String(fav.pet || ''),
      },
    };
  }, [masterAssetDetailsFavorites, masterAssetDetailsRapport, masterAssetDetailsType]);

  const masterCharacterMissingRequiredImageFields = useMemo(() => {
    if (String(masterAssetDetailsType || '').trim() !== 'character') return [] as string[];
    const f = (masterAssetDetailsFields && typeof masterAssetDetailsFields === 'object') ? masterAssetDetailsFields : {};

    const missing: string[] = [];
    const reqStr = (key: string, label: string) => {
      const v = String((f as any)[key] ?? '').trim();
      if (v === '') missing.push(label);
    };
    const reqAge = (key: string, label: string) => {
      const n = Number((f as any)[key] ?? 0);
      if (!Number.isFinite(n) || n <= 0) missing.push(label);
    };

    reqStr('dob', 'DOB');
    reqAge('age', 'Age');
    reqStr('hometown', 'Hometown');
    reqStr('ethnicity', 'Ethnicity');
    reqStr('mbti', 'MBTI');
    reqStr('height', 'Height');
    reqStr('weight', 'Weight');
    reqStr('eye_color', 'Eye color');
    reqStr('hair_color', 'Hair color');

    return missing;
  }, [masterAssetDetailsFields, masterAssetDetailsType]);

  const [caseAvailableMasterCharacterIds, setCaseAvailableMasterCharacterIds] = useState([]);
  const [caseAvailableMasterLocationIds, setCaseAvailableMasterLocationIds] = useState([]);
  const [caseAvailableMasterWeaponIds, setCaseAvailableMasterWeaponIds] = useState([]);
  const [caseAvailableMasterMotiveIds, setCaseAvailableMasterMotiveIds] = useState([]);

  const loadMasterCharacters = useCallback(async () => {
    if (!isAdmin) {
      setMasterCharacters([]);
      return;
    }
    const mid = Number(mysteryId);
    if (!mid) {
      setMasterCharacters([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get(
        '/api/mystery/admin.php?action=list_master_characters&mystery_id=' + String(mid) + '&include_archived=' + String(masterAssetsIncludeArchived ? 1 : 0)
      );
      setMasterCharacters(Array.isArray(res?.characters) ? res.characters : []);
    } catch (e) {
      setError(e?.message || 'Failed to load master characters');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetsIncludeArchived, mysteryId]);

  const loadVoiceProfiles = useCallback(async () => {
    if (!isAdmin) {
      setVoiceProfiles([]);
      return;
    }
    const mid = Number(mysteryId);
    if (!mid) {
      setVoiceProfiles([]);
      return;
    }
    setError('');
    try {
      const res = await ApiClient.get(
        '/api/mystery/admin.php?action=list_voice_profiles&mystery_id=' + String(mid) + '&include_archived=0'
      );
      setVoiceProfiles(Array.isArray(res?.voice_profiles) ? res.voice_profiles : []);
    } catch (e) {
      setError(e?.message || 'Failed to load voice profiles');
    }
  }, [isAdmin, mysteryId]);

  const loadMasterLocations = useCallback(async () => {
    if (!isAdmin) {
      setMasterLocations([]);
      return;
    }
    const mid = Number(mysteryId);
    if (!mid) {
      setMasterLocations([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get(
        '/api/mystery/admin.php?action=list_master_locations&mystery_id=' + String(mid) + '&include_archived=' + String(masterAssetsIncludeArchived ? 1 : 0)
      );
      setMasterLocations(Array.isArray(res?.locations) ? res.locations : []);
    } catch (e) {
      setError(e?.message || 'Failed to load master locations');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetsIncludeArchived, mysteryId]);

  const upsertMasterCharacter = async (e) => {
    e.preventDefault();
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const name = String(newMasterCharacter.name || '').trim();
    if (!name) {
      setError('Master character name is required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=upsert_master_character', { mystery_id: mid, name, rapport: { likes: [], dislikes: [], quirks: [], fun_facts: [] }, favorites: { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' }, is_archived: 0 });
      await loadMasterCharacters();
      setNewMasterCharacter({ name: '' });
      setMessage('Master character saved.');
    } catch (err) {
      setError(err?.message || 'Failed to save master character');
    } finally {
      setBusy(false);
    }
  };

  const upsertMasterLocation = async (e) => {
    e.preventDefault();
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const name = String(newMasterLocation.name || '').trim();
    if (!name) {
      setError('Master location name is required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const data = {};
      await ApiClient.post('/api/mystery/admin.php?action=upsert_master_location', { mystery_id: mid, name, data, is_archived: 0 });
      await loadMasterLocations();
      setNewMasterLocation({ name: '' });
      setMessage('Master location saved.');
    } catch (err) {
      setError(err?.message || 'Failed to save master location');
    } finally {
      setBusy(false);
    }
  };

  const loadMasterWeapons = useCallback(async () => {
    if (!isAdmin) {
      setMasterWeapons([]);
      return;
    }
    const mid = Number(mysteryId);
    if (!mid) {
      setMasterWeapons([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get(
        '/api/mystery/admin.php?action=list_master_weapons&mystery_id=' + String(mid) + '&include_archived=' + String(masterAssetsIncludeArchived ? 1 : 0)
      );
      setMasterWeapons(Array.isArray(res?.weapons) ? res.weapons : []);
    } catch (e) {
      setError(e?.message || 'Failed to load master weapons');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetsIncludeArchived, mysteryId]);

  const loadMasterMotives = useCallback(async () => {
    if (!isAdmin) {
      setMasterMotives([]);
      return;
    }
    const mid = Number(mysteryId);
    if (!mid) {
      setMasterMotives([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get(
        '/api/mystery/admin.php?action=list_master_motives&mystery_id=' + String(mid) + '&include_archived=' + String(masterAssetsIncludeArchived ? 1 : 0)
      );
      setMasterMotives(Array.isArray(res?.motives) ? res.motives : []);
    } catch (e) {
      setError(e?.message || 'Failed to load master motives');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, masterAssetsIncludeArchived, mysteryId]);

  const backfillMasterAssetColumnsFromJson = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=backfill_master_asset_columns_from_json', {
        mystery_id: mid,
        types: ['character', 'location', 'weapon'],
      });
      const rep = (res && typeof res === 'object') ? res.report : null;
      const msg = rep
        ? ('Imported from JSON. Characters updated: ' + String(rep.characters_updated || 0)
          + ', Locations updated: ' + String(rep.locations_updated || 0)
          + ', Weapons updated: ' + String(rep.weapons_updated || 0) + '.')
        : 'Imported from JSON.';
      setMessage(msg);
      await loadMasterCharacters();
      await loadMasterLocations();
      await loadMasterWeapons();
    } catch (e) {
      setError(e?.message || 'Import failed');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, loadMasterCharacters, loadMasterLocations, loadMasterWeapons, mysteryId]);

  const cleanupMasterOnlyFieldsForMystery = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }

    const ok = window.confirm('Run cleanup across ALL cases for this mystery? This removes address/aliases/eye_color/weight/hair_color from case entity JSON and is safe to re-run.');
    if (!ok) return;

    setError('');
    setMessage('');
    setBusy(true);
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=cleanup_master_only_fields_for_mystery', {
        mystery_id: mid,
      });
      const rep = res?.report;
      const updated = Number(rep?.entities_updated || 0) || 0;
      const scanned = Number(rep?.entities_scanned || 0) || 0;

      const audit = (rep && typeof rep === 'object') ? rep.audit : null;
      const tpBefore = (audit && typeof audit === 'object') ? audit.target_paths_before : null;
      const tpAfter = (audit && typeof audit === 'object') ? audit.target_paths_after : null;
      const anyBefore = (audit && typeof audit === 'object') ? audit.anywhere_keys_before : null;
      const anyAfter = (audit && typeof audit === 'object') ? audit.anywhere_keys_after : null;

      const keys = ['address', 'aliases', 'eye_color', 'weight', 'hair_color', 'hair'];
      const fmtCounts = (obj) => {
        if (!obj || typeof obj !== 'object') return '';
        const parts = [];
        for (const k of keys) {
          const n = Number(obj[k] || 0) || 0;
          if (n > 0) parts.push(`${k}:${n}`);
        }
        return parts.join(', ');
      };

      const tpB = fmtCounts(tpBefore);
      const tpA = fmtCounts(tpAfter);
      const anyB = fmtCounts(anyBefore);
      const anyA = fmtCounts(anyAfter);

      const msgParts = [`Cleanup complete. Updated ${updated} of ${scanned} case characters.`];
      if (audit && typeof audit === 'object') {
        msgParts.push(`Target paths before: ${tpB || '0'}; after: ${tpA || '0'}.`);
        msgParts.push(`Anywhere in JSON before: ${anyB || '0'}; after: ${anyA || '0'}.`);
      }

      setMessage(msgParts.join(' '));
    } catch (e) {
      setError(e?.message || 'Cleanup failed');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, mysteryId]);

  const linkAndImportCaseDetailsForMystery = useCallback(async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }

    const ok = window.confirm('Run link+import across ALL cases for this mystery? This will link case characters to master assets and import missing booking fields into the master asset library (fills blanks only).');
    if (!ok) {
      setError('');
      setMessage('Link+import cancelled.');
      return;
    }

    setError('');
    setMessage('Running link+import');
    setBusy(true);
    try {
      const timeoutMs = 120000;
      const res = await Promise.race([
        ApiClient.post('/api/mystery/admin.php?action=link_and_import_case_character_details_for_mystery', {
          mystery_id: mid,
        }),
        new Promise((_, reject) => {
          window.setTimeout(() => reject(new Error('Link+import timed out after ' + String(Math.round(timeoutMs / 1000)) + 's. The server may still be running it; you can refresh and try again, or check server logs.')), timeoutMs);
        }),
      ]);
      const rep = res?.report;
      const casesScanned = Number(rep?.cases_scanned || 0) || 0;
      const entitiesScanned = Number(rep?.entities_scanned || 0) || 0;
      const entitiesLinked = Number(rep?.entities_linked || 0) || 0;
      const mastersUpdated = Number(rep?.masters_updated || 0) || 0;
      const mastersNoop = Number(rep?.masters_noop || 0) || 0;
      const unmatched = Number(rep?.entities_unmatched || 0) || 0;
      const ambiguous = Number(rep?.entities_ambiguous || 0) || 0;

      const fields = (rep && typeof rep === 'object') ? rep.updated_fields_counts : null;
      const fmtFields = (obj) => {
        if (!obj || typeof obj !== 'object') return '0';
        const keys = ['dob', 'age', 'hometown', 'height', 'distinguishing_marks', 'education', 'employment', 'criminal_record'];
        const parts = [];
        for (const k of keys) {
          const n = Number(obj[k] || 0) || 0;
          if (n > 0) parts.push(`${k}:${n}`);
        }
        return parts.length ? parts.join(', ') : '0';
      };

      setMessage(
        'Link+import complete. Cases scanned: ' + String(casesScanned)
        + '. Entities scanned: ' + String(entitiesScanned)
        + ', linked: ' + String(entitiesLinked)
        + ', unmatched: ' + String(unmatched)
        + ', ambiguous: ' + String(ambiguous)
        + '. Masters updated: ' + String(mastersUpdated)
        + ', noop: ' + String(mastersNoop)
        + '. Fields imported: ' + fmtFields(fields) + '.'
      );

      await loadMasterCharacters();
    } catch (e) {
      setError(e?.message || 'Link+import failed');
    } finally {
      setBusy(false);
    }
  }, [isAdmin, loadMasterCharacters, mysteryId]);

  useEffect(() => {
    if (!assetLibraryOpen) return;
    if (!isAdmin) return;
    loadMasterCharacters();
    loadMasterLocations();
    loadMasterWeapons();
    loadMasterMotives();
    loadVoiceProfiles();
  }, [assetLibraryOpen, isAdmin, loadMasterCharacters, loadMasterLocations, loadMasterWeapons, loadMasterMotives, loadVoiceProfiles]);

  useEffect(() => {
    if (!mysteriesModalOpen) return;
    loadStoryBookEntries();
  }, [loadStoryBookEntries, mysteriesModalOpen]);

  const upsertMasterWeapon = async (e) => {
    e.preventDefault();
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const name = String(newMasterWeapon.name || '').trim();
    if (!name) {
      setError('Master weapon name is required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const data = {};
      await ApiClient.post('/api/mystery/admin.php?action=upsert_master_weapon', { mystery_id: mid, name, data, is_archived: 0 });
      await loadMasterWeapons();
      setNewMasterWeapon({ name: '' });
      setMessage('Master weapon saved.');
    } catch (err) {
      setError(err?.message || 'Failed to save master weapon');
    } finally {
      setBusy(false);
    }
  };

  const upsertMasterMotive = async (e) => {
    e.preventDefault();
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const name = String(newMasterMotive.name || '').trim();
    if (!name) {
      setError('Master motive name is required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const data = {};
      await ApiClient.post('/api/mystery/admin.php?action=upsert_master_motive', { mystery_id: mid, name, data, is_archived: 0 });
      await loadMasterMotives();
      setNewMasterMotive({ name: '' });
      setMessage('Master motive saved.');
    } catch (err) {
      setError(err?.message || 'Failed to save master motive');
    } finally {
      setBusy(false);
    }
  };

  const archiveMasterAsset = async ({ type, id, is_archived }) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const rid = Number(id || 0);
    if (!rid) return;
    const t = String(type || '').trim();
    let action = '';
    if (t === 'character') action = 'archive_master_character';
    else if (t === 'location') action = 'archive_master_location';
    else if (t === 'weapon') action = 'archive_master_weapon';
    else if (t === 'motive') action = 'archive_master_motive';
    else return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=' + action, { mystery_id: mid, id: rid, is_archived: is_archived ? 1 : 0 });
      if (t === 'character') await loadMasterCharacters();
      else if (t === 'location') await loadMasterLocations();
      else if (t === 'weapon') await loadMasterWeapons();
      else if (t === 'motive') await loadMasterMotives();
      setMessage(is_archived ? 'Archived.' : 'Restored.');
    } catch (e) {
      setError(e?.message || 'Failed to update asset');
    } finally {
      setBusy(false);
    }
  };

  const requestMasterAssetDelete = ({ type, item }) => {
    if (!isAdmin) return;
    const t = String(type || '').trim();
    const it = (item && typeof item === 'object') ? item : null;
    if (!t || !it) return;
    if (!Number(it.is_archived || 0)) {
      setError('Only archived assets can be deleted.');
      return;
    }

    setPendingMasterDelete({ type: t, item: it });
    showModalNow(masterDeleteConfirmRef, masterDeleteConfirmApiRef);
  };

  const confirmMasterAssetDelete = async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const pending = (pendingMasterDelete && typeof pendingMasterDelete === 'object') ? pendingMasterDelete : null;
    const t = String(pending?.type || '').trim();
    const it = (pending?.item && typeof pending?.item === 'object') ? pending.item : null;
    if (!it) return;
    const rid = Number(it.id || 0);
    if (!rid) return;
    if (!Number(it.is_archived || 0)) {
      setError('Only archived assets can be deleted.');
      return;
    }

    let action = '';
    if (t === 'character') action = 'delete_master_character';
    else if (t === 'location') action = 'delete_master_location';
    else if (t === 'weapon') action = 'delete_master_weapon';
    else if (t === 'motive') action = 'delete_master_motive';
    else return;

    setPendingMasterDelete(null);

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=' + action, { mystery_id: mid, id: rid });
      if (t === 'character') await loadMasterCharacters();
      else if (t === 'location') await loadMasterLocations();
      else if (t === 'weapon') await loadMasterWeapons();
      else if (t === 'motive') await loadMasterMotives();
      setMessage('Deleted.');

      const modal = masterDeleteConfirmApiRef.current;
      if (modal) modal.hide();
    } catch (e) {
      setError(e?.message || 'Failed to delete asset');
    } finally {
      setBusy(false);
    }
  };

  const setMasterAssetRegenLock = async ({ type, item, is_regen_locked }) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const t = String(type || '').trim();
    const it = (item && typeof item === 'object') ? item : null;
    if (!it) return;
    const id = Number(it.id || 0);
    if (!id) return;
    const nextLocked = (Number(is_regen_locked || 0) ? 1 : 0);

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=set_master_regen_lock', { mystery_id: mid, type: t, id, is_regen_locked: nextLocked });

      if (t === 'character') await loadMasterCharacters();
      else if (t === 'location') await loadMasterLocations();
      else if (t === 'weapon') await loadMasterWeapons();
      else if (t === 'motive') await loadMasterMotives();

      setMasterAssetDetailsItem((prev) => {
        const p = (prev && typeof prev === 'object') ? prev : null;
        if (!p) return prev;
        if (String(masterAssetDetailsType || '') !== t) return prev;
        if (Number(p.id || 0) !== id) return prev;
        return { ...p, is_regen_locked: nextLocked };
      });

      setMessage(nextLocked ? 'Locked from regeneration.' : 'Unlocked for regeneration.');
    } catch (e) {
      setError(e?.message || 'Failed to update lock');
    } finally {
      setBusy(false);
    }
  };

  const saveMasterAssetDetails = async () => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const t = String(masterAssetDetailsType || '').trim();
    const item = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    if (!item) return;

    const id = Number(item.id || 0);
    const slug = String(item.slug || '').trim();
    const name = String(masterAssetDetailsName || '').trim();
    if (!slug || !name) {
      setError('Name is required.');
      return;
    }

    let action = '';
    if (t === 'character') action = 'upsert_master_character';
    else if (t === 'location') action = 'upsert_master_location';
    else if (t === 'weapon') action = 'upsert_master_weapon';
    else if (t === 'motive') action = 'upsert_master_motive';
    else return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const f: any = (masterAssetDetailsFields && typeof masterAssetDetailsFields === 'object') ? masterAssetDetailsFields : {};
      const payload: any = {
        mystery_id: mid,
        id,
        slug,
        name,
        is_archived: Number(item.is_archived || 0) ? 1 : 0,
      };

      if (t !== 'character') {
        const dataObj = getMasterAssetDataObject();
        payload.description = String(dataObj.description || '');
        payload.items = Array.isArray(dataObj.items) ? dataObj.items : [];
        payload.image = (dataObj.image && typeof dataObj.image === 'object' && !Array.isArray(dataObj.image)) ? dataObj.image : null;
      }

      if (t === 'character') {
        payload.agent_id = Number(f.agent_id || 0) || 0;
        payload.voice_profile_id = Number(f.voice_profile_id || 0) || 0;
        payload.dob = String(f.dob || '');
        payload.age = Number(f.age || 0) || 0;
        payload.hometown = String(f.hometown || '');
        payload.address = String(f.address || '');
        payload.ethnicity = String(f.ethnicity || '');
        payload.zodiac = String(f.zodiac || '');
        payload.mbti = String(f.mbti || '');
        payload.height = String(f.height || '');
        payload.weight = String(f.weight || '');
        payload.eye_color = String(f.eye_color || '');
        payload.hair_color = String(f.hair_color || '');
        payload.distinguishing_marks = String(f.distinguishing_marks || '');
        payload.education = String(f.education || '');
        payload.employment = Array.isArray(f.employment) ? f.employment.map((x) => String(x || '').trim()).filter(Boolean) : [];
        payload.aliases = Array.isArray(f.aliases) ? f.aliases.map((x) => String(x || '').trim()).filter(Boolean) : [];
        payload.criminal_record = String(f.criminal_record || '');

        payload.rapport = {
          likes: Array.isArray(masterAssetDetailsRapport?.likes) ? masterAssetDetailsRapport.likes.map((x) => String(x || '').trim()).filter(Boolean) : [],
          dislikes: Array.isArray(masterAssetDetailsRapport?.dislikes) ? masterAssetDetailsRapport.dislikes.map((x) => String(x || '').trim()).filter(Boolean) : [],
          quirks: Array.isArray(masterAssetDetailsRapport?.quirks) ? masterAssetDetailsRapport.quirks.map((x) => String(x || '').trim()).filter(Boolean) : [],
          fun_facts: Array.isArray(masterAssetDetailsRapport?.fun_facts) ? masterAssetDetailsRapport.fun_facts.map((x) => String(x || '').trim()).filter(Boolean) : [],
        };
        payload.favorites = {
          color: String(masterAssetDetailsFavorites?.color || ''),
          snack: String(masterAssetDetailsFavorites?.snack || ''),
          drink: String(masterAssetDetailsFavorites?.drink || ''),
          music: String(masterAssetDetailsFavorites?.music || ''),
          hobby: String(masterAssetDetailsFavorites?.hobby || ''),
          pet: String(masterAssetDetailsFavorites?.pet || ''),
        };
      } else if (t === 'location') {
        payload.location_id = String(f.location_id || '');
        payload.address_line1 = String(f.address_line1 || '');
        payload.address_line2 = String(f.address_line2 || '');
        payload.city = String(f.city || '');
        payload.region = String(f.region || '');
        payload.postal_code = String(f.postal_code || '');
        payload.country = String(f.country || '');
        payload.base_image_prompt = String(f.base_image_prompt || '');
        payload.overlay_asset_prompt = String(f.overlay_asset_prompt || '');
        payload.overlay_trigger = String(f.overlay_trigger || '');
      } else if (t === 'weapon') {
        payload.fingerprints = Array.isArray(f.fingerprints) ? f.fingerprints.map((x) => String(x || '').trim()).filter(Boolean) : [];
      } else if (t === 'motive') {
        // no extra curated fields currently
      }

      await ApiClient.post('/api/mystery/admin.php?action=' + action, payload);

      setMasterAssetDetailsItem((prev) => {
        const p = (prev && typeof prev === 'object') ? prev : {};
        if (t === 'character') {
          return { ...p, name, ...payload };
        }
        const dataObj = getMasterAssetDataObject();
        return { ...p, name, description: payload.description, items: payload.items, image: payload.image, ...payload, data: dataObj };
      });

      setMasterAssetNameDrafts((prev) => {
        const key = String(t || '') + ':' + String(id || '');
        if (!prev || typeof prev !== 'object' || !Object.prototype.hasOwnProperty.call(prev, key)) return prev;
        const next = { ...prev };
        delete next[key];
        return next;
      });

      masterAssetDetailsCleanSnapshotRef.current = buildMasterAssetDetailsSnapshot();

      if (t === 'character') await loadMasterCharacters();
      else if (t === 'location') await loadMasterLocations();
      else if (t === 'weapon') await loadMasterWeapons();
      else if (t === 'motive') await loadMasterMotives();

      setMessage('Saved.');
    } catch (e) {
      setError(e?.message || 'Failed to save');
    } finally {
      setBusy(false);
    }
  };

  const openMasterAssetDetails = ({ type, item }) => {
    const t = String(type || '').trim();
    const it = (item && typeof item === 'object') ? item : null;
    if (!it) return;
    setMasterAssetDetailsType(t);
    setMasterAssetDetailsItem(it);
    setMasterAssetDetailsName(String(it.name || ''));
    setMasterAssetDetailsLocks({});
    setMasterAssetDetailsFields({
      agent_id: Number(it.agent_id || 0) || 0,
      voice_profile_id: Number(it.voice_profile_id || 0) || 0,
      dob: String(it.dob || ''),
      age: Number(it.age || 0) || 0,
      hometown: String(it.hometown || ''),
      address: String(it.address || ''),
      ethnicity: String(it.ethnicity || ''),
      zodiac: String(it.zodiac || ''),
      mbti: String(it.mbti || ''),
      height: String(it.height || ''),
      weight: String(it.weight || ''),
      eye_color: String(it.eye_color || ''),
      hair_color: String(it.hair_color || ''),
      distinguishing_marks: String(it.distinguishing_marks || ''),
      education: String(it.education || ''),
      employment: Array.isArray(it.employment) ? it.employment : [],
      aliases: Array.isArray(it.aliases) ? it.aliases : [],
      criminal_record: String(it.criminal_record || ''),
      location_id: String(it.location_id || ''),
      address_line1: String(it.address_line1 || ''),
      address_line2: String(it.address_line2 || ''),
      city: String(it.city || ''),
      region: String(it.region || ''),
      postal_code: String(it.postal_code || ''),
      country: String(it.country || ''),
      base_image_prompt: String(it.base_image_prompt || ''),
      overlay_asset_prompt: String(it.overlay_asset_prompt || ''),
      overlay_trigger: String(it.overlay_trigger || ''),
      description: String(it.description || ''),
      fingerprints: Array.isArray(it.fingerprints) ? it.fingerprints : [],
    });
    if (t === 'character') {
      const rp = (it.rapport && typeof it.rapport === 'object') ? it.rapport : { likes: [], dislikes: [], quirks: [], fun_facts: [] };
      const fav = (it.favorites && typeof it.favorites === 'object') ? it.favorites : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' };
      setMasterAssetDetailsRapport({
        likes: Array.isArray(rp.likes) ? rp.likes : [],
        dislikes: Array.isArray(rp.dislikes) ? rp.dislikes : [],
        quirks: Array.isArray(rp.quirks) ? rp.quirks : [],
        fun_facts: Array.isArray(rp.fun_facts) ? rp.fun_facts : [],
      });
      setMasterAssetDetailsFavorites({
        color: String(fav.color || ''),
        snack: String(fav.snack || ''),
        drink: String(fav.drink || ''),
        music: String(fav.music || ''),
        hobby: String(fav.hobby || ''),
        pet: String(fav.pet || ''),
      });
      setMasterAssetDetailsData({ description: '', items: [], image: null });
      loadMasterCharacterImages({ mystery_id: Number(mysteryId), id: Number(it.id || 0) });
      setMasterCharacterIrEmotionEnabled(() => {
        const next: Record<string, boolean> = {};
        for (const emo of masterCharacterIrEmotions) next[emo] = true;
        return next;
      });
    } else {
      setMasterAssetDetailsData({
        description: String(it.description || it?.data?.description || ''),
        items: Array.isArray(it.items || it?.data?.items) ? (it.items || it.data.items) : [],
        image: (it.image && typeof it.image === 'object' && !Array.isArray(it.image)) ? it.image : null,
      });
    }

    window.setTimeout(() => {
      masterAssetDetailsCleanSnapshotRef.current = buildMasterAssetDetailsSnapshot();
    }, 0);

    loadMasterAssetFieldLocks({ mystery_id: Number(mysteryId), type: t, id: Number(it.id || 0) });
    setMasterAssetDetailsOpen(true);
    showModalNow(masterAssetDetailsRef, masterAssetDetailsApiRef);
  };

  useEffect(() => {
    if (String(masterAssetDetailsType || '').trim() !== 'character') return;
    const urls = Array.isArray(masterCharacterIrUrls) ? masterCharacterIrUrls : [];
    if (urls.length <= 1) return;
    const timer = window.setInterval(() => {
      setMasterCharacterIrIndex((prev) => {
        const next = (Number(prev || 0) + 1) % urls.length;
        return next;
      });
    }, 8000);
    return () => {
      try { window.clearInterval(timer); } catch (_e) {}
    };
  }, [masterAssetDetailsType, masterCharacterIrUrls]);

  const updateMasterAssetNameDraft = ({ type, id, value }) => {
    const key = String(type || '') + ':' + String(id || '');
    setMasterAssetNameDrafts((prev) => ({ ...prev, [key]: String(value || '') }));
  };

  const getMasterAssetNameDraft = ({ type, id, fallback }) => {
    const key = String(type || '') + ':' + String(id || '');
    const v = masterAssetNameDrafts && Object.prototype.hasOwnProperty.call(masterAssetNameDrafts, key)
      ? masterAssetNameDrafts[key]
      : undefined;
    if (typeof v === 'string') return v;
    return String(fallback || '');
  };

  const saveMasterAssetInlineName = async ({ type, item }) => {
    if (!isAdmin) return;
    const mid = Number(mysteryId);
    if (!mid) {
      setError('Select a mystery first.');
      return;
    }
    const t = String(type || '').trim();
    const it = (item && typeof item === 'object') ? item : null;
    if (!it) return;
    const id = Number(it.id || 0);
    const slug = String(it.slug || '').trim();
    if (!id || !slug) return;

    const nextName = String(getMasterAssetNameDraft({ type: t, id, fallback: it.name }) || '').trim();
    const currentName = String(it.name || '').trim();
    if (!nextName || nextName === currentName) return;

    let action = '';
    if (t === 'character') action = 'upsert_master_character';
    else if (t === 'location') action = 'upsert_master_location';
    else if (t === 'weapon') action = 'upsert_master_weapon';
    else if (t === 'motive') action = 'upsert_master_motive';
    else return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const payload: any = {
        mystery_id: mid,
        id,
        slug,
        name: nextName,
        is_archived: Number(it.is_archived || 0) ? 1 : 0,
      };
      if (t !== 'character') {
        payload.data = (it.data && typeof it.data === 'object') ? it.data : {};
      }
      await ApiClient.post('/api/mystery/admin.php?action=' + action, payload);

      setMasterAssetNameDrafts((prev) => {
        const key = String(t || '') + ':' + String(id || '');
        if (!prev || typeof prev !== 'object' || !Object.prototype.hasOwnProperty.call(prev, key)) return prev;
        const next = { ...prev };
        delete next[key];
        return next;
      });

      if (t === 'character') await loadMasterCharacters();
      else if (t === 'location') await loadMasterLocations();
      else if (t === 'weapon') await loadMasterWeapons();
      else if (t === 'motive') await loadMasterMotives();
    } catch (e) {
      setError(e?.message || 'Failed to save');
    } finally {
      setBusy(false);
    }
  };

  const saveCaseSetup = async () => {
    const sid = Number(scenarioId);
    if (!sid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const currentSpecs = (scenario && typeof scenario === 'object' && scenario.specs && typeof scenario.specs === 'object') ? scenario.specs : {};
      const nextSpecs = {
        ...currentSpecs,
        case_setup: {
          ...(currentSpecs.case_setup && typeof currentSpecs.case_setup === 'object' ? currentSpecs.case_setup : {}),
          available_master_character_ids: caseAvailableMasterCharacterIds,
          available_master_location_ids: caseAvailableMasterLocationIds,
          available_master_weapon_ids: caseAvailableMasterWeaponIds,
          available_master_motive_ids: caseAvailableMasterMotiveIds,
        },
      };
      await ApiClient.post('/api/mystery/admin.php?action=update_scenario', { id: sid, specs: nextSpecs });
      await loadScenario(sid);
      setMessage('Case setup saved.');
    } catch (e) {
      setError(e?.message || 'Failed to save case setup');
    } finally {
      setBusy(false);
    }
  };

  const [caseNotes, setCaseNotes] = useState([]);
  const [caseNoteId, setCaseNoteId] = useState('');
  const [caseNote, setCaseNote] = useState(null);
  const [caseNoteDraft, setCaseNoteDraft] = useState(
    JSON.stringify(
      { blocks: [{ style: 'typed', text: '' }], tags: [], annotations: [] },
      null,
      2
    )
  );
  const [caseNoteTitle, setCaseNoteTitle] = useState('');
  const [caseNoteType, setCaseNoteType] = useState('case_file');
  const [caseNoteClueCount, setCaseNoteClueCount] = useState('2');

  const [lies, setLies] = useState([]);
  const [newLie, setNewLie] = useState({ entity_id: '', lie_type: 'white_lie', topic_key: '', relevance: 'low' });
  const [newLieTriggerText, setNewLieTriggerText] = useState('[]');
  const [newLieLieText, setNewLieLieText] = useState('');
  const [newLieTruthText, setNewLieTruthText] = useState('');
  const [newLieNotes, setNewLieNotes] = useState('');

  const [images, setImages] = useState([]);
  const [newImage, setNewImage] = useState({ image_type: 'crime_scene', title: '', provider: '', model: '', status: 'missing' });
  const [newImagePrompt, setNewImagePrompt] = useState('');
  const [newImageNegativePrompt, setNewImageNegativePrompt] = useState('');
  const [newImageParamsText, setNewImageParamsText] = useState('{}');

  const loadScenarioEntities = async (sid) => {
    const id = Number(sid);
    if (!id) {
      setScenarioEntities([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_scenario_entities&scenario_id=' + String(id));
      setScenarioEntities(Array.isArray(res?.scenario_entities) ? res.scenario_entities : []);
    } catch (e) {
      setError(e?.message || 'Failed to load scenario cast');
    } finally {
      setBusy(false);
    }
  };

  const loadInterrogationEvents = async (sid) => {
    const id = Number(sid);
    if (!id) {
      setInterrogationEvents([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_interrogation_events&scenario_id=' + String(id));
      setInterrogationEvents(Array.isArray(res?.events) ? res.events : []);
    } catch (e) {
      setError(e?.message || 'Failed to load interrogation log');
    } finally {
      setBusy(false);
    }
  };

  const askSuspect = async (e) => {
    e.preventDefault();
    const sid = Number(scenarioId);
    const eid = Number(interviewEntityId);
    const q = String(interviewQuestion || '').trim();
    if (!sid || !eid || !q) {
      setError('Scenario, suspect, and question are required.');
      return;
    }

    setBusy(true);
    setError('');
    setMessage('');
    setInterviewAnswer('');
    setInterviewAudioUrl('');
    setInterviewMeta(null);

    try {
      const wantTts = Boolean(interviewTtsEnabled);
      const res = await ApiClient.post('/api/mystery/interrogate.php', {
        scenario_id: sid,
        entity_id: eid,
        question_text: q,
        tts_enabled: wantTts ? 1 : 0,
      });
      setInterviewAnswer(String(res?.answer_text || ''));
      const ttsErr = String(res?.meta?.tts_error || '').trim();
      if (wantTts && ttsErr) disableTtsWithToast(ttsErr);
      setInterviewAudioUrl((wantTts && ttsErr) ? '' : String(res?.audio_url || ''));
      setInterviewMeta(res?.meta || null);
      setInterviewQuestion('');
      await loadInterrogationEvents(sid);
      await loadConversationEvents({ silent: true });
      setMessage('Interrogation recorded.');
    } catch (err) {
      setError(err?.message || 'Failed to interrogate suspect');
    } finally {
      setBusy(false);
    }
  };

  const loadJobs = async (cid) => {
    const id = Number(cid);
    if (!id) {
      setJobs([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_jobs&case_id=' + String(id));
      setJobs(Array.isArray(res?.jobs) ? res.jobs : []);
    } catch (e) {
      setError(e?.message || 'Failed to load jobs');
    } finally {
      setBusy(false);
    }
  };

  const deleteQueuedJob = async (jobId) => {
    const cid = Number(caseId);
    const jid = Number(jobId);
    if (!cid || !jid) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=delete_job', {
        case_id: cid,
        job_id: jid,
      });
      setDeleteJobArmedId(0);
      await loadJobs(cid);
      setMessage('Job deleted from queue.');
    } catch (e) {
      setError(e?.message || 'Failed to delete job');
    } finally {
      setBusy(false);
    }
  };

  const clearQueuedJobs = async () => {
    const cid = Number(caseId);
    if (!cid) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=clear_queue', {
        case_id: cid,
        scenario_id: 0,
      });
      setClearQueueArmed(false);
      await loadJobs(cid);
      setMessage('Queued jobs cleared.');
    } catch (e) {
      setError(e?.message || 'Failed to clear queue');
    } finally {
      setBusy(false);
    }
  };

  const clearCompletedJobs = async () => {
    const cid = Number(caseId);
    if (!cid) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=clear_completed_jobs', {
        case_id: cid,
      });
      await loadJobs(cid);
      setMessage('Completed jobs cleared.');
    } catch (e) {
      setError(e?.message || 'Failed to clear completed jobs');
    } finally {
      setBusy(false);
    }
  };

  const loadCaseNotes = async (sid) => {
    const id = Number(sid);
    if (!id) {
      setCaseNotes([]);
      setCaseNoteId('');
      setCaseNote(null);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_case_notes&scenario_id=' + String(id));
      const list = Array.isArray(res?.case_notes) ? res.case_notes : [];
      setCaseNotes(list);
      if (!caseNoteId && list.length) {
        const firstCaseFile = list.find((n) => String(n?.note_type || '') === 'case_file');
        if (firstCaseFile?.id) setCaseNoteId(String(firstCaseFile.id));
        else setCaseNoteId(String(list[0].id));
      }
    } catch (e) {
      setError(e?.message || 'Failed to load case notes');
    } finally {
      setBusy(false);
    }
  };

  const loadPlayTemplatesAndResumables = async () => {
    setPlayBusy(true);
    setPlayError('');
    try {
      const [tpl, res] = await Promise.all([
        ApiClient.get('/api/mystery/play.php?action=list_templates'),
        ApiClient.get('/api/mystery/play.php?action=list_resumable'),
      ]);
      setPlayTemplates(Array.isArray(tpl?.templates) ? tpl.templates : []);
      setPlayResumables(Array.isArray(res?.items) ? res.items : []);
    } catch (e) {
      setPlayError(e?.message || 'Failed to load templates/resumable cases');
    } finally {
      setPlayBusy(false);
    }
  };

  const resumeScenarioNow = async ({ caseId: cid, scenarioId: sid, title }) => {
    const c = Number(cid);
    const s = Number(sid);
    if (!c || !s) return;
    setError('');
    setMessage('');
    try {
      setCaseId(String(c));
      setScenarioId(String(s));
      setMessage(String(title || 'Resumed.') || 'Resumed.');
      setStartResumeTab('caseboard');
    } catch (e) {
      setError(e?.message || 'Failed to resume');
    }
  };

  const createCaseInstanceFromTemplate = async () => {
    const templateCaseId = Number(playTemplateCaseId);
    if (!templateCaseId) {
      setPlayError('Select a template case.');
      return;
    }
    const newTitle = String(playNewCaseTitle || '').trim();
    if (!newTitle) {
      setPlayError('New title is required.');
      return;
    }

    setPlayBusy(true);
    setPlayError('');
    setError('');
    setMessage('');
    try {
      const template = (Array.isArray(playTemplates) ? playTemplates : []).find((t) => Number(t?.id || 0) === templateCaseId) || null;
      const templateMysteryId = Number(template?.mystery_id || 0);
      if (templateMysteryId > 0) setMysteryId(String(templateMysteryId));

      const res = await ApiClient.post('/api/mystery/play.php?action=create_case_instance', {
        template_case_id: templateCaseId,
        new_title: newTitle,
      });

      const newCaseId = Number(res?.case_id || 0);
      const scenarioIds = Array.isArray(res?.scenario_ids) ? res.scenario_ids : [];
      const firstScenarioId = Number(scenarioIds[0] || 0);
      if (newCaseId <= 0) throw new Error('Case creation succeeded but case_id was missing');

      setCaseId(String(newCaseId));
      if (firstScenarioId > 0) setScenarioId(String(firstScenarioId));
      setPlayNewCaseTitle('');
      setMessage('Created new case instance.');
      setStartResumeTab('caseboard');
      await loadPlayTemplatesAndResumables();
    } catch (e) {
      setPlayError(e?.message || 'Failed to create case instance');
    } finally {
      setPlayBusy(false);
    }
  };

  const loadCaseNote = async (id) => {
    const noteId = Number(id);
    if (!noteId) {
      setCaseNote(null);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_case_note&id=' + String(noteId));
      const note = res?.case_note || null;
      setCaseNote(note);
      setCaseNoteTitle(String(note?.title || ''));
      setCaseNoteType(String(note?.note_type || 'case_file'));
      setCaseNoteClueCount(String(note?.clue_count ?? 0));
      setCaseNoteDraft(JSON.stringify(note?.content_rich || {}, null, 2));
    } catch (e) {
      setError(e?.message || 'Failed to load case note');
    } finally {
      setBusy(false);
    }
  };

  const saveCaseNote = async () => {
    const sid = Number(scenarioId);
    const id = Number(caseNoteId);
    if (!sid) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const content = JSON.parse(String(caseNoteDraft || '{}'));
      const title = String(caseNoteTitle || '').trim();
      const noteType = String(caseNoteType || '').trim();
      const clueCount = Number(caseNoteClueCount);
      if (!title) throw new Error('Title is required');
      if (!noteType) throw new Error('Note type is required');
      if (!id) {
        const res = await ApiClient.post('/api/mystery/admin.php?action=create_case_note', {
          scenario_id: sid,
          title,
          note_type: noteType,
          clue_count: Number.isFinite(clueCount) ? clueCount : 0,
          content_rich: content,
        });
        await loadCaseNotes(sid);
        if (res?.id) setCaseNoteId(String(res.id));
        setMessage('Case note created.');
        return;
      }

      await ApiClient.post('/api/mystery/admin.php?action=update_case_note', {
        id,
        title,
        note_type: noteType,
        clue_count: Number.isFinite(clueCount) ? clueCount : 0,
        content_rich: content,
      });
      await loadCaseNotes(sid);
      await loadCaseNote(id);
      setMessage('Case note saved.');
    } catch (e) {
      setError(e?.message || 'Failed to save case note (invalid JSON?)');
    } finally {
      setBusy(false);
    }
  };

  const deleteCaseNote = async () => {
    const sid = Number(scenarioId);
    const id = Number(caseNoteId);
    if (!sid || !id) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=delete_case_note', { id });
      setCaseNoteId('');
      setCaseNote(null);
      await loadCaseNotes(sid);
      setMessage('Case note deleted.');
    } catch (e) {
      setError(e?.message || 'Failed to delete case note');
    } finally {
      setBusy(false);
    }
  };

  const loadLies = async (sid) => {
    const id = Number(sid);
    if (!id) {
      setLies([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_lies&scenario_id=' + String(id));
      setLies(Array.isArray(res?.lies) ? res.lies : []);
    } catch (e) {
      setError(e?.message || 'Failed to load lies');
    } finally {
      setBusy(false);
    }
  };

  const createLie = async (e) => {
    e.preventDefault();
    const sid = Number(scenarioId);
    const entityId = Number(newLie.entity_id);
    if (!sid || !entityId) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const triggerQuestions = JSON.parse(String(newLieTriggerText || '[]'));
      if (!Array.isArray(triggerQuestions)) throw new Error('trigger_questions must be an array');

      await ApiClient.post('/api/mystery/admin.php?action=create_lie', {
        scenario_id: sid,
        entity_id: entityId,
        lie_type: String(newLie.lie_type || '').trim(),
        topic_key: String(newLie.topic_key || '').trim(),
        lie_text: String(newLieLieText || ''),
        truth_text: String(newLieTruthText || ''),
        trigger_questions: triggerQuestions,
        relevance: String(newLie.relevance || 'low'),
        notes: String(newLieNotes || ''),
      });
      await loadLies(sid);
      setNewLie({ entity_id: '', lie_type: 'white_lie', topic_key: '', relevance: 'low' });
      setNewLieTriggerText('[]');
      setNewLieLieText('');
      setNewLieTruthText('');
      setNewLieNotes('');
      setMessage('Lie created.');
    } catch (err) {
      setError(err?.message || 'Failed to create lie');
    } finally {
      setBusy(false);
    }
  };

  const deleteLie = async (id) => {
    const sid = Number(scenarioId);
    const lieId = Number(id);
    if (!sid || !lieId) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=delete_lie', { id: lieId });
      await loadLies(sid);
      setMessage('Lie deleted.');
    } catch (err) {
      setError(err?.message || 'Failed to delete lie');
    } finally {
      setBusy(false);
    }
  };

  const loadImages = async (cid, sid) => {
    const c = Number(cid);
    const scenario = Number(sid);
    if (!c || !scenario) {
      setImages([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_images&case_id=' + String(c) + '&scenario_id=' + String(scenario));
      setImages(Array.isArray(res?.images) ? res.images : []);
    } catch (e) {
      setError(e?.message || 'Failed to load images');
    } finally {
      setBusy(false);
    }
  };

  const createImage = async (e) => {
    e.preventDefault();
    const cid = Number(caseId);
    const sid = Number(scenarioId);
    if (!cid || !sid) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const params = JSON.parse(String(newImageParamsText || '{}'));

      const imageType = String(newImage.image_type || '').trim();
      let styleKind: 'generic' | 'location' | 'mugshot' | 'weapon' = 'generic';
      if (imageType.includes('mugshot')) styleKind = 'mugshot';
      else if (imageType.includes('weapon')) styleKind = 'weapon';
      else if (imageType.includes('location')) styleKind = 'location';
      const promptStyled = buildStyledImagePrompt({ promptText: String(newImagePrompt || ''), kind: styleKind });

      await ApiClient.post('/api/mystery/admin.php?action=create_image_record', {
        case_id: cid,
        scenario_id: sid,
        image_type: imageType,
        title: String(newImage.title || '').trim(),
        prompt_text: promptStyled,
        negative_prompt_text: String(newImageNegativePrompt || ''),
        provider: String(newImage.provider || '').trim(),
        model: String(newImage.model || '').trim(),
        params,
        status: String(newImage.status || 'missing'),
        url: '',
        alt_text: '',
        clue_notes: '',
      });
      await loadImages(cid, sid);
      setNewImage({ image_type: 'crime_scene', title: '', provider: '', model: '', status: 'missing' });
      setNewImagePrompt('');
      setNewImageNegativePrompt('');
      setNewImageParamsText('{}');
      setMessage('Image record created.');
    } catch (err) {
      setError(err?.message || 'Failed to create image record');
    } finally {
      setBusy(false);
    }
  };

  const loadMysteries = async () => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_mysteries');
      const list = Array.isArray(res?.mysteries) ? res.mysteries : [];
      setMysteries(list);
      if (!mysteryId && list.length) setMysteryId(String(list[0].id));
    } catch (e) {
      setError(e?.message || 'Failed to load mysteries');
    } finally {
      setBusy(false);
    }
  };

  const loadCases = async (mid) => {
    const id = Number(mid);
    if (!id) {
      setCases([]);
      setCaseId('');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_cases&mystery_id=' + String(id));
      const list = Array.isArray(res?.cases) ? res.cases : [];
      setCases(list);
      if (!caseId && list.length) setCaseId(String(list[0].id));
    } catch (e) {
      setError(e?.message || 'Failed to load cases');
    } finally {
      setBusy(false);
    }
  };

  const loadScenarios = async (cid) => {
    const id = Number(cid);
    if (!id) {
      setScenarios([]);
      setScenarioId('');
      setScenario(null);
      setConstraintsDraft('{}');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_scenarios&case_id=' + String(id));
      const list = Array.isArray(res?.scenarios) ? res.scenarios : [];
      setScenarios(list);
      const current = String(scenarioId || '');
      const exists = current && list.some((s) => String(s?.id) === current);
      if (!exists) {
        setScenarioId(list.length ? String(list[0].id) : '');
      }
    } catch (e) {
      setError(e?.message || 'Failed to load scenarios');
    } finally {
      setBusy(false);
    }
  };

  const loadScenario = async (sid) => {
    const id = Number(sid);
    if (!id) {
      setScenario(null);
      setConstraintsDraft('{}');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_scenario&scenario_id=' + String(id));
      const sc = res?.scenario || null;
      setScenario(sc);
      const constraints = sc?.constraints || {};
      setConstraintsDraft(JSON.stringify(constraints, null, 2));
    } catch (e) {
      setError(e?.message || 'Failed to load scenario');
    } finally {
      setBusy(false);
    }
  };

  const loadScenarioColdHardFacts = async (sid) => {
    const id = Number(sid);
    if (!id) {
      setStoryLongDraft('');
      setStoryAnnotationsDraft('[]');
      setStoryLongSaved('');
      setStoryAnnotationsSaved('[]');
      setColdHardFactsUpdatedAt('');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_scenario_cold_hard_facts&scenario_id=' + String(id));
      const sb = res?.cold_hard_facts || null;
      const longText = String(sb?.cold_hard_facts_text || '');
      const annotations = Array.isArray(sb?.annotations) ? sb.annotations : [];
      setStoryLongDraft(longText);
      setStoryAnnotationsDraft(JSON.stringify(annotations, null, 2));
      setStoryLongSaved(longText);
      setStoryAnnotationsSaved(JSON.stringify(annotations, null, 2));
      setColdHardFactsUpdatedAt(String(sb?.updated_at || ''));
    } catch (e) {
      setError(e?.message || 'Failed to load Cold Hard Facts');
    } finally {
      setBusy(false);
    }
  };

  const loadScenarioColdHardFactsSilent = async (sid) => {
    const id = Number(sid);
    if (!id) return;
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_scenario_cold_hard_facts&scenario_id=' + String(id));
      const sb = res?.cold_hard_facts || null;
      const longText = String(sb?.cold_hard_facts_text || '');
      const annotations = Array.isArray(sb?.annotations) ? sb.annotations : [];
      setStoryLongDraft(longText);
      setStoryAnnotationsDraft(JSON.stringify(annotations, null, 2));
      setStoryLongSaved(longText);
      setStoryAnnotationsSaved(JSON.stringify(annotations, null, 2));
      setColdHardFactsUpdatedAt(String(sb?.updated_at || ''));
    } catch (_e) {
    }
  };

  const saveScenarioColdHardFacts = async () => {
    const sid = Number(scenarioId);
    if (!sid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const parsed = JSON.parse(String(storyAnnotationsDraft || '[]'));
      if (!Array.isArray(parsed)) {
        setError('Annotations must be a JSON array.');
        return;
      }
      await ApiClient.post('/api/mystery/admin.php?action=update_scenario_cold_hard_facts', {
        scenario_id: sid,
        cold_hard_facts_text: String(storyLongDraft || ''),
        annotations: parsed,
      });
      await loadScenarioColdHardFacts(sid);
      setMessage('Cold Hard Facts saved.');
    } catch (e) {
      setError(e?.message || 'Failed to save Cold Hard Facts (invalid JSON?)');
    } finally {
      setBusy(false);
    }
  };

  const storyColdHardFactsDirty = String(storyLongDraft || '') !== String(storyLongSaved || '')
    || String(storyAnnotationsDraft || '') !== String(storyAnnotationsSaved || '');

  const refreshStoryAndColdHardFacts = async () => {
    const sid = Number(scenarioId || 0);
    if (!sid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await loadScenario(sid);
      await loadScenarioColdHardFacts(sid);
    } catch (e) {
      setError((e as any)?.message || 'Failed to refresh');
    } finally {
      setBusy(false);
    }
  };

  const loadJobsSilent = async (cid) => {
    const id = Number(cid);
    if (!id) return [];
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_jobs&case_id=' + String(id));
      return Array.isArray(res?.jobs) ? res.jobs : [];
    } catch (_err) {
      return [];
    }
  };

  useEffect(() => {
    if (!storyGenSync.active) return;
    const cid = Number(caseId || 0);
    const sid = Number(storyGenSyncScenarioIdRef.current || 0);
    if (!cid || !sid) return;

    let alive = true;
    const tick = async () => {
      if (!alive) return;
      const jobsList = await loadJobsSilent(cid);
      const relevant = Array.isArray(jobsList)
        ? jobsList.filter((j: any) => Number(j?.scenario_id || 0) === sid && (String(j?.action || '') === 'generate_crime_details' || String(j?.action || '') === 'generate_story_narrative'))
        : [];

      const crimeJob = relevant.find((j: any) => String(j?.action || '') === 'generate_crime_details') || null;
      const storyJob = relevant.find((j: any) => String(j?.action || '') === 'generate_story_narrative') || null;
      const crimeStatus = String(crimeJob?.status || '').trim();
      const storyStatus = String(storyJob?.status || '').trim();

      const hasError = crimeStatus === 'error' || crimeStatus === 'failed' || storyStatus === 'error' || storyStatus === 'failed';
      const isDone = (crimeStatus === 'done' || crimeStatus === 'skipped' || crimeStatus === 'canceled' || crimeStatus === 'failed' || crimeStatus === 'error')
        && (storyStatus === 'done' || storyStatus === 'skipped' || storyStatus === 'canceled' || storyStatus === 'failed' || storyStatus === 'error');

      setStoryGenSync((prev) => ({
        ...prev,
        crimeStatus,
        storyStatus,
        status: hasError ? 'Generation failed.' : (isDone ? 'Generation complete.' : 'Generating'),
        error: hasError ? (String(storyJob?.error_text || crimeJob?.error_text || '').trim() || 'Generation failed') : '',
        active: isDone ? false : prev.active,
      }));

      if (isDone) {
        try {
          await loadScenario(sid);
          if (!storyColdHardFactsDirty) {
            await loadScenarioColdHardFacts(sid);
          }
        } catch (_err) {
        }
      }
    };

    void tick();
    const t = window.setInterval(() => {
      void tick();
    }, 2500);

    return () => {
      alive = false;
      window.clearInterval(t);
    };
  }, [storyGenSync.active, caseId, storyColdHardFactsDirty]);

  const parseColdHardFactsAnnotations = () => {
    try {
      const parsed = JSON.parse(String(storyAnnotationsDraft || '[]'));
      return Array.isArray(parsed) ? parsed : [];
    } catch (_err) {
      return [];
    }
  };

  const writeColdHardFactsAnnotations = (next) => {
    const safe = Array.isArray(next) ? next : [];
    setStoryAnnotationsDraft(JSON.stringify(safe, null, 2));
  };

  const addColdHardFactsAnnotationFromForm = () => {
    const paragraph = Number(newAnnotation.paragraph || 0);
    if (!paragraph || paragraph < 1) {
      setError('Annotation paragraph must be 1 or greater.');
      return;
    }
    const type = String(newAnnotation.type || '').trim();
    if (!type) {
      setError('Annotation type is required.');
      return;
    }

    const base: any = {
      paragraph,
      type,
      note: String(newAnnotation.note || '').trim(),
    };

    if (type === 'character' || type === 'killer' || type === 'witness') {
      const eid = Number(newAnnotation.entity_id || 0);
      if (!eid) {
        setError('Select a character for this annotation type.');
        return;
      }
      base.entity_id = eid;
    } else if (type === 'lie') {
      const lid = Number(newAnnotation.lie_id || 0);
      if (!lid) {
        setError('Select a lie for this annotation.');
        return;
      }
      base.lie_id = lid;
    } else if (type === 'case_note') {
      const nid = Number(newAnnotation.case_note_id || 0);
      if (!nid) {
        setError('Select a case note for this annotation.');
        return;
      }
      base.case_note_id = nid;
    } else {
      const v = String(newAnnotation.value || '').trim();
      if (v) {
        if (type === 'weapon') base.weapon = v;
        else if (type === 'motive') base.motive = v;
        else if (type === 'location') base.location = v;
        else if (type === 'weather') base.weather = v;
        else base.value = v;
      }
    }

    const prev = parseColdHardFactsAnnotations();
    writeColdHardFactsAnnotations([...prev, base]);
    setNewAnnotation({ paragraph: String(paragraph), type, entity_id: '', lie_id: '', case_note_id: '', value: '', note: '' });
  };

  const removeColdHardFactsAnnotationAt = (idx) => {
    const n = Number(idx);
    if (!Number.isFinite(n) || n < 0) return;
    const prev = parseColdHardFactsAnnotations();
    if (n >= prev.length) return;
    const next = prev.filter((_, i) => i !== n);
    writeColdHardFactsAnnotations(next);
  };

  const runColdHardFactsAudit = async () => {
    const sid = Number(scenarioId);
    if (!sid) return;
    setColdHardFactsAuditBusy(true);
    setError('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=audit_scenario_cold_hard_facts&scenario_id=' + String(sid));
      setColdHardFactsAudit(res?.report || null);
      setColdHardFactsAuditOpen(true);
    } catch (e) {
      setError(e?.message || 'Failed to run Cold Hard Facts audit');
    } finally {
      setColdHardFactsAuditBusy(false);
    }
  };

  const applyColdHardFactsFix = async (fix) => {
    const sid = Number(scenarioId);
    if (!sid) return;
    const action = String(fix?.action || '').trim();
    const payload = (fix && typeof fix === 'object') ? (fix.payload || null) : null;
    if (!action || !payload || typeof payload !== 'object') return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=apply_scenario_cold_hard_facts_fix', {
        scenario_id: sid,
        action,
        payload,
      });

      if (action === 'attach_entity') {
        await loadScenarioEntities(sid);
      }
      await loadScenarioColdHardFacts(sid);
      await runColdHardFactsAudit();
      setMessage('Fix applied.');
    } catch (e) {
      setError(e?.message || 'Failed to apply fix');
    } finally {
      setBusy(false);
    }
  };

  const applyAllColdHardFactsFixes = async () => {
    const sid = Number(scenarioId);
    if (!sid) return;
    if (!applyAllFixesArmed) {
      setError('Arm Apply all fixes first.');
      return;
    }
    const fixes = Array.isArray(coldHardFactsAudit?.quick_fixes) ? coldHardFactsAudit.quick_fixes : [];
    if (!fixes.length) return;

    setApplyAllFixesBusy(true);
    setBusy(true);
    setError('');
    setMessage('');
    try {
      for (const f of fixes) {
        const action = String(f?.action || '').trim();
        const payload = (f && typeof f === 'object') ? (f.payload || null) : null;
        if (!action || !payload || typeof payload !== 'object') continue;
        await ApiClient.post('/api/mystery/admin.php?action=apply_scenario_cold_hard_facts_fix', { scenario_id: sid, action, payload });
      }
      await loadScenarioEntities(sid);
      await loadScenarioColdHardFacts(sid);
      await runColdHardFactsAudit();
      setApplyAllFixesArmed(false);
      setMessage('All fixes applied.');
    } catch (e) {
      setError(e?.message || 'Failed to apply all fixes');
    } finally {
      setBusy(false);
      setApplyAllFixesBusy(false);
    }
  };

  const loadCharacters = async (cid) => {
    const id = Number(cid);
    if (!id) {
      setCharacters([]);
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=list_entities&case_id=' + String(id) + '&entity_type=character&include_data=1');
      setCharacters(Array.isArray(res?.entities) ? res.entities : []);
    } catch (e) {
      setError(e?.message || 'Failed to load characters');
    } finally {
      setBusy(false);
    }
  };

  useEffect(() => {
    if (!isAuthed) return;
    loadMysteries();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isAuthed]);

  useEffect(() => {
    if (!startResumeOpen) return;
    if (!isAuthed) return;
    if (startResumeTab !== 'start') return;
    loadPlayTemplatesAndResumables();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [startResumeOpen, startResumeTab, isAuthed]);

  useEffect(() => {
    if (!isAuthed) return;
    loadCases(mysteryId);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [mysteryId, isAuthed]);

  useEffect(() => {
    if (!mysterySettingsOpen) return;
    if (!isAuthed || !isAdmin) return;
    loadMysterySettings();
    loadTtsVoices();
    loadAgentProfiles();
  }, [mysterySettingsOpen, isAuthed, isAdmin]);

  useEffect(() => {
    if (!isAuthed) return;
    setScenarioId('');
    setScenario(null);
    setConstraintsDraft('{}');
    loadScenarios(caseId);
    loadCharacters(caseId);
    loadJobs(caseId);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [caseId, isAuthed]);

  useEffect(() => {
    if (!isAuthed) return;
    loadScenario(scenarioId);
    loadScenarioEntities(scenarioId);
    loadInterrogationEvents(scenarioId);
    loadCaseNotes(scenarioId);
    loadLies(scenarioId);
    loadScenarioColdHardFacts(scenarioId);
    loadImages(caseId, scenarioId);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [scenarioId, isAuthed]);

  useEffect(() => {
    if (!isAuthed) return;
    if (!scenarioId) {
      setScenarioEntities([]);
      setInterrogationEvents([]);
      setInterviewEntityId('');
      setInterviewQuestion('');
      setInterviewAnswer('');
      setInterviewAudioUrl('');
      setInterviewMeta(null);
      setCaseNotes([]);
      setCaseNoteId('');
      setCaseNote(null);
      setLies([]);
      setImages([]);
      setStoryLongDraft('');
      setStoryAnnotationsDraft('[]');
      setColdHardFactsUpdatedAt('');
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [scenarioId, isAuthed]);

  useEffect(() => {
    if (!scenarioId) return;
    if (String(interviewEntityId || '').trim() !== '') return;
    const first = scenarioEntities.find((se) => {
      const role = String(se?.role || '').trim();
      return role === 'suspect' || role === 'witness' || role === 'killer' || role === 'bystander' || role === 'victim';
    });
    if (first && first.entity_id) {
      setInterviewEntityId(String(first.entity_id));
    }
  }, [scenarioEntities, scenarioId, interviewEntityId]);

  useEffect(() => {
    const el = interviewAudioRef.current;
    if (!el) return;
    try {
      el.pause();
      el.currentTime = 0;
    } catch (_) {
    }
  }, [interviewAudioUrl]);

  useEffect(() => {
    if (!isAuthed) return;
    loadCaseNote(caseNoteId);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [caseNoteId, isAuthed]);

  const createCase = async (e) => {
    e.preventDefault();
    const mid = Number(mysteryId);
    if (!mid) return;
    const title = String(newCase.title || '').trim();
    if (!title) {
      setError('Case title is required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=create_case', { mystery_id: mid, title, description: '' });
      await loadCases(mid);
      if (res?.id) setCaseId(String(res.id));
      setNewCase({ title: '' });
      setMessage('Case created.');
    } catch (e) {
      setError(e?.message || 'Failed to create case');
    } finally {
      setBusy(false);
    }
  };

  const createScenario = async (e) => {
    e.preventDefault();
    const cid = Number(caseId);
    if (!cid) return;
    const title = String(newScenario.title || '').trim();
    if (!title) {
      setError('Crime scene title is required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=create_scenario', { case_id: cid, title, status: 'draft' });
      await loadScenarios(cid);
      const sid = Number(res?.id || 0);
      if (sid) {
        setScenarioId(String(sid));
        try {
          await ApiClient.post('/api/mystery/admin.php?action=bootstrap_scenario', { scenario_id: sid, min_suspects: 8 });
        } catch (err) {
          setError(err?.message || 'Crime scene created, but bootstrap failed');
        }
      }
      setMessage('Crime scene created.');
    } catch (e) {
      setError(e?.message || 'Failed to create crime scene');
    } finally {
      setBusy(false);
    }
  };

  const deleteScenario = async () => {
    const sid = Number(scenarioId);
    const cid = Number(caseId);
    if (!sid || !cid) return;
    if (!deleteScenarioArmed) {
      setError('Arm Delete Crime Scene first.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=delete_scenario', { id: sid });
      setDeleteScenarioArmed(false);
      setScenarioId('');
      setScenario(null);
      await loadScenarios(cid);
      setMessage('Crime scene deleted.');
    } catch (e) {
      setError(e?.message || 'Failed to delete crime scene');
    } finally {
      setBusy(false);
    }
  };

  const reassignScenarioCase = async (nextCaseId) => {
    const sid = Number(scenarioId);
    const nextCid = Number(nextCaseId);
    if (!sid || !nextCid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=reassign_scenario_case', { scenario_id: sid, case_id: nextCid });
      setCaseId(String(nextCid));
      await loadScenarios(nextCid);
      await loadScenario(sid);
      setMessage('Crime scene reassigned.');
    } catch (e) {
      setError(e?.message || 'Failed to reassign crime scene');
    } finally {
      setBusy(false);
    }
  };

  const ensureDefaultScenarioForCase = async () => {
    const cid = Number(caseId);
    if (!cid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.post('/api/mystery/admin.php?action=ensure_default_scenario_for_case', { case_id: cid, min_suspects: 8 });
      const sid = Number(res?.scenario_id || 0);
      await loadScenarios(cid);
      if (sid) {
        setScenarioId(String(sid));
        await loadScenario(sid);
        await loadScenarioEntities(sid);
        await loadCaseNotes(sid);
      }
      setMessage('Scenario synced.');
    } catch (e) {
      setError(e?.message || 'Failed to create scenario for this case');
    } finally {
      setBusy(false);
    }
  };

  const saveConstraints = async () => {
    const sid = Number(scenarioId);
    if (!sid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const parsed = JSON.parse(String(constraintsDraft || '{}'));
      await ApiClient.post('/api/mystery/admin.php?action=update_scenario', { id: sid, constraints: parsed });
      await loadScenario(sid);
      setMessage('Constraints saved.');
    } catch (e) {
      setError(e?.message || 'Failed to save constraints (invalid JSON?)');
    } finally {
      setBusy(false);
    }
  };

  const createCharacter = async (e) => {
    e.preventDefault();
    const cid = Number(caseId);
    if (!cid) return;
    const name = String(newCharacter.name || '').trim();
    if (!name) {
      setError('Character name is required.');
      return;
    }
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=create_entity', {
        case_id: cid,
        entity_type: 'character',
        name,
        data: {},
      });
      await loadCharacters(cid);
      setNewCharacter({ name: '' });
      setMessage('Character created.');
    } catch (e) {
      setError(e?.message || 'Failed to create character');
    } finally {
      setBusy(false);
    }
  };

  const attachCharacter = async (e) => {
    e.preventDefault();
    const sid = Number(scenarioId);
    const eid = Number(attachEntityId);
    if (!sid || !eid) return;
    const role = String(attachRole || '').trim();
    if (!role) {
      setError('Role is required.');
      return;
    }

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const override = JSON.parse(String(attachOverrideText || '{}'));
      await ApiClient.post('/api/mystery/admin.php?action=attach_entity_to_scenario', {
        scenario_id: sid,
        entity_id: eid,
        role,
        override,
      });
      await loadScenarioEntities(sid);
      setAttachOverrideText('{}');
      setMessage('Character attached.');
    } catch (err) {
      setError(err?.message || 'Failed to attach character (invalid JSON?)');
    } finally {
      setBusy(false);
    }
  };

  const detachScenarioEntity = async (id) => {
    const seId = Number(id);
    const sid = Number(scenarioId);
    if (!seId || !sid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=detach_entity_from_scenario', { id: seId });
      await loadScenarioEntities(sid);
      setMessage('Removed from scenario.');
    } catch (err) {
      setError(err?.message || 'Remove failed');
    } finally {
      setBusy(false);
    }
  };

  const enqueueJob = async (e) => {
    e.preventDefault();
    const cid = Number(caseId);
    if (!cid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const spec = JSON.parse(String(jobSpecText || '{}'));
      if (!spec || typeof spec !== 'object' || Array.isArray(spec)) {
        throw new Error('Spec JSON must be an object');
      }
      spec.image_styles = getImageStyleSettings();
      spec.scope = {
        character: jobScopeCharacter ? 1 : 0,
        location: jobScopeLocation ? 1 : 0,
        weapon: jobScopeWeapon ? 1 : 0,
        motive: jobScopeMotive ? 1 : 0,
      };
      await ApiClient.post('/api/mystery/admin.php?action=enqueue_job', {
        case_id: cid,
        scenario_id: Number(scenarioId) || 0,
        action: String(jobAction || '').trim() || 'regenerate',
        spec,
      });
      await loadJobs(cid);
      setMessage('Job queued.');
    } catch (err) {
      setError(err?.message || 'Failed to enqueue job (invalid JSON?)');
    } finally {
      setBusy(false);
    }
  };

  const previewEnqueueJobJson = () => {
    const cid = Number(caseId);
    if (!cid) return;
    try {
      const spec = JSON.parse(String(jobSpecText || '{}'));
      if (!spec || typeof spec !== 'object' || Array.isArray(spec)) {
        throw new Error('Spec JSON must be an object');
      }
      (spec as any).image_styles = getImageStyleSettings();
      (spec as any).scope = {
        character: jobScopeCharacter ? 1 : 0,
        location: jobScopeLocation ? 1 : 0,
        weapon: jobScopeWeapon ? 1 : 0,
        motive: jobScopeMotive ? 1 : 0,
      };
      openJsonPreview({
        title: 'enqueue_job: ' + String(jobAction || 'regenerate'),
        payload: {
          endpoint: '/api/mystery/admin.php?action=enqueue_job',
          method: 'POST',
          body: {
            case_id: cid,
            scenario_id: Number(scenarioId) || 0,
            action: String(jobAction || '').trim() || 'regenerate',
            spec,
          },
        },
      });
    } catch (err) {
      openJsonPreview({
        title: 'enqueue_job: invalid spec_json',
        payload: {
          error: String((err as any)?.message || 'Invalid JSON'),
          spec_text: String(jobSpecText || ''),
        },
      });
    }
  };

  const enqueueSpecificJob = async ({ action, spec, requireScenario, entityId = undefined }: { action: any; spec: any; requireScenario: any; entityId?: any }) => {
    const cid = Number(caseId);
    const sid = Number(scenarioId);
    if (!cid) return;
    if (requireScenario && !sid) return;

    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/mystery/admin.php?action=enqueue_job', {
        case_id: cid,
        scenario_id: sid || 0,
        entity_id: Number(entityId || 0) > 0 ? Number(entityId || 0) : undefined,
        action: String(action || '').trim(),
        spec: (spec && typeof spec === 'object') ? spec : {},
      });
      await loadJobs(cid);
      setMessage('Job queued.');
    } catch (err) {
      setError(err?.message || 'Failed to enqueue job');
    } finally {
      setBusy(false);
    }
  };

  const [backStoriesInspectorOpenEntityIds, setBackStoriesInspectorOpenEntityIds] = useState<number[]>([]);
  const [backStoriesInspectorBusyByEntityId, setBackStoriesInspectorBusyByEntityId] = useState<Record<string, boolean>>({});
  const [backStoriesInspectorErrorByEntityId, setBackStoriesInspectorErrorByEntityId] = useState<Record<string, string>>({});
  const [backStoriesInspectorDepositionByEntityId, setBackStoriesInspectorDepositionByEntityId] = useState<Record<string, { text: string; updated_at: string }>>({});
  const [backStoriesInspectorRapSheetByEntityId, setBackStoriesInspectorRapSheetByEntityId] = useState<Record<string, any>>({});

  const toggleBackStoriesInspectorOpen = (entityId: number) => {
    const id = Number(entityId || 0);
    if (!id) return;
    setBackStoriesInspectorOpenEntityIds((prev) => {
      const set = new Set(Array.isArray(prev) ? prev : []);
      if (set.has(id)) set.delete(id);
      else set.add(id);
      return Array.from(set);
    });
  };

  const loadBackStoriesInspectorForEntity = useCallback(async (entityId: number) => {
    const sid = Number(scenarioId || 0);
    const eid = Number(entityId || 0);
    if (!sid || !eid) return;

    setBackStoriesInspectorBusyByEntityId((prev) => ({ ...(prev || {}), [String(eid)]: true }));
    setBackStoriesInspectorErrorByEntityId((prev) => ({ ...(prev || {}), [String(eid)]: '' }));
    try {
      const [depRes, rapRes] = await Promise.all([
        ApiClient.get('/api/mystery/admin.php?action=get_scenario_deposition&scenario_id=' + String(sid) + '&entity_id=' + String(eid)),
        ApiClient.get('/api/mystery/rap_sheet.php?scenario_id=' + String(sid) + '&entity_id=' + String(eid)),
      ]);

      const dep = (depRes && typeof depRes === 'object') ? (depRes as any).deposition : null;
      const text = (dep && typeof dep === 'object') ? String(dep.text || '') : '';
      const updatedAt = (dep && typeof dep === 'object') ? String(dep.updated_at || '') : '';
      setBackStoriesInspectorDepositionByEntityId((prev) => ({
        ...(prev || {}),
        [String(eid)]: { text, updated_at: updatedAt },
      }));

      const rap = (rapRes && typeof rapRes === 'object') ? (rapRes as any).rap_sheet : null;
      setBackStoriesInspectorRapSheetByEntityId((prev) => ({
        ...(prev || {}),
        [String(eid)]: rap,
      }));
    } catch (e) {
      setBackStoriesInspectorErrorByEntityId((prev) => ({ ...(prev || {}), [String(eid)]: (e as any)?.message || 'Failed to load inspector data' }));
    } finally {
      setBackStoriesInspectorBusyByEntityId((prev) => ({ ...(prev || {}), [String(eid)]: false }));
    }
  }, [scenarioId]);

  const [masterCharacterDepositionBusy, setMasterCharacterDepositionBusy] = useState(false);
  const [masterCharacterDepositionError, setMasterCharacterDepositionError] = useState('');
  const [masterCharacterDepositionText, setMasterCharacterDepositionText] = useState('');
  const [masterCharacterDepositionUpdatedAt, setMasterCharacterDepositionUpdatedAt] = useState('');

  const masterCharacterScenarioEntityId = useMemo(() => {
    if (String(masterAssetDetailsType || '').trim() !== 'character') return 0;
    const sid = Number(scenarioId);
    if (!sid) return 0;
    const it = (masterAssetDetailsItem && typeof masterAssetDetailsItem === 'object') ? masterAssetDetailsItem : null;
    const masterSlug = String(it?.slug || '').trim();
    if (!masterSlug) return 0;
    const list = Array.isArray(scenarioEntities) ? scenarioEntities : [];
    for (const se of list) {
      if (!se || typeof se !== 'object') continue;
      const role = String(se?.role || '').trim();
      if (role !== 'suspect') continue;
      if (String(se?.master_slug || '').trim() !== masterSlug) continue;
      return Number(se?.entity_id || 0) || 0;
    }
    return 0;
  }, [masterAssetDetailsItem, masterAssetDetailsType, scenarioEntities, scenarioId]);

  const loadMasterCharacterDeposition = useCallback(async () => {
    const sid = Number(scenarioId);
    const eid = Number(masterCharacterScenarioEntityId || 0);
    if (!sid || !eid) {
      setMasterCharacterDepositionText('');
      setMasterCharacterDepositionUpdatedAt('');
      return;
    }
    setMasterCharacterDepositionBusy(true);
    setMasterCharacterDepositionError('');
    try {
      const res = await ApiClient.get('/api/mystery/admin.php?action=get_scenario_deposition&scenario_id=' + String(sid) + '&entity_id=' + String(eid));
      const dep = (res && typeof res === 'object') ? (res as any).deposition : null;
      if (dep && typeof dep === 'object') {
        setMasterCharacterDepositionText(String(dep.text || ''));
        setMasterCharacterDepositionUpdatedAt(String(dep.updated_at || ''));
      } else {
        setMasterCharacterDepositionText('');
        setMasterCharacterDepositionUpdatedAt('');
      }
    } catch (e) {
      setMasterCharacterDepositionError((e as any)?.message || 'Failed to load deposition');
    } finally {
      setMasterCharacterDepositionBusy(false);
    }
  }, [masterCharacterScenarioEntityId, scenarioId]);

  useEffect(() => {
    if (!masterAssetDetailsOpen) return;
    if (String(masterAssetDetailsType || '').trim() !== 'character') return;
    void loadMasterCharacterDeposition();
  }, [loadMasterCharacterDeposition, masterAssetDetailsOpen, masterAssetDetailsType, masterCharacterScenarioEntityId, scenarioId]);

  return (
    <PageLayout page="mystery" title="Mystery Game" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
      <section className="section">
        <div className="container">
          <div className="catn8-mystery-header">
            <div className="catn8-mystery-header-title">Mysteries from the Graves</div>
            <button
              type="button"
              className="catn8-mystery-header-close"
              aria-label="Close"
              onClick={() => {
                window.location.href = '/';
              }}
            >
              
            </button>
          </div>

          <div className="row g-3">
            <div className="col-12">
              <div className="catn8-card p-3">
                <div className="d-flex flex-column gap-2">
                  <div className="d-flex flex-wrap gap-2">
                    <button
                      type="button"
                      className="btn btn-primary"
                      onClick={() => {
                        if (!caseId) {
                          setGameMgmtOpen(true);
                          showModalNow(gameMgmtRef, gameMgmtApiRef);
                          return;
                        }
                        if (scenarioId) {
                          openStartResumeTab('caseboard');
                          return;
                        }
                        openStartResumeTab('start');
                      }}
                      disabled={busy}
                    >
                      Take the Case
                    </button>
                    <button
                      type="button"
                      className="btn btn-outline-secondary"
                      onClick={() => {
                        setGameMgmtOpen(true);
                        showModalNow(gameMgmtRef, gameMgmtApiRef);
                      }}
                      disabled={busy}
                    >
                      Dossier
                    </button>
                    <button
                      type="button"
                      className="btn btn-outline-secondary"
                      onClick={() => {
                        setScenariosModalOpen(true);
                        showModalNow(scenariosModalRef, scenariosModalApiRef);
                      }}
                      disabled={busy}
                    >
                      Crime Scenes
                    </button>
                    <button
                      type="button"
                      className="btn btn-outline-secondary"
                      onClick={() => {
                        setMysteriesModalOpen(true);
                        showModalNow(mysteriesModalRef, mysteriesModalApiRef);
                      }}
                      disabled={busy}
                    >
                      Back Stories
                    </button>
                    <button
                      type="button"
                      className="btn btn-outline-secondary"
                      onClick={() => {
                        if (!caseId) {
                          setError('Select a case first.');
                          setGameMgmtOpen(true);
                          showModalNow(gameMgmtRef, gameMgmtApiRef);
                          return;
                        }
                        openStartResumeTab('tools');
                      }}
                      disabled={busy}
                    >
                      Darkroom
                    </button>
                    <button
                      type="button"
                      className="btn btn-outline-secondary"
                      onClick={() => {
                        setAssetLibraryOpen(true);
                        showModalNow(assetLibraryRef, assetLibraryApiRef);
                      }}
                      disabled={busy}
                    >
                      Asset Library
                    </button>
                    <button
                      type="button"
                      className="btn btn-outline-secondary"
                      onClick={() => {
                        if (!isAdmin) {
                          setError('Only admins can manage Mystery settings.');
                          return;
                        }
                        setMysterySettingsOpen(true);
                        showModalNow(mysterySettingsRef, mysterySettingsApiRef);
                      }}
                      disabled={busy}
                    >
                      Communications
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={startResumeRef}>
        <div className="modal-dialog modal-dialog-centered catn8-case-details-dialog">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">{(() => {
                const t = String(startResumeTab || 'start');
                if (t === 'start') return 'Start / Resume';
                if (t === 'tools') return 'Darkroom';
                if (t === 'case_file') return 'Case File';
                if (t === 'log') return 'Investigation Log';
                return 'Case Details';
              })()}</div>
              <div className="d-flex align-items-center gap-2">
                {startResumeTab === 'tools' ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-secondary"
                    onClick={() => {
                      setAdvancedModalOpen(true);
                      showModalNow(advancedModalRef, advancedModalApiRef);
                    }}
                    disabled={busy || !caseId}
                  >
                    Advanced
                  </button>
                ) : null}
                {startResumeTab === 'tools' && isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-secondary"
                    onClick={() => {
                      try {
                        const el = document.activeElement;
                        if (el && typeof (el as any).blur === 'function') (el as any).blur();
                      } catch (_err) {
                      }
                      try {
                        const api = startResumeApiRef.current;
                        if (api && typeof api.hide === 'function') api.hide();
                      } catch (_err) {
                      }
                      window.setTimeout(() => {
                        if (typeof onOpenAiImageConfig === 'function') onOpenAiImageConfig();
                      }, 0);
                    }}
                    disabled={busy}
                    aria-label="AI Image Configuration"
                    title="AI Image Configuration"
                  >
                    {cogSvg}
                  </button>
                ) : null}
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">
              <div className="catn8-card p-3 catn8-mystery-modal-card">

                {!caseId && startResumeTab !== 'start' ? (
                  <div className="alert alert-warning" role="alert">
                    Select (or create) a case to begin.
                    <button
                      type="button"
                      className="btn btn-sm btn-primary mt-2"
                      onClick={() => {
                        transitionToModal(startResumeRef, gameMgmtRef, gameMgmtApiRef, setGameMgmtOpen);
                      }}
                      disabled={busy}
                    >
                      Open Mystery / Dossier
                    </button>
                  </div>
                ) : null}

                {caseId && !scenarioId && startResumeTab !== 'start' ? (
                  <div className="mt-3">
                    <div className="text-muted">Select a scenario to continue.</div>
                    <button
                      type="button"
                      className="btn btn-primary mt-2"
                      onClick={() => {
                        transitionToModal(startResumeRef, gameMgmtRef, gameMgmtApiRef, setGameMgmtOpen);
                      }}
                      disabled={busy}
                    >
                      Choose Scenario
                    </button>
                  </div>
                ) : null}

                {startResumeTab === 'start' ? (
                  <div className="mt-3">
                    <div className="d-flex justify-content-end mb-2">
                      <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadPlayTemplatesAndResumables} disabled={playBusy || busy}>
                        Refresh
                      </button>
                    </div>

                    <div className="row g-3">
                      <div className="col-lg-6">
                        <div className="catn8-card p-3 h-100">
                          <div className="fw-bold">Resume</div>
                          <div className="form-text mb-2">Pick a scenario you already started.</div>

                          <div className="table-responsive">
                            <table className="table table-sm align-middle">
                              <thead>
                                <tr>
                                  <th>Case</th>
                                  <th>Scenario</th>
                                  <th></th>
                                </tr>
                              </thead>
                              <tbody>
                                {playResumables.map((it) => (
                                  <tr key={String(it.scenario_id)}>
                                    <td>
                                      <div title={it.case_slug ? ('Slug: ' + String(it.case_slug)) : ''}>{it.case_title}</div>
                                    </td>
                                    <td>
                                      <div title={it.scenario_slug ? ('Slug: ' + String(it.scenario_slug)) : ''}>{it.scenario_title}</div>
                                    </td>
                                    <td className="text-end">
                                      <button
                                        type="button"
                                        className="btn btn-sm btn-primary"
                                        onClick={() => resumeScenarioNow({ caseId: it.case_id, scenarioId: it.scenario_id, title: 'Resumed.' })}
                                        disabled={playBusy || busy}
                                      >
                                        Resume
                                      </button>
                                    </td>
                                  </tr>
                                ))}
                                {!playResumables.length ? (
                                  <tr>
                                    <td colSpan={3} className="text-muted">No resumable scenarios yet.</td>
                                  </tr>
                                ) : null}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>

                      <div className="col-lg-6">
                        <div className="catn8-card p-3 h-100">
                          <div className="fw-bold">Start new case from template</div>
                          <div className="form-text mb-2">Clone a template into your own playable case instance.</div>

                          <div className="mb-2">
                            <label className="form-label" htmlFor="mystery-play-template">Template</label>
                            <select
                              id="mystery-play-template"
                              className="form-select"
                              value={playTemplateCaseId}
                              onChange={(e) => setPlayTemplateCaseId(e.target.value)}
                              disabled={playBusy || busy}
                            >
                              <option value="">Select a template</option>
                              {playTemplates.map((t) => (
                                <option key={t.id} value={String(t.id)} title={t.slug ? ('Slug: ' + String(t.slug)) : ''}>
                                  {t.title}
                                </option>
                              ))}
                            </select>
                          </div>

                          <div className="row g-2">
                            <div className="col-12">
                              <label className="form-label" htmlFor="mystery-play-new-title">New title</label>
                              <input
                                id="mystery-play-new-title"
                                className="form-control"
                                value={playNewCaseTitle}
                                onChange={(e) => setPlayNewCaseTitle(e.target.value)}
                                disabled={playBusy || busy}
                                placeholder="My New Case"
                              />
                            </div>
                          </div>

                          <div className="d-flex justify-content-end mt-3">
                            <button
                              type="button"
                              className="btn btn-primary"
                              onClick={createCaseInstanceFromTemplate}
                              disabled={playBusy || busy}
                            >
                              Create
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ) : null}

                {caseId && scenarioId ? (
                  <div className="mt-3">
                    <div className="mt-3">
                      {startResumeTab === 'case_file' ? (
                        <div>
                          <div className="alert alert-info" role="alert">
                            This is your Case File for the selected scenario. Its stored as a case note with <span className="catn8-mystery-token">note_type = case_file</span>.
                          </div>

                          <div className="d-flex justify-content-between align-items-center gap-2 mb-2">
                            <div className="text-muted">Notes loaded: {String(caseNotes.length)}</div>
                            <div className="d-flex gap-2">
                              <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => loadCaseNotes(scenarioId)} disabled={busy || !scenarioId}>
                                Refresh
                              </button>
                              <button
                                type="button"
                                className="btn btn-sm btn-outline-secondary"
                                onClick={() => {
                                  setCaseNoteId('');
                                  setCaseNote(null);
                                  setCaseNoteType('case_file');
                                  setCaseNoteTitle('Case File');
                                  setCaseNoteClueCount('0');
                                  setCaseNoteDraft(JSON.stringify({ blocks: [{ style: 'typed', text: '' }], tags: [], annotations: [] }, null, 2));
                                }}
                                disabled={busy || !scenarioId}
                              >
                                New
                              </button>
                            </div>
                          </div>

                          <div className="catn8-card p-3">
                            <div className="row g-2 align-items-end">
                              <div className="col-md-6">
                                <label className="form-label" htmlFor="mystery-case-file-note">Select note</label>
                                <select
                                  id="mystery-case-file-note"
                                  className="form-select"
                                  value={String(caseNoteId || '')}
                                  onChange={(e) => {
                                    setCaseNoteType('case_file');
                                    setCaseNoteId(e.target.value);
                                  }}
                                  disabled={busy || !scenarioId}
                                >
                                  <option value="">(New Case File)</option>
                                  {caseNotes
                                    .filter((n) => String(n?.note_type || '') === 'case_file')
                                    .map((n) => (
                                      <option key={n.id} value={String(n.id)}>
                                        {n.title} (#{n.id})
                                      </option>
                                    ))}
                                </select>
                              </div>

                              <div className="col-md-6">
                                <label className="form-label" htmlFor="mystery-case-file-title">Title</label>
                                <input
                                  id="mystery-case-file-title"
                                  className="form-control"
                                  value={caseNoteTitle}
                                  onChange={(e) => setCaseNoteTitle(e.target.value)}
                                  disabled={busy || !scenarioId}
                                />
                              </div>

                              <div className="col-md-6">
                                <label className="form-label" htmlFor="mystery-case-file-type">Type</label>
                                <input
                                  id="mystery-case-file-type"
                                  className="form-control"
                                  value={String(caseNoteType || 'case_file')}
                                  readOnly
                                  disabled
                                />
                              </div>

                              <div className="col-md-6">
                                <label className="form-label" htmlFor="mystery-case-file-clues">Clue count</label>
                                <input
                                  id="mystery-case-file-clues"
                                  className="form-control"
                                  type="number"
                                  value={caseNoteClueCount}
                                  onChange={(e) => setCaseNoteClueCount(e.target.value)}
                                  disabled={busy || !scenarioId}
                                />
                              </div>

                              <div className="col-12">
                                <label className="form-label" htmlFor="mystery-case-file-json">Content (JSON)</label>
                                <textarea
                                  id="mystery-case-file-json"
                                  className="form-control"
                                  rows={10}
                                  value={caseNoteDraft}
                                  onChange={(e) => setCaseNoteDraft(e.target.value)}
                                  disabled={busy || !scenarioId}
                                  spellCheck={false}
                                />
                              </div>

                              <div className="col-12 d-flex justify-content-end gap-2">
                                <button type="button" className="btn btn-outline-danger" onClick={deleteCaseNote} disabled={busy || !scenarioId || !caseNoteId}>
                                  Delete
                                </button>
                                <button
                                  type="button"
                                  className="btn btn-primary"
                                  onClick={() => {
                                    setCaseNoteType('case_file');
                                    saveCaseNote();
                                  }}
                                  disabled={busy || !scenarioId}
                                >
                                  Save
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ) : null}

                      {startResumeTab === 'caseboard' ? (
                        <div className="row g-3 catn8-case-details-caseboard">
                          <div className="col-12 col-lg-4">
                            <div className="catn8-card p-3">
                              <div className="fw-bold">Sheriff Live</div>

                              <div className="d-flex justify-content-between align-items-center mb-3 gap-2">
                                <div className="text-muted">Status: {sheriffLiveStatus}</div>
                                <div className="d-flex gap-2">
                                  <button type="button" className="btn btn-outline-secondary" onClick={startSheriffLiveSession} disabled={busy || !scenarioId}>
                                    Prepare Session
                                  </button>
                                  <button type="button" className="btn btn-primary" onClick={startSheriffLiveStreaming} disabled={busy || !scenarioId || !sheriffLiveTokenName}>
                                    Start
                                  </button>
                                  <button type="button" className="btn btn-outline-danger" onClick={stopSheriffLiveStreaming} disabled={busy || sheriffLiveStatus === 'idle'}>
                                    Stop
                                  </button>
                                </div>
                              </div>

                              <div className="catn8-card p-3">
                                <div className="fw-bold">Session</div>
                                <div className="form-text">Model: {sheriffLiveModel || '(not prepared)'}.</div>
                                <div className="form-text">Token: <span className="catn8-mystery-token">{sheriffLiveTokenName || '(not prepared)'}</span>.</div>
                                <div className="form-text">Entity ID: {sheriffLiveEntityId ? String(sheriffLiveEntityId) : '(not prepared)'}.</div>
                                <div className="mt-3">
                                  <label className="form-label" htmlFor="sheriff-live-system-instruction">System Instruction</label>
                                  <textarea
                                    id="sheriff-live-system-instruction"
                                    className="form-control"
                                    rows={6}
                                    value={sheriffLiveSystemInstruction || ''}
                                    readOnly
                                    spellCheck={false}
                                  />
                                </div>
                              </div>

                              <div className="catn8-card p-3 mt-3">
                                <div className="fw-bold">Live transcripts</div>
                                <div className="row g-3 mt-1">
                                  <div className="col-md-6">
                                    <div className="text-muted small mb-1">You (live)</div>
                                    <div className="catn8-mystery-interrogation-transcript-body" role="textbox" aria-label="Your speech transcript">
                                      {sheriffLiveInputText || <span className="text-muted"></span>}
                                    </div>
                                  </div>
                                  <div className="col-md-6">
                                    <div className="text-muted small mb-1">Sheriff</div>
                                    <div className="catn8-mystery-interrogation-transcript-body" role="textbox" aria-label="Sheriff speech transcript">
                                      {sheriffLiveOutputText || <span className="text-muted"></span>}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div className="col-12 col-lg-4">
                            <div className="catn8-card p-3">
                              <div className="d-flex align-items-center justify-content-between gap-2">
                                <div className="fw-bold">Recent Interrogations</div>
                                <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => loadInterrogationEvents(scenarioId)} disabled={busy || !scenarioId}>
                                  Refresh
                                </button>
                              </div>
                              <div className="table-responsive mt-2">
                                <table className="table table-sm align-middle">
                                  <thead>
                                    <tr>
                                      <th>Time</th>
                                      <th>Suspect</th>
                                      <th>Question</th>
                                      <th>Answer</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {interrogationEvents.map((ev) => (
                                      <tr key={ev.id}>
                                        <td className="text-muted">{ev.created_at}</td>
                                        <td>{ev.entity_name}</td>
                                        <td className="catn8-mystery-log-text">{ev.question}</td>
                                        <td className="catn8-mystery-log-text">{ev.answer}</td>
                                      </tr>
                                    ))}
                                    {!interrogationEvents.length ? (
                                      <tr>
                                        <td colSpan={4} className="text-muted">{scenarioId ? 'No interrogations yet.' : 'Select a scenario.'}</td>
                                      </tr>
                                    ) : null}
                                  </tbody>
                                </table>
                              </div>
                            </div>

                            <div className="catn8-card p-3 mt-3">
                              <div className="d-flex justify-content-between align-items-center gap-2 mb-2">
                                <div className="fw-bold">Investigation Log</div>
                                <button
                                  type="button"
                                  className="btn btn-sm btn-outline-secondary"
                                  onClick={() => loadConversationEvents({ silent: false })}
                                  disabled={conversationEventsBusy || !scenarioId}
                                >
                                  Refresh
                                </button>
                              </div>

                              {conversationEventsError ? (
                                <div className="text-danger small mb-2">{conversationEventsError}</div>
                              ) : null}

                              <div className="catn8-mystery-investigation-log-scroll" ref={investigationLogScrollRef} tabIndex={0} role="textbox" aria-label="Investigation log">
                                {investigationLogEvents.map((ev) => {
                                  const id = Number(ev?.entity_id || 0);
                                  const name = String(entityNameById.get(id) || '').trim() || (id ? ('Suspect #' + String(id)) : 'Suspect');
                                  return (
                                    <div key={ev.id} className="catn8-mystery-investigation-log-line">
                                      <span className="catn8-mystery-investigation-log-speaker">{name}:</span>
                                      {' '}
                                      <span className="catn8-mystery-investigation-log-text">{ev.content_text}</span>
                                    </div>
                                  );
                                })}

                                {!investigationLogEvents.length ? (
                                  <div className="text-muted small">{scenarioId ? 'No suspect statements yet.' : 'Select a scenario.'}</div>
                                ) : null}
                              </div>
                            </div>
                          </div>

                          <div className="col-12 col-lg-4">
                            <div className="catn8-card p-3">
                              <div className="d-flex align-items-center justify-content-between gap-2">
                                <div className="fw-bold">Suspects</div>
                                <div className="text-muted small">Click a thumbnail to interrogate. Press Enter to toggle Talk.</div>
                              </div>

                              <div className="catn8-mystery-cast-grid mt-2">
                                {scenarioCast
                                  .filter((c) => c.role === 'suspect' || c.role === 'killer')
                                  .map((c) => (
                                    <button
                                      key={String(c.role) + ':' + String(c.entityId)}
                                      type="button"
                                      className="catn8-mystery-cast-tile"
                                      onClick={() => {
                                        setInterrogationEntityId(c.entityId);
                                        setInterrogationEntityName(c.name);
                                        setInterrogationAgentId(c.agentId);
                                        setInterrogationOpen(true);
                                        showModalNow(interrogationRef, interrogationApiRef);
                                      }}
                                      disabled={busy}
                                    >
                                      <div className="catn8-mystery-cast-thumb">
                                        <img className="catn8-mystery-cast-thumb-img" src={c.thumbUrl} alt={c.name} loading="lazy" />
                                      </div>
                                      <div className="catn8-mystery-cast-name">{c.name}</div>
                                      <div className="catn8-mystery-cast-role">suspect</div>
                                    </button>
                                  ))}

                                {!scenarioCast.filter((c) => c.role === 'suspect' || c.role === 'killer').length ? (
                                  <div className="text-muted small">No suspects attached to this scenario yet.</div>
                                ) : null}
                              </div>
                            </div>
                          </div>
                        </div>
                      ) : null}

                      {startResumeTab === 'tools' ? (
                        <div className="row g-3">
                          <div className="col-12 col-lg-6">
                            <div className="catn8-card p-3">
                              <div className="fw-bold">Controls</div>
                              <div className="form-text mb-2">Queue generation jobs and manage image prompt styles.</div>

                              <form className="row g-2" onSubmit={enqueueJob}>
                                <div className="col-12">
                                  <label className="form-label" htmlFor="mystery-job-action">Action</label>
                                  <select
                                    id="mystery-job-action"
                                    className="form-select"
                                    value={jobAction}
                                    onChange={(e) => setJobAction(e.target.value)}
                                    disabled={busy || !caseId}
                                  >
                                    <option value="generate">Generate</option>
                                    <option value="regenerate">Regenerate (rebuild only unlocked items)</option>
                                    <option value="reset">Reset</option>
                                  </select>
                                  <div className="form-text">
                                    Generate (fill missing content). Regenerate (overwrite unlocked content only).
                                  </div>
                                </div>

                                <div className="col-12">
                                  <label className="form-label">Scope</label>
                                  <div className="d-flex flex-wrap gap-3">
                                    <label className="form-check m-0">
                                      <input
                                        className="form-check-input"
                                        type="checkbox"
                                        checked={jobScopeCharacter}
                                        onChange={(e) => setJobScopeCharacter(e.target.checked)}
                                        disabled={busy || !caseId}
                                      />
                                      <span className="form-check-label">Characters</span>
                                    </label>
                                    <label className="form-check m-0">
                                      <input
                                        className="form-check-input"
                                        type="checkbox"
                                        checked={jobScopeLocation}
                                        onChange={(e) => setJobScopeLocation(e.target.checked)}
                                        disabled={busy || !caseId}
                                      />
                                      <span className="form-check-label">Locations</span>
                                    </label>
                                    <label className="form-check m-0">
                                      <input
                                        className="form-check-input"
                                        type="checkbox"
                                        checked={jobScopeWeapon}
                                        onChange={(e) => setJobScopeWeapon(e.target.checked)}
                                        disabled={busy || !caseId}
                                      />
                                      <span className="form-check-label">Weapons</span>
                                    </label>
                                    <label className="form-check m-0">
                                      <input
                                        className="form-check-input"
                                        type="checkbox"
                                        checked={jobScopeMotive}
                                        onChange={(e) => setJobScopeMotive(e.target.checked)}
                                        disabled={busy || !caseId}
                                      />
                                      <span className="form-check-label">Motives</span>
                                    </label>
                                  </div>
                                  <div className="form-text">Used by scoped jobs (e.g., regenerating only some master datasets).</div>
                                </div>

                                <div className="col-12 d-flex gap-2">
                                  <button
                                    type="button"
                                    className="btn btn-outline-secondary"
                                    onClick={previewEnqueueJobJson}
                                    disabled={busy || !caseId}
                                  >
                                    View JSON
                                  </button>
                                  <button type="submit" className="btn btn-primary" disabled={busy || !caseId}>
                                    Queue Job
                                  </button>
                                  <button type="button" className="btn btn-outline-secondary" onClick={() => loadJobs(caseId)} disabled={busy || !caseId}>
                                    Refresh
                                  </button>
                                </div>
                              </form>

                              <div className="mt-2 d-flex flex-wrap align-items-center gap-2">
                                {!clearQueueArmed ? (
                                  <button
                                    type="button"
                                    className="btn btn-outline-danger"
                                    onClick={() => setClearQueueArmed(true)}
                                    disabled={busy || !caseId}
                                  >
                                    Clear queued jobs
                                  </button>
                                ) : null}
                                <button type="button" className="btn btn-outline-danger" onClick={clearCompletedJobs} disabled={busy || !caseId}>
                                  Clear Completed Jobs
                                </button>
                                {clearQueueArmed ? (
                                  <>
                                    <button type="button" className="btn btn-danger" onClick={clearQueuedJobs} disabled={busy || !caseId}>
                                      Confirm clear
                                    </button>
                                    <button type="button" className="btn btn-outline-secondary" onClick={() => setClearQueueArmed(false)} disabled={busy}>
                                      Cancel
                                    </button>
                                  </>
                                ) : null}
                              </div>

                              <hr className="my-3" />

                              <div className="catn8-card p-2">
                                <div className="fw-bold">Image Style Master</div>
                                <div className="form-text">Prepended to every image prompt.</div>
                                <textarea
                                  className="form-control mt-2"
                                  rows={3}
                                  value={imageStyleMasterDraft}
                                  onChange={(e) => setImageStyleMasterDraft(e.target.value)}
                                  onBlur={() => saveImageStyleSetting({ key: 'master', value: imageStyleMasterDraft })}
                                  disabled={busy || !isAdmin}
                                  spellCheck={false}
                                />
                              </div>

                              <div className="catn8-card p-2 mt-2">
                                <div className="fw-bold">Location Image Style</div>
                                <div className="form-text">Added after master style for location prompts.</div>
                                <textarea
                                  className="form-control mt-2"
                                  rows={3}
                                  value={locationImageStyleDraft}
                                  onChange={(e) => setLocationImageStyleDraft(e.target.value)}
                                  onBlur={() => saveImageStyleSetting({ key: 'location', value: locationImageStyleDraft })}
                                  disabled={busy || !isAdmin}
                                  spellCheck={false}
                                />
                              </div>

                              <div className="catn8-card p-2 mt-2">
                                <div className="fw-bold">Mugshot Image Style</div>
                                <div className="form-text">Added after master style for mugshot prompts.</div>
                                <textarea
                                  className="form-control mt-2"
                                  rows={3}
                                  value={mugshotImageStyleDraft}
                                  onChange={(e) => setMugshotImageStyleDraft(e.target.value)}
                                  onBlur={() => saveImageStyleSetting({ key: 'mugshot', value: mugshotImageStyleDraft })}
                                  disabled={busy || !isAdmin}
                                  spellCheck={false}
                                />
                              </div>

                              <div className="catn8-card p-2 mt-2">
                                <div className="fw-bold">Weapon Image Style</div>
                                <div className="form-text">Added after master style for weapon prompts.</div>
                                <textarea
                                  className="form-control mt-2"
                                  rows={3}
                                  value={weaponImageStyleDraft}
                                  onChange={(e) => setWeaponImageStyleDraft(e.target.value)}
                                  onBlur={() => saveImageStyleSetting({ key: 'weapon', value: weaponImageStyleDraft })}
                                  disabled={busy || !isAdmin}
                                  spellCheck={false}
                                />
                              </div>
                            </div>

                            <div className="catn8-card p-3 mt-3">
                              <div>
                                <div className="fw-bold">Job Spec (JSON)</div>
                                <div className="form-text mb-2">Optional extra parameters for generation jobs. Image styles are auto-injected when you queue jobs.</div>
                              </div>
                              <textarea
                                className="form-control"
                                rows={10}
                                value={jobSpecText}
                                onChange={(e) => setJobSpecText(e.target.value)}
                                disabled={busy || !caseId}
                                spellCheck={false}
                              />
                            </div>
                          </div>
                          <div className="col-12 col-lg-6">
                            <div className="catn8-card p-3 h-100">
                              <div className="d-flex justify-content-between align-items-center gap-2">
                                <div>
                                  <div className="fw-bold">Log</div>
                                  <div className="form-text">Recent generation jobs and status.</div>
                                </div>
                                <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => loadJobs(caseId)} disabled={busy || !caseId}>
                                  Refresh
                                </button>
                              </div>

                              <div className="table-responsive mt-2 catn8-mystery-tools-log-scroll">
                                <table className="table table-sm align-middle">
                                  <thead>
                                    <tr>
                                      <th>Action</th>
                                      <th>Finished</th>
                                      <th>Status</th>
                                      <th className="catn8-mystery-tools-log-col-error">Error</th>
                                      <th></th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {jobs.map((j) => (
                                      <tr key={j.id}>
                                        <td>{j.action}</td>
                                        <td className="text-muted">
                                          {(['done', 'error', 'canceled', 'failed'].includes(String(j.status || '').trim()))
                                            ? (String(j.updated_at || '').trim() || '')
                                            : ''}
                                        </td>
                                        <td className="text-muted">{j.status}</td>
                                        <td className="text-muted catn8-mystery-tools-log-col-error">
                                          {String(j.status || '') === 'error' ? (String(j.error_text || '').trim() || 'Error') : ''}
                                        </td>
                                        <td className="text-end">
                                          {String(j.status || '') === 'queued' ? (
                                            Number(deleteJobArmedId) === Number(j.id) ? (
                                              <div className="d-flex justify-content-end gap-2">
                                                <button
                                                  type="button"
                                                  className="btn btn-sm btn-danger"
                                                  onClick={() => deleteQueuedJob(j.id)}
                                                  disabled={busy || !caseId}
                                                >
                                                  Confirm delete
                                                </button>
                                                <button
                                                  type="button"
                                                  className="btn btn-sm btn-outline-secondary"
                                                  onClick={() => setDeleteJobArmedId(0)}
                                                  disabled={busy}
                                                >
                                                  Cancel
                                                </button>
                                              </div>
                                            ) : (
                                              <button
                                                type="button"
                                                className="btn btn-sm btn-outline-danger"
                                                onClick={() => setDeleteJobArmedId(Number(j.id))}
                                                disabled={busy || !caseId}
                                              >
                                                Delete
                                              </button>
                                            )
                                          ) : null}
                                        </td>
                                      </tr>
                                    ))}
                                    {!jobs.length ? (
                                      <tr>
                                        <td colSpan={5} className="text-muted">{caseId ? 'No jobs yet.' : 'Select a case.'}</td>
                                      </tr>
                                    ) : null}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                        </div>
                      ) : null}
                    </div>
                  </div>
                ) : null}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={interrogationRef}>
        <div className="modal-dialog modal-dialog-centered catn8-mystery-interrogation-dialog">
          <div className="modal-content catn8-mystery-interrogation-content">
            <div className="modal-header">
              <div className="fw-bold">Interrogation: {interrogationEntityName || '(unknown)'}</div>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className="btn btn-sm btn-outline-secondary"
                  onClick={() => {
                    const sid = Number(scenarioId);
                    const eid = Number(interrogationEntityId);
                    if (!sid || !eid) {
                      setError('Select a scenario and suspect first.');
                      return;
                    }
                    setRapSheetOpen(true);
                    showModalNow(rapSheetRef, rapSheetApiRef);
                    loadRapSheet(sid, eid, { silent: true });
                  }}
                  disabled={busy || !scenarioId}
                >
                  RAP Sheet
                </button>
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body catn8-mystery-interrogation-body">
              <div className="catn8-mystery-interrogation-left">
                <div className="catn8-mystery-interrogation-image-wrap">
                  <img className="catn8-mystery-interrogation-image" src={interrogationImageUrlFinal} alt={interrogationEntityName || 'Interrogation'} />
                </div>

                <form className="catn8-mystery-interrogation-typed-form" onSubmit={askInterrogationTyped}>
                  <div className="input-group">
                    <input
                      type="text"
                      className="form-control"
                      value={interrogationTypedQuestion}
                      onChange={(e) => setInterrogationTypedQuestion(e.target.value)}
                      placeholder="Type a question for the suspect"
                      disabled={busy || !scenarioId || !interrogationEntityId}
                      aria-label="Type a question for the suspect"
                    />
                    <button
                      type="submit"
                      className="btn btn-primary"
                      disabled={busy || !scenarioId || !interrogationEntityId || !String(interrogationTypedQuestion || '').trim()}
                    >
                      Send
                    </button>
                  </div>
                </form>

                <audio
                  ref={interrogationTypedAudioRef}
                  className="catn8-mystery-interrogation-typed-audio"
                  src={interrogationTypedAudioUrl ? interrogationTypedAudioUrl : undefined}
                  preload="auto"
                />
              </div>
              <div className="catn8-mystery-interrogation-right">
                <div className="d-flex align-items-center gap-2">
                  <div className="text-muted small">Status: {interrogationStatus}</div>
                </div>

                <div className="catn8-mystery-interrogation-transcripts">
                  <div className="catn8-mystery-interrogation-transcript">
                    <div className="catn8-mystery-interrogation-transcript-title">You (live)</div>
                    <div className="catn8-mystery-interrogation-transcript-body" role="textbox" aria-label="Your speech transcript">
                      {interrogationInputText || <span className="text-muted"></span>}
                    </div>
                  </div>

                  <div className="catn8-mystery-interrogation-transcript">
                    <div className="catn8-mystery-interrogation-transcript-title">Agent</div>
                    <div className="catn8-mystery-interrogation-transcript-body" role="textbox" aria-label="Agent speech transcript">
                      {interrogationOutputText || <span className="text-muted"></span>}
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  className={(interrogationStatus === 'idle' || interrogationStatus === 'closed')
                    ? 'btn catn8-mystery-talk-btn catn8-mystery-interrogation-voice-fab'
                    : 'btn btn-outline-danger catn8-mystery-interrogation-voice-fab'}
                  onClick={() => {
                    if (interrogationStatus === 'idle' || interrogationStatus === 'closed') startInterrogationStreaming();
                    else stopInterrogationStreaming();
                  }}
                  disabled={busy || !scenarioId || !interrogationEntityId}
                >
                  {interrogationStatus === 'idle' || interrogationStatus === 'closed' ? 'Voice Talk' : 'Stop'}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={rapSheetRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">RAP Sheet{rapSheet?.suspect?.name ? (': ' + String(rapSheet.suspect.name)) : ''}</div>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className="btn btn-sm btn-outline-secondary"
                  onClick={() => {
                    loadRapSheet(scenarioId, interrogationEntityId, { silent: false });
                  }}
                  disabled={rapSheetBusy || !scenarioId || !interrogationEntityId}
                >
                  Refresh
                </button>
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">

              {rapSheetError ? <div className="alert alert-danger" role="alert">{rapSheetError}</div> : null}

              <div className="row g-3">
                <div className="col-12 col-lg-5">
                  <div className="catn8-card p-3">
                    <div className="fw-bold mb-2">Booking Info</div>
                    {rapSheet?.booking && typeof rapSheet.booking === 'object' ? (
                      <div className="table-responsive">
                        <table className="table table-sm align-middle mb-0">
                          <tbody>
                            {Object.entries(rapSheet.booking).map(([k, v]) => (
                              <tr key={k}>
                                <td className="text-muted catn8-rap-sheet-booking-key">{String(k)}</td>
                                <td>{String(v || '')}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className="text-muted">No booking details available.</div>
                    )}
                  </div>

                  <div className="catn8-card p-3 mt-3">
                    <div className="fw-bold mb-2">Time of Death &amp; Alibi</div>
                    <div className="d-flex flex-column gap-2">
                      <div>
                        <div className="text-muted small">Estimated time of death</div>
                        <div className="fw-bold">{String(rapSheet?.time_of_death || 'Unknown')}</div>
                      </div>
                      <div>
                        <div className="text-muted small">Claimed alibi</div>
                        <div className="catn8-mystery-log-text">{String(rapSheet?.alibi?.lie_text || 'None documented.')}</div>
                        {rapSheet?.alibi?.truth_text ? (
                          <div className="mt-2">
                            <div className="text-muted small">Truth (admin)</div>
                            <div className="catn8-mystery-log-text">{String(rapSheet?.alibi?.truth_text || '')}</div>
                          </div>
                        ) : null}
                      </div>
                      {Array.isArray(rapSheet?.alibi?.trigger_questions) && rapSheet.alibi.trigger_questions.length ? (
                        <div>
                          <div className="text-muted small">Common alibi questions</div>
                          <div className="d-flex flex-column gap-1">
                            {rapSheet.alibi.trigger_questions.map((q, idx) => (
                              <div key={String(idx)} className="text-muted small">{String(q || '')}</div>
                            ))}
                          </div>
                        </div>
                      ) : null}
                    </div>
                  </div>

                  <div className="catn8-card p-3 mt-3">
                    <div className="fw-bold mb-2">Prior Arrests</div>
                    {Array.isArray(rapSheet?.prior_arrests) && rapSheet.prior_arrests.length ? (
                      <div className="d-flex flex-column gap-2">
                        {rapSheet.prior_arrests.map((a, idx) => (
                          <div key={String(a?.id || idx)} className="catn8-card p-2">
                            <div className="fw-bold">{String(a?.summary || 'Arrest')}</div>
                            {a?.date ? <div className="text-muted small">{String(a.date)}</div> : null}
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-muted">None documented.</div>
                    )}
                  </div>
                </div>

                <div className="col-12 col-lg-7">
                  <div className="catn8-card p-3">
                    <div className="fw-bold mb-2">Information obtained during rapport building</div>
                    {Array.isArray(rapSheet?.kid_detective) && rapSheet.kid_detective.length ? (
                      <div className="table-responsive">
                        <table className="table table-sm align-middle mb-0">
                          <thead>
                            <tr>
                              <th className="catn8-rap-sheet-col-question">Question</th>
                              <th>Answer</th>
                            </tr>
                          </thead>
                          <tbody>
                            {rapSheet.kid_detective.map((qa, idx) => (
                              <tr key={String(idx)}>
                                <td className="catn8-mystery-log-text">{String(qa?.question || '')}</td>
                                <td className="catn8-mystery-log-text">{String(qa?.answer || '')}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className="text-muted">No starter Q&amp;A available.</div>
                    )}
                  </div>

                  <div className="catn8-card p-3 mt-3">
                    <div className="fw-bold mb-2">Interrogation History</div>
                    {Array.isArray(rapSheet?.interrogations) && rapSheet.interrogations.length ? (
                      <div className="table-responsive">
                        <table className="table table-sm align-middle">
                          <thead>
                            <tr>
                              <th className="catn8-rap-sheet-col-time">Time</th>
                              <th className="catn8-rap-sheet-col-case">Case</th>
                              <th className="catn8-rap-sheet-col-scenario">Scenario</th>
                              <th>Q</th>
                              <th>A</th>
                            </tr>
                          </thead>
                          <tbody>
                            {rapSheet.interrogations.map((ev) => (
                              <tr key={String(ev?.id)}>
                                <td className="text-muted">{String(ev?.asked_at || '')}</td>
                                <td>{String(ev?.case_title || '')}</td>
                                <td>{String(ev?.scenario_title || '')}</td>
                                <td className="catn8-mystery-log-text">{String(ev?.question_text || '')}</td>
                                <td className="catn8-mystery-log-text">{String(ev?.answer_text || '')}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className="text-muted">No interrogations found yet.</div>
                    )}
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={gameMgmtRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl catn8-modal-wide">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Dossier</div>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className="btn btn-sm btn-outline-secondary"
                  onClick={() => {
                    setAdvancedModalOpen(true);
                    showModalNow(advancedModalRef, advancedModalApiRef);
                  }}
                  disabled={busy}
                >
                  Advanced
                </button>
                {isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-secondary"
                    onClick={() => {
                      try {
                        const el = document.activeElement;
                        if (el && typeof (el as any).blur === 'function') (el as any).blur();
                      } catch (_err) {
                      }
                      try {
                        const api = gameMgmtApiRef.current;
                        if (api && typeof api.hide === 'function') api.hide();
                      } catch (_err) {
                      }
                      window.setTimeout(() => {
                        if (typeof onOpenAiConfig === 'function') onOpenAiConfig();
                      }, 0);
                    }}
                    disabled={busy}
                    aria-label="AI Configuration"
                    title="AI Configuration"
                  >
                    {cogSvg}
                  </button>
                ) : null}
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">

              <div className="catn8-card p-3 mb-3">
                <div className="row g-3">
                  <div className="col-lg-6">
                    <div className="catn8-card p-3 h-100">
                      <div>
                        <div className="fw-bold">Selections</div>
                        <div className="form-text">Pick a mystery and case, or create a new case.</div>
                      </div>

                      <div className="d-flex align-items-end justify-content-between gap-2 mt-2">
                        <div className="flex-grow-1">
                          <label className="form-label" htmlFor="mystery-mystery">Mystery</label>
                          <select id="mystery-mystery" className="form-select" value={mysteryId} onChange={(e) => setMysteryId(e.target.value)} disabled={busy}>
                            <option value="">Select a mystery</option>
                            {mysteries.map((m) => (
                              <option key={m.id} value={String(m.id)} title={m.slug ? ('Slug: ' + String(m.slug)) : ''}>
                                {m.title}
                              </option>
                            ))}
                          </select>
                        </div>
                        <button type="button" className="btn btn-outline-secondary" onClick={loadMysteries} disabled={busy}>
                          Refresh Mysteries
                        </button>
                      </div>

                      <div className="d-flex align-items-end justify-content-between gap-2 mt-3">
                        <div className="flex-grow-1">
                          <label className="form-label" htmlFor="mystery-case">Case</label>
                          <select id="mystery-case" className="form-select" value={caseId} onChange={(e) => setCaseId(e.target.value)} disabled={busy || !mysteryId}>
                            <option value="">Select a case</option>
                            {cases.filter((c) => Number(c?.is_archived || 0) !== 1).map((c) => (
                              <option key={c.id} value={String(c.id)} title={c.slug ? ('Slug: ' + String(c.slug)) : ''}>
                                {c.title}
                              </option>
                            ))}
                          </select>

                          <div className="form-check mt-2">
                            <input
                              className="form-check-input"
                              type="checkbox"
                              id="mystery-is-template"
                              checked={Boolean(cases.find((c) => String(c.id) === String(caseId))?.is_template)}
                              disabled={busy || !caseId}
                              onChange={(e) => setCaseTemplateFlag({ case_id: caseId, is_template: e.target.checked })}
                            />
                            <label className="form-check-label" htmlFor="mystery-is-template">
                              This case is a template
                            </label>
                          </div>
                        </div>
                        <button type="button" className="btn btn-outline-secondary" onClick={() => loadCases(mysteryId)} disabled={busy || !mysteryId}>
                          Refresh Cases
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="col-lg-6">
                    <div className="catn8-card p-3 h-100">
                      <div className="fw-bold">Create Case</div>
                      <div className="form-text">Create a new case under the selected mystery.</div>

                      <form className="row g-2 mt-2" onSubmit={createCase}>
                        <div className="col-12">
                          <label className="form-label" htmlFor="mystery-new-case-title">Title</label>
                          <input
                            id="mystery-new-case-title"
                            className="form-control"
                            value={newCase.title}
                            onChange={(e) => setNewCase((c) => ({ ...c, title: e.target.value }))}
                            disabled={busy}
                            placeholder="Mysteries from the Graves"
                          />
                        </div>
                        <div className="col-12 d-flex justify-content-end">
                          <button type="submit" className="btn btn-primary" disabled={busy || !mysteryId}>
                            Create Case
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <div className="row g-3 mt-1">
                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div>
                      <div className="fw-bold">Crime Scene</div>
                      <div className="form-text">High-level case facts derived from the selected crime scene.</div>
                    </div>

                    {!scenarioId ? (
                      <div className="text-muted mt-2">Select a crime scene (Scenarios modal) to see details here.</div>
                    ) : (
                      <div className="row g-2 mt-2">
                        <div className="col-6">
                          <div className="text-muted small">Crime Scene</div>
                          <div className="fw-semibold">{String(scenario?.title || '')}</div>
                        </div>
                        <div className="col-6">
                          <div className="text-muted small">Location</div>
                          <div className="fw-semibold">{String(scenarioCrimeScene?.location || 'Not set')}</div>
                        </div>
                        <div className="col-6">
                          <div className="text-muted small">Weapon</div>
                          <div className="fw-semibold">{String(scenarioCrimeScene?.weapon || 'Not set')}</div>
                        </div>
                        <div className="col-6">
                          <div className="text-muted small">Motive</div>
                          <div className="fw-semibold">{String(scenarioCrimeScene?.motive || 'Not set')}</div>
                        </div>
                        <div className="col-12">
                          <div className="text-muted small">Briefing</div>
                          <div className="catn8-card p-2">
                            {(() => {
                              const c = scenarioConstraintsParsed || {};
                              const sb = (c && typeof c.briefing === 'object' && c.briefing) ? c.briefing : null;
                              const story = (sb && typeof sb === 'object' ? (sb.narrative_text || sb.story_text || sb.story || '') : '') || scenario?.story_text || scenario?.story || '';
                              const text = String(story || '').trim();
                              return text ? <div className="catn8-prewrap">{text}</div> : <div className="text-muted">No story text.</div>;
                            })()}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div className="fw-bold">Clone from Template</div>
                    <div className="form-text">Create a new case by copying entities/scenarios from a template.</div>

                    <form className="row g-2 mt-2" onSubmit={cloneFromTemplate}>
                        <div className="col-12">
                          <label className="form-label" htmlFor="mystery-clone-template">Template Case</label>
                          <select
                            id="mystery-clone-template"
                            className="form-select"
                            value={cloneTemplateCaseId}
                            onChange={(e) => setCloneTemplateCaseId(e.target.value)}
                            disabled={busy}
                          >
                            <option value="">Select a template</option>
                            {cases.filter((c) => Number(c.is_template || 0) === 1).map((c) => (
                              <option key={c.id} value={String(c.id)} title={c.slug ? ('Slug: ' + String(c.slug)) : ''}>
                                {c.title}
                              </option>
                            ))}
                          </select>
                        </div>
                        <div className="col-12">
                          <label className="form-label" htmlFor="mystery-clone-title">New Title</label>
                          <input
                            id="mystery-clone-title"
                            className="form-control"
                            value={cloneNewTitle}
                            onChange={(e) => setCloneNewTitle(e.target.value)}
                            disabled={busy}
                            placeholder="My New Mystery"
                          />
                        </div>
                        <div className="col-12 d-flex justify-content-end">
                          <button type="submit" className="btn btn-primary" disabled={busy}>
                            Clone Case
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                <div className="col-12">
                  <div className="catn8-card p-3">
                    <div className="d-flex align-items-center justify-content-between gap-2">
                      <div>
                        <div className="fw-bold">Case Setup</div>
                        <div className="form-text">Pick which master characters, locations, weapons, and motives are available for this case.</div>
                      </div>
                      <div className="d-flex gap-2">
                        <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => { loadMasterCharacters(); loadMasterLocations(); loadMasterWeapons(); loadMasterMotives(); }} disabled={busy || !isAdmin}>
                          Refresh Library
                        </button>
                        <button type="button" className="btn btn-sm btn-primary" onClick={saveCaseSetup} disabled={busy || !scenarioId}>
                          Save Case Setup
                        </button>
                      </div>
                    </div>

                    {!isAdmin ? (
                      <div className="alert alert-info mt-3 mb-0" role="alert">
                        Master rosters are admin-managed. Ask an admin to update the Asset Library.
                      </div>
                    ) : null}

                    <div className="row g-3 mt-1">
                      <div className="col-lg-6">
                        <div className="fw-bold">Available Characters</div>
                        <div className="form-text mb-2">These are pulled from this mystery's master roster.</div>
                        <div className="table-responsive">
                          <table className="table table-sm align-middle">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Name</th>
                              </tr>
                            </thead>
                            <tbody>
                              {masterCharacters.map((c) => {
                                const id = Number(c.id);
                                const checked = caseAvailableMasterCharacterIds.includes(id);
                                return (
                                  <tr key={c.id}>
                                    <td style={{ width: 42 }}>
                                      <input
                                        type="checkbox"
                                        className="form-check-input"
                                        checked={checked}
                                        disabled={busy || !scenarioId}
                                        onChange={(e) => {
                                          const on = e.target.checked;
                                          setCaseAvailableMasterCharacterIds((prev) => {
                                            const s = new Set(prev);
                                            if (on) s.add(id);
                                            else s.delete(id);
                                            return Array.from(s);
                                          });
                                        }}
                                      />
                                    </td>
                                    <td title={c.slug ? ('Slug: ' + String(c.slug)) : ''}>{c.name}</td>
                                  </tr>
                                );
                              })}
                              {!masterCharacters.length ? (
                                <tr>
                                  <td colSpan={2} className="text-muted">{isAdmin ? 'No master characters yet.' : 'Not available.'}</td>
                                </tr>
                              ) : null}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <div className="col-lg-6">
                        <div className="fw-bold">Available Locations</div>
                        <div className="form-text mb-2">These are pulled from this mystery's master roster.</div>
                        <div className="table-responsive">
                          <table className="table table-sm align-middle">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Name</th>
                              </tr>
                            </thead>
                            <tbody>
                              {masterLocations.map((l) => {
                                const id = Number(l.id);
                                const checked = caseAvailableMasterLocationIds.includes(id);
                                return (
                                  <tr key={l.id}>
                                    <td style={{ width: 42 }}>
                                      <input
                                        type="checkbox"
                                        className="form-check-input"
                                        checked={checked}
                                        disabled={busy || !scenarioId}
                                        onChange={(e) => {
                                          const on = e.target.checked;
                                          setCaseAvailableMasterLocationIds((prev) => {
                                            const s = new Set(prev);
                                            if (on) s.add(id);
                                            else s.delete(id);
                                            return Array.from(s);
                                          });
                                        }}
                                      />
                                    </td>
                                    <td title={l.slug ? ('Slug: ' + String(l.slug)) : ''}>{l.name}</td>
                                  </tr>
                                );
                              })}
                              {!masterLocations.length ? (
                                <tr>
                                  <td colSpan={2} className="text-muted">{isAdmin ? 'No master locations yet.' : 'Not available.'}</td>
                                </tr>
                              ) : null}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <div className="col-lg-6">
                        <div className="fw-bold">Available Weapons</div>
                        <div className="form-text mb-2">These are pulled from this mystery's master roster.</div>
                        <div className="table-responsive">
                          <table className="table table-sm align-middle">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Name</th>
                              </tr>
                            </thead>
                            <tbody>
                              {masterWeapons.map((w) => {
                                const id = Number(w.id);
                                const checked = caseAvailableMasterWeaponIds.includes(id);
                                return (
                                  <tr key={w.id}>
                                    <td style={{ width: 42 }}>
                                      <input
                                        type="checkbox"
                                        className="form-check-input"
                                        checked={checked}
                                        disabled={busy || !scenarioId}
                                        onChange={(e) => {
                                          const on = e.target.checked;
                                          setCaseAvailableMasterWeaponIds((prev) => {
                                            const s = new Set(prev);
                                            if (on) s.add(id);
                                            else s.delete(id);
                                            return Array.from(s);
                                          });
                                        }}
                                      />
                                    </td>
                                    <td title={w.slug ? ('Slug: ' + String(w.slug)) : ''}>{w.name}</td>
                                  </tr>
                                );
                              })}
                              {!masterWeapons.length ? (
                                <tr>
                                  <td colSpan={2} className="text-muted">{isAdmin ? 'No master weapons yet.' : 'Not available.'}</td>
                                </tr>
                              ) : null}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <div className="col-lg-6">
                        <div className="fw-bold">Available Motives</div>
                        <div className="form-text mb-2">These are pulled from this mystery's master roster.</div>
                        <div className="table-responsive">
                          <table className="table table-sm align-middle">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Name</th>
                              </tr>
                            </thead>
                            <tbody>
                              {masterMotives.map((m) => {
                                const id = Number(m.id);
                                const checked = caseAvailableMasterMotiveIds.includes(id);
                                return (
                                  <tr key={m.id}>
                                    <td style={{ width: 42 }}>
                                      <input
                                        type="checkbox"
                                        className="form-check-input"
                                        checked={checked}
                                        disabled={busy || !scenarioId}
                                        onChange={(e) => {
                                          const on = e.target.checked;
                                          setCaseAvailableMasterMotiveIds((prev) => {
                                            const s = new Set(prev);
                                            if (on) s.add(id);
                                            else s.delete(id);
                                            return Array.from(s);
                                          });
                                        }}
                                      />
                                    </td>
                                    <td title={m.slug ? ('Slug: ' + String(m.slug)) : ''}>{m.name}</td>
                                  </tr>
                                );
                              })}
                              {!masterMotives.length ? (
                                <tr>
                                  <td colSpan={2} className="text-muted">{isAdmin ? 'No master motives yet.' : 'Not available.'}</td>
                                </tr>
                              ) : null}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={scenariosModalRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Crime Scenes</div>
              <div className="d-flex align-items-center gap-2">
                {isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-secondary"
                    onClick={() => {
                      try {
                        const el = document.activeElement;
                        if (el && typeof (el as any).blur === 'function') (el as any).blur();
                      } catch (_err) {
                      }
                      try {
                        const api = scenariosModalApiRef.current;
                        if (api && typeof api.hide === 'function') api.hide();
                      } catch (_err) {
                      }
                      window.setTimeout(() => {
                        if (typeof onOpenAiConfig === 'function') onOpenAiConfig();
                      }, 0);
                    }}
                    disabled={busy}
                    aria-label="AI Configuration"
                    title="AI Configuration"
                  >
                    {cogSvg}
                  </button>
                ) : null}
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">

              {!caseId ? (
                <div className="alert alert-info" role="alert">
                  Select a mystery and case first.
                  <div className="mt-2">
                    <button
                      type="button"
                      className="btn btn-sm btn-primary"
                      onClick={() => {
                        transitionToModal(scenariosModalRef, gameMgmtRef, gameMgmtApiRef, setGameMgmtOpen);
                      }}
                      disabled={busy}
                    >
                      Open Dossier
                    </button>
                  </div>
                </div>
              ) : null}

              <div className="row g-3">
                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div>
                      <div className="fw-bold">Case Crime Scene</div>
                      <div className="form-text">Select an existing crime scene or create a new one for this case.</div>
                    </div>

                    {caseId && !scenarios.length ? (
                      <div className="alert alert-info mt-3" role="alert">
                        This case has no scenarios yet. Create one to unlock the full cast and Case File.
                        <div className="mt-2">
                          <button type="button" className="btn btn-sm btn-primary" onClick={ensureDefaultScenarioForCase} disabled={busy || !caseId}>
                            Create Matching Scenario
                          </button>
                        </div>
                      </div>
                    ) : null}

                    <form className="row g-2 align-items-end mt-2" onSubmit={createScenario}>
                      <div className="col-lg-12">
                        <label className="form-label" htmlFor="mystery-scenario-case">Case (for filtering)</label>
                        <div className="d-flex align-items-end gap-2">
                          <select
                            id="mystery-scenario-case"
                            className="form-select"
                            value={caseId}
                            onChange={(e) => setCaseId(e.target.value)}
                            disabled={busy || !mysteryId}
                          >
                            <option value="">Select a case</option>
                            {cases.filter((c) => Number(c?.is_archived || 0) !== 1).map((c) => (
                              <option key={c.id} value={String(c.id)} title={c.slug ? ('Slug: ' + String(c.slug)) : ''}>
                                {c.title}
                              </option>
                            ))}
                          </select>
                          <button type="button" className="btn btn-outline-secondary" onClick={() => loadCases(mysteryId)} disabled={busy || !mysteryId}>
                            Refresh
                          </button>
                        </div>
                      </div>

                      <div className="col-lg-6">
                        <label className="form-label" htmlFor="mystery-scenario">Crime Scene</label>
                        <select id="mystery-scenario" className="form-select" value={scenarioId} onChange={(e) => setScenarioId(e.target.value)} disabled={busy || !caseId}>
                          <option value="">Select a crime scene</option>
                          {scenarios.map((s) => (
                            <option key={s.id} value={String(s.id)} title={s.slug ? ('Slug: ' + String(s.slug)) : ''}>
                              {s.title}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div className="col-lg-6">
                        <label className="form-label" htmlFor="mystery-scenario-connected-case">Connected Case</label>
                        <select
                          id="mystery-scenario-connected-case"
                          className="form-select"
                          value={String(scenario?.case_id || caseId || '')}
                          onChange={(e) => reassignScenarioCase(e.target.value)}
                          disabled={busy || !scenarioId}
                        >
                          <option value="">Select a case</option>
                          {cases.filter((c) => Number(c?.is_archived || 0) !== 1).map((c) => (
                            <option key={c.id} value={String(c.id)} title={c.slug ? ('Slug: ' + String(c.slug)) : ''}>
                              {c.title}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div className="col-lg-6">
                        <label className="form-label" htmlFor="mystery-new-scenario-title">Title</label>
                        <input
                          id="mystery-new-scenario-title"
                          className="form-control"
                          value={newScenario.title}
                          onChange={(e) => setNewScenario((s) => ({ ...s, title: e.target.value }))}
                          disabled={busy || !caseId}
                          placeholder="The Alleyway Call"
                        />
                      </div>

                      <div className="col-lg-12 d-flex justify-content-between align-items-center">
                        <div className="form-check">
                          <input
                            id="mystery-delete-crime-scene-armed"
                            className="form-check-input"
                            type="checkbox"
                            checked={deleteScenarioArmed}
                            onChange={(e) => setDeleteScenarioArmed(e.target.checked)}
                            disabled={busy || !scenarioId}
                          />
                          <label className="form-check-label" htmlFor="mystery-delete-crime-scene-armed">Arm delete</label>
                        </div>

                        <div className="d-flex gap-2">
                          <button type="button" className="btn btn-outline-danger" disabled={busy || !scenarioId} onClick={deleteScenario}>
                            Delete Crime Scene
                          </button>
                          <button type="submit" className="btn btn-primary" disabled={busy || !caseId}>
                            Create Crime Scene
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>

                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div className="d-flex align-items-start justify-content-between gap-2">
                      <div>
                        <div className="fw-bold">Crime Details</div>
                        <div className="form-text mb-2">Quick view of the key crime details for the selected scenario.</div>
                      </div>
                    </div>

                    {!scenarioId ? (
                      <div className="text-muted">Select a scenario to view crime details.</div>
                    ) : (
                      <div className="d-flex flex-column gap-3">
                        <div className="row g-2">
                          <div className="col-6">
                            <div className="text-muted small">Killer</div>
                            <div className="fw-semibold">
                              {(() => {
                                const list = Array.isArray(scenarioCrimeScene?.murderer_ids) ? scenarioCrimeScene.murderer_ids : [];
                                const names = list.map((id) => entityNameById.get(Number(id)) || ('Entity #' + String(id)));
                                return names.length ? names.join(', ') : 'Not set';
                              })()}
                            </div>
                          </div>
                          <div className="col-6">
                            <div className="text-muted small">Motive</div>
                            <div className="fw-semibold">{String(scenarioCrimeScene?.motive || 'Not set')}</div>
                          </div>
                          <div className="col-6">
                            <div className="text-muted small">Weapon</div>
                            <div className="fw-semibold">{String(scenarioCrimeScene?.weapon || 'Not set')}</div>
                          </div>
                          <div className="col-6">
                            <div className="text-muted small">Location</div>
                            <div className="fw-semibold">{String(scenarioCrimeScene?.location || 'Not set')}</div>
                          </div>
                        </div>

                        <div className="d-flex justify-content-end">
                          <button
                            type="button"
                            className="btn btn-outline-secondary"
                            onClick={() => {
                              transitionToModal(scenariosModalRef, mysteriesModalRef, mysteriesModalApiRef, setMysteriesModalOpen);
                            }}
                            disabled={busy || !scenarioId}
                          >
                            Open Back Stories
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="row g-3 mt-1">
                <div className="col-12">
                  <div className="catn8-card p-3">
                    <div className="d-flex justify-content-between align-items-start gap-2">
                      <div>
                        <div className="fw-bold">Story Book</div>
                        <div className="form-text">Store and edit reference mysteries (DB-backed) to use as story inspiration and structure.</div>
                      </div>
                      <div className="d-flex align-items-center gap-2">
                        <div className="form-check">
                          <input
                            id="mystery-story-book-include-archived"
                            className="form-check-input"
                            type="checkbox"
                            checked={storyBookIncludeArchived}
                            onChange={(e) => setStoryBookIncludeArchived(e.target.checked)}
                            disabled={busy || storyBookBusy}
                          />
                          <label className="form-check-label" htmlFor="mystery-story-book-include-archived">Show archived</label>
                        </div>
                        <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadStoryBookEntries} disabled={busy || storyBookBusy || !mysteryId}>
                          Refresh
                        </button>
                        {isAdmin ? (
                          <button type="button" className="btn btn-sm btn-outline-primary" onClick={createNewStoryBookEntry} disabled={busy || storyBookBusy}>
                            New
                          </button>
                        ) : null}
                      </div>
                    </div>

                    {storyBookError ? (
                      <div className="alert alert-danger mt-2" role="alert">{String(storyBookError)}</div>
                    ) : null}

                    <div className="row g-2 mt-1">
                      <div className="col-lg-4">
                        <label className="form-label" htmlFor="mystery-story-book-select">Entry</label>
                        <select
                          id="mystery-story-book-select"
                          className="form-select"
                          value={storyBookSelectedId}
                          onChange={(e) => {
                            const v = String(e.target.value || '');
                            void loadStoryBookEntry(v);
                          }}
                          disabled={busy || storyBookBusy || !mysteryId}
                        >
                          <option value="">Select</option>
                          {storyBookEntries.map((x) => (
                            <option key={'sbe' + String(x.id)} value={String(x.id)}>
                              {String(x.title || x.slug || ('Entry #' + String(x.id)))}
                            </option>
                          ))}
                        </select>
                      </div>
                      <div className="col-lg-4">
                        <label className="form-label" htmlFor="mystery-story-book-title">Title</label>
                        <input
                          id="mystery-story-book-title"
                          className="form-control"
                          value={storyBookTitleDraft}
                          onChange={(e) => setStoryBookTitleDraft(e.target.value)}
                          disabled={busy || storyBookBusy || !isAdmin}
                          placeholder="The Locked Room Affair"
                        />
                      </div>
                      <div className="col-lg-4">
                        <label className="form-label" htmlFor="mystery-story-book-slug">Slug (optional)</label>
                        <input
                          id="mystery-story-book-slug"
                          className="form-control"
                          value={storyBookSlugDraft}
                          onChange={(e) => setStoryBookSlugDraft(e.target.value)}
                          disabled={busy || storyBookBusy || !isAdmin}
                          placeholder="locked-room-affair"
                        />
                      </div>
                    </div>

                    <div className="row g-2 mt-1">
                      <div className="col-lg-8">
                        <label className="form-label" htmlFor="mystery-story-book-source">Source Text</label>
                        <textarea
                          id="mystery-story-book-source"
                          className="form-control"
                          rows={10}
                          value={storyBookSourceDraft}
                          onChange={(e) => setStoryBookSourceDraft(e.target.value)}
                          disabled={busy || storyBookBusy || !isAdmin}
                          spellCheck={false}
                        />
                      </div>
                      <div className="col-lg-4">
                        <label className="form-label" htmlFor="mystery-story-book-meta">Meta (JSON object)</label>
                        <textarea
                          id="mystery-story-book-meta"
                          className="form-control"
                          rows={10}
                          value={storyBookMetaDraft}
                          onChange={(e) => setStoryBookMetaDraft(e.target.value)}
                          disabled={busy || storyBookBusy || !isAdmin}
                          spellCheck={false}
                        />
                      </div>
                    </div>

                    {isAdmin ? (
                      <div className="d-flex justify-content-end gap-2 mt-2">
                        <button type="button" className="btn btn-outline-danger" onClick={archiveStoryBookEntry} disabled={busy || storyBookBusy || !storyBookSelectedId}>
                          Archive
                        </button>
                        <button type="button" className="btn btn-primary" onClick={saveStoryBookEntry} disabled={busy || storyBookBusy || !mysteryId}>
                          Save
                        </button>
                      </div>
                    ) : null}
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={mysteriesModalRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Back Stories</div>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className="btn btn-sm btn-outline-secondary"
                  onClick={() => void refreshStoryAndColdHardFacts()}
                  disabled={busy || !scenarioId}
                  aria-label="Refresh"
                  title="Refresh"
                >
                  {refreshSvg}
                </button>
                <button
                  type="button"
                  className={'btn btn-sm btn-primary catn8-dirty-save' + (storyColdHardFactsDirty ? ' catn8-dirty-save--visible' : '')}
                  onClick={saveScenarioColdHardFacts}
                  disabled={busy || !scenarioId || !storyColdHardFactsDirty}
                >
                  Save
                </button>
                {isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-secondary"
                    onClick={() => {
                      try {
                        const el = document.activeElement;
                        if (el && typeof (el as any).blur === 'function') (el as any).blur();
                      } catch (_err) {
                      }
                      try {
                        const api = mysteriesModalApiRef.current;
                        if (api && typeof api.hide === 'function') api.hide();
                      } catch (_err) {
                      }
                      window.setTimeout(() => {
                        if (typeof onOpenAiConfig === 'function') onOpenAiConfig();
                      }, 0);
                    }}
                    disabled={busy}
                    aria-label="AI Configuration"
                    title="AI Configuration"
                  >
                    {cogSvg}
                  </button>
                ) : null}
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">

              {!scenarioId ? (
                <div className="alert alert-info" role="alert">
                  Select a crime scene first.
                  <div className="mt-2">
                    <button
                      type="button"
                      className="btn btn-sm btn-primary"
                      onClick={() => {
                        transitionToModal(mysteriesModalRef, scenariosModalRef, scenariosModalApiRef, setScenariosModalOpen);
                      }}
                      disabled={busy}
                    >
                      Open Crime Scenes
                    </button>
                  </div>
                </div>
              ) : null}

              <div className="row g-3">
                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div>
                      <div className="fw-bold">Stories</div>
                      <div className="form-text">Select a story (crime scene) to view/edit its narrative.</div>
                    </div>

                    {!caseId ? (
                      <div className="text-muted mt-2">Select a case first.</div>
                    ) : !scenarios.length ? (
                      <div className="text-muted mt-2">No crime scenes yet. Create one in the Crime Scenes modal.</div>
                    ) : (
                      <div className="list-group mt-2">
                        {scenarios.map((s: any) => {
                          const id = String(s?.id || '');
                          const active = String(scenarioId || '') === id;
                          return (
                            <button
                              type="button"
                              key={'story' + id}
                              className={active ? 'list-group-item list-group-item-action active' : 'list-group-item list-group-item-action'}
                              onClick={() => setScenarioId(id)}
                              disabled={busy}
                            >
                              {String(s?.title || ('Story #' + id))}
                            </button>
                          );
                        })}
                      </div>
                    )}
                  </div>
                </div>

                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div className="d-flex align-items-start justify-content-between gap-2">
                      <div>
                        <div className="fw-bold">Briefing</div>
                        <div className="form-text">Short briefing text for the selected scenario.</div>
                      </div>

                      <div className="d-flex align-items-center gap-2">
                        <button
                          type="button"
                          className="btn btn-sm btn-outline-secondary"
                          onClick={() => openJsonPreview({
                            title: 'bootstrap_scenario',
                            payload: {
                              endpoint: '/api/mystery/admin.php?action=bootstrap_scenario',
                              method: 'POST',
                              body: {
                                scenario_id: Number(scenarioId || 0),
                                min_suspects: 8,
                                story_book_entry_id: Number(storyBookSelectedId || 0) || 0,
                              },
                            },
                          })}
                          disabled={busy || !scenarioId}
                        >
                          View JSON
                        </button>
                        <button
                          type="button"
                          className="btn btn-sm btn-outline-primary"
                          onClick={async () => {
                            const sid = Number(scenarioId || 0);
                            if (!sid) return;
                            setBusy(true);
                            setError('');
                            setMessage('');
                            try {
                              await ApiClient.post('/api/mystery/admin.php?action=bootstrap_scenario', {
                                scenario_id: sid,
                                min_suspects: 8,
                                story_book_entry_id: Number(storyBookSelectedId || 0) || 0,
                              });
                              await loadScenario(sid);
                              await loadScenarioEntities(sid);
                              storyGenSyncScenarioIdRef.current = sid;
                              setStoryGenSync({ active: true, status: 'Generating', error: '', crimeStatus: 'queued', storyStatus: 'queued' });
                              setMessage('Story generation queued.');
                            } catch (e) {
                              setError((e as any)?.message || 'Failed to queue story generation');
                            } finally {
                              setBusy(false);
                            }
                          }}
                          disabled={busy || !scenarioId}
                          title="Queues crime details + narrative generation for this scenario"
                        >
                          Generate / Regenerate
                        </button>
                      </div>
                    </div>

                     <div className="mt-2 d-flex justify-content-end">
                       <div className="d-flex gap-2">
                         <button
                           type="button"
                           className="btn btn-sm btn-outline-secondary"
                           onClick={() => openJsonPreview({
                             title: 'enqueue_job: generate_missing_depositions',
                             payload: {
                               endpoint: '/api/mystery/admin.php?action=enqueue_job',
                               method: 'POST',
                               body: {
                                 case_id: Number(caseId) || 0,
                                 scenario_id: Number(scenarioId) || 0,
                                 action: 'generate_missing_depositions',
                                 spec: {},
                               },
                             },
                           })}
                           disabled={busy || !scenarioId}
                         >
                           View JSON
                         </button>
                         <button
                           type="button"
                           className="btn btn-sm btn-outline-secondary"
                           onClick={() => enqueueSpecificJob({ action: 'regenerate', spec: {}, requireScenario: true })}
                           disabled={busy || !scenarioId}
                           title="Queues a full backstory regenerate job for this scenario"
                         >
                           Regenerate Backstory
                         </button>
                         <button
                           type="button"
                           className="btn btn-sm btn-outline-primary"
                           onClick={() => enqueueSpecificJob({ action: 'generate_missing_depositions', spec: {}, requireScenario: true })}
                           disabled={busy || !scenarioId}
                         >
                           Generate Missing Depositions
                         </button>
                       </div>
                     </div>

                    {storyGenSync.error ? (
                      <div className="alert alert-danger mt-2" role="alert">{String(storyGenSync.error)}</div>
                    ) : storyGenSync.active || storyGenSync.status ? (
                      <div className="text-muted small mt-2">
                        {String(storyGenSync.status || '').trim()}
                        {(storyGenSync.crimeStatus || storyGenSync.storyStatus) ? (
                          <span>
                            {' '}({String(storyGenSync.crimeStatus || '')}/{String(storyGenSync.storyStatus || '')})
                          </span>
                        ) : null}
                        {!storyGenSync.active && storyGenSync.status && storyColdHardFactsDirty ? (
                          <span> Your edits are dirty; refresh wont overwrite them.</span>
                        ) : null}
                      </div>
                    ) : null}

                    {!scenarioId ? (
                      <div className="text-muted mt-2">Select a story to view the briefing.</div>
                    ) : (
                      <div className="mt-2">
                        <div className="catn8-card p-2">
                          {(() => {
                            const c = scenarioConstraintsParsed || {};
                            const sb = (c && typeof (c as any).briefing === 'object' && (c as any).briefing) ? (c as any).briefing : null;
                            const story = (sb && typeof sb === 'object' ? ((sb as any).narrative_text || (sb as any).story_text || (sb as any).story || '') : '') || (scenario as any)?.story_text || (scenario as any)?.story || '';
                            const text = String(story || '').trim();
                            if (!text) {
                              return <div className="text-muted">No briefing text yet. Generate and wait for the worker, then this view will auto-refresh.</div>;
                            }
                            return <div className="catn8-prewrap">{text}</div>;
                          })()}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                <div className="col-12">
                  <div className="catn8-card p-3">
                    <div className="d-flex justify-content-between align-items-start gap-2">
                      <div>
                        <div className="fw-bold">Characters (Inspector)</div>
                        <div className="form-text">Inspect per-character game logic before reviewing Cold Hard Facts.</div>
                      </div>
                      <div className="d-flex align-items-center gap-2">
                        <button
                          type="button"
                          className="btn btn-sm btn-outline-secondary"
                          onClick={() => {
                            const list = Array.isArray(scenarioEntities) ? scenarioEntities : [];
                            const ids = list
                              .filter((se: any) => {
                                const role = String(se?.role || '').trim();
                                return role === 'suspect' || role === 'killer' || role === 'witness' || role === 'bystander' || role === 'victim' || role === 'sheriff';
                              })
                              .map((se: any) => Number(se?.entity_id || 0))
                              .filter((n: any) => Number(n || 0) > 0);
                            setBackStoriesInspectorOpenEntityIds(Array.from(new Set(ids)));
                          }}
                          disabled={busy || !scenarioId}
                          title="Expand all characters"
                        >
                          Expand All
                        </button>
                        <button
                          type="button"
                          className="btn btn-sm btn-outline-secondary"
                          onClick={() => setBackStoriesInspectorOpenEntityIds([])}
                          disabled={busy}
                          title="Collapse all"
                        >
                          Collapse
                        </button>
                      </div>
                    </div>

                    {!scenarioId ? (
                      <div className="text-muted mt-2">Select a crime scene first.</div>
                    ) : (
                      <div className="mt-2 d-flex flex-column gap-2">
                        {(Array.isArray(scenarioEntities) ? scenarioEntities : [])
                          .filter((se: any) => {
                            const role = String(se?.role || '').trim();
                            return role === 'suspect' || role === 'killer' || role === 'witness' || role === 'bystander' || role === 'victim' || role === 'sheriff';
                          })
                          .map((se: any) => {
                            const eid = Number(se?.entity_id || 0);
                            const role = String(se?.role || '').trim();
                            const name = String(se?.entity_name || '').trim() || (eid ? ('Character #' + String(eid)) : 'Character');
                            const open = backStoriesInspectorOpenEntityIds.includes(eid);
                            const busyRow = Boolean(backStoriesInspectorBusyByEntityId[String(eid)]);
                            const err = String(backStoriesInspectorErrorByEntityId[String(eid)] || '').trim();
                            const dep = backStoriesInspectorDepositionByEntityId[String(eid)] || { text: '', updated_at: '' };
                            const rap = backStoriesInspectorRapSheetByEntityId[String(eid)] || null;
                            const override = (se && typeof se === 'object' && se.override && typeof se.override === 'object' && !Array.isArray(se.override)) ? se.override : {};

                            const entityLies = (Array.isArray(lies) ? lies : []).filter((l: any) => Number(l?.entity_id || 0) === eid);

                            const readOverride = (key: string) => {
                              const v = (override as any)?.[key];
                              if (v === null || v === undefined) return '';
                              if (typeof v === 'string') return v;
                              try {
                                return JSON.stringify(v, null, 2);
                              } catch (_err) {
                                return String(v);
                              }
                            };

                            const objective = readOverride('objective') || readOverride('personal_objective') || readOverride('day_objective');
                            const whereabouts = readOverride('whereabouts_at_time_of_death') || readOverride('location_at_time_of_crime') || readOverride('whereabouts');
                            const relevance = readOverride('relevance') || readOverride('relevance_to_crime') || readOverride('why_here') || readOverride('why_at_location');

                            return (
                              <div key={'bsi' + String(eid)} className="catn8-card p-2">
                                <button
                                  type="button"
                                  className="btn btn-sm btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
                                  onClick={() => toggleBackStoriesInspectorOpen(eid)}
                                  disabled={busy}
                                >
                                  <span className="fw-semibold">{name}</span>
                                  <span className="text-muted small">{role || 'character'}</span>
                                </button>

                                {open ? (
                                  <div className="mt-2">
                                    <div className="d-flex justify-content-between align-items-center gap-2">
                                      <div className="text-muted small">Entity #{eid}</div>
                                      <div className="d-flex gap-2">
                                        <button
                                          type="button"
                                          className="btn btn-sm btn-outline-secondary"
                                          onClick={() => void loadBackStoriesInspectorForEntity(eid)}
                                          disabled={busy || busyRow || !scenarioId}
                                          title="Loads deposition + rap sheet for this character"
                                        >
                                          {busyRow ? 'Loading' : 'Load Details'}
                                        </button>
                                        <button
                                          type="button"
                                          className="btn btn-sm btn-outline-secondary"
                                          onClick={() => openJsonPreview({
                                            title: 'enqueue_job: generate_deposition',
                                            payload: {
                                              endpoint: '/api/mystery/admin.php?action=enqueue_job',
                                              method: 'POST',
                                              body: {
                                                case_id: Number(caseId) || 0,
                                                scenario_id: Number(scenarioId) || 0,
                                                entity_id: Number(eid) || 0,
                                                action: 'generate_deposition',
                                                spec: {},
                                              },
                                            },
                                          })}
                                          disabled={busy || !scenarioId || !eid}
                                        >
                                          View Deposition Prompt
                                        </button>
                                        <button
                                          type="button"
                                          className="btn btn-sm btn-outline-primary"
                                          onClick={() => enqueueSpecificJob({ action: 'generate_deposition', spec: {}, requireScenario: true, entityId: eid })}
                                          disabled={busy || !scenarioId || !eid}
                                          title="Queue deposition generation"
                                        >
                                          Regenerate Deposition
                                        </button>
                                      </div>
                                    </div>

                                    {err ? (
                                      <div className="alert alert-danger mt-2 mb-0" role="alert">{err}</div>
                                    ) : null}

                                    <div className="row g-3 mt-1">
                                      <div className="col-lg-6">
                                        <div>
                                          <div className="fw-bold">Deposition</div>
                                          <div className="form-text">Scenario-specific sworn statement.</div>
                                        </div>
                                        <div className="mt-2 catn8-card p-2">
                                          {dep.updated_at ? (
                                            <div className="text-muted small mb-2">Updated: {String(dep.updated_at)}</div>
                                          ) : null}
                                          {String(dep.text || '').trim() ? (
                                            <div className="catn8-prewrap">{String(dep.text || '')}</div>
                                          ) : (
                                            <div className="text-muted">No deposition loaded (or not generated yet).</div>
                                          )}
                                        </div>
                                      </div>

                                      <div className="col-lg-6">
                                        <div>
                                          <div className="fw-bold">Time of Death / Whereabouts</div>
                                          <div className="form-text">From rap sheet (includes timeline alibi if present).</div>
                                        </div>
                                        <div className="mt-2 catn8-card p-2">
                                          {rap ? (
                                            <div className="d-flex flex-column gap-2">
                                              <div>
                                                <div className="text-muted small">Time of death</div>
                                                <div className="fw-semibold">{String(rap?.time_of_death || 'Unknown')}</div>
                                              </div>
                                              <div>
                                                <div className="text-muted small">Claimed alibi / location</div>
                                                <div className="catn8-prewrap">{String(rap?.alibi?.lie_text || 'None documented.')}</div>
                                              </div>
                                              {rap?.alibi?.truth_text ? (
                                                <div>
                                                  <div className="text-muted small">Truth (admin)</div>
                                                  <div className="catn8-prewrap">{String(rap?.alibi?.truth_text || '')}</div>
                                                </div>
                                              ) : null}
                                            </div>
                                          ) : whereabouts ? (
                                            <div className="catn8-prewrap">{whereabouts}</div>
                                          ) : (
                                            <div className="text-muted">Load details to see rap sheet / alibi.</div>
                                          )}
                                        </div>
                                      </div>

                                      <div className="col-lg-6">
                                        <div>
                                          <div className="fw-bold">Objective</div>
                                          <div className="form-text">From scenario overrides (if present).</div>
                                        </div>
                                        <div className="mt-2 catn8-card p-2">
                                          {objective ? <div className="catn8-prewrap">{objective}</div> : <div className="text-muted">No objective field found in override JSON.</div>}
                                        </div>
                                      </div>

                                      <div className="col-lg-6">
                                        <div>
                                          <div className="fw-bold">Relevance / Why they matter</div>
                                          <div className="form-text">From overrides (if present).</div>
                                        </div>
                                        <div className="mt-2 catn8-card p-2">
                                          {relevance ? <div className="catn8-prewrap">{relevance}</div> : <div className="text-muted">No relevance field found in override JSON.</div>}
                                        </div>
                                      </div>

                                      <div className="col-12">
                                        <div className="d-flex justify-content-between align-items-start gap-2">
                                          <div>
                                            <div className="fw-bold">Lies</div>
                                            <div className="form-text">All lies for this character in this scenario.</div>
                                          </div>
                                          <div className="text-muted small">{entityLies.length} total</div>
                                        </div>
                                        <div className="mt-2 d-flex flex-column gap-2">
                                          {entityLies.length ? entityLies.slice(0, 50).map((l: any) => (
                                            <div key={'bl' + String(l?.id || '')} className="catn8-card p-2">
                                              <div className="d-flex justify-content-between align-items-center gap-2">
                                                <div className="fw-semibold">{String(l?.topic_key || '(no topic_key)')}</div>
                                                <div className="text-muted small">{String(l?.lie_type || '')}{l?.relevance ? (' / ' + String(l.relevance)) : ''}</div>
                                              </div>
                                              <div className="mt-2">
                                                <div className="text-muted small">Lie</div>
                                                <div className="catn8-prewrap">{String(l?.lie_text || '')}</div>
                                              </div>
                                              {String(l?.truth_text || '').trim() ? (
                                                <div className="mt-2">
                                                  <div className="text-muted small">Truth</div>
                                                  <div className="catn8-prewrap">{String(l?.truth_text || '')}</div>
                                                </div>
                                              ) : null}
                                              {String(l?.notes || '').trim() ? (
                                                <div className="mt-2">
                                                  <div className="text-muted small">Notes</div>
                                                  <div className="catn8-prewrap">{String(l?.notes || '')}</div>
                                                </div>
                                              ) : null}
                                            </div>
                                          )) : (
                                            <div className="text-muted">No lies found for this character.</div>
                                          )}
                                          {entityLies.length > 50 ? (
                                            <div className="text-muted small">Showing first 50 lies</div>
                                          ) : null}
                                        </div>
                                      </div>

                                      <div className="col-12">
                                        <details>
                                          <summary className="fw-semibold">Raw override JSON</summary>
                                          <div className="mt-2">
                                            <textarea
                                              className="form-control"
                                              rows={8}
                                              value={JSON.stringify(override || {}, null, 2)}
                                              readOnly
                                              spellCheck={false}
                                            />
                                          </div>
                                        </details>
                                      </div>
                                    </div>
                                  </div>
                                ) : null}
                              </div>
                            );
                          })}
                      </div>
                    )}
                  </div>
                </div>

                <div className="col-12">
                  <div className="catn8-card p-3">
                    <div className="d-flex justify-content-between align-items-start gap-2">
                      <div>
                        <div className="fw-bold">Cold Hard Facts (long)</div>
                        <div className="form-text">Full narrative + paragraph-based annotations.</div>
                      </div>

                      <div className="d-flex align-items-center gap-2">
                        <div className="text-muted small">Updated: {coldHardFactsUpdatedAt || '(unknown)'}</div>
                        <button
                          type="button"
                          className="btn btn-sm btn-outline-secondary"
                          onClick={runColdHardFactsAudit}
                          disabled={busy || coldHardFactsAuditBusy || !scenarioId}
                          title="Checks & balances: validates Cold Hard Facts + annotations against scenario constraints/entities/lies/notes"
                        >
                          Audit
                        </button>
                      </div>
                    </div>

                    {coldHardFactsAuditOpen && coldHardFactsAudit ? (
                      <div className="catn8-card p-2 mt-2">
                        <div className="d-flex justify-content-between align-items-center gap-2">
                          <div className="fw-semibold">Audit Report</div>
                          <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => setColdHardFactsAuditOpen(false)} disabled={busy}>
                            Hide
                          </button>
                        </div>

                        {Array.isArray((coldHardFactsAudit as any)?.errors) && (coldHardFactsAudit as any).errors.length ? (
                          <div className="mt-2">
                            <div className="fw-semibold text-danger">Errors</div>
                            <ul className="mb-0">
                              {(coldHardFactsAudit as any).errors.map((m: any, i: number) => (
                                <li key={'ae' + String(i)}>{String(m)}</li>
                              ))}
                            </ul>
                          </div>
                        ) : (
                          <div className="mt-2 text-muted">No errors.</div>
                        )}

                        {Array.isArray((coldHardFactsAudit as any)?.warnings) && (coldHardFactsAudit as any).warnings.length ? (
                          <div className="mt-2">
                            <div className="fw-semibold text-warning">Warnings</div>
                            <ul className="mb-0">
                              {(coldHardFactsAudit as any).warnings.map((m: any, i: number) => (
                                <li key={'aw' + String(i)}>{String(m)}</li>
                              ))}
                            </ul>
                          </div>
                        ) : null}

                        {Array.isArray((coldHardFactsAudit as any)?.quick_fixes) && (coldHardFactsAudit as any).quick_fixes.length ? (
                          <div className="mt-3">
                            <div className="fw-semibold">Quick Fixes</div>
                            <div className="form-text mb-2">These are safe, deterministic fixes (no AI) generated from the audit.</div>

                            <div className="d-flex justify-content-between align-items-center gap-2 mb-2">
                              <div className="form-check">
                                <input
                                  id="mystery-apply-all-fixes-armed"
                                  className="form-check-input"
                                  type="checkbox"
                                  checked={applyAllFixesArmed}
                                  onChange={(e) => setApplyAllFixesArmed(e.target.checked)}
                                  disabled={busy || applyAllFixesBusy}
                                />
                                <label className="form-check-label" htmlFor="mystery-apply-all-fixes-armed">Arm apply all fixes</label>
                              </div>
                              <button
                                type="button"
                                className={applyAllFixesArmed ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-secondary'}
                                onClick={applyAllColdHardFactsFixes}
                                disabled={busy || applyAllFixesBusy || !scenarioId}
                                title="Applies all quick fixes shown in this audit, in order"
                              >
                                Apply All
                              </button>
                            </div>

                            <div className="d-flex flex-column gap-2">
                              {(coldHardFactsAudit as any).quick_fixes.slice(0, 15).map((f: any, i: number) => (
                                <div key={'qf' + String(f?.id || i)} className="d-flex justify-content-between align-items-center gap-2">
                                  <div className="text-muted small">{String(f?.label || '')}</div>
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-primary"
                                    onClick={() => applyColdHardFactsFix(f)}
                                    disabled={busy || !scenarioId}
                                  >
                                    Apply
                                  </button>
                                </div>
                              ))}
                              {(coldHardFactsAudit as any).quick_fixes.length > 15 ? (
                                <div className="text-muted small">Showing first 15 fixes</div>
                              ) : null}
                            </div>
                          </div>
                        ) : null}
                      </div>
                    ) : null}

                    <div className="mt-2">
                      <textarea
                        id="mystery-story-long"
                        className="form-control"
                        rows={12}
                        value={storyLongDraft}
                        onChange={(e) => setStoryLongDraft(e.target.value)}
                        disabled={busy || !scenarioId}
                        spellCheck={false}
                      />
                    </div>

                    <div className="mt-2">
                      <details>
                        <summary className="fw-semibold">JSON annotations</summary>
                        <div className="mt-2">
                          <div className="form-text">These annotations support Cold Hard Facts (long) and are not authoritative for weapon/motive/location. Crime details come from the crime scene fields stored in the database.</div>
                          <textarea
                            id="mystery-story-annotations"
                            className="form-control"
                            rows={6}
                            value={storyAnnotationsDraft}
                            onChange={(e) => setStoryAnnotationsDraft(e.target.value)}
                            disabled={busy || !scenarioId}
                            spellCheck={false}
                            placeholder={'[\n  {\n    "paragraph": 3,\n    "type": "weapon",\n    "weapon": "tire_iron",\n    "note": "Mentioned in paragraph 3"\n  }\n]'}
                          />
                        </div>
                      </details>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={advancedModalRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Advanced</div>
              <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div className="modal-body">

              {!scenarioId ? (
                <div className="alert alert-info" role="alert">
                  Select a scenario first.
                  <div className="mt-2">
                    <button
                      type="button"
                      className="btn btn-sm btn-primary"
                      onClick={() => {
                        setScenariosModalOpen(true);
                        showModalNow(scenariosModalRef, scenariosModalApiRef);
                      }}
                      disabled={busy}
                    >
                      Open Scenarios
                    </button>
                  </div>
                </div>
              ) : null}

              <div className="row g-3">
                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div>
                      <div className="fw-bold">Scenario Constraints (JSON)</div>
                      <div className="form-text mb-2">
                        This is your scenario constraint pack (killer/alibis/relationships/etc). Save is JSON-validated.
                      </div>
                    </div>
                    <textarea
                      className="form-control"
                      rows={12}
                      value={constraintsDraft}
                      onChange={(e) => setConstraintsDraft(e.target.value)}
                      disabled={busy || !scenarioId}
                      spellCheck={false}
                    />
                    <div className="d-flex justify-content-end gap-2 mt-2">
                      <button type="button" className="btn btn-outline-secondary" onClick={() => loadScenario(scenarioId)} disabled={busy || !scenarioId}>
                        Reload
                      </button>
                      <button type="button" className="btn btn-primary" onClick={saveConstraints} disabled={busy || !scenarioId}>
                        Save
                      </button>
                    </div>
                  </div>
                </div>

                <div className="col-lg-6">
                  <div className="catn8-card p-3 h-100">
                    <div>
                      <div className="fw-bold">Job Spec (JSON)</div>
                      <div className="form-text mb-2">Optional extra parameters for generation jobs.</div>
                    </div>
                    <textarea
                      className="form-control"
                      rows={12}
                      value={jobSpecText}
                      onChange={(e) => setJobSpecText(e.target.value)}
                      disabled={busy || !caseId}
                      spellCheck={false}
                    />
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={caseboardRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Caseboard</div>
              <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div className="modal-body">
              <div className="text-muted">Use Start / Resume to access Caseboard.</div>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={toolsRef}>
        <div className="modal-dialog modal-dialog-centered modal-lg">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Darkroom</div>
              <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div className="modal-body">
              <div className="text-muted">Use Start / Resume to access Darkroom.</div>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={mysterySettingsRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl catn8-modal-wide">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Communications</div>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className={isMysterySettingsDirty ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-secondary'}
                  onClick={() => saveMysterySettingsObject(mysterySettingsObj)}
                  disabled={busy || !isAdmin || !isMysterySettingsDirty}
                  aria-label="Save"
                  title={isMysterySettingsDirty ? 'Save changes' : 'No changes to save'}
                >
                  {saveSvg}
                </button>
                {isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-secondary"
                    onClick={() => {
                      try {
                        const modal = mysterySettingsApiRef.current;
                        if (modal) modal.hide();
                      } catch (_err) {
                      }
                      window.setTimeout(() => {
                        if (typeof onOpenAiVoiceConfig === 'function') onOpenAiVoiceConfig();
                      }, 0);
                    }}
                    disabled={busy}
                    aria-label="AI Voice Configuration"
                    title="AI Voice Configuration"
                  >
                    {cogSvg}
                  </button>
                ) : null}
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">
              {!isAdmin ? (
                <div className="alert alert-info" role="alert">Only admins can manage Mystery settings.</div>
              ) : null}
              {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}

              <datalist id="mystery-tts-voice-options">
                {filteredTtsVoices.map((v) => (
                  <option key={String(v?.name || '')} value={String(v?.name || '')} />
                ))}
              </datalist>

              <div className="d-flex justify-content-between align-items-center gap-2 mb-3">
                <div className="text-muted">Updated: {mysterySettingsUpdatedAt || '(unknown)'}</div>
                <div className="d-flex gap-2">
                  <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadMysterySettings} disabled={busy || !isAdmin}>
                    Refresh
                  </button>
                </div>
              </div>

              <ul className="nav nav-tabs mb-3" role="tablist">
                <li className="nav-item" role="presentation">
                  <button
                    className={'nav-link' + (mysterySettingsTab === 'voice' ? ' active' : '')}
                    type="button"
                    role="tab"
                    onClick={() => setMysterySettingsTab('voice')}
                  >
                    Communications
                  </button>
                </li>
                <li className="nav-item" role="presentation">
                  <button
                    className={'nav-link' + (mysterySettingsTab === 'advanced' ? ' active' : '')}
                    type="button"
                    role="tab"
                    onClick={() => setMysterySettingsTab('advanced')}
                  >
                    Advanced
                  </button>
                </li>
              </ul>

              {mysterySettingsTab === 'voice' ? (
                <div className="row g-3">
                  <div className="col-12">
                    <div className="catn8-card p-3">
                      <div className="d-flex justify-content-between align-items-center gap-2">
                        <div>
                          <div className="fw-bold">AI Model Sync</div>
                          <div className="form-text">Persist voice matches in the database so you can switch providers/models without remapping characters.</div>
                        </div>
                        <div className="d-flex gap-2">
                          <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadAgentProfiles} disabled={busy || !isAdmin}>
                            Refresh Profiles
                          </button>
                        </div>
                      </div>

                      <hr />

                      <div className="d-flex justify-content-between align-items-center gap-2">
                        <div>
                          <div className="fw-bold">Voice Map</div>
                          <div className="form-text">Keys are `voice_id` values stored on characters. Each entry can override language/voice/rate/pitch.</div>
                        </div>
                        <div className="d-flex gap-2">
                          <button type="button" className="btn btn-sm btn-outline-secondary" onClick={addMissingVoiceIdsFromCharacters} disabled={busy || !isAdmin}>
                            Add Missing
                          </button>
                          <button type="button" className="btn btn-sm btn-primary" onClick={autoAssignVoiceMapBestMatchAndSave} disabled={busy || !isAdmin}>
                            Auto-Assign + Save
                          </button>
                        </div>
                      </div>

                      <div className="row g-2 mt-3 align-items-end">
                        <div className="col-8">
                          <label className="form-label" htmlFor="mystery-new-voice-id">Add voice_id</label>
                          <input
                            id="mystery-new-voice-id"
                            className="form-control"
                            value={newVoiceMapId}
                            onChange={(e) => setNewVoiceMapId(e.target.value)}
                            disabled={busy || !isAdmin}
                            list="mystery-voice-id-suggestions"
                            placeholder="suspect_hank"
                          />
                          <datalist id="mystery-voice-id-suggestions">
                            {voiceIdSuggestions.map((v) => (
                              <option key={v} value={v} />
                            ))}
                          </datalist>
                        </div>
                        <div className="col-4">
                          <button
                            type="button"
                            className="btn btn-primary w-100"
                            onClick={() => {
                              const v = String(newVoiceMapId || '').trim();
                              if (!v) return;
                              addVoiceMapEntry(v);
                              setNewVoiceMapId('');
                            }}
                            disabled={busy || !isAdmin || !String(newVoiceMapId || '').trim()}
                          >
                            Add
                          </button>
                        </div>
                      </div>

                      <div className="table-responsive mt-3">
                        <table className="table table-sm align-middle">
                          <thead>
                            <tr>
                              <th>Character(s)</th>
                              <th>voice_id</th>
                              <th></th>
                              <th>Language</th>
                              <th>Voice name</th>
                              <th>Rate</th>
                              <th>Pitch</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody>
                            {voiceMapRowIds
                              .map((vid) => {
                                const active = getActiveVoiceMap(mysterySettingsObj);
                                const provider = String(active?.provider || 'google');
                                const vm = (active?.voice_map && typeof active.voice_map === 'object') ? active.voice_map : {};
                                const locks = (active?.voice_map_locks && typeof active.voice_map_locks === 'object') ? active.voice_map_locks : {};
                                const entry = (vm && typeof vm[vid] === 'object' && vm[vid]) ? vm[vid] : {};
                                const locked = Number(locks?.[vid] || 0) ? 1 : 0;
                                const mappedChars = voiceIdToCharacters.get(vid) || [];
                                const accentPref = String(Object.prototype.hasOwnProperty.call(accentDraftByVoiceId, vid) ? accentDraftByVoiceId[vid] : (voiceIdToAccentPreference.get(vid) || ''));
                                const mergedLanguage = String(entry.language_code || accentPref || mysterySettingsObj?.tts?.language_code || 'en-US');
                                return (
                                  <tr key={vid}>
                                    <td>
                                      {mappedChars.length ? (
                                        <div>{mappedChars.join(', ')}</div>
                                      ) : (
                                        <div className="text-muted">Not used</div>
                                      )}
                                    </td>
                                    <td className="text-muted">{vid}</td>
                                    <td>
                                      <button
                                        type="button"
                                        className={locked ? 'btn btn-sm btn-outline-warning' : 'btn btn-sm btn-outline-secondary'}
                                        onClick={(e) => {
                                          if (e && typeof e.preventDefault === 'function') e.preventDefault();
                                          if (e && typeof e.stopPropagation === 'function') e.stopPropagation();
                                          toggleVoiceMapLock(vid);
                                        }}
                                        disabled={busy || !isAdmin}
                                        title={locked ? 'Locked (click to unlock)' : 'Unlocked (click to lock)'}
                                        aria-label={locked ? 'Unlock voice map' : 'Lock voice map'}
                                      >
                                        {locked ? lockSvg : unlockSvg}
                                      </button>
                                    </td>
                                    <td>
                                      <input
                                        className="form-control form-control-sm"
                                        value={mergedLanguage}
                                        onChange={(e) => {
                                          const v = String(e.target.value || '');
                                          setAccentDraftByVoiceId((prev) => ({ ...(prev && typeof prev === 'object' ? prev : {}), [vid]: v }));
                                          updateVoiceMapEntry(vid, 'language_code', v);
                                        }}
                                        onBlur={(e) => setAccentPreferenceForVoiceId(vid, e.target.value)}
                                        disabled={busy || !isAdmin || Boolean(locked)}
                                        placeholder={String(mysterySettingsObj?.tts?.language_code || 'en-US')}
                                      />
                                    </td>
                                    <td>
                                      <input
                                        className="form-control form-control-sm"
                                        value={String(entry.voice_name || '')}
                                        onChange={(e) => updateVoiceMapEntry(vid, 'voice_name', e.target.value)}
                                        disabled={busy || !isAdmin || Boolean(locked)}
                                        placeholder={provider === 'google' ? String(mysterySettingsObj?.tts?.voice_name || '') : ''}
                                        list={provider === 'google' ? 'mystery-tts-voice-options' : undefined}
                                      />
                                      {provider === 'google' ? <div className="form-text">{describeVoiceTier(entry.voice_name) || ''}</div> : null}
                                    </td>
                                    <td>
                                      <input
                                        className="form-control form-control-sm"
                                        type="number"
                                        step="0.05"
                                        min="0.25"
                                        max="4"
                                        value={String(entry.speaking_rate ?? '')}
                                        onChange={(e) => updateVoiceMapEntry(vid, 'speaking_rate', e.target.value === '' ? '' : Number(e.target.value))}
                                        disabled={busy || !isAdmin || Boolean(locked) || provider !== 'google'}
                                        placeholder={String(mysterySettingsObj?.tts?.speaking_rate ?? 1.0)}
                                      />
                                    </td>
                                    <td>
                                      <input
                                        className="form-control form-control-sm"
                                        type="number"
                                        step="0.5"
                                        min="-20"
                                        max="20"
                                        value={String(entry.pitch ?? '')}
                                        onChange={(e) => updateVoiceMapEntry(vid, 'pitch', e.target.value === '' ? '' : Number(e.target.value))}
                                        disabled={busy || !isAdmin || Boolean(locked) || provider !== 'google'}
                                        placeholder={String(mysterySettingsObj?.tts?.pitch ?? 0.0)}
                                      />
                                    </td>
                                    <td className="text-end">
                                      <button type="button" className="btn btn-sm btn-outline-danger" onClick={() => deleteVoiceMapEntry(vid)} disabled={busy || !isAdmin || Boolean(locked)}>
                                        Remove
                                      </button>
                                    </td>
                                  </tr>
                                );
                              })}
                            {!voiceMapRowIds.length ? (
                              <tr>
                                <td colSpan={8} className="text-muted">No voice map entries yet.</td>
                              </tr>
                            ) : null}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              ) : null}

              {mysterySettingsTab === 'advanced' ? (
                <div className="row g-3">
                  <div className="col-lg-7">
                    <div className="catn8-card p-3 h-100">
                      <div className="fw-bold">Advanced JSON</div>
                      <div className="form-text mb-3">Use this for settings that are easier to manage as JSON.</div>

                      <div className="row g-2 align-items-end">
                        <div className="col-md-8">
                          <label className="form-label" htmlFor="mystery-settings-editor-target">Editor target</label>
                          <select
                            id="mystery-settings-editor-target"
                            className="form-select"
                            value={mysterySettingsEditorTarget}
                            onChange={(e) => setMysterySettingsEditorTarget(e.target.value)}
                            disabled={busy || !isAdmin}
                          >
                            <option value="tts">settings.tts</option>
                            <option value="tts_voice_map">settings.tts.voice_map (active)</option>
                            <option value="tts_voice_map_google">settings.tts.voice_maps.google.voice_map</option>
                            <option value="tts_voice_map_live">settings.tts.voice_maps.live.voice_map</option>
                            <option value="full">Full settings</option>
                          </select>
                        </div>
                        <div className="col-md-4">
                          <button type="button" className="btn btn-outline-secondary w-100" onClick={openMysterySettingsEditor} disabled={busy || !isAdmin}>
                            Open Editor
                          </button>
                        </div>
                      </div>

                      <div className="mt-3">
                        <label className="form-label" htmlFor="mystery-settings-json">Current JSON (read-only)</label>
                        <textarea id="mystery-settings-json" className="form-control" rows={8} value={mysterySettingsDraft} readOnly spellCheck={false} />
                      </div>
                    </div>
                  </div>

                  <div className="col-lg-5">
                    <div className="catn8-card p-3 h-100">
                      <div className="fw-bold">TTS Defaults</div>
                      <div className="form-text mb-3">Used when a voice map entry does not override a field.</div>

                      <div className="row g-2 mb-2">
                        <div className="col-12">
                          <label className="form-label" htmlFor="mystery-tts-active-voice-map">Active Voice Map</label>
                          <select
                            id="mystery-tts-active-voice-map"
                            className="form-select"
                            value={getActiveVoiceMapProvider()}
                            onChange={(e) => setActiveVoiceMapProvider(e.target.value)}
                            disabled={busy || !isAdmin}
                          >
                            <option value="google">Google Cloud TTS</option>
                            <option value="live">Gemini Live</option>
                          </select>
                          <div className="form-text">Choose which providers voice map youre editing below.</div>
                        </div>
                      </div>

                      <div className="row g-2 mb-2">
                        <div className="col-6">
                          <label className="form-label" htmlFor="mystery-tts-tier-filter">Voice tier</label>
                          <select
                            id="mystery-tts-tier-filter"
                            className="form-select"
                            value={ttsVoiceTierFilter}
                            onChange={(e) => setTtsVoiceTierFilter(e.target.value)}
                            disabled={busy || !isAdmin}
                          >
                            <option value="all">All</option>
                            {ttsVoiceTierOptions.map((t) => (
                              <option key={t} value={t}>{t}</option>
                            ))}
                          </select>
                        </div>
                        <div className="col-6">
                          <label className="form-label" htmlFor="mystery-tts-gender-filter">Voice gender</label>
                          <select
                            id="mystery-tts-gender-filter"
                            className="form-select"
                            value={ttsVoiceGenderFilter}
                            onChange={(e) => setTtsVoiceGenderFilter(e.target.value)}
                            disabled={busy || !isAdmin}
                          >
                            <option value="all">All</option>
                            {ttsVoiceGenderOptions.map((g) => (
                              <option key={g} value={g}>{g}</option>
                            ))}
                          </select>
                        </div>
                        <div className="col-12">
                          <div className="form-text">
                            Showing {String(filteredTtsVoices.length)} of {String((Array.isArray(ttsVoices) ? ttsVoices : []).length)} voices
                          </div>
                        </div>
                      </div>

                      <div className="row g-2">
                        <div className="col-6">
                          <label className="form-label" htmlFor="mystery-tts-format">Output format</label>
                          <select
                            id="mystery-tts-format"
                            className="form-select"
                            value={String(mysterySettingsObj?.tts?.output_format || 'mp3')}
                            onChange={(e) => updateTtsField('output_format', e.target.value)}
                            disabled={busy || !isAdmin}
                          >
                            <option value="mp3">MP3</option>
                            <option value="wav">WAV</option>
                          </select>
                        </div>
                        <div className="col-6">
                          <label className="form-label" htmlFor="mystery-tts-language">Default language</label>
                          <input
                            id="mystery-tts-language"
                            className="form-control"
                            value={String(mysterySettingsObj?.tts?.language_code || 'en-US')}
                            onChange={(e) => updateTtsField('language_code', e.target.value)}
                            disabled={busy || !isAdmin}
                            placeholder="en-US"
                          />
                        </div>
                        <div className="col-12">
                          <label className="form-label" htmlFor="mystery-tts-voice">Default Google voice name</label>
                          <div className="d-flex gap-2">
                            <input
                              id="mystery-tts-voice"
                              className="form-control"
                              value={String(mysterySettingsObj?.tts?.voice_name || '')}
                              onChange={(e) => updateTtsField('voice_name', e.target.value)}
                              disabled={busy || !isAdmin}
                              placeholder="en-US-Standard-C"
                              list="mystery-tts-voice-options"
                            />
                            <button type="button" className="btn btn-outline-secondary" onClick={loadTtsVoices} disabled={busy || !isAdmin}>
                              Refresh
                            </button>
                          </div>
                          <div className="form-text">
                            {describeVoiceTier(mysterySettingsObj?.tts?.voice_name) || (ttsVoicesLoadedAt ? 'Voices loaded.' : 'Voices not loaded yet.')}
                            {ttsVoicesLoadedAt ? '  ' + String(ttsVoices.length) + ' voices' : ''}
                          </div>
                        </div>
                        <div className="col-6">
                          <label className="form-label" htmlFor="mystery-tts-rate">Default speaking rate</label>
                          <input
                            id="mystery-tts-rate"
                            className="form-control"
                            type="number"
                            step="0.05"
                            min="0.25"
                            max="4"
                            value={String(mysterySettingsObj?.tts?.speaking_rate ?? 1.0)}
                            onChange={(e) => updateTtsField('speaking_rate', Number(e.target.value))}
                            disabled={busy || !isAdmin}
                          />
                        </div>
                        <div className="col-6">
                          <label className="form-label" htmlFor="mystery-tts-pitch">Default pitch</label>
                          <input
                            id="mystery-tts-pitch"
                            className="form-control"
                            type="number"
                            step="0.5"
                            min="-20"
                            max="20"
                            value={String(mysterySettingsObj?.tts?.pitch ?? 0.0)}
                            onChange={(e) => updateTtsField('pitch', Number(e.target.value))}
                            disabled={busy || !isAdmin}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : null}

            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={mysterySettingsEditorRef}>
        <div className="modal-dialog modal-dialog-centered modal-lg">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Mystery Settings JSON Editor</div>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className={isMysterySettingsEditorDirty ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-secondary'}
                  onClick={() => applyMysterySettingsEditor({ saveToServer: 1 })}
                  disabled={busy || !isAdmin || !isMysterySettingsEditorDirty}
                  aria-label="Save"
                  title={isMysterySettingsEditorDirty ? 'Save changes' : 'No changes to save'}
                >
                  {saveSvg}
                </button>
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">
              {mysterySettingsEditorError ? <div className="alert alert-danger" role="alert">{mysterySettingsEditorError}</div> : null}

              <div className="row g-2 align-items-end">
                <div className="col-8">
                  <label className="form-label" htmlFor="mystery-settings-editor-target-2">Target</label>
                  <select
                    id="mystery-settings-editor-target-2"
                    className="form-select"
                    value={mysterySettingsEditorTarget}
                    onChange={(e) => setMysterySettingsEditorTarget(e.target.value)}
                    disabled={busy || !isAdmin}
                  >
                    <option value="tts">settings.tts</option>
                    <option value="tts_voice_map">settings.tts.voice_map (active)</option>
                    <option value="tts_voice_map_google">settings.tts.voice_maps.google.voice_map</option>
                    <option value="tts_voice_map_live">settings.tts.voice_maps.live.voice_map</option>
                    <option value="full">Full settings</option>
                  </select>
                </div>
                <div className="col-4 d-flex gap-2">
                  <button
                    type="button"
                    className="btn btn-outline-secondary w-100"
                    onClick={() => applyMysterySettingsEditor({ saveToServer: 0 })}
                    disabled={busy || !isAdmin}
                  >
                    Apply
                  </button>
                </div>
              </div>

              <div className="mt-3">
                <label className="form-label" htmlFor="mystery-settings-editor-text">JSON</label>
                <textarea
                  id="mystery-settings-editor-text"
                  className="form-control"
                  rows={12}
                  value={mysterySettingsEditorText}
                  onChange={(e) => setMysterySettingsEditorText(e.target.value)}
                  disabled={busy || !isAdmin}
                  spellCheck={false}
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={masterDeleteConfirmRef}>
        <div className="modal-dialog modal-dialog-centered">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Delete permanently?</div>
              <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div className="modal-body">
              <div className="mb-2">
                This will permanently delete the archived asset:
              </div>
              <div className="fw-bold">
                {String((pendingMasterDelete && typeof pendingMasterDelete === 'object' && pendingMasterDelete.item)
                  ? (pendingMasterDelete.item.name || pendingMasterDelete.item.slug || pendingMasterDelete.item.id || '')
                  : '')}
              </div>
              <div className="form-text">
                This cannot be undone.
              </div>
            </div>
            <div className="modal-footer">
              <button
                type="button"
                className="btn btn-outline-secondary"
                data-bs-dismiss="modal"
                disabled={busy}
              >
                Cancel
              </button>
              <button
                type="button"
                className="btn btn-danger"
                onClick={confirmMasterAssetDelete}
                disabled={busy || !isAdmin || !(pendingMasterDelete && typeof pendingMasterDelete === 'object' && pendingMasterDelete.item)}
              >
                Delete permanently
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={assetLibraryRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl catn8-modal-wide">
          <div className="modal-content">
            <div className="modal-header">
              <div className="fw-bold">Asset Library (Master Rosters)</div>
              <div className="d-flex align-items-center gap-3">
                {isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-primary"
                    onClick={backfillMasterAssetColumnsFromJson}
                    disabled={busy || !isAdmin}
                    title="Populate curated DB columns from existing Data JSON (fills blanks only)"
                  >
                    Import from JSON
                  </button>
                ) : null}
                {isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-danger"
                    onClick={cleanupMasterOnlyFieldsForMystery}
                    disabled={busy || !isAdmin}
                    title="Remove master-only fields from ALL case character JSON for this mystery"
                  >
                    Cleanup Case JSON
                  </button>
                ) : null}
                {isAdmin ? (
                  <button
                    type="button"
                    className="btn btn-sm btn-outline-secondary"
                    onClick={linkAndImportCaseDetailsForMystery}
                    disabled={busy || !isAdmin}
                    title="Link case characters to master assets and import missing rap sheet fields into master library"
                  >
                    Link + Import Case Details
                  </button>
                ) : null}
                <label className="form-check form-switch m-0">
                  <input
                    className="form-check-input"
                    type="checkbox"
                    checked={masterAssetsIncludeArchived}
                    onChange={(e) => {
                      const next = !!e.target.checked;
                      setMasterAssetsIncludeArchived(next);
                    }}
                    disabled={busy || !isAdmin}
                  />
                  <span className="form-check-label">Show archived</span>
                </label>
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body catn8-asset-library">
              {!isAdmin ? (
                <div className="alert alert-info" role="alert">
                  Only admins can manage the global master rosters.
                </div>
              ) : null}

              {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
              {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

              <div className="row g-2">
                <div className="col-12 col-md-6 col-xl-3">
                  <div className="catn8-card catn8-mystery-roster-card p-2 h-100">
                    <div className="d-flex align-items-center justify-content-between gap-2">
                      <div>
                        <div className="fw-bold">Master Characters</div>
                        <div className="form-text">One shared roster across all games/cases.</div>
                      </div>
                      <div className="d-flex align-items-center gap-2">
                        <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadMasterCharacters} disabled={busy || !isAdmin}>
                          Refresh
                        </button>
                      </div>
                    </div>

                    <form className="row g-2 mt-3" onSubmit={upsertMasterCharacter}>
                      <div className="col-8">
                        <label className="form-label" htmlFor="mystery-master-character-name">New character name</label>
                        <input
                          id="mystery-master-character-name"
                          className="form-control"
                          value={newMasterCharacter.name}
                          onChange={(e) => setNewMasterCharacter((c) => ({ ...c, name: e.target.value }))}
                          disabled={busy || !isAdmin}
                          placeholder="Chief Hank Mercer"
                        />
                      </div>
                      <div className="col-4 d-flex justify-content-end">
                        <button type="submit" className="btn btn-primary w-100" disabled={busy || !isAdmin}>
                          Add
                        </button>
                      </div>
                    </form>

                    <div className="table-responsive mt-3">
                      <table className="table table-sm align-middle">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th className="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {masterCharacters.map((c) => (
                            <tr key={c.id}>
                              <td>
                                <input
                                  className="form-control form-control-sm"
                                  value={getMasterAssetNameDraft({ type: 'character', id: c.id, fallback: c.name })}
                                  onChange={(e) => updateMasterAssetNameDraft({ type: 'character', id: c.id, value: e.target.value })}
                                  onBlur={() => saveMasterAssetInlineName({ type: 'character', item: c })}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                      e.preventDefault();
                                      e.currentTarget.blur();
                                    }
                                  }}
                                  disabled={busy || !isAdmin}
                                />
                                {Number(c.is_archived || 0) ? <div className="form-text">Archived</div> : null}
                              </td>
                              <td className="text-end">
                                <div className="btn-group btn-group-sm" role="group">
                                  {masterAssetsIncludeArchived && Number(c.is_archived || 0) ? (
                                    <button
                                      type="button"
                                      className="btn btn-outline-danger"
                                      onClick={() => requestMasterAssetDelete({ type: 'character', item: c })}
                                      disabled={busy || !isAdmin}
                                      title="Delete permanently"
                                      aria-label="Delete permanently"
                                    >
                                      {trashSvg}
                                    </button>
                                  ) : (
                                    <button
                                      type="button"
                                      className="btn btn-outline-secondary"
                                      onClick={() => openMasterAssetDetails({ type: 'character', item: c })}
                                      disabled={busy || !isAdmin}
                                      title="Edit details"
                                    >
                                      {pencilSvg}
                                    </button>
                                  )}
                                  <button
                                    type="button"
                                    className={Number(c.is_case_locked || 0)
                                      ? 'btn btn-outline-danger'
                                      : (Number(c.is_regen_locked || 0) ? 'btn btn-outline-warning' : 'btn btn-outline-secondary')}
                                    onClick={() => {
                                      if (Number(c.is_case_locked || 0)) return;
                                      setMasterAssetRegenLock({ type: 'character', item: c, is_regen_locked: Number(c.is_regen_locked || 0) ? 0 : 1 });
                                    }}
                                    disabled={busy || !isAdmin || Boolean(Number(c.is_case_locked || 0))}
                                    title={Number(c.is_case_locked || 0)
                                      ? 'Locked: referenced by an ongoing case'
                                      : (Number(c.is_regen_locked || 0) ? 'Locked from regeneration (click to unlock)' : 'Unlocked (click to lock from regeneration)')}
                                    aria-label={Number(c.is_case_locked || 0)
                                      ? 'Locked due to ongoing case'
                                      : (Number(c.is_regen_locked || 0) ? 'Unlock from regeneration' : 'Lock from regeneration')}
                                  >
                                    {Number(c.is_case_locked || 0) ? <span className="text-danger">{lockSvg}</span> : (Number(c.is_regen_locked || 0) ? lockSvg : unlockSvg)}
                                  </button>
                                  <button
                                    type="button"
                                    className={Number(c.is_archived || 0) ? 'btn btn-outline-success' : 'btn btn-outline-danger'}
                                    onClick={() => archiveMasterAsset({ type: 'character', id: c.id, is_archived: Number(c.is_archived || 0) ? 0 : 1 })}
                                    disabled={busy || !isAdmin}
                                  >
                                    {Number(c.is_archived || 0) ? 'Restore' : 'Archive'}
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                          {!masterCharacters.length ? (
                            <tr>
                              <td colSpan={2} className="text-muted">{isAdmin ? 'No master characters yet.' : 'Not available.'}</td>
                            </tr>
                          ) : null}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div className="col-12 col-md-6 col-xl-3">
                  <div className="catn8-card catn8-mystery-roster-card p-2 h-100">
                    <div className="d-flex align-items-center justify-content-between gap-2">
                      <div>
                        <div className="fw-bold">Master Locations</div>
                        <div className="form-text">One shared roster across all games/cases.</div>
                      </div>
                      <div className="d-flex align-items-center gap-2">
                        <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadMasterLocations} disabled={busy || !isAdmin}>
                          Refresh
                        </button>
                      </div>
                    </div>

                    <form className="row g-2 mt-3" onSubmit={upsertMasterLocation}>
                      <div className="col-8">
                        <label className="form-label" htmlFor="mystery-master-location-name">New location name</label>
                        <input
                          id="mystery-master-location-name"
                          className="form-control"
                          value={newMasterLocation.name}
                          onChange={(e) => setNewMasterLocation((l) => ({ ...l, name: e.target.value }))}
                          disabled={busy || !isAdmin}
                          placeholder="Great Room"
                        />
                      </div>
                      <div className="col-4 d-flex justify-content-end">
                        <button type="submit" className="btn btn-primary w-100" disabled={busy || !isAdmin}>
                          Add
                        </button>
                      </div>
                    </form>

                    <div className="table-responsive mt-3">
                      <table className="table table-sm align-middle">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th className="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {masterLocations.map((l) => (
                            <tr key={l.id}>
                              <td>
                                <input
                                  className="form-control form-control-sm"
                                  value={getMasterAssetNameDraft({ type: 'location', id: l.id, fallback: l.name })}
                                  onChange={(e) => updateMasterAssetNameDraft({ type: 'location', id: l.id, value: e.target.value })}
                                  onBlur={() => saveMasterAssetInlineName({ type: 'location', item: l })}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                      e.preventDefault();
                                      e.currentTarget.blur();
                                    }
                                  }}
                                  disabled={busy || !isAdmin}
                                />
                                {Number(l.is_archived || 0) ? <div className="form-text">Archived</div> : null}
                              </td>
                              <td className="text-end">
                                <div className="btn-group btn-group-sm" role="group">
                                  {masterAssetsIncludeArchived && Number(l.is_archived || 0) ? (
                                    <button
                                      type="button"
                                      className="btn btn-outline-danger"
                                      onClick={() => requestMasterAssetDelete({ type: 'location', item: l })}
                                      disabled={busy || !isAdmin}
                                      title="Delete permanently"
                                      aria-label="Delete permanently"
                                    >
                                      {trashSvg}
                                    </button>
                                  ) : (
                                    <button
                                      type="button"
                                      className="btn btn-outline-secondary"
                                      onClick={() => openMasterAssetDetails({ type: 'location', item: l })}
                                      disabled={busy || !isAdmin}
                                      title="Edit details"
                                    >
                                      {pencilSvg}
                                    </button>
                                  )}
                                  <button
                                    type="button"
                                    className={Number(l.is_case_locked || 0)
                                      ? 'btn btn-outline-danger'
                                      : (Number(l.is_regen_locked || 0) ? 'btn btn-outline-warning' : 'btn btn-outline-secondary')}
                                    onClick={() => {
                                      if (Number(l.is_case_locked || 0)) return;
                                      setMasterAssetRegenLock({ type: 'location', item: l, is_regen_locked: Number(l.is_regen_locked || 0) ? 0 : 1 });
                                    }}
                                    disabled={busy || !isAdmin || Boolean(Number(l.is_case_locked || 0))}
                                    title={Number(l.is_case_locked || 0)
                                      ? 'Locked: referenced by an ongoing case'
                                      : (Number(l.is_regen_locked || 0) ? 'Locked from regeneration (click to unlock)' : 'Unlocked (click to lock from regeneration)')}
                                    aria-label={Number(l.is_case_locked || 0)
                                      ? 'Locked due to ongoing case'
                                      : (Number(l.is_regen_locked || 0) ? 'Unlock from regeneration' : 'Lock from regeneration')}
                                  >
                                    {Number(l.is_case_locked || 0) ? <span className="text-danger">{lockSvg}</span> : (Number(l.is_regen_locked || 0) ? lockSvg : unlockSvg)}
                                  </button>
                                  <button
                                    type="button"
                                    className={Number(l.is_archived || 0) ? 'btn btn-outline-success' : 'btn btn-outline-danger'}
                                    onClick={() => archiveMasterAsset({ type: 'location', id: l.id, is_archived: Number(l.is_archived || 0) ? 0 : 1 })}
                                    disabled={busy || !isAdmin}
                                  >
                                    {Number(l.is_archived || 0) ? 'Restore' : 'Archive'}
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                          {!masterLocations.length ? (
                            <tr>
                              <td colSpan={2} className="text-muted">{isAdmin ? 'No master locations yet.' : 'Not available.'}</td>
                            </tr>
                          ) : null}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div className="col-12 col-md-6 col-xl-3">
                  <div className="catn8-card catn8-mystery-roster-card p-2 h-100">
                    <div className="d-flex align-items-center justify-content-between gap-2">
                      <div>
                        <div className="fw-bold">Master Weapons</div>
                        <div className="form-text">One shared roster across all games/cases.</div>
                      </div>
                      <div className="d-flex align-items-center gap-2">
                        <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadMasterWeapons} disabled={busy || !isAdmin}>
                          Refresh
                        </button>
                      </div>
                    </div>

                    <form className="row g-2 mt-3" onSubmit={upsertMasterWeapon}>
                      <div className="col-8">
                        <label className="form-label" htmlFor="mystery-master-weapon-name">New weapon name</label>
                        <input
                          id="mystery-master-weapon-name"
                          className="form-control"
                          value={newMasterWeapon.name}
                          onChange={(e) => setNewMasterWeapon((w) => ({ ...w, name: e.target.value }))}
                          disabled={busy || !isAdmin}
                          placeholder="Fireplace Poker"
                        />
                      </div>
                      <div className="col-4 d-flex justify-content-end">
                        <button type="submit" className="btn btn-primary w-100" disabled={busy || !isAdmin}>
                          Add
                        </button>
                      </div>
                    </form>

                    <div className="table-responsive mt-3">
                      <table className="table table-sm align-middle">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th className="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {masterWeapons.map((w) => (
                            <tr key={w.id}>
                              <td>
                                <input
                                  className="form-control form-control-sm"
                                  value={getMasterAssetNameDraft({ type: 'weapon', id: w.id, fallback: w.name })}
                                  onChange={(e) => updateMasterAssetNameDraft({ type: 'weapon', id: w.id, value: e.target.value })}
                                  onBlur={() => saveMasterAssetInlineName({ type: 'weapon', item: w })}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                      e.preventDefault();
                                      e.currentTarget.blur();
                                    }
                                  }}
                                  disabled={busy || !isAdmin}
                                />
                                {Number(w.is_archived || 0) ? <div className="form-text">Archived</div> : null}
                              </td>
                              <td className="text-end">
                                <div className="btn-group btn-group-sm" role="group">
                                  {masterAssetsIncludeArchived && Number(w.is_archived || 0) ? (
                                    <button
                                      type="button"
                                      className="btn btn-outline-danger"
                                      onClick={() => requestMasterAssetDelete({ type: 'weapon', item: w })}
                                      disabled={busy || !isAdmin}
                                      title="Delete permanently"
                                      aria-label="Delete permanently"
                                    >
                                      {trashSvg}
                                    </button>
                                  ) : (
                                    <button
                                      type="button"
                                      className="btn btn-outline-secondary"
                                      onClick={() => openMasterAssetDetails({ type: 'weapon', item: w })}
                                      disabled={busy || !isAdmin}
                                      title="Edit details"
                                    >
                                      {pencilSvg}
                                    </button>
                                  )}
                                  <button
                                    type="button"
                                    className={Number(w.is_case_locked || 0)
                                      ? 'btn btn-outline-danger'
                                      : (Number(w.is_regen_locked || 0) ? 'btn btn-outline-warning' : 'btn btn-outline-secondary')}
                                    onClick={() => {
                                      if (Number(w.is_case_locked || 0)) return;
                                      setMasterAssetRegenLock({ type: 'weapon', item: w, is_regen_locked: Number(w.is_regen_locked || 0) ? 0 : 1 });
                                    }}
                                    disabled={busy || !isAdmin || Boolean(Number(w.is_case_locked || 0))}
                                    title={Number(w.is_case_locked || 0)
                                      ? 'Locked: referenced by an ongoing case'
                                      : (Number(w.is_regen_locked || 0) ? 'Locked from regeneration (click to unlock)' : 'Unlocked (click to lock from regeneration)')}
                                    aria-label={Number(w.is_case_locked || 0)
                                      ? 'Locked due to ongoing case'
                                      : (Number(w.is_regen_locked || 0) ? 'Unlock from regeneration' : 'Lock from regeneration')}
                                  >
                                    {Number(w.is_case_locked || 0) ? <span className="text-danger">{lockSvg}</span> : (Number(w.is_regen_locked || 0) ? lockSvg : unlockSvg)}
                                  </button>
                                  <button
                                    type="button"
                                    className={Number(w.is_archived || 0) ? 'btn btn-outline-success' : 'btn btn-outline-danger'}
                                    onClick={() => archiveMasterAsset({ type: 'weapon', id: w.id, is_archived: Number(w.is_archived || 0) ? 0 : 1 })}
                                    disabled={busy || !isAdmin}
                                  >
                                    {Number(w.is_archived || 0) ? 'Restore' : 'Archive'}
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                          {!masterWeapons.length ? (
                            <tr>
                              <td colSpan={2} className="text-muted">{isAdmin ? 'No master weapons yet.' : 'Not available.'}</td>
                            </tr>
                          ) : null}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div className="col-12 col-md-6 col-xl-3">
                  <div className="catn8-card catn8-mystery-roster-card p-2 h-100">
                    <div className="d-flex align-items-center justify-content-between gap-2">
                      <div>
                        <div className="fw-bold">Master Motives</div>
                        <div className="form-text">One shared roster across all games/cases.</div>
                      </div>
                      <div className="d-flex align-items-center gap-2">
                        <button type="button" className="btn btn-sm btn-outline-secondary" onClick={loadMasterMotives} disabled={busy || !isAdmin}>
                          Refresh
                        </button>
                      </div>
                    </div>

                    <form className="row g-2 mt-3" onSubmit={upsertMasterMotive}>
                      <div className="col-8">
                        <label className="form-label" htmlFor="mystery-master-motive-name">New motive name</label>
                        <input
                          id="mystery-master-motive-name"
                          className="form-control"
                          value={newMasterMotive.name}
                          onChange={(e) => setNewMasterMotive((m) => ({ ...m, name: e.target.value }))}
                          disabled={busy || !isAdmin}
                          placeholder="Revenge"
                        />
                      </div>
                      <div className="col-4 d-flex justify-content-end">
                        <button type="submit" className="btn btn-primary w-100" disabled={busy || !isAdmin}>
                          Add
                        </button>
                      </div>
                    </form>

                    <div className="table-responsive mt-3">
                      <table className="table table-sm align-middle">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th className="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {masterMotives.map((m) => (
                            <tr key={m.id}>
                              <td>
                                <input
                                  className="form-control form-control-sm"
                                  value={getMasterAssetNameDraft({ type: 'motive', id: m.id, fallback: m.name })}
                                  onChange={(e) => updateMasterAssetNameDraft({ type: 'motive', id: m.id, value: e.target.value })}
                                  onBlur={() => saveMasterAssetInlineName({ type: 'motive', item: m })}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                      e.preventDefault();
                                      e.currentTarget.blur();
                                    }
                                  }}
                                  disabled={busy || !isAdmin}
                                />
                                {Number(m.is_archived || 0) ? <div className="form-text">Archived</div> : null}
                              </td>
                              <td className="text-end">
                                <div className="btn-group btn-group-sm" role="group">
                                  {masterAssetsIncludeArchived && Number(m.is_archived || 0) ? (
                                    <button
                                      type="button"
                                      className="btn btn-outline-danger"
                                      onClick={() => requestMasterAssetDelete({ type: 'motive', item: m })}
                                      disabled={busy || !isAdmin}
                                      title="Delete permanently"
                                      aria-label="Delete permanently"
                                    >
                                      {trashSvg}
                                    </button>
                                  ) : (
                                    <button
                                      type="button"
                                      className="btn btn-outline-secondary"
                                      onClick={() => openMasterAssetDetails({ type: 'motive', item: m })}
                                      disabled={busy || !isAdmin}
                                      title="Edit details"
                                    >
                                      {pencilSvg}
                                    </button>
                                  )}
                                  <button
                                    type="button"
                                    className={Number(m.is_case_locked || 0)
                                      ? 'btn btn-outline-danger'
                                      : (Number(m.is_regen_locked || 0) ? 'btn btn-outline-warning' : 'btn btn-outline-secondary')}
                                    onClick={() => {
                                      if (Number(m.is_case_locked || 0)) return;
                                      setMasterAssetRegenLock({ type: 'motive', item: m, is_regen_locked: Number(m.is_regen_locked || 0) ? 0 : 1 });
                                    }}
                                    disabled={busy || !isAdmin || Boolean(Number(m.is_case_locked || 0))}
                                    title={Number(m.is_case_locked || 0)
                                      ? 'Locked: referenced by an ongoing case'
                                      : (Number(m.is_regen_locked || 0) ? 'Locked from regeneration (click to unlock)' : 'Unlocked (click to lock from regeneration)')}
                                    aria-label={Number(m.is_case_locked || 0)
                                      ? 'Locked due to ongoing case'
                                      : (Number(m.is_regen_locked || 0) ? 'Unlock from regeneration' : 'Lock from regeneration')}
                                  >
                                    {Number(m.is_case_locked || 0) ? <span className="text-danger">{lockSvg}</span> : (Number(m.is_regen_locked || 0) ? lockSvg : unlockSvg)}
                                  </button>
                                  <button
                                    type="button"
                                    className={Number(m.is_archived || 0) ? 'btn btn-outline-success' : 'btn btn-outline-danger'}
                                    onClick={() => archiveMasterAsset({ type: 'motive', id: m.id, is_archived: Number(m.is_archived || 0) ? 0 : 1 })}
                                    disabled={busy || !isAdmin}
                                  >
                                    {Number(m.is_archived || 0) ? 'Restore' : 'Archive'}
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                          {!masterMotives.length ? (
                            <tr>
                              <td colSpan={2} className="text-muted">{isAdmin ? 'No master motives yet.' : 'Not available.'}</td>
                            </tr>
                          ) : null}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={masterAssetDetailsRef}>
        <div className="modal-dialog modal-dialog-centered modal-xl">
            <div className="modal-content">
              <div className="modal-header">
                <div className="fw-bold">Asset Details</div>
                <div className="d-flex align-items-center gap-2">
                  <button
                    type="button"
                    className={isMasterAssetDetailsDirty ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-secondary'}
                    onClick={saveMasterAssetDetails}
                    disabled={busy || !isAdmin || !isMasterAssetDetailsDirty}
                    aria-label="Save"
                    title={isMasterAssetDetailsDirty ? 'Save changes' : 'No changes to save'}
                  >
                    {saveSvg}
                  </button>
                  {isAdmin ? (
                    <button
                      type="button"
                      className="btn btn-sm btn-outline-secondary"
                      onClick={() => {
                        try {
                          const el = document.activeElement;
                          if (el && typeof (el as any).blur === 'function') (el as any).blur();
                        } catch (_err) {
                        }
                        try {
                          const api = masterAssetDetailsApiRef.current;
                          if (api && typeof api.hide === 'function') api.hide();
                        } catch (_err) {
                        }
                        window.setTimeout(() => {
                          if (typeof onOpenAiImageConfig === 'function') onOpenAiImageConfig();
                        }, 0);
                      }}
                      disabled={busy}
                      aria-label="AI Image Configuration"
                      title="AI Image Configuration"
                    >
                      {cogSvg}
                    </button>
                  ) : null}
                  <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
              </div>
              <div className="modal-body">
                {!masterAssetDetailsItem ? (
                  <div className="text-muted">Select an asset first.</div>
                ) : (
                  <div className="row g-3">
                    <div className="col-12 col-xl-4">
                        <div className="catn8-card p-3 h-100">
                          <div className="d-flex justify-content-between align-items-center gap-2">
                            <div>
                              <div className="fw-bold">Basics</div>
                              <div className="form-text">Type: {String(masterAssetDetailsType || '').trim() || 'asset'}</div>
                            </div>
                            <div className="d-flex gap-2">
                              {String(masterAssetDetailsType || '').trim() === 'character' || String(masterAssetDetailsType || '').trim() === 'location' || String(masterAssetDetailsType || '').trim() === 'weapon' || String(masterAssetDetailsType || '').trim() === 'motive' ? (
                                <button
                                  type="button"
                                  className="btn btn-sm btn-outline-danger"
                                  onClick={clearMasterAssetFields}
                                  disabled={busy || !isAdmin || Boolean(Number(masterAssetDetailsItem?.is_regen_locked || 0))}
                                  title={Number(masterAssetDetailsItem?.is_regen_locked || 0) ? 'Unlock from regeneration to clear' : 'Clear fields'}
                                >
                                  Clear Fields
                                </button>
                              ) : null}
                              {String(masterAssetDetailsType || '').trim() === 'character' || String(masterAssetDetailsType || '').trim() === 'location' || String(masterAssetDetailsType || '').trim() === 'weapon' || String(masterAssetDetailsType || '').trim() === 'motive' ? (
                                <button
                                  type="button"
                                  className="btn btn-sm btn-outline-secondary"
                                  onClick={openMasterAssetDerivedJson}
                                  disabled={busy || !isAdmin}
                                  title="View derived JSON built from DB"
                                >
                                  View Content Prompt
                                </button>
                              ) : null}
                              <button
                                type="button"
                                className="btn btn-sm btn-outline-primary"
                                onClick={generateMasterAssetContent}
                                disabled={busy || !isAdmin || Boolean(Number(masterAssetDetailsItem?.is_regen_locked || 0))}
                                title={Number(masterAssetDetailsItem?.is_regen_locked || 0) ? 'Locked from regeneration' : 'Generate content'}
                              >
                                Generate Content
                              </button>
                            </div>
                          </div>

                          <div className="mt-3">
                            <label className="form-label" htmlFor="master-asset-details-name">Name</label>
                            <div className="input-group">
                              <button
                                type="button"
                                className={isMasterAssetFieldLocked('name') ? 'btn btn-outline-warning' : 'btn btn-outline-secondary'}
                                onClick={() => toggleMasterAssetFieldLock('name')}
                                disabled={busy || !isAdmin}
                                title={isMasterAssetFieldLocked('name') ? 'Locked (click to unlock)' : 'Unlocked (click to lock)'}
                              >
                                {isMasterAssetFieldLocked('name') ? lockSvg : unlockSvg}
                              </button>
                              <input
                                id="master-asset-details-name"
                                className="form-control"
                                value={masterAssetDetailsName}
                                onChange={(e) => setMasterAssetDetailsName(e.target.value)}
                                disabled={busy || !isAdmin || isMasterAssetFieldLocked('name')}
                              />
                            </div>
                          </div>

                          <div className="mt-3">
                            <div className="fw-bold">Profile</div>
                            <div className="form-text mb-2">Curated fields are stored in database columns.</div>
                            {String(masterAssetDetailsType || '').trim() === 'character' ? (
                              <div className="row g-2">
                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-character-voice-profile">Voice profile</label>
                                  <select
                                    id="master-asset-character-voice-profile"
                                    className="form-select"
                                    value={String(masterAssetDetailsFields.voice_profile_id || '0')}
                                    onChange={(e) => {
                                      const v = Number(e.target.value || 0) || 0;
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        voice_profile_id: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  >
                                    <option value="0">(None)</option>
                                    {(Array.isArray(voiceProfiles) ? voiceProfiles : []).map((vp) => (
                                      <option key={String(vp.id)} value={String(vp.id)}>
                                        {String(vp.display_name || vp.voice_id || vp.id)}
                                      </option>
                                    ))}
                                  </select>
                                </div>

                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-character-dob">DOB</label>
                                  <input
                                    id="master-asset-character-dob"
                                    type="date"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.dob || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        dob: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-character-age">Age</label>
                                  <input
                                    id="master-asset-character-age"
                                    type="number"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.age || 0)}
                                    onChange={(e) => {
                                      const v = Number(e.target.value || 0) || 0;
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        age: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-character-hometown">Hometown</label>
                                  <input
                                    id="master-asset-character-hometown"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.hometown || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        hometown: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-character-address">Address</label>
                                  <input
                                    id="master-asset-character-address"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.address || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        address: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12 col-md-4">
                                  <label className="form-label" htmlFor="master-asset-character-ethnicity">Ethnicity</label>
                                  <select
                                    id="master-asset-character-ethnicity"
                                    className="form-select"
                                    value={String(masterAssetDetailsFields.ethnicity || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        ethnicity: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  >
                                    <option value="">(Blank)</option>
                                    {['White', 'Black', 'Hispanic/Latino', 'Asian', 'Native American', 'Middle Eastern', 'Multiracial', 'Other', 'Unknown'].map((v) => (
                                      <option key={v} value={v}>{v}</option>
                                    ))}
                                  </select>
                                </div>

                                <div className="col-12 col-md-4">
                                  <label className="form-label" htmlFor="master-asset-character-zodiac">Zodiac</label>
                                  <select
                                    id="master-asset-character-zodiac"
                                    className="form-select"
                                    value={String(masterAssetDetailsFields.zodiac || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        zodiac: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  >
                                    <option value="">(Blank)</option>
                                    {['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces'].map((v) => (
                                      <option key={v} value={v}>{v}</option>
                                    ))}
                                  </select>
                                </div>

                                <div className="col-12 col-md-4">
                                  <label className="form-label" htmlFor="master-asset-character-mbti">MBTI</label>
                                  <select
                                    id="master-asset-character-mbti"
                                    className="form-select"
                                    value={String(masterAssetDetailsFields.mbti || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        mbti: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  >
                                    <option value="">(Blank)</option>
                                    {['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP', 'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP'].map((v) => (
                                      <option key={v} value={v}>{v}</option>
                                    ))}
                                  </select>
                                </div>

                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-character-height">Height</label>
                                  <input
                                    id="master-asset-character-height"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.height || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        height: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-character-weight">Weight</label>
                                  <input
                                    id="master-asset-character-weight"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.weight || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        weight: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-character-eye-color">Eye color</label>
                                  <input
                                    id="master-asset-character-eye-color"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.eye_color || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        eye_color: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-character-hair-color">Hair color</label>
                                  <input
                                    id="master-asset-character-hair-color"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.hair_color || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        hair_color: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-character-aliases">Aliases (one per line)</label>
                                  <textarea
                                    id="master-asset-character-aliases"
                                    className="form-control"
                                    rows={3}
                                    value={(Array.isArray(masterAssetDetailsFields.aliases) ? masterAssetDetailsFields.aliases : []).map((x) => String(x || '')).join('\n')}
                                    onChange={(e) => {
                                      const lines = String(e.target.value || '').split(/\r?\n/).map((x) => String(x || '').trim()).filter(Boolean);
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        aliases: lines,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-character-employment">Employment (one per line)</label>
                                  <textarea
                                    id="master-asset-character-employment"
                                    className="form-control"
                                    rows={3}
                                    value={(Array.isArray(masterAssetDetailsFields.employment) ? masterAssetDetailsFields.employment : []).map((x) => String(x || '')).join('\n')}
                                    onChange={(e) => {
                                      const lines = String(e.target.value || '').split(/\r?\n/).map((x) => String(x || '').trim()).filter(Boolean);
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        employment: lines,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>

                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-character-marks">Distinguishing marks</label>
                                  <textarea
                                    id="master-asset-character-marks"
                                    className="form-control"
                                    rows={2}
                                    value={String(masterAssetDetailsFields.distinguishing_marks || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        distinguishing_marks: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                    spellCheck={false}
                                  />
                                </div>

                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-character-education">Education</label>
                                  <textarea
                                    id="master-asset-character-education"
                                    className="form-control"
                                    rows={2}
                                    value={String(masterAssetDetailsFields.education || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        education: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                    spellCheck={false}
                                  />
                                </div>

                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-character-criminal">Criminal record</label>
                                  <textarea
                                    id="master-asset-character-criminal"
                                    className="form-control"
                                    rows={2}
                                    value={String(masterAssetDetailsFields.criminal_record || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        criminal_record: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                    spellCheck={false}
                                  />
                                </div>
                              </div>
                            ) : null}

                            {String(masterAssetDetailsType || '').trim() === 'location' ? (
                              <div className="row g-2">
                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-location-id">Location ID</label>
                                  <input
                                    id="master-asset-location-id"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.location_id || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        location_id: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>
                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-location-address-line1">Address line 1</label>
                                  <input
                                    id="master-asset-location-address-line1"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.address_line1 || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        address_line1: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>
                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-location-address-line2">Address line 2</label>
                                  <input
                                    id="master-asset-location-address-line2"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.address_line2 || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        address_line2: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>
                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-location-city">City</label>
                                  <input
                                    id="master-asset-location-city"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.city || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        city: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>
                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-location-region">Region/State</label>
                                  <input
                                    id="master-asset-location-region"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.region || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        region: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>
                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-location-postal">Postal code</label>
                                  <input
                                    id="master-asset-location-postal"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.postal_code || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        postal_code: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>
                                <div className="col-12 col-md-6">
                                  <label className="form-label" htmlFor="master-asset-location-country">Country</label>
                                  <input
                                    id="master-asset-location-country"
                                    className="form-control"
                                    value={String(masterAssetDetailsFields.country || '')}
                                    onChange={(e) => {
                                      const v = String(e.target.value || '');
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        country: v,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                  />
                                </div>
                              </div>
                            ) : null}

                            {String(masterAssetDetailsType || '').trim() === 'weapon' ? (
                              <div className="row g-2">
                                <div className="col-12">
                                  <label className="form-label" htmlFor="master-asset-weapon-fingerprints">Fingerprints (one per line)</label>
                                  <textarea
                                    id="master-asset-weapon-fingerprints"
                                    className="form-control"
                                    rows={3}
                                    value={(Array.isArray(masterAssetDetailsFields.fingerprints) ? masterAssetDetailsFields.fingerprints : []).map((x) => String(x || '')).join('\n')}
                                    onChange={(e) => {
                                      const lines = String(e.target.value || '').split(/\r?\n/).map((x) => String(x || '').trim()).filter(Boolean);
                                      setMasterAssetDetailsFields((prev) => ({
                                        ...(prev && typeof prev === 'object' ? prev : {}),
                                        fingerprints: lines,
                                      }));
                                    }}
                                    disabled={busy || !isAdmin}
                                    spellCheck={false}
                                  />
                                </div>
                              </div>
                            ) : null}
                          </div>
                        </div>

                      </div>

                    <div className="col-12 col-xl-4">
                        <div className="catn8-card p-3 h-100">
                          {String(masterAssetDetailsType || '').trim() === 'character' ? (
                            <>
                              <div className="d-flex align-items-center justify-content-between gap-2">
                                <div className="fw-bold">Character Images</div>
                                <div className="d-flex gap-2">
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-primary"
                                    onClick={generateAllMissingMasterCharacterImages}
                                    disabled={busy || !isAdmin}
                                    title="Generates baseline character image, mugshot, and missing interrogation room images for selected emotions"
                                  >
                                    Generate All Missing Images
                                  </button>
                                </div>
                              </div>

                              <div className="mt-3">
                                <div className="fw-bold">Character Image</div>
                                {masterCharacterImageUrl ? (
                                  <div className="mt-2">
                                    <img className="img-fluid rounded" src={masterCharacterImageUrl} alt="Character" loading="lazy" />
                                  </div>
                                ) : (
                                  <div className="form-text mt-2">No character image found.</div>
                                )}

                                <div className="mt-2 d-flex flex-wrap gap-2">
                                  <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => openMasterCharacterImagePrompt({ kind: 'character' })} disabled={busy || !isAdmin}>
                                    View Character Prompt
                                  </button>
                                </div>

                                <div className="mt-2 d-flex gap-2">
                                  <span
                                    title={masterCharacterMissingRequiredImageFields.length
                                      ? ('Complete all required character fields before generating: ' + masterCharacterMissingRequiredImageFields.join(', '))
                                      : 'Generates character image if missing'
                                    }
                                  >
                                    <button
                                      type="button"
                                      className="btn btn-sm btn-outline-primary"
                                      onClick={() => generateMasterCharacterImages({ kind: 'character' })}
                                      disabled={busy || !isAdmin || masterCharacterMissingRequiredImageFields.length > 0}
                                    >
                                      Generate Character Image
                                    </button>
                                  </span>
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-danger"
                                    onClick={() => deleteMasterCharacterImage({ kind: 'character' })}
                                    disabled={busy || !isAdmin || !masterCharacterImageUrl}
                                    title="Deletes character image file for this agent"
                                  >
                                    Delete Character Image
                                  </button>
                                </div>

                                <div className="d-flex gap-2 align-items-center mt-2">
                                  <input
                                    type="file"
                                    className="form-control"
                                    accept="image/png,image/jpeg,image/webp"
                                    disabled={busy || !isAdmin}
                                    onChange={(e) => {
                                      const f = (e.target.files && e.target.files[0]) ? e.target.files[0] : null;
                                      if (!f) return;
                                      uploadMasterCharacterImage({ kind: 'character', file: f });
                                      try { (e.target as any).value = ''; } catch (_e) {}
                                    }}
                                  />
                                </div>
                              </div>

                              <hr className="my-3" />

                              <div className="mt-3">
                                <div className="fw-bold">Mugshot</div>
                                {masterCharacterMugshotUrl ? (
                                  <div className="mt-2">
                                    <img className="img-fluid rounded" src={masterCharacterMugshotUrl} alt="Mugshot" loading="lazy" />
                                  </div>
                                ) : (
                                  <div className="form-text mt-2">No mugshot found.</div>
                                )}

                                <div className="mt-2 d-flex flex-wrap gap-2">
                                  <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => openMasterCharacterImagePrompt({ kind: 'mugshot' })} disabled={busy || !isAdmin}>
                                    View Mugshot Prompt
                                  </button>
                                </div>

                                <div className="mt-2 d-flex gap-2">
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-primary"
                                    onClick={() => generateMasterCharacterImages({ kind: 'mugshot' })}
                                    disabled={busy || !isAdmin}
                                    title="Generates mugshot if missing"
                                  >
                                    Generate Mugshot
                                  </button>
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-danger"
                                    onClick={() => deleteMasterCharacterImage({ kind: 'mugshot' })}
                                    disabled={busy || !isAdmin || !masterCharacterMugshotUrl}
                                    title="Deletes mugshot file for this agent"
                                  >
                                    Delete Mugshot
                                  </button>
                                </div>

                                <div className="d-flex gap-2 align-items-center mt-2">
                                  <input
                                    type="file"
                                    className="form-control"
                                    accept="image/png,image/jpeg,image/webp"
                                    disabled={busy || !isAdmin}
                                    onChange={(e) => {
                                      const f = (e.target.files && e.target.files[0]) ? e.target.files[0] : null;
                                      if (!f) return;
                                      uploadMasterCharacterImage({ kind: 'mugshot', file: f });
                                      try { (e.target as any).value = ''; } catch (_e) {}
                                    }}
                                  />
                                </div>
                              </div>

                              <hr className="my-3" />

                              <div className="mt-3">
                                <div className="fw-bold">Interrogation Room Photos</div>

                                {masterCharacterIrUrls.length > 0 ? (
                                  <div className="mt-2">
                                    <div className="form-text">Showing {Math.min(masterCharacterIrIndex + 1, masterCharacterIrUrls.length)} / {masterCharacterIrUrls.length}</div>
                                    <img
                                      className="img-fluid rounded"
                                      src={masterCharacterIrUrls[Math.max(0, Math.min(masterCharacterIrIndex, masterCharacterIrUrls.length - 1))]}
                                      alt="Interrogation room"
                                      loading="lazy"
                                    />
                                  </div>
                                ) : (
                                  <div className="form-text mt-2">No interrogation room photos found.</div>
                                )}

                                <div className="mt-2 d-flex flex-wrap gap-2">
                                  <button type="button" className="btn btn-sm btn-outline-secondary" onClick={() => openMasterCharacterImagePrompt({ kind: 'ir' })} disabled={busy || !isAdmin}>
                                    View Interrogation Room Prompt
                                  </button>
                                </div>

                                <div className="mt-2 d-flex flex-wrap gap-2">
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-secondary"
                                    onClick={() => setMasterCharacterIrIndex((prev) => Math.max(0, Number(prev || 0) - 1))}
                                    disabled={busy || !isAdmin || masterCharacterIrUrls.length <= 1}
                                  >
                                    Prev
                                  </button>
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-secondary"
                                    onClick={() => setMasterCharacterIrIndex((prev) => {
                                      const urls = Array.isArray(masterCharacterIrUrls) ? masterCharacterIrUrls : [];
                                      if (urls.length <= 1) return 0;
                                      return (Number(prev || 0) + 1) % urls.length;
                                    })}
                                    disabled={busy || !isAdmin || masterCharacterIrUrls.length <= 1}
                                  >
                                    Next
                                  </button>
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-danger"
                                    onClick={() => {
                                      const urls = Array.isArray(masterCharacterIrUrls) ? masterCharacterIrUrls : [];
                                      const idx = Math.max(0, Math.min(Number(masterCharacterIrIndex || 0), urls.length - 1));
                                      const u = urls[idx] || '';
                                      if (!u) return;
                                      deleteMasterCharacterImage({ kind: 'ir', url: u });
                                    }}
                                    disabled={busy || !isAdmin || masterCharacterIrUrls.length <= 0}
                                    title="Deletes the currently displayed interrogation room image"
                                  >
                                    Delete Interrogation Room Photo
                                  </button>
                                </div>

                                <div className="mt-2">
                                  <div className="fw-bold">Emotions</div>
                                  <div className="form-text">Generate missing images for selected emotions.</div>
                                  <div className="d-flex flex-wrap gap-2 mt-2">
                                    {masterCharacterIrEmotions.map((emo) => {
                                      const checked = masterCharacterIrEmotionEnabled?.[emo] !== false;
                                      return (
                                        <label key={emo} className="form-check m-0">
                                          <input
                                            className="form-check-input"
                                            type="checkbox"
                                            checked={checked}
                                            onChange={(e) => {
                                              const on = e.target.checked;
                                              setMasterCharacterIrEmotionEnabled((prev) => {
                                                const base = (prev && typeof prev === 'object') ? prev : {};
                                                return { ...base, [emo]: on };
                                              });
                                            }}
                                            disabled={busy || !isAdmin}
                                          />
                                          <span className="form-check-label">{emo}</span>
                                        </label>
                                      );
                                    })}
                                  </div>

                                  <div className="mt-2 d-flex gap-2">
                                    <button
                                      type="button"
                                      className="btn btn-sm btn-outline-primary"
                                      onClick={() => generateMasterCharacterImages({ kind: 'ir' })}
                                      disabled={busy || !isAdmin}
                                      title="Creates any missing interrogation room images for selected emotions"
                                    >
                                      Generate Interrogation Room Photo
                                    </button>
                                  </div>
                                </div>

                                <div className="d-flex gap-2 align-items-center mt-2">
                                  <input
                                    type="file"
                                    className="form-control"
                                    accept="image/png,image/jpeg,image/webp"
                                    disabled={busy || !isAdmin}
                                    onChange={(e) => {
                                      const f = (e.target.files && e.target.files[0]) ? e.target.files[0] : null;
                                      if (!f) return;
                                      uploadMasterCharacterImage({ kind: 'ir', file: f });
                                      try { (e.target as any).value = ''; } catch (_e) {}
                                    }}
                                  />
                                </div>
                              </div>
                            </>
                          ) : null}

                          {String(masterAssetDetailsType || '').trim() !== 'character' ? (
                            <div className="mt-3">
                              <div className="d-flex justify-content-between align-items-center gap-2">
                                <div className="fw-bold">Image</div>
                                <div className="d-flex gap-2">
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-secondary"
                                    onClick={() => {
                                      updateMasterAssetDetailsDataObject((prev) => {
                                        const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : {};
                                        if (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) return base;
                                        return { ...base, image: { title: '', url: '', alt_text: '', prompt_text: '', negative_prompt_text: '', provider: '', model: '' } };
                                      });
                                    }}
                                    disabled={busy || !isAdmin}
                                  >
                                    Create
                                  </button>
                                  <button
                                    type="button"
                                    className="btn btn-sm btn-outline-danger"
                                    onClick={() => {
                                      updateMasterAssetDetailsDataObject((prev) => {
                                        const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : {};
                                        if (!base.image) return base;
                                        const next = { ...base } as any;
                                        delete next.image;
                                        return next;
                                      });
                                    }}
                                    disabled={busy || !isAdmin || !(getMasterAssetDataObject().image && typeof getMasterAssetDataObject().image === 'object')}
                                  >
                                    Remove
                                  </button>
                                </div>
                              </div>

                              {getMasterAssetDataObject().image && typeof getMasterAssetDataObject().image === 'object' && !Array.isArray(getMasterAssetDataObject().image) ? (
                                <div className="mt-2">
                                  {String(masterAssetDetailsType || '').trim() === 'location' || String(masterAssetDetailsType || '').trim() === 'weapon' ? (
                                    <div className="d-flex gap-2 mb-2">
                                      <button
                                        type="button"
                                        className="btn btn-sm btn-outline-primary"
                                        onClick={generateMasterAssetPrimaryImage}
                                        disabled={busy || !isAdmin}
                                        title={String(masterAssetDetailsType || '').trim() === 'location' ? 'Generates primary location image from Image prompt' : 'Generates primary weapon image from Image prompt'}
                                      >
                                        Generate Image
                                      </button>
                                      <button
                                        type="button"
                                        className="btn btn-sm btn-outline-danger"
                                        onClick={deleteMasterAssetPrimaryImage}
                                        disabled={busy || !isAdmin || !String((getMasterAssetDataObject().image as any)?.url || '').trim()}
                                        title={String(masterAssetDetailsType || '').trim() === 'location' ? 'Deletes the primary location image file' : 'Deletes the primary weapon image file'}
                                      >
                                        Delete Image
                                      </button>
                                    </div>
                                  ) : null}

                                  <div className="d-flex gap-2 align-items-center">
                                    <input
                                      type="file"
                                      className="form-control"
                                      accept="image/png,image/jpeg,image/webp"
                                      disabled={busy || !isAdmin || (String(masterAssetDetailsType || '').trim() === 'character')}
                                      onChange={(e) => {
                                        const f = (e.target.files && e.target.files[0]) ? e.target.files[0] : null;
                                        if (!f) return;
                                        uploadMasterAssetImage({ file: f });
                                        try { (e.target as any).value = ''; } catch (_e) {}
                                      }}
                                    />
                                  </div>

                                  {(() => {
                                    const u = String((getMasterAssetDataObject().image as any)?.url || '').trim();
                                    if (!u) return null;
                                    return (
                                      <div className="mt-2">
                                        <img className="img-fluid rounded" src={u} alt="Asset" loading="lazy" />
                                      </div>
                                    );
                                  })()}

                                  {['title', 'url', 'alt_text', 'prompt_text', 'negative_prompt_text', 'provider', 'model'].map((k) => {
                                    const lk = 'image.' + k;
                                    const id = 'master-asset-image-' + k;
                                    const isTextArea = (k === 'prompt_text' || k === 'negative_prompt_text');
                                    const label = k.replace(/_/g, ' ');
                                    const img = getMasterAssetDataObject().image;
                                    const val = String((img as any)?.[k] || '');
                                    return (
                                      <div key={k} className="mt-2">
                                        <label className="form-label" htmlFor={id}>{label}</label>
                                        <div className="input-group">
                                          <button
                                            type="button"
                                            className={isMasterAssetFieldLocked(lk) ? 'btn btn-outline-warning' : 'btn btn-outline-secondary'}
                                            onClick={() => toggleMasterAssetFieldLock(lk)}
                                            disabled={busy || !isAdmin}
                                            title={isMasterAssetFieldLocked(lk) ? 'Locked (click to unlock)' : 'Unlocked (click to lock)'}
                                          >
                                            {isMasterAssetFieldLocked(lk) ? lockSvg : unlockSvg}
                                          </button>
                                          {isTextArea ? (
                                            <textarea
                                              id={id}
                                              className="form-control"
                                              rows={2}
                                              value={val}
                                              onChange={(e) => {
                                                const v = String(e.target.value || '');
                                                updateMasterAssetDetailsDataObject((prev) => {
                                                  const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : {};
                                                  const curImg = (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) ? base.image : {};
                                                  return { ...base, image: { ...curImg, [k]: v } };
                                                });
                                              }}
                                              disabled={busy || !isAdmin || isMasterAssetFieldLocked(lk)}
                                              spellCheck={false}
                                            />
                                          ) : (
                                            <input
                                              id={id}
                                              className="form-control"
                                              value={val}
                                              onChange={(e) => {
                                                const v = String(e.target.value || '');
                                                updateMasterAssetDetailsDataObject((prev) => {
                                                  const base = (prev && typeof prev === 'object' && !Array.isArray(prev)) ? prev : {};
                                                  const curImg = (base.image && typeof base.image === 'object' && !Array.isArray(base.image)) ? base.image : {};
                                                  return { ...base, image: { ...curImg, [k]: v } };
                                                });
                                              }}
                                              disabled={busy || !isAdmin || isMasterAssetFieldLocked(lk)}
                                            />
                                          )}
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              ) : (
                                <div className="form-text mt-2">No image metadata yet.</div>
                              )}
                            </div>
                          ) : null}
                        </div>

                      </div>

                    <div className="col-12 col-xl-4">
                      {String(masterAssetDetailsType || '').trim() === 'character' ? (
                        <div className="catn8-card p-3 h-100">
                          <div className="fw-bold">Rapport Traits</div>
                          <div className="row g-2 mt-2">
                            <div className="col-12">
                              <label className="form-label" htmlFor="master-asset-rapport-likes">Likes (one per line)</label>
                              <textarea
                                id="master-asset-rapport-likes"
                                className="form-control"
                                rows={3}
                                value={(masterCharacterRapport?.likes || []).join('\n')}
                                onChange={(e) => {
                                  const lines = String(e.target.value || '').split(/\r?\n/).map((x) => String(x || '').trim()).filter(Boolean);
                                  setMasterAssetDetailsRapport((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { likes: [], dislikes: [], quirks: [], fun_facts: [] }),
                                    likes: lines,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                                spellCheck={false}
                              />
                            </div>
                            <div className="col-12">
                              <label className="form-label" htmlFor="master-asset-rapport-dislikes">Dislikes (one per line)</label>
                              <textarea
                                id="master-asset-rapport-dislikes"
                                className="form-control"
                                rows={3}
                                value={(masterCharacterRapport?.dislikes || []).join('\n')}
                                onChange={(e) => {
                                  const lines = String(e.target.value || '').split(/\r?\n/).map((x) => String(x || '').trim()).filter(Boolean);
                                  setMasterAssetDetailsRapport((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { likes: [], dislikes: [], quirks: [], fun_facts: [] }),
                                    dislikes: lines,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                                spellCheck={false}
                              />
                            </div>
                            <div className="col-12">
                              <label className="form-label" htmlFor="master-asset-rapport-quirks">Quirks (one per line)</label>
                              <textarea
                                id="master-asset-rapport-quirks"
                                className="form-control"
                                rows={3}
                                value={(masterCharacterRapport?.quirks || []).join('\n')}
                                onChange={(e) => {
                                  const lines = String(e.target.value || '').split(/\r?\n/).map((x) => String(x || '').trim()).filter(Boolean);
                                  setMasterAssetDetailsRapport((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { likes: [], dislikes: [], quirks: [], fun_facts: [] }),
                                    quirks: lines,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                                spellCheck={false}
                              />
                            </div>
                            <div className="col-12">
                              <label className="form-label" htmlFor="master-asset-rapport-facts">Fun facts (one per line)</label>
                              <textarea
                                id="master-asset-rapport-facts"
                                className="form-control"
                                rows={3}
                                value={(masterCharacterRapport?.fun_facts || []).join('\n')}
                                onChange={(e) => {
                                  const lines = String(e.target.value || '').split(/\r?\n/).map((x) => String(x || '').trim()).filter(Boolean);
                                  setMasterAssetDetailsRapport((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { likes: [], dislikes: [], quirks: [], fun_facts: [] }),
                                    fun_facts: lines,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                                spellCheck={false}
                              />
                            </div>

                            <div className="col-12 mt-2">
                              <div className="fw-bold">Favorites</div>
                              <div className="form-text mb-2">Optional quick hooks for the RAP sheet.</div>
                            </div>

                            <div className="col-12 col-md-6">
                              <label className="form-label" htmlFor="master-asset-rapport-fav-color">Favorite color</label>
                              <input
                                id="master-asset-rapport-fav-color"
                                className="form-control"
                                value={String(masterCharacterRapport?.favorites?.color || '')}
                                onChange={(e) => {
                                  const v = String(e.target.value || '');
                                  setMasterAssetDetailsFavorites((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' }),
                                    color: v,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                              />
                            </div>
                            <div className="col-12 col-md-6">
                              <label className="form-label" htmlFor="master-asset-rapport-fav-snack">Favorite snack</label>
                              <input
                                id="master-asset-rapport-fav-snack"
                                className="form-control"
                                value={String(masterCharacterRapport?.favorites?.snack || '')}
                                onChange={(e) => {
                                  const v = String(e.target.value || '');
                                  setMasterAssetDetailsFavorites((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' }),
                                    snack: v,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                              />
                            </div>
                            <div className="col-12 col-md-6">
                              <label className="form-label" htmlFor="master-asset-rapport-fav-drink">Favorite drink</label>
                              <input
                                id="master-asset-rapport-fav-drink"
                                className="form-control"
                                value={String(masterCharacterRapport?.favorites?.drink || '')}
                                onChange={(e) => {
                                  const v = String(e.target.value || '');
                                  setMasterAssetDetailsFavorites((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' }),
                                    drink: v,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                              />
                            </div>
                            <div className="col-12 col-md-6">
                              <label className="form-label" htmlFor="master-asset-rapport-fav-music">Favorite music</label>
                              <input
                                id="master-asset-rapport-fav-music"
                                className="form-control"
                                value={String(masterCharacterRapport?.favorites?.music || '')}
                                onChange={(e) => {
                                  const v = String(e.target.value || '');
                                  setMasterAssetDetailsFavorites((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' }),
                                    music: v,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                              />
                            </div>
                            <div className="col-12 col-md-6">
                              <label className="form-label" htmlFor="master-asset-rapport-fav-hobby">Favorite hobby</label>
                              <input
                                id="master-asset-rapport-fav-hobby"
                                className="form-control"
                                value={String(masterCharacterRapport?.favorites?.hobby || '')}
                                onChange={(e) => {
                                  const v = String(e.target.value || '');
                                  setMasterAssetDetailsFavorites((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' }),
                                    hobby: v,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                              />
                            </div>
                            <div className="col-12 col-md-6">
                              <label className="form-label" htmlFor="master-asset-rapport-fav-pet">Favorite pet / pets</label>
                              <input
                                id="master-asset-rapport-fav-pet"
                                className="form-control"
                                value={String(masterCharacterRapport?.favorites?.pet || '')}
                                onChange={(e) => {
                                  const v = String(e.target.value || '');
                                  setMasterAssetDetailsFavorites((prev) => ({
                                    ...((prev && typeof prev === 'object') ? prev : { color: '', snack: '', drink: '', music: '', hobby: '', pet: '' }),
                                    pet: v,
                                  }));
                                }}
                                disabled={busy || !isAdmin}
                              />
                            </div>
                          </div>

                          <hr className="my-3" />

                          <div>
                            <div className="d-flex align-items-center justify-content-between gap-2">
                              <div>
                                <div className="fw-bold">Deposition</div>
                                <div className="form-text">Scenario-specific sworn statement (suspect).</div>
                              </div>
                              <div className="d-flex gap-2">
                                <button
                                  type="button"
                                  className="btn btn-sm btn-outline-secondary"
                                  onClick={loadMasterCharacterDeposition}
                                  disabled={busy || masterCharacterDepositionBusy || !scenarioId || !masterCharacterScenarioEntityId}
                                  title={!scenarioId ? 'Select a scenario first' : (!masterCharacterScenarioEntityId ? 'This master character is not attached as a suspect in the current scenario' : 'Reload deposition')}
                                >
                                  Refresh
                                </button>
                                <button
                                  type="button"
                                  className="btn btn-sm btn-outline-secondary"
                                  onClick={() => openJsonPreview({
                                    title: 'enqueue_job: generate_deposition',
                                    payload: {
                                      endpoint: '/api/mystery/admin.php?action=enqueue_job',
                                      method: 'POST',
                                      body: {
                                        case_id: Number(caseId) || 0,
                                        scenario_id: Number(scenarioId) || 0,
                                        entity_id: Number(masterCharacterScenarioEntityId || 0) || 0,
                                        action: 'generate_deposition',
                                        spec: {},
                                      },
                                    },
                                  })}
                                  disabled={busy || !scenarioId || !masterCharacterScenarioEntityId}
                                >
                                  View Deposition Prompt
                                </button>
                                <button
                                  type="button"
                                  className="btn btn-sm btn-outline-primary"
                                  onClick={() => enqueueSpecificJob({ action: 'generate_deposition', spec: {}, requireScenario: true, entityId: masterCharacterScenarioEntityId })}
                                  disabled={busy || !scenarioId || !masterCharacterScenarioEntityId}
                                  title={!scenarioId ? 'Select a scenario first' : (!masterCharacterScenarioEntityId ? 'This master character is not attached as a suspect in the current scenario' : 'Queue deposition generation')}
                                >
                                  Generate
                                </button>
                              </div>
                            </div>

                            {masterCharacterDepositionError ? (
                              <div className="alert alert-danger mt-2 mb-0" role="alert">{masterCharacterDepositionError}</div>
                            ) : null}

                            {!scenarioId ? (
                              <div className="text-muted mt-2">Select a scenario to view depositions.</div>
                            ) : (!masterCharacterScenarioEntityId ? (
                              <div className="text-muted mt-2">This master character is not attached as a suspect in the selected scenario.</div>
                            ) : (
                              <div className="mt-2">
                                {masterCharacterDepositionUpdatedAt ? (
                                  <div className="text-muted small">Updated: {masterCharacterDepositionUpdatedAt}</div>
                                ) : null}
                                <div className="catn8-card p-2 mt-1">
                                  {masterCharacterDepositionText.trim()
                                    ? <div className="catn8-prewrap">{masterCharacterDepositionText}</div>
                                    : <div className="text-muted">No deposition yet.</div>}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : (
                        <div className="catn8-card p-3 h-100">
                          <label className="form-label" htmlFor="master-asset-details-description">Description</label>
                          <div className="input-group">
                            <button
                              type="button"
                              className={isMasterAssetFieldLocked('description') ? 'btn btn-outline-warning' : 'btn btn-outline-secondary'}
                              onClick={() => toggleMasterAssetFieldLock('description')}
                              disabled={busy || !isAdmin}
                              title={isMasterAssetFieldLocked('description') ? 'Locked (click to unlock)' : 'Unlocked (click to lock)'}
                            >
                              {isMasterAssetFieldLocked('description') ? lockSvg : unlockSvg}
                            </button>
                            <textarea
                              id="master-asset-details-description"
                              className="form-control"
                              rows={3}
                              value={String(getMasterAssetDataObject().description || '')}
                              onChange={(e) => {
                                const v = String(e.target.value || '');
                                updateMasterAssetDetailsDataObject((prev) => ({
                                  ...(prev && typeof prev === 'object' && !Array.isArray(prev) ? prev : {}),
                                  description: v,
                                }));
                              }}
                              disabled={busy || !isAdmin || isMasterAssetFieldLocked('description')}
                              spellCheck={false}
                            />
                          </div>

                          {String(masterAssetDetailsType || '').trim() === 'location' ? (
                            <>
                              <div className="mt-3">
                                <label className="form-label" htmlFor="master-asset-location-base-image">Base image prompt</label>
                                <textarea
                                  id="master-asset-location-base-image"
                                  className="form-control"
                                  rows={2}
                                  value={String(masterAssetDetailsFields.base_image_prompt || '')}
                                  onChange={(e) => {
                                    const v = String(e.target.value || '');
                                    setMasterAssetDetailsFields((prev) => ({
                                      ...(prev && typeof prev === 'object' ? prev : {}),
                                      base_image_prompt: v,
                                    }));
                                  }}
                                  disabled={busy || !isAdmin}
                                  spellCheck={false}
                                />
                              </div>
                              <div className="mt-3">
                                <label className="form-label" htmlFor="master-asset-location-overlay-asset">Overlay asset prompt</label>
                                <textarea
                                  id="master-asset-location-overlay-asset"
                                  className="form-control"
                                  rows={2}
                                  value={String(masterAssetDetailsFields.overlay_asset_prompt || '')}
                                  onChange={(e) => {
                                    const v = String(e.target.value || '');
                                    setMasterAssetDetailsFields((prev) => ({
                                      ...(prev && typeof prev === 'object' ? prev : {}),
                                      overlay_asset_prompt: v,
                                    }));
                                  }}
                                  disabled={busy || !isAdmin}
                                  spellCheck={false}
                                />
                              </div>
                              <div className="mt-3">
                                <label className="form-label" htmlFor="master-asset-location-overlay-trigger">Overlay trigger</label>
                                <input
                                  id="master-asset-location-overlay-trigger"
                                  className="form-control"
                                  value={String(masterAssetDetailsFields.overlay_trigger || '')}
                                  onChange={(e) => {
                                    const v = String(e.target.value || '');
                                    setMasterAssetDetailsFields((prev) => ({
                                      ...(prev && typeof prev === 'object' ? prev : {}),
                                      overlay_trigger: v,
                                    }));
                                  }}
                                  disabled={busy || !isAdmin}
                                />
                              </div>
                              <hr className="my-3" />
                            </>
                          ) : (
                            <hr className="my-3" />
                          )}

                          <div className="fw-bold">Advanced</div>
                          <div className="form-text mt-1">Data JSON is DB-first for curated fields.</div>
                          <details className="mt-2">
                            <summary className="fw-bold">Data JSON</summary>
                            <div className="form-text mb-2 mt-2">Must be valid JSON object.</div>
                            <textarea
                              className="form-control"
                              rows={18}
                              value={masterAssetDetailsDataText}
                              readOnly
                              disabled={busy || !isAdmin}
                              spellCheck={false}
                            />
                          </details>

                          <div className="d-flex justify-content-end gap-2 mt-3">
                            <button
                              type="button"
                              className="btn btn-outline-secondary"
                              onClick={() => {
                                if (!masterAssetDetailsItem) return;
                                setMasterAssetDetailsName(String(masterAssetDetailsItem.name || ''));
                                setMasterAssetDetailsData({
                                  description: String(masterAssetDetailsItem.description || masterAssetDetailsItem?.data?.description || ''),
                                  items: Array.isArray(masterAssetDetailsItem.items)
                                    ? masterAssetDetailsItem.items
                                    : (Array.isArray(masterAssetDetailsItem?.data?.items) ? masterAssetDetailsItem.data.items : []),
                                  image: (masterAssetDetailsItem.image && typeof masterAssetDetailsItem.image === 'object' && !Array.isArray(masterAssetDetailsItem.image))
                                    ? masterAssetDetailsItem.image
                                    : ((masterAssetDetailsItem?.data?.image && typeof masterAssetDetailsItem.data.image === 'object' && !Array.isArray(masterAssetDetailsItem.data.image)) ? masterAssetDetailsItem.data.image : null),
                                });
                              }}
                              disabled={busy || !isAdmin}
                            >
                              Reset
                            </button>
                            <button
                              type="button"
                              className={Number(masterAssetDetailsItem?.is_archived || 0) ? 'btn btn-outline-success' : 'btn btn-outline-danger'}
                              onClick={() => archiveMasterAsset({
                                type: masterAssetDetailsType,
                                id: masterAssetDetailsItem?.id,
                                is_archived: Number(masterAssetDetailsItem?.is_archived || 0) ? 0 : 1,
                              })}
                              disabled={busy || !isAdmin}
                            >
                              {Number(masterAssetDetailsItem?.is_archived || 0) ? 'Restore' : 'Archive'}
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={masterAssetJsonRef}>
        <div className="modal-dialog modal-dialog-centered modal-lg">
          <div className="modal-content">
            <div className="modal-header">
              <h5 className="modal-title">{masterAssetJsonTitle || 'JSON'}</h5>
              <div className="d-flex gap-2 align-items-center">
                <button type="button" className="btn btn-sm btn-outline-secondary" onClick={copyMasterAssetJsonText} disabled={!masterAssetJsonText}>
                  Copy
                </button>
                <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">
              {masterAssetJsonError ? <div className="alert alert-danger" role="alert">{masterAssetJsonError}</div> : null}
              <textarea className="form-control" value={String(masterAssetJsonText || '')} readOnly rows={18} spellCheck={false} />
            </div>
            <div className="modal-footer">
              <button type="button" className="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <div className="modal fade catn8-mystery-modal catn8-stacked-modal" tabIndex={-1} aria-hidden="true" ref={jsonPreviewRef}>
        <div className="modal-dialog modal-dialog-centered modal-lg">
          <div className="modal-content">
            <div className="modal-header">
              <h5 className="modal-title">{jsonPreviewTitle || 'JSON'}</h5>
              <button type="button" className="btn-close catn8-mystery-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div className="modal-body">
              <textarea className="form-control" value={String(jsonPreviewText || '')} readOnly rows={18} spellCheck={false} />
            </div>
            <div className="modal-footer">
              <button type="button" className="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

</PageLayout>
);

}

function WordsearchPrintModal({ open, onClose, puzzles, defaultPuzzleId, onPrint }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [selected, setSelected] = useState([]);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    const start = defaultPuzzleId ? [String(defaultPuzzleId)] : [];
    setSelected(start);
    setError('');
  }, [open, defaultPuzzleId]);

  const toggle = (pid) => {
    const id = String(pid);
    setSelected((prev) => (prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]));
  };

  const submit = async () => {
    setBusy(true);
    setError('');
    try {
      if (typeof onPrint !== 'function') throw new Error('Print handler not available');
      await onPrint(selected);
      const modal = modalApiRef.current;
      if (modal) modal.hide();
    } catch (e) {
      setError(e?.message || 'Print failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Print Word Search</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            <div className="fw-bold mb-2">Select puzzles to print</div>
            <div className="d-flex flex-column gap-2" style={{ maxHeight: 320, overflow: 'auto' }}>
              {(Array.isArray(puzzles) ? puzzles : []).map((p) => (
                <label key={p.id} className="form-check">
                  <input
                    className="form-check-input"
                    type="checkbox"
                    checked={selected.includes(String(p.id))}
                    onChange={() => toggle(p.id)}
                    disabled={busy}
                  />
                  <span className="form-check-label">{p.title}</span>
                </label>
              ))}
            </div>
            <button type="button" className="btn btn-primary w-100 mt-3" onClick={submit} disabled={busy}>
              Print
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function AccountModal({ open, onClose, viewer, onChanged }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const [username, setUsername] = useState('');
  const [email, setEmail] = useState('');
  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [deletePassword, setDeletePassword] = useState('');
  const cleanProfileRef = useRef('');

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');
    setCurrentPassword('');
    setNewPassword('');
    setDeletePassword('');

    ApiClient.get('/api/auth/account.php')
      .then((res) => {
        const u = res?.user || viewer || {};
        setUsername(String(u.username || ''));
        setEmail(String(u.email || ''));
        cleanProfileRef.current = JSON.stringify({ username: String(u.username || ''), email: String(u.email || '') });
      })
      .catch((e) => setError(e?.message || 'Failed to load account'))
      .finally(() => setBusy(false));
  }, [open, viewer]);

  const isProfileDirty = useMemo(() => {
    const cur = JSON.stringify({ username: String(username || ''), email: String(email || '') });
    return String(cleanProfileRef.current || '') !== cur;
  }, [username, email]);

  const saveProfile = async (e) => {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/auth/account.php', { action: 'update_profile', username, email });
      setMessage('Saved.');
      cleanProfileRef.current = JSON.stringify({ username: String(username || ''), email: String(email || '') });
      if (typeof onChanged === 'function') onChanged();
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  const changePassword = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/auth/account.php', { action: 'change_password', current_password: currentPassword, new_password: newPassword });
      setCurrentPassword('');
      setNewPassword('');
      setMessage('Password updated.');
    } catch (err) {
      setError(err?.message || 'Update failed');
    } finally {
      setBusy(false);
    }
  };

  const deleteAccount = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/auth/account.php', { action: 'delete_account', current_password: deletePassword });
      setMessage('Account deleted.');
      if (typeof onChanged === 'function') onChanged();
      if (typeof onClose === 'function') onClose();
    } catch (err) {
      setError(err?.message || 'Delete failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Your Account</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={isProfileDirty ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-secondary'}
                onClick={saveProfile}
                disabled={busy || !isProfileDirty}
                aria-label="Save"
                title={isProfileDirty ? 'Save profile changes' : 'No profile changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <div className="fw-bold mb-2">Profile</div>
            <form onSubmit={saveProfile}>
              <div className="mb-3">
                <label className="form-label" htmlFor="acct-username">Username</label>
                <input
                  id="acct-username"
                  className="form-control"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  disabled={busy}
                  autoComplete="username"
                />
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="acct-email">Email</label>
                <input
                  id="acct-email"
                  className="form-control"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  disabled={busy}
                  autoComplete="email"
                />
              </div>
              <button type="submit" className="btn btn-primary w-100" disabled={busy}>
                Save profile
              </button>
            </form>

            <hr />

            <div className="fw-bold mb-2">Change password</div>
            <form onSubmit={changePassword}>
              <div className="mb-3">
                <label className="form-label" htmlFor="acct-current-pass">Current password</label>
                <input
                  id="acct-current-pass"
                  className="form-control"
                  type="password"
                  value={currentPassword}
                  onChange={(e) => setCurrentPassword(e.target.value)}
                  disabled={busy}
                  autoComplete="current-password"
                />
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="acct-new-pass">New password</label>
                <input
                  id="acct-new-pass"
                  className="form-control"
                  type="password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  disabled={busy}
                  autoComplete="new-password"
                />
              </div>
              <button type="submit" className="btn btn-primary w-100" disabled={busy || !currentPassword || !newPassword}>
                Update password
              </button>
            </form>

            <hr />

            <div className="fw-bold mb-2">Delete account</div>
            <form onSubmit={deleteAccount}>
              <div className="mb-3">
                <label className="form-label" htmlFor="acct-delete-pass">Current password</label>
                <input
                  id="acct-delete-pass"
                  className="form-control"
                  type="password"
                  value={deletePassword}
                  onChange={(e) => setDeletePassword(e.target.value)}
                  disabled={busy}
                  autoComplete="current-password"
                />
              </div>
              <button type="submit" className="btn btn-outline-danger w-100" disabled={busy || !deletePassword}>
                Delete my account
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function ManagePuzzlesModal({ open, onClose, topics, puzzles, viewer, onChanged }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const [activeId, setActiveId] = useState(null);
  const [title, setTitle] = useState('');
  const [pagesCount, setPagesCount] = useState(1);
  const [puzzle, setPuzzle] = useState(null);

  const canEditActive = useMemo(() => {
    const uid = Number(viewer?.user_id || 0);
    if (!uid || !puzzle) return false;
    if (Number(viewer?.is_admin || 0) === 1) return true;
    return Number(puzzle?.owner_user_id || 0) === uid;
  }, [viewer, puzzle]);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setError('');
    setMessage('');
    setBusy(false);
    setActiveId(null);
    setPuzzle(null);
    setTitle('');
    setPagesCount(1);
  }, [open]);

  const loadPuzzle = async (id) => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/wordsearch/puzzles.php?action=get&id=' + String(id));
      const p = res?.puzzle;
      if (!p) throw new Error('Puzzle not found');
      setActiveId(Number(p.id));
      setPuzzle(p);
      setTitle(String(p.title || ''));
      setPagesCount(Number(p.pages_count || 1));
    } catch (e) {
      setError(e?.message || 'Failed to load puzzle');
    } finally {
      setBusy(false);
    }
  };

  const rename = async () => {
    if (!activeId || !canEditActive) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/wordsearch/puzzles.php?action=update', { id: activeId, title });
      setMessage('Saved.');
      if (typeof onChanged === 'function') onChanged();
    } catch (e) {
      setError(e?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  const resize = async () => {
    if (!activeId || !canEditActive) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const desired = Number(pagesCount);
      const oldCount = Number(puzzle?.pages_count || 1);

      await ApiClient.post('/api/wordsearch/puzzles.php?action=resize', { id: activeId, pages_count: desired });

      // If resized upwards, generate missing pages immediately.
      if (desired > oldCount) {
        const topic = (Array.isArray(topics) ? topics : []).find((t) => Number(t.id) === Number(puzzle?.topic_id || 0));
        if (topic) {
          const wordsPerPage = Number(topic.words_per_page || 15);
          const baseSeed = (Date.now() ^ (activeId * 1009)) >>> 0;
          for (let pageNumber = oldCount + 1; pageNumber <= desired; pageNumber += 1) {
            const seed = (baseSeed + (pageNumber * 7919)) >>> 0;
            const words = pickWordsForPage({ allWords: topic.words, count: wordsPerPage, gridSize: Number(puzzle?.grid_size || 12), seed: seed + 17 });
            const out = buildWordSearch({ size: Number(puzzle?.grid_size || 12), words, seed, difficulty: String(puzzle?.difficulty || 'easy') });
            await ApiClient.post('/api/wordsearch/pages.php?action=upsert', {
              puzzle_id: activeId,
              page_number: pageNumber,
              seed: String(seed),
              words: out.words,
              grid: out.grid,
            });
          }
        }
      }

      setMessage('Updated page count.');
      if (typeof onChanged === 'function') onChanged();
      await loadPuzzle(activeId);
    } catch (e) {
      setError(e?.message || 'Resize failed');
    } finally {
      setBusy(false);
    }
  };

  const remove = async () => {
    if (!activeId || !canEditActive) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/wordsearch/puzzles.php?action=delete', { id: activeId });
      setMessage('Deleted.');
      setActiveId(null);
      setPuzzle(null);
      setTitle('');
      setPagesCount(1);
      if (typeof onChanged === 'function') onChanged();
    } catch (e) {
      setError(e?.message || 'Delete failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-xl">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Manage Puzzles</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <div className="row g-3">
              <div className="col-lg-4">
                <div className="fw-bold mb-2">Puzzles</div>
                <div className="list-group">
                  {(puzzles || []).map((p) => (
                    <button
                      key={p.id}
                      type="button"
                      className={'list-group-item list-group-item-action ' + (Number(p.id) === Number(activeId) ? 'active' : '')}
                      onClick={() => loadPuzzle(p.id)}
                      disabled={busy}
                    >
                      <div className="fw-bold">{p.title}</div>
                      <div className="small">{p.topic_title}{p.owner_username ? `  ${p.owner_username}` : ''}</div>
                    </button>
                  ))}
                </div>
              </div>

              <div className="col-lg-8">
                {!puzzle ? (
                  <div className="text-muted">Select a puzzle to manage.</div>
                ) : (
                  <>
                    <div className="row g-3">
                      <div className="col-md-8">
                        <label className="form-label" htmlFor="mp-title">Title</label>
                        <input
                          id="mp-title"
                          className="form-control"
                          value={title}
                          onChange={(e) => setTitle(e.target.value)}
                          disabled={busy || !canEditActive}
                        />
                      </div>
                      <div className="col-md-4">
                        <label className="form-label" htmlFor="mp-pages">Pages</label>
                        <input
                          id="mp-pages"
                          className="form-control"
                          type="number"
                          min={1}
                          max={200}
                          step={1}
                          value={String(pagesCount)}
                          onChange={(e) => setPagesCount(Number(e.target.value))}
                          disabled={busy || !canEditActive}
                        />
                      </div>
                    </div>

                    <div className="d-flex gap-2 mt-3">
                      <button type="button" className="btn btn-primary" onClick={rename} disabled={busy || !canEditActive || !title.trim()}>
                        Save title
                      </button>
                      <button type="button" className="btn btn-primary" onClick={resize} disabled={busy || !canEditActive}>
                        Update pages
                      </button>
                      <button type="button" className="btn btn-outline-danger ms-auto" onClick={remove} disabled={busy || !canEditActive}>
                        Delete puzzle
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  );
}

function PuzzleManagerModal({ open, onClose, topics, viewer, onCreated, onDeleted }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [settings, setSettings] = useState({});
  const [message, setMessage] = useState('');

  const [title, setTitle] = useState('');
  const [topicId, setTopicId] = useState('');
  const [gridSize, setGridSize] = useState(12);
  const [difficulty, setDifficulty] = useState('easy');
  const [pagesCount, setPagesCount] = useState(10);

  const canCreate = !!(viewer?.user_id);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(false);
    setError('');
    setMessage('');
    setTitle('');

    const t0 = Array.isArray(topics) && topics.length ? topics[0] : null;
    setTopicId(t0 ? String(t0.id) : '');
    setGridSize(12);
    setDifficulty('easy');
    setPagesCount(10);
  }, [open, topics]);

  const createPuzzle = async (e) => {
    e.preventDefault();
    if (!canCreate) {
      setError('Please log in to create puzzles.');
      return;
    }

    setBusy(true);
    setError('');
    setMessage('');
    try {
      const topic = (Array.isArray(topics) ? topics : []).find((t) => String(t.id) === String(topicId));
      if (!topic) throw new Error('Topic not found');

      const settingsRes = await ApiClient.get('/api/wordsearch/settings.php');
      const wsSettings = settingsRes?.settings || {};

      const created = await ApiClient.post('/api/wordsearch/puzzles.php?action=create', {
        title,
        topic_id: Number(topicId),
        grid_size: gridSize,
        difficulty,
        pages_count: pagesCount,
      });

      const puzzleId = Number(created?.puzzle_id || 0);
      if (!puzzleId) throw new Error('Failed to create puzzle');

      const wordsPerPage = Number(topic.words_per_page || 15);
      const baseSeed = (Date.now() ^ (puzzleId * 1009)) >>> 0;

      for (let pageNumber = 1; pageNumber <= pagesCount; pageNumber += 1) {
        const seed = (baseSeed + (pageNumber * 7919)) >>> 0;
        const words = pickWordsForPage({ allWords: topic.words, count: wordsPerPage, gridSize, seed: seed + 17 });
        const out = buildWordSearch({ size: gridSize, words, seed, difficulty });

        const qf = generateWordsearchQuickFacts({ topic, puzzleTitle: title, pageNumber, words: out.words, settings: wsSettings });

        await ApiClient.post('/api/wordsearch/pages.php?action=upsert', {
          puzzle_id: puzzleId,
          page_number: pageNumber,
          seed: String(seed),
          words: out.words,
          grid: out.grid,
          description: qf.description,
          summary: qf.summary,
        });
      }

      setMessage('Created puzzle and generated pages.');
      if (typeof onCreated === 'function') onCreated(puzzleId);
    } catch (err) {
      setError(err?.message || 'Create failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Create Puzzle</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            {!canCreate ? (
              <div className="alert alert-warning" role="alert">You must be logged in to create puzzles.</div>
            ) : null}

            <form onSubmit={createPuzzle}>
              <div className="mb-3">
                <label className="form-label" htmlFor="puz-title">Title</label>
                <input
                  id="puz-title"
                  className="form-control"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  disabled={busy || !canCreate}
                  placeholder="My Puzzle"
                />
              </div>

              <div className="mb-3">
                <label className="form-label" htmlFor="puz-topic">Topic</label>
                <select
                  id="puz-topic"
                  className="form-select"
                  value={topicId}
                  onChange={(e) => setTopicId(e.target.value)}
                  disabled={busy || !canCreate}
                >
                  {(topics || []).map((t) => (
                    <option key={t.id} value={String(t.id)}>{t.title}</option>
                  ))}
                </select>
              </div>

              <div className="row g-3">
                <div className="col-md-4">
                  <label className="form-label" htmlFor="puz-grid">Grid size</label>
                  <input
                    id="puz-grid"
                    className="form-control"
                    type="number"
                    min={8}
                    max={30}
                    step={1}
                    value={String(gridSize)}
                    onChange={(e) => setGridSize(Number(e.target.value))}
                    disabled={busy || !canCreate}
                  />
                </div>
                <div className="col-md-4">
                  <label className="form-label" htmlFor="puz-difficulty">Difficulty</label>
                  <select
                    id="puz-difficulty"
                    className="form-select"
                    value={difficulty}
                    onChange={(e) => setDifficulty(e.target.value)}
                    disabled={busy || !canCreate}
                  >
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                  </select>
                </div>
                <div className="col-md-4">
                  <label className="form-label" htmlFor="puz-pages">Pages</label>
                  <input
                    id="puz-pages"
                    className="form-control"
                    type="number"
                    min={1}
                    max={200}
                    step={1}
                    value={String(pagesCount)}
                    onChange={(e) => setPagesCount(Number(e.target.value))}
                    disabled={busy || !canCreate}
                  />
                </div>
              </div>

              <button type="submit" className="btn btn-primary w-100 mt-3" disabled={busy || !canCreate || !title.trim() || !topicId}>
                Create & Generate
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function TopicManagerModal({ open, onClose, onChanged }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const [topics, setTopics] = useState([]);
  const [activeId, setActiveId] = useState(null);
  const [form, setForm] = useState({ slug: '', title: '', description: '', words_per_page: 15, is_active: 1, wordsText: '' });
  const [mode, setMode] = useState('create');

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  const loadList = async () => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/wordsearch/topics.php?action=list');
      setTopics(Array.isArray(res?.topics) ? res.topics : []);
    } catch (e) {
      setError(e?.message || 'Failed to load topics');
    } finally {
      setBusy(false);
    }
  };

  const loadTopic = async (id) => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/wordsearch/topics.php?action=get&id=' + String(id));
      const t = res?.topic;
      if (!t) throw new Error('Topic not found');
      setActiveId(Number(t.id));
      setMode('edit');
      setForm({
        slug: String(t.slug || ''),
        title: String(t.title || ''),
        description: String(t.description || ''),
        words_per_page: Number.isFinite(Number(t.words_per_page)) ? Number(t.words_per_page) : 15,
        is_active: Number(t.is_active || 0) ? 1 : 0,
        wordsText: Array.isArray(t.words) ? t.words.join('\n') : '',
      });
    } catch (e) {
      setError(e?.message || 'Failed to load topic');
    } finally {
      setBusy(false);
    }
  };

  useEffect(() => {
    if (!open) return;
    setMode('create');
    setActiveId(null);
    setForm({ slug: '', title: '', description: '', words_per_page: 15, is_active: 1, wordsText: '' });
    loadList();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  const wordsFromText = (text) => {
    const raw = String(text || '').split(/\r?\n/g);
    return raw
      .map((w) => normalizeWord(w))
      .filter((w) => w.length >= 3);
  };

  const save = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const payload = {
        slug: form.slug,
        title: form.title,
        description: form.description,
        words_per_page: Number.isFinite(Number(form.words_per_page)) ? Number(form.words_per_page) : 15,
        is_active: form.is_active,
        words: wordsFromText(form.wordsText),
      };

      if (mode === 'edit') {
        await ApiClient.post('/api/wordsearch/topics.php?action=update', { ...payload, id: activeId });
        setMessage('Saved.');
      } else {
        await ApiClient.post('/api/wordsearch/topics.php?action=create', payload);
        setMessage('Created.');
        setForm({ slug: '', title: '', description: '', words_per_page: 15, is_active: 1, wordsText: '' });
      }

      await loadList();
      if (typeof onChanged === 'function') onChanged();
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  const remove = async () => {
    if (!activeId) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/wordsearch/topics.php?action=delete', { id: activeId });
      setMessage('Deleted.');
      setMode('create');
      setActiveId(null);
      setForm({ slug: '', title: '', description: '', words_per_page: 15, is_active: 1, wordsText: '' });
      await loadList();
      if (typeof onChanged === 'function') onChanged();
    } catch (err) {
      setError(err?.message || 'Delete failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-xl">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Topics</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <div className="row g-3">
              <div className="col-lg-4">
                <div className="d-flex justify-content-between align-items-center mb-2">
                  <div className="fw-bold">Existing topics</div>
                  <button type="button" className="btn btn-outline-secondary btn-sm" onClick={loadList} disabled={busy}>
                    Refresh
                  </button>
                </div>
                <div className="list-group">
                  {topics.map((t) => (
                    <button
                      key={t.id}
                      type="button"
                      className={'list-group-item list-group-item-action ' + (Number(t.id) === Number(activeId) ? 'active' : '')}
                      onClick={() => loadTopic(t.id)}
                      disabled={busy}
                    >
                      <div className="fw-bold">{t.title}</div>
                      <div className="small">{t.slug}</div>
                    </button>
                  ))}
                </div>
              </div>

              <div className="col-lg-8">
                <div className="d-flex justify-content-between align-items-center mb-2">
                  <div className="fw-bold">{mode === 'edit' ? 'Edit topic' : 'Create topic'}</div>
                  <div className="d-flex gap-2">
                    {mode === 'edit' ? (
                      <>
                        <button type="button" className="btn btn-outline-secondary btn-sm" onClick={() => {
                          setMode('create');
                          setActiveId(null);
                          setForm({ slug: '', title: '', description: '', words_per_page: 15, is_active: 1, wordsText: '' });
                          setMessage('');
                          setError('');
                        }} disabled={busy}>
                          New
                        </button>
                        <button type="button" className="btn btn-outline-danger btn-sm" onClick={remove} disabled={busy}>
                          Delete
                        </button>
                      </>
                    ) : null}
                  </div>
                </div>

                <form onSubmit={save}>
                  <div className="row g-3">
                    <div className="col-md-6">
                      <label className="form-label" htmlFor="topic-slug">Slug</label>
                      <input
                        id="topic-slug"
                        className="form-control"
                        value={form.slug}
                        onChange={(e) => setForm((f) => ({ ...f, slug: e.target.value }))}
                        disabled={busy}
                        placeholder="my-topic"
                      />
                    </div>
                    <div className="col-md-6">
                      <label className="form-label" htmlFor="topic-title">Title</label>
                      <input
                        id="topic-title"
                        className="form-control"
                        value={form.title}
                        onChange={(e) => setForm((f) => ({ ...f, title: e.target.value }))}
                        disabled={busy}
                        placeholder="My Topic"
                      />
                    </div>
                    <div className="col-12">
                      <label className="form-label" htmlFor="topic-desc">Description</label>
                      <input
                        id="topic-desc"
                        className="form-control"
                        value={form.description}
                        onChange={(e) => setForm((f) => ({ ...f, description: e.target.value }))}
                        disabled={busy}
                      />
                    </div>
                    <div className="col-md-4">
                      <label className="form-label" htmlFor="topic-words-per-page">Words per page</label>
                      <input
                        id="topic-words-per-page"
                        className="form-control"
                        type="number"
                        min={5}
                        max={60}
                        step={1}
                        value={String(form.words_per_page)}
                        onChange={(e) => setForm((f) => ({ ...f, words_per_page: Number(e.target.value) }))}
                        disabled={busy}
                      />
                    </div>
                    <div className="col-12">
                      <label className="form-label" htmlFor="topic-words">Words (one per line)</label>
                      <textarea
                        id="topic-words"
                        className="form-control"
                        rows={10}
                        value={form.wordsText}
                        onChange={(e) => setForm((f) => ({ ...f, wordsText: e.target.value }))}
                        disabled={busy}
                      />
                      <div className="form-text">Words are normalized to letters only.</div>
                    </div>
                    <div className="col-12">
                      <div className="form-check">
                        <input
                          id="topic-active"
                          className="form-check-input"
                          type="checkbox"
                          checked={!!form.is_active}
                          onChange={(e) => setForm((f) => ({ ...f, is_active: e.target.checked ? 1 : 0 }))}
                          disabled={busy}
                        />
                        <label className="form-check-label" htmlFor="topic-active">Active</label>
                      </div>
                    </div>
                  </div>

                  <button type="submit" className="btn btn-primary w-100 mt-3" disabled={busy}>
                    {mode === 'edit' ? 'Save changes' : 'Create topic'}
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function normalizeWord(value) {
  return String(value || '').toUpperCase().replace(/[^A-Z]/g, '');
}

function createRng(seed0) {
  let t = (seed0 >>> 0);
  return () => {
    t += 0x6d2b79f5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  };
}

function pickWordsForPage({ allWords, count, gridSize, seed }) {
  const rng = createRng(seed);
  const pool = (Array.isArray(allWords) ? allWords : [])
    .map((w) => normalizeWord(w))
    .filter((w) => w.length >= 3 && w.length <= gridSize);

  const unique = [...new Set(pool)];
  for (let i = unique.length - 1; i > 0; i -= 1) {
    const j = Math.floor(rng() * (i + 1));
    [unique[i], unique[j]] = [unique[j], unique[i]];
  }

  return unique.slice(0, Math.max(1, count));
}

function buildWordSearch({ size, words, seed, difficulty }) {
  const rng = createRng(seed);
  const grid = Array.from({ length: size }, () => Array.from({ length: size }, () => ''));

  const easyDirs = [
    { dr: 0, dc: 1 },
    { dr: 1, dc: 0 },
  ];
  const mediumDirs = [
    ...easyDirs,
    { dr: 1, dc: 1 },
    { dr: -1, dc: 1 },
  ];
  const hardDirs = [
    ...mediumDirs,
    { dr: 0, dc: -1 },
    { dr: -1, dc: 0 },
    { dr: 1, dc: -1 },
    { dr: -1, dc: -1 },
  ];

  const directions = (difficulty === 'hard') ? hardDirs : (difficulty === 'medium' ? mediumDirs : easyDirs);
  const randInt = (n) => Math.floor(rng() * n);

  const canPlace = (word, r0, c0, dir) => {
    const { dr, dc } = dir;
    const r1 = r0 + dr * (word.length - 1);
    const c1 = c0 + dc * (word.length - 1);
    if (r1 < 0 || r1 >= size || c1 < 0 || c1 >= size) return false;
    for (let i = 0; i < word.length; i += 1) {
      const r = r0 + dr * i;
      const c = c0 + dc * i;
      const existing = grid[r][c];
      if (existing && existing !== word[i]) return false;
    }
    return true;
  };

  const place = (word, r0, c0, dir) => {
    const { dr, dc } = dir;
    for (let i = 0; i < word.length; i += 1) {
      grid[r0 + dr * i][c0 + dc * i] = word[i];
    }
  };

  const normalized = words
    .map((w) => normalizeWord(w))
    .filter((w) => w.length >= 3 && w.length <= size)
    .sort((a, b) => b.length - a.length);

  for (const word of normalized) {
    let placedWord = false;
    for (let attempt = 0; attempt < 900; attempt += 1) {
      const dir = directions[randInt(directions.length)];
      const r0 = randInt(size);
      const c0 = randInt(size);
      if (!canPlace(word, r0, c0, dir)) continue;
      place(word, r0, c0, dir);
      placedWord = true;
      break;
    }
    if (!placedWord) {
      throw new Error('Could not place word: ' + word);
    }
  }

  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  for (let r = 0; r < size; r += 1) {
    for (let c = 0; c < size; c += 1) {
      if (!grid[r][c]) grid[r][c] = alphabet[randInt(alphabet.length)];
    }
  }

  return { grid, words: normalized };
}

function generateWordsearchQuickFacts({ topic, puzzleTitle, pageNumber, words, settings }) {
  const enabled = Number(settings?.quick_facts_enabled || 0) === 1;
  if (!enabled) return { description: '', summary: '' };

  const style = String(settings?.quick_facts_style || 'gentle').trim().toLowerCase();
  const sentences = Math.min(6, Math.max(1, Number(settings?.quick_facts_sentences || 2)));

  const topicTitle = String(topic?.title || '').trim();
  const title = String(puzzleTitle || '').trim();
  const wordsList = (Array.isArray(words) ? words : []).map((w) => String(w)).filter(Boolean);
  const topWords = wordsList.slice(0, 6).join(', ');

  const styleLead = (style === 'fun')
    ? 'Have fun hunting'
    : (style === 'educational')
      ? 'Explore'
      : 'Enjoy searching for';

  const description = topicTitle
    ? `${styleLead} ${topicTitle} words.`
    : `${styleLead} words from ${title || 'this puzzle'}.`;

  const parts = [];
  if (topicTitle) {
    parts.push(`Page ${pageNumber} highlights ${topicTitle}.`);
  } else {
    parts.push(`Page ${pageNumber} highlights this theme.`);
  }

  if (topWords) {
    parts.push(`Look for words like ${topWords}.`);
  }

  if (style === 'educational') {
    parts.push('Try reading each word out loud as you find it.');
  } else if (style === 'fun') {
    parts.push('Circle each word and celebrate every find!');
  } else {
    parts.push('Take your time and enjoy the challenge.');
  }

  const summary = parts.slice(0, sentences).join(' ');
  return { description, summary };
}

function WordsearchSettingsModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const cleanSnapshotRef = useRef('');
  const [settings, setSettings] = useState({
    grid_size: 12,
    difficulty: 'easy',
    quick_facts_enabled: 1,
    quick_facts_sentences: 2,
    quick_facts_style: 'gentle',
  });
  const [isAdmin, setIsAdmin] = useState(0);
  const [saveGlobal, setSaveGlobal] = useState(false);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');
    setSaveGlobal(false);

    ApiClient.get('/api/wordsearch/settings.php')
      .then((res) => {
        const s = res?.settings || {};
        const qEnabled = Number(s.quick_facts_enabled) === 0 ? 0 : 1;
        const qSent = Math.min(6, Math.max(1, Number(s.quick_facts_sentences || 2)));
        const qStyle = String(s.quick_facts_style || 'gentle');
        const nextSettings = {
          grid_size: Number.isFinite(Number(s.grid_size)) ? Number(s.grid_size) : 12,
          difficulty: String(s.difficulty || 'easy'),
          quick_facts_enabled: qEnabled,
          quick_facts_sentences: Number.isFinite(qSent) ? qSent : 2,
          quick_facts_style: qStyle,
        };
        setSettings(nextSettings);
        setIsAdmin(Number(res?.is_admin || 0));
        cleanSnapshotRef.current = JSON.stringify({ settings: nextSettings, saveGlobal: false });
      })
      .catch((e) => setError(e?.message || 'Failed to load word search settings'))
      .finally(() => setBusy(false));
  }, [open]);

  const isDirty = useMemo(() => {
    const cur = JSON.stringify({ settings, saveGlobal });
    return String(cleanSnapshotRef.current || '') !== cur;
  }, [settings, saveGlobal]);

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  const save = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/wordsearch/settings.php', {
        grid_size: settings.grid_size,
        difficulty: settings.difficulty,
        quick_facts_enabled: settings.quick_facts_enabled,
        quick_facts_sentences: settings.quick_facts_sentences,
        quick_facts_style: settings.quick_facts_style,
        save_global: (isAdmin && saveGlobal) ? 1 : 0,
      });
      setMessage((isAdmin && saveGlobal) ? 'Saved global defaults.' : 'Saved for this session.');
      cleanSnapshotRef.current = JSON.stringify({ settings, saveGlobal });
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Word Search Settings</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                onClick={save}
                disabled={busy || !isDirty}
                aria-label="Save"
                title={isDirty ? 'Save changes' : 'No changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <form onSubmit={save}>
              <div className="mb-3">
                <label className="form-label" htmlFor="ws-grid">Grid size</label>
                <input
                  id="ws-grid"
                  className="form-control"
                  type="number"
                  min={8}
                  max={30}
                  step={1}
                  value={String(settings.grid_size)}
                  onChange={(e) => setSettings((s) => ({ ...s, grid_size: Number(e.target.value) }))}
                  disabled={busy}
                />
              </div>

              <div className="mb-3">
                <label className="form-label" htmlFor="ws-difficulty">Difficulty</label>
                <select
                  id="ws-difficulty"
                  className="form-select"
                  value={settings.difficulty}
                  onChange={(e) => setSettings((s) => ({ ...s, difficulty: e.target.value }))}
                  disabled={busy}
                >
                  <option value="easy">Easy (no diagonal, no backwards)</option>
                  <option value="medium">Medium (diagonal allowed)</option>
                  <option value="hard">Hard (diagonal + backwards allowed)</option>
                </select>
              </div>

              {isAdmin ? (
                <div className="form-check mb-3">
                  <input
                    id="ws-save-global"
                    className="form-check-input"
                    type="checkbox"
                    checked={saveGlobal}
                    onChange={(e) => setSaveGlobal(e.target.checked)}
                    disabled={busy}
                  />
                  <label className="form-check-label" htmlFor="ws-save-global">
                    Save as global defaults
                  </label>
                </div>
              ) : null}
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function AIConfigModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const suppressCloseRef = useRef(false);
  const pendingJsonOpenRef = useRef(false);
  const cleanSnapshotRef = useRef('');

  type AiLooseObject = Record<string, any>;
  type AIConfigState = {
    provider: string;
    model: string;
    base_url: string;
    location: string;
    temperature: number;
    system_prompt: string;
    provider_config: AiLooseObject;
  };
  type AIConfigSavePayload = {
    provider: string;
    model: string;
    base_url: string;
    location: string;
    temperature: number;
    system_prompt: string;
    provider_config: AiLooseObject;
    secrets?: AiLooseObject;
  };

  const [config, setConfig] = useState<AIConfigState>({ provider: 'openai', model: 'gpt-4o-mini', base_url: '', location: '', temperature: 0.2, system_prompt: '', provider_config: {} });
  const [hasSecrets, setHasSecrets] = useState<Record<string, AiLooseObject>>({});
  const [secretsByProvider, setSecretsByProvider] = useState<Record<string, AiLooseObject>>({});
  const [jsonEditorOpen, setJsonEditorOpen] = useState(false);
  const [jsonText, setJsonText] = useState('{}');

  const buildSnapshot = (nextConfig = config, nextSecretsByProvider = secretsByProvider) => {
    const cfg = (nextConfig && typeof nextConfig === 'object') ? (nextConfig as any) : {};
    const providerNorm = normalizeText(cfg.provider);
    const secrets = (nextSecretsByProvider && typeof nextSecretsByProvider === 'object' && providerNorm && nextSecretsByProvider[providerNorm] && typeof nextSecretsByProvider[providerNorm] === 'object')
      ? nextSecretsByProvider[providerNorm]
      : {};
    return JSON.stringify({ cfg, secrets });
  };

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');
    setHasSecrets({});
    setSecretsByProvider({});

    ApiClient.get('/api/settings/ai.php')
      .then((resAi) => {
        const cfg = resAi?.config || {};
        const providerConfig = (cfg && typeof cfg === 'object' && cfg.provider_config && typeof cfg.provider_config === 'object' && !Array.isArray(cfg.provider_config)) ? cfg.provider_config : {};
        const nextConfig = {
          provider: String(cfg.provider || 'openai'),
          model: String(cfg.model || 'gpt-4o-mini'),
          base_url: String(cfg.base_url || ''),
          location: String(cfg.location || ''),
          temperature: Number.isFinite(Number(cfg.temperature)) ? Number(cfg.temperature) : 0.2,
          system_prompt: String(cfg.system_prompt || ''),
          provider_config: providerConfig,
        };
        setConfig(nextConfig);
        setHasSecrets((resAi && typeof resAi === 'object' && resAi.has_secrets && typeof resAi.has_secrets === 'object') ? resAi.has_secrets : {});
        cleanSnapshotRef.current = buildSnapshot(nextConfig, {});
      })
      .catch((e) => setError(e?.message || 'Failed to load AI configuration'))
      .finally(() => setBusy(false));
  }, [open]);

  const providerKey = normalizeText(config.provider);
  const modelChoices = useMemo(() => aiGetModelChoices(config.provider), [config.provider]);

  useEffect(() => {
    if (!open) return;
    if (!config || typeof config !== 'object') return;
    if (!config.provider) return;
    const choices = aiGetModelChoices(config.provider);
    if (!choices.length) return;
    const current = String(config.model || '').trim();
    if (current !== '') return;
    setConfig((c) => ({ ...c, model: String(choices[0].value || '') }));
  }, [open, config.provider, config.model]);

  const openJsonEditor = () => {
    const modal = modalApiRef.current;
    if (!modal) {
      setJsonEditorOpen(true);
      return;
    }
    suppressCloseRef.current = true;
    pendingJsonOpenRef.current = true;
    modal.hide();
  };

  const closeJsonEditor = () => {
    setJsonEditorOpen(false);
    window.setTimeout(() => {
      const modal = modalApiRef.current;
      if (modal && open) modal.show();
    }, 0);
  };

  const testAiProvider = async () => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const res = await ApiClient.get('/api/settings/ai_test.php');
      const provider = String(res?.ai?.provider || '').trim();
      const model = String(res?.ai?.model || '').trim();
      const sample = String(res?.sample || '').trim();
      const label = provider ? provider + (model ? ' / ' + model : '') : 'AI provider';
      setMessage(label + ' OK' + (sample ? ': ' + sample : ''));
    } catch (e) {
      setError(e?.message || 'Failed to test AI provider');
    } finally {
      setBusy(false);
    }
  };

  const save = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      let providerConfig = config?.provider_config;
      if (!providerConfig || typeof providerConfig !== 'object' || Array.isArray(providerConfig)) providerConfig = {};

      const payload: AIConfigSavePayload = {
        provider: String(config.provider || '').trim(),
        model: String(config.model || '').trim(),
        base_url: String(config.base_url || '').trim(),
        location: String(config.location || '').trim(),
        temperature: Number(config.temperature),
        system_prompt: String(config.system_prompt || ''),
        provider_config: providerConfig as AiLooseObject,
      };

      const providerNorm = normalizeText(payload.provider);
      const providerSecrets = secretsByProvider[providerNorm] && typeof secretsByProvider[providerNorm] === 'object' ? secretsByProvider[providerNorm] : null;
      if (providerSecrets) {
        payload.secrets = providerSecrets;
      }

      const resAi = await ApiClient.post('/api/settings/ai.php', payload);

      const nextCfg = resAi?.config || {};
      const nextProviderConfig = (nextCfg && typeof nextCfg === 'object' && nextCfg.provider_config && typeof nextCfg.provider_config === 'object' && !Array.isArray(nextCfg.provider_config)) ? nextCfg.provider_config : {};
      setConfig({
        provider: String(nextCfg.provider || payload.provider || 'openai'),
        model: String(nextCfg.model || payload.model || 'gpt-4o-mini'),
        base_url: String(nextCfg.base_url || payload.base_url || ''),
        location: String(nextCfg.location || payload.location || ''),
        temperature: Number.isFinite(Number(nextCfg.temperature)) ? Number(nextCfg.temperature) : Number(payload.temperature),
        system_prompt: String(nextCfg.system_prompt || payload.system_prompt || ''),
        provider_config: nextProviderConfig,
      });
      setHasSecrets((resAi && typeof resAi === 'object' && resAi.has_secrets && typeof resAi.has_secrets === 'object') ? resAi.has_secrets : {});
      setSecretsByProvider((all) => {
        const next = { ...(all || {}) };
        if (providerNorm) next[providerNorm] = {};
        return next;
      });
      setMessage('Saved.');
      const nextConfigState = {
        provider: String(nextCfg.provider || payload.provider || 'openai'),
        model: String(nextCfg.model || payload.model || 'gpt-4o-mini'),
        base_url: String(nextCfg.base_url || payload.base_url || ''),
        location: String(nextCfg.location || payload.location || ''),
        temperature: Number.isFinite(Number(nextCfg.temperature)) ? Number(nextCfg.temperature) : Number(payload.temperature),
        system_prompt: String(nextCfg.system_prompt || payload.system_prompt || ''),
        provider_config: nextProviderConfig,
      };
      cleanSnapshotRef.current = buildSnapshot(nextConfigState, { [providerNorm]: {} });
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  const providerHas = (hasSecrets && typeof hasSecrets === 'object' && hasSecrets[providerKey] && typeof hasSecrets[providerKey] === 'object') ? hasSecrets[providerKey] : {};
  const providerSecrets = (secretsByProvider && typeof secretsByProvider === 'object' && secretsByProvider[providerKey] && typeof secretsByProvider[providerKey] === 'object') ? secretsByProvider[providerKey] : {};

  const isDirty = String(cleanSnapshotRef.current || '') !== buildSnapshot();

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  return (
    <>
      <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
        <div className="modal-dialog modal-dialog-centered modal-lg">
          <div className="modal-content">
            <div className="modal-header">
              <h5 className="modal-title">AI Configuration</h5>
              <div className="d-flex align-items-center gap-2">
                <button
                  type="button"
                  className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                  onClick={save}
                  disabled={busy || !isDirty}
                  aria-label="Save"
                  title={isDirty ? 'Save changes' : 'No changes to save'}
                >
                  {saveSvg}
                </button>
                <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
            </div>
            <div className="modal-body">
              {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
              {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

              <form onSubmit={save}>
                <datalist id="ai-location-options">
                  <option value="global" />
                  <option value="us-central1" />
                  <option value="us-east1" />
                  <option value="us-west1" />
                  <option value="europe-west4" />
                </datalist>

                <div className="border rounded p-3 mb-3">
                  <div className="fw-semibold mb-2">General AI Provider</div>
                  <div className="row g-3">
                    <div className="col-md-6">
                      <label className="form-label" htmlFor="ai-provider">Provider</label>
                      <select
                        id="ai-provider"
                        className="form-select"
                        value={config.provider}
                        onChange={(e) => {
                          const nextProvider = e.target.value;
                          const choices = aiGetModelChoices(nextProvider);
                          const nextModel = choices.length ? String(choices[0].value || '') : '';
                          setConfig((c) => ({
                            ...c,
                            provider: nextProvider,
                            model: nextModel,
                            base_url: '',
                            location: '',
                            provider_config: {},
                          }));
                        }}
                        disabled={busy}
                      >
                        {AI_PROVIDER_CHOICES.map((p) => (
                          <option key={p.value} value={p.value}>{p.label}</option>
                        ))}
                      </select>
                    </div>
                    <div className="col-md-6">
                      <label className="form-label" htmlFor="ai-model">Model</label>
                      <datalist id="ai-model-options">
                        {modelChoices.map((m) => (
                          <option key={m.value} value={m.value} />
                        ))}
                      </datalist>
                      <input
                        id="ai-model"
                        className="form-control"
                        value={String(config.model || '')}
                        onChange={(e) => setConfig((c) => ({ ...c, model: e.target.value }))}
                        disabled={busy}
                        list="ai-model-options"
                        placeholder={modelChoices.length ? String(modelChoices[0].value || '') : 'Enter model id'}
                      />
                      <div className="form-text">Pick a preset or type an exact model id (recommended for new releases).</div>
                    </div>

                    <div className="col-12">
                      {providerKey === 'openai' || providerKey === 'together_ai' || providerKey === 'fireworks_ai' ? (
                        <>
                          <label className="form-label" htmlFor="ai-base-url">Base URL{providerKey === 'openai' ? ' (optional)' : ''}</label>
                          <input
                            id="ai-base-url"
                            className="form-control"
                            value={config.base_url}
                            onChange={(e) => setConfig((c) => ({ ...c, base_url: e.target.value }))}
                            disabled={busy}
                            placeholder=""
                          />
                        </>
                      ) : null}
                    </div>

                    {providerKey === 'google_vertex_ai' ? (
                      <div className="col-md-6">
                        <label className="form-label" htmlFor="ai-location">Location</label>
                        <input
                          id="ai-location"
                          className="form-control"
                          list="ai-location-options"
                          value={config.location}
                          onChange={(e) => setConfig((c) => ({ ...c, location: e.target.value }))}
                          disabled={busy}
                          placeholder="global"
                        />
                      </div>
                    ) : null}

                    {providerKey === 'azure_openai' ? (
                      <>
                        <div className="col-12">
                          <label className="form-label" htmlFor="ai-azure-endpoint">Endpoint</label>
                          <input
                            id="ai-azure-endpoint"
                            className="form-control"
                            value={String(config?.provider_config?.azure_endpoint || '')}
                            onChange={(e) =>
                              setConfig((c) => ({
                                ...c,
                                provider_config: { ...(c.provider_config || {}), azure_endpoint: e.target.value },
                              }))
                            }
                            disabled={busy}
                            placeholder="https://{resource}.openai.azure.com"
                          />
                        </div>
                        <div className="col-md-6">
                          <label className="form-label" htmlFor="ai-azure-deployment">Deployment</label>
                          <input
                            id="ai-azure-deployment"
                            className="form-control"
                            value={String(config?.provider_config?.azure_deployment || '')}
                            onChange={(e) =>
                              setConfig((c) => ({
                                ...c,
                                provider_config: { ...(c.provider_config || {}), azure_deployment: e.target.value },
                              }))
                            }
                            disabled={busy}
                            placeholder=""
                          />
                        </div>
                        <div className="col-md-6">
                          <label className="form-label" htmlFor="ai-azure-api-version">API Version</label>
                          <input
                            id="ai-azure-api-version"
                            className="form-control"
                            value={String(config?.provider_config?.azure_api_version || '')}
                            onChange={(e) =>
                              setConfig((c) => ({
                                ...c,
                                provider_config: { ...(c.provider_config || {}), azure_api_version: e.target.value },
                              }))
                            }
                            disabled={busy}
                            placeholder=""
                          />
                        </div>
                      </>
                    ) : null}

                    {providerKey === 'aws_bedrock' ? (
                      <div className="col-12">
                        <label className="form-label" htmlFor="ai-aws-region">Region</label>
                        <input
                          id="ai-aws-region"
                          className="form-control"
                          value={String(config?.provider_config?.aws_region || '')}
                          onChange={(e) =>
                            setConfig((c) => ({
                              ...c,
                              provider_config: { ...(c.provider_config || {}), aws_region: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder="us-east-1"
                        />
                      </div>
                    ) : null}

                    <div className="col-md-4">
                      <label className="form-label" htmlFor="ai-temperature">Temperature</label>
                      <input
                        id="ai-temperature"
                        className="form-control"
                        type="number"
                        step="0.05"
                        min="0"
                        max="2"
                        value={String(config.temperature)}
                        onChange={(e) => setConfig((c) => ({ ...c, temperature: Number(e.target.value) }))}
                        disabled={busy}
                      />
                    </div>

                    <div className="col-md-8 d-flex align-items-end justify-content-end">
                      <div className="d-flex gap-2">
                        <button type="button" className="btn btn-outline-secondary" onClick={testAiProvider} disabled={busy}>
                          Test provider
                        </button>
                        <button type="button" className="btn btn-outline-secondary" onClick={openJsonEditor} disabled={busy}>
                          Edit JSON
                        </button>
                      </div>
                    </div>

                    {providerKey === 'openai' || providerKey === 'anthropic' || providerKey === 'google_ai_studio' || providerKey === 'azure_openai' || providerKey === 'together_ai' || providerKey === 'fireworks_ai' || providerKey === 'huggingface' ? (
                      <div className="col-12">
                        <label className="form-label" htmlFor="ai-provider-api-key">
                          {providerKey === 'huggingface' ? 'API Token' : 'API Key'}
                          {providerHas.api_key ? ' (saved)' : ' (not set)'}
                        </label>
                        <input
                          id="ai-provider-api-key"
                          className="form-control"
                          value={String(providerSecrets.api_key || '')}
                          onChange={(e) =>
                            setSecretsByProvider((all) => ({
                              ...(all || {}),
                              [providerKey]: { ...((all || {})[providerKey] || {}), api_key: e.target.value },
                            }))
                          }
                          disabled={busy}
                          placeholder={providerHas.api_key ? 'Enter to replace existing token' : 'Enter token'}
                          autoComplete="off"
                        />
                      </div>
                    ) : null}

                    {providerKey === 'google_vertex_ai' ? (
                      <div className="col-12">
                        <label className="form-label" htmlFor="ai-provider-service-account">
                          Service Account JSON
                          {providerHas.service_account_json ? ' (saved)' : ' (not set)'}
                        </label>
                        <textarea
                          id="ai-provider-service-account"
                          className="form-control"
                          rows={6}
                          value={String(providerSecrets.service_account_json || '')}
                          onChange={(e) =>
                            setSecretsByProvider((all) => ({
                              ...(all || {}),
                              [providerKey]: { ...((all || {})[providerKey] || {}), service_account_json: e.target.value },
                            }))
                          }
                          disabled={busy}
                          spellCheck={false}
                        />
                      </div>
                    ) : null}

                    {providerKey === 'aws_bedrock' ? (
                      <>
                        <div className="col-md-6">
                          <label className="form-label" htmlFor="ai-aws-access-key-id">
                            AWS Access Key ID
                            {providerHas.aws_access_key_id ? ' (saved)' : ' (not set)'}
                          </label>
                          <input
                            id="ai-aws-access-key-id"
                            className="form-control"
                            value={String(providerSecrets.aws_access_key_id || '')}
                            onChange={(e) =>
                              setSecretsByProvider((all) => ({
                                ...(all || {}),
                                [providerKey]: { ...((all || {})[providerKey] || {}), aws_access_key_id: e.target.value },
                              }))
                            }
                            disabled={busy}
                            autoComplete="off"
                          />
                        </div>
                        <div className="col-md-6">
                          <label className="form-label" htmlFor="ai-aws-secret-access-key">
                            AWS Secret Access Key
                            {providerHas.aws_secret_access_key ? ' (saved)' : ' (not set)'}
                          </label>
                          <input
                            id="ai-aws-secret-access-key"
                            className="form-control"
                            value={String(providerSecrets.aws_secret_access_key || '')}
                            onChange={(e) =>
                              setSecretsByProvider((all) => ({
                                ...(all || {}),
                                [providerKey]: { ...((all || {})[providerKey] || {}), aws_secret_access_key: e.target.value },
                              }))
                            }
                            disabled={busy}
                            autoComplete="off"
                          />
                        </div>
                        <div className="col-12">
                          <label className="form-label" htmlFor="ai-aws-session-token">
                            AWS Session Token
                            {providerHas.aws_session_token ? ' (saved)' : ' (not set)'}
                          </label>
                          <input
                            id="ai-aws-session-token"
                            className="form-control"
                            value={String(providerSecrets.aws_session_token || '')}
                            onChange={(e) =>
                              setSecretsByProvider((all) => ({
                                ...(all || {}),
                                [providerKey]: { ...((all || {})[providerKey] || {}), aws_session_token: e.target.value },
                              }))
                            }
                            disabled={busy}
                            autoComplete="off"
                          />
                        </div>
                      </>
                    ) : null}

                    <div className="col-12">
                      <label className="form-label" htmlFor="ai-system-prompt">System Prompt</label>
                      <textarea
                        id="ai-system-prompt"
                        className="form-control"
                        rows={6}
                        value={config.system_prompt}
                        onChange={(e) => setConfig((c) => ({ ...c, system_prompt: e.target.value }))}
                        disabled={busy}
                        placeholder="(stub)"
                      />
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <AIConfigJsonModal
        open={jsonEditorOpen}
        onClose={closeJsonEditor}
        value={config}
        busy={busy}
        onSave={async (next) => {
          const nextProviderConfig = next?.provider_config && typeof next.provider_config === 'object' && !Array.isArray(next.provider_config) ? next.provider_config : {};
          setConfig({
            provider: String(next?.provider || 'openai'),
            model: String(next?.model || 'gpt-4o-mini'),
            base_url: String(next?.base_url || ''),
            location: String(next?.location || ''),
            temperature: Number.isFinite(Number(next?.temperature)) ? Number(next?.temperature) : 0.2,
            system_prompt: String(next?.system_prompt || ''),
            provider_config: nextProviderConfig,
          });
        }}
      />
    </>
  );
}

function SiteAppearanceModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const [tokens, setTokens] = useState({ brand_primary: '#9b59b6', brand_secondary: '#2ecc71', action_fg: '#ffffff' });
  const cleanSnapshotRef = useRef('');

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');
    ApiClient.get('/api/settings/appearance.php')
      .then((res) => {
        const t = res?.tokens || {};
        const nextTokens = {
          brand_primary: String(t.brand_primary || '#9b59b6'),
          brand_secondary: String(t.brand_secondary || '#2ecc71'),
          action_fg: String(t.action_fg || '#ffffff'),
        };
        setTokens(nextTokens);
        cleanSnapshotRef.current = JSON.stringify(nextTokens);
      })
      .catch((e) => setError(e?.message || 'Failed to load appearance settings'))
      .finally(() => setBusy(false));
  }, [open]);

  const isDirty = useMemo(() => {
    return String(cleanSnapshotRef.current || '') !== JSON.stringify(tokens);
  }, [tokens]);

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  const save = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/settings/appearance.php', tokens);
      setMessage('Saved. Refresh the page if you don\'t see changes immediately.');
      cleanSnapshotRef.current = JSON.stringify(tokens);
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Site Appearance</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                onClick={save}
                disabled={busy || !isDirty}
                aria-label="Save"
                title={isDirty ? 'Save changes' : 'No changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <form onSubmit={save}>
              <div className="mb-3">
                <label className="form-label" htmlFor="appearance-brand-primary">Primary brand color</label>
                <input
                  className="form-control form-control-color"
                  type="color"
                  id="appearance-brand-primary"
                  value={tokens.brand_primary}
                  onChange={(e) => setTokens((t) => ({ ...t, brand_primary: e.target.value }))}
                  disabled={busy}
                />
              </div>

              <div className="mb-3">
                <label className="form-label" htmlFor="appearance-brand-secondary">Secondary brand color</label>
                <input
                  className="form-control form-control-color"
                  type="color"
                  id="appearance-brand-secondary"
                  value={tokens.brand_secondary}
                  onChange={(e) => setTokens((t) => ({ ...t, brand_secondary: e.target.value }))}
                  disabled={busy}
                />
              </div>

              <div className="mb-3">
                <label className="form-label" htmlFor="appearance-action-fg">Button text color</label>
                <input
                  className="form-control form-control-color"
                  type="color"
                  id="appearance-action-fg"
                  value={tokens.action_fg}
                  onChange={(e) => setTokens((t) => ({ ...t, action_fg: e.target.value }))}
                  disabled={busy}
                />
              </div>

              <div className="d-flex gap-2 mb-3">
                <button type="button" className="btn btn-primary" disabled>
                  Primary button
                </button>
                <button type="button" className="btn btn-secondary" disabled>
                  Secondary button
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function AuthPolicyModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const [policy, setPolicy] = useState({ require_email_verification: 0, allow_public_signup: 1 });
  const cleanSnapshotRef = useRef('');

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');
    ApiClient.get('/api/settings/auth_policy.php')
      .then((res) => {
        const p = res?.policy || {};
        const nextPolicy = {
          require_email_verification: (p.require_email_verification ? 1 : 0),
          allow_public_signup: (p.allow_public_signup ? 1 : 0),
        };
        setPolicy(nextPolicy);
        cleanSnapshotRef.current = JSON.stringify(nextPolicy);
      })
      .catch((e) => setError(e?.message || 'Failed to load settings'))
      .finally(() => setBusy(false));
  }, [open]);

  const isDirty = useMemo(() => {
    return String(cleanSnapshotRef.current || '') !== JSON.stringify(policy);
  }, [policy]);

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  const save = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/settings/auth_policy.php', policy);
      setMessage('Saved.');
      cleanSnapshotRef.current = JSON.stringify(policy);
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Account & Signup Policy</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                onClick={save}
                disabled={busy || !isDirty}
                aria-label="Save"
                title={isDirty ? 'Save changes' : 'No changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <form onSubmit={save}>
              <div className="form-check form-switch mb-3">
                <input
                  className="form-check-input"
                  type="checkbox"
                  role="switch"
                  id="policy-allow-public"
                  checked={policy.allow_public_signup === 1}
                  onChange={(e) => setPolicy((p) => ({ ...p, allow_public_signup: e.target.checked ? 1 : 0 }))}
                  disabled={busy}
                />
                <label className="form-check-label" htmlFor="policy-allow-public">
                  Allow public users to create accounts
                </label>
                <div className="form-text">
                  If off, signups are still accepted but accounts are disabled until an admin enables them.
                </div>
              </div>

              <div className="form-check form-switch mb-3">
                <input
                  className="form-check-input"
                  type="checkbox"
                  role="switch"
                  id="policy-require-verify"
                  checked={policy.require_email_verification === 1}
                  onChange={(e) => setPolicy((p) => ({ ...p, require_email_verification: e.target.checked ? 1 : 0 }))}
                  disabled={busy || policy.allow_public_signup === 0}
                />
                <label className="form-check-label" htmlFor="policy-require-verify">
                  Require email verification before activation
                </label>
                <div className="form-text">
                  When public signup is disabled, verification is forced off (admin approval becomes the activation step).
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function NavBar({ active, viewer, onLoginClick, onLogout, onAccountClick }) {
  const isAuthed = Boolean(viewer && viewer.id);
  const isAdministrator = Number(viewer?.is_administrator || 0) === 1;
  const isMysteryGameUser = Number(viewer?.is_mystery_game_user || 0) === 1;
  const isWordsearchUser = Number(viewer?.is_wordsearch_user || 0) === 1;

  const links = [
    { key: 'about', href: 'about.php', label: 'About' },
    { key: 'stories', href: 'stories.php', label: 'Stories' },
    { key: 'games', href: 'games.php', label: 'Games' },
    { key: 'arcade', href: 'arcade.php', label: 'Arcade' },
    { key: 'activities', href: 'activities.php', label: 'Activities' },
    ...(isAuthed && isWordsearchUser ? [{ key: 'wordsearch', href: 'wordsearch.php', label: 'Word Search' }] : []),
  ];

  return (
    <nav className="navbar navbar-expand-lg navbar-light sticky-top">
      <div className="container">
        <a className={"nav-link navbar-home-link" + (active === 'home' ? ' active' : '')} href="/">Home</a>
        <a className="navbar-brand" href="/">
          <img src="images/catn8_logo.svg" alt="catn8.us Logo" />
        </a>
        <button
          className="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span className="navbar-toggler-icon"></span>
        </button>
        <div className="collapse navbar-collapse" id="navbarNav">
          <ul className="navbar-nav ms-auto">
            {links.map((l) => (
              <li className="nav-item" key={l.key}>
                <a className={"nav-link" + (active === l.key ? ' active' : '')} href={l.href}>
                  {l.label}
                </a>
              </li>
            ))}
            {isAuthed && isMysteryGameUser ? (
              <li className="nav-item">
                <a className={"nav-link" + (active === 'mystery' ? ' active' : '')} href="mystery.php">
                  Mystery Game
                </a>
              </li>
            ) : null}
            {isAuthed && isAdministrator ? (
              <li className="nav-item">
                <a className={"nav-link" + (active === 'settings' ? ' active' : '')} href="settings.php">
                  Settings
                </a>
              </li>
            ) : null}
            {isAuthed ? (
              <>
                <li className="nav-item">
                  <a
                    className="nav-link"
                    href="account.php"
                    onClick={(e) => {
                      if (typeof onAccountClick === 'function') {
                        e.preventDefault();
                        onAccountClick();
                      }
                    }}
                  >
                    {viewer.username}
                  </a>
                </li>
                <li className="nav-item">
                  <a
                    className="nav-link"
                    href="logout.php"
                    onClick={(e) => {
                      if (typeof onLogout === 'function') {
                        e.preventDefault();
                        onLogout();
                      }
                    }}
                  >
                    Logout
                  </a>
                </li>
              </>
            ) : (
              <li className="nav-item">
                <a
                  className={"nav-link" + (active === 'login' ? ' active' : '')}
                  href="login.php"
                  onClick={(e) => {
                    if (typeof onLoginClick === 'function') {
                      e.preventDefault();
                      onLoginClick();
                    }
                  }}
                >
                  Login
                </a>
              </li>
            )}
          </ul>
        </div>
      </div>
    </nav>
  );
}

function FilterBar({ label, query, setQuery }) {
  return (
    <div className="catn8-filter">
      <label className="catn8-filter-label" htmlFor="catn8-filter-input">
        Filter {label}
      </label>
      <input
        id="catn8-filter-input"
        className="catn8-filter-input"
        type="search"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="Type to filter..."
      />
      <button
        className="catn8-filter-button"
        type="button"
        onClick={() => setQuery('')}
        disabled={query === ''}
      >
        Clear
      </button>
    </div>
  );
}

function LoginModal({ open, onClose, onLoggedIn, onToast }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [activeTab, setActiveTab] = useState('login');
  const [loginUsername, setLoginUsername] = useState('');
  const [loginPassword, setLoginPassword] = useState('');
  const [signupUsername, setSignupUsername] = useState('');
  const [signupEmail, setSignupEmail] = useState('');
  const [signupPassword, setSignupPassword] = useState('');
  const [signupPassword2, setSignupPassword2] = useState('');
  const [busy, setBusy] = useState(false);
  const [message, setMessage] = useState('');
  const [error, setError] = useState('');
  const [forgotOpen, setForgotOpen] = useState(false);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) {
      modal.show();
    } else {
      modal.hide();
    }
  }, [open]);

  useEffect(() => {
    if (open) {
      setError('');
      setMessage('');
    }
  }, [open]);

  const submitLogin = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/auth/login.php', { username: loginUsername, password: loginPassword });

      let u = null;
      if (typeof onLoggedIn === 'function') {
        u = await onLoggedIn();
      }

      if (!u || !u.id) {
        const msg = 'Login succeeded, but your session was not detected. Please refresh the page and try again.';
        setError(msg);
        if (typeof onToast === 'function') {
          onToast({ tone: 'error', title: 'Login incomplete', message: msg });
        }
        return;
      }

      setMessage('Logged in.');
      if (typeof onToast === 'function') {
        onToast({ tone: 'success', title: 'Login successful', message: 'You are now logged in.' });
      }
      if (typeof onClose === 'function') onClose();
    } catch (err) {
      const msg = err?.message || 'Login failed';
      setError(msg);
      if (typeof onToast === 'function') {
        onToast({ tone: 'error', title: 'Login failed', message: msg });
      }
    } finally {
      setBusy(false);
    }
  };

  const submitSignup = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      if (signupPassword !== signupPassword2) {
        throw new Error('Passwords do not match');
      }
      const res = await ApiClient.post('/api/auth/register.php', { username: signupUsername, email: signupEmail, password: signupPassword });
      const status = res?.status || '';
      if (status === 'pending_admin_approval') {
        setMessage('Account created and pending admin approval.');
      } else if (status === 'verification_required') {
        setMessage('Account created. Check your email for a verification link.');
      } else {
        setMessage('Account created.');
      }
      setActiveTab('login');
    } catch (err) {
      setError(err?.message || 'Sign up failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <>
      <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
        <div className="modal-dialog modal-dialog-centered">
          <div className="modal-content">
            <div className="modal-header">
              <h5 className="modal-title">Account</h5>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div className="modal-body">
              <ul className="nav nav-tabs" role="tablist">
                <li className="nav-item" role="presentation">
                  <button
                    className={'nav-link' + (activeTab === 'login' ? ' active' : '')}
                    type="button"
                    role="tab"
                    onClick={() => setActiveTab('login')}
                  >
                    Login
                  </button>
                </li>
                <li className="nav-item" role="presentation">
                  <button
                    className={'nav-link' + (activeTab === 'signup' ? ' active' : '')}
                    type="button"
                    role="tab"
                    onClick={() => setActiveTab('signup')}
                  >
                    Create Account
                  </button>
                </li>
              </ul>

              <div className="pt-3">
                {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
                {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

                {activeTab === 'login' ? (
                  <form id="loginForm" onSubmit={submitLogin}>
                    <div className="mb-3">
                      <label className="form-label" htmlFor="username">Username</label>
                      <input
                        className="form-control"
                        type="text"
                        id="username"
                        name="username"
                        autoComplete="username"
                        value={loginUsername}
                        onChange={(e) => setLoginUsername(e.target.value)}
                        disabled={busy}
                      />
                    </div>
                    <div className="mb-2">
                      <label className="form-label" htmlFor="password">Password</label>
                      <input
                        className="form-control"
                        type="password"
                        id="password"
                        name="password"
                        autoComplete="current-password"
                        value={loginPassword}
                        onChange={(e) => setLoginPassword(e.target.value)}
                        disabled={busy}
                      />
                    </div>
                    <div className="mb-3">
                      <button
                        type="button"
                        className="btn btn-link p-0"
                        onClick={() => setForgotOpen(true)}
                        disabled={busy}
                      >
                        Forgot password?
                      </button>
                    </div>
                    <button id="loginButton" type="submit" className="btn btn-primary w-100" disabled={busy}>
                      Sign in
                    </button>
                  </form>
                ) : (
                  <form onSubmit={submitSignup}>
                    <div className="mb-3">
                      <label className="form-label" htmlFor="signup-username">Username</label>
                      <input
                        className="form-control"
                        type="text"
                        id="signup-username"
                        name="username"
                        autoComplete="username"
                        value={signupUsername}
                        onChange={(e) => setSignupUsername(e.target.value)}
                        disabled={busy}
                      />
                    </div>
                    <div className="mb-3">
                      <label className="form-label" htmlFor="signup-email">Email</label>
                      <input
                        className="form-control"
                        type="email"
                        id="signup-email"
                        name="email"
                        autoComplete="email"
                        value={signupEmail}
                        onChange={(e) => setSignupEmail(e.target.value)}
                        disabled={busy}
                      />
                    </div>
                    <div className="mb-3">
                      <label className="form-label" htmlFor="signup-password">Password</label>
                      <input
                        className="form-control"
                        type="password"
                        id="signup-password"
                        name="new-password"
                        autoComplete="new-password"
                        value={signupPassword}
                        onChange={(e) => setSignupPassword(e.target.value)}
                        disabled={busy}
                      />
                    </div>
                    <div className="mb-3">
                      <label className="form-label" htmlFor="signup-password2">Confirm Password</label>
                      <input
                        className="form-control"
                        type="password"
                        id="signup-password2"
                        autoComplete="new-password"
                        value={signupPassword2}
                        onChange={(e) => setSignupPassword2(e.target.value)}
                        disabled={busy}
                      />
                    </div>
                    <button type="submit" className="btn btn-primary w-100" disabled={busy}>
                      Create account
                    </button>
                  </form>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <ForgotPasswordModal open={forgotOpen} onClose={() => setForgotOpen(false)} />
    </>
  );
}

function ForgotPasswordModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [email, setEmail] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [newPassword2, setNewPassword2] = useState('');
  const [busy, setBusy] = useState(false);
  const [message, setMessage] = useState('');
  const [error, setError] = useState('');

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  const submit = async (e) => {
    e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      if (newPassword !== newPassword2) throw new Error('Passwords do not match');
      await ApiClient.post('/api/auth/request_password_reset.php', { email, new_password: newPassword });
      setMessage('If the email exists, a confirmation link was sent. Your password will update after you click the link.');
    } catch (err) {
      setError(err?.message || 'Request failed');
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Forgot Password</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}
            <form onSubmit={submit}>
              <div className="mb-3">
                <label className="form-label" htmlFor="forgot-email">Email</label>
                <input
                  className="form-control"
                  type="email"
                  id="forgot-email"
                  autoComplete="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  disabled={busy}
                />
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="forgot-pass1">New password</label>
                <input
                  className="form-control"
                  type="password"
                  id="forgot-pass1"
                  autoComplete="new-password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  disabled={busy}
                />
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="forgot-pass2">Confirm new password</label>
                <input
                  className="form-control"
                  type="password"
                  id="forgot-pass2"
                  autoComplete="new-password"
                  value={newPassword2}
                  onChange={(e) => setNewPassword2(e.target.value)}
                  disabled={busy}
                />
              </div>
              <button type="submit" className="btn btn-primary w-100" disabled={busy}>
                Send reset email
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function VerifyPage() {
  const [status, setStatus] = useState('Verifying...');
  const [error, setError] = useState('');

  useEffect(() => {
    const token = new URLSearchParams(window.location.search).get('token') || '';
    if (!token) {
      setStatus('');
      setError('Missing token');
      return;
    }
    ApiClient.post('/api/auth/verify.php', { token })
      .then(() => {
        setError('');
        setStatus('Your account is now verified. You can close this page and log in.');
      })
      .catch((e) => {
        setStatus('');
        setError(e?.message || 'Verification failed');
      });
  }, []);

  return (
    <PageLayout page="verify" title="Verify">
      <section className="section">
        <div className="container">
          <h1 className="section-title">Verify Account</h1>
          {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
          {status ? <div className="alert alert-info" role="alert">{status}</div> : null}
        </div>
      </section>
    </PageLayout>
  );
}

function ResetPage() {
  const [status, setStatus] = useState('Confirming...');
  const [error, setError] = useState('');

  useEffect(() => {
    const token = new URLSearchParams(window.location.search).get('token') || '';
    if (!token) {
      setStatus('');
      setError('Missing token');
      return;
    }
    ApiClient.post('/api/auth/confirm_password_reset.php', { token })
      .then(() => {
        setError('');
        setStatus('Your password has been updated. You can close this page and log in.');
      })
      .catch((e) => {
        setStatus('');
        setError(e?.message || 'Password reset failed');
      });
  }, []);

  return (
    <PageLayout page="reset" title="Reset Password">
      <section className="section">
        <div className="container">
          <h1 className="section-title">Reset Password</h1>
          {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
          {status ? <div className="alert alert-info" role="alert">{status}</div> : null}
        </div>
      </section>
    </PageLayout>
  );
}

function EmailConfigModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');
  const [form, setForm] = useState({ host: 'smtp.ionos.com', port: 587, secure: 'tls', user: '', pass: '', from_email: '', from_name: 'catn8.us' });
  const cleanFormRef = useRef('');

  const saveSvg = (
    <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
      <path
        fill="currentColor"
        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4.5a1 1 0 0 0-.293-.707l-2.5-2.5A1 1 0 0 0 11.5 1H2zm1 1h8v4H3V2zm0 6h10v6H3V8zm2 1v4h6V9H5z"
      />
    </svg>
  );

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  useEffect(() => {
    if (!open) return;
    setBusy(true);
    setError('');
    setMessage('');
    ApiClient.get('/api/settings/email.php')
      .then((res) => {
        const cfg = res?.config || {};
        const next = (f) => ({
          ...f,
          host: cfg.host || f.host,
          port: cfg.port || f.port,
          secure: cfg.secure || f.secure,
          user: cfg.user || f.user,
          from_email: cfg.from_email || f.from_email,
          from_name: cfg.from_name || f.from_name,
          pass: '',
        });
        setForm((f) => {
          const nf = next(f);
          cleanFormRef.current = JSON.stringify({ ...nf, pass: '' });
          return nf;
        });
      })
      .catch((e) => setError(e?.message || 'Failed to load email settings'))
      .finally(() => setBusy(false));
  }, [open]);

  const isDirty = useMemo(() => {
    const cur = JSON.stringify({ ...form, pass: String(form.pass || '') });
    return String(cleanFormRef.current || '') !== cur;
  }, [form]);

  const save = async (e) => {
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/settings/email.php', form);
      setMessage('Saved.');
      setForm((f) => ({ ...f, pass: '' }));
      cleanFormRef.current = JSON.stringify({ ...form, pass: '' });
    } catch (err) {
      setError(err?.message || 'Save failed');
    } finally {
      setBusy(false);
    }
  };

  const setField = (k) => (e) => setForm((f) => ({ ...f, [k]: e.target.value }));

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Email Configuration</h5>
            <div className="d-flex align-items-center gap-2">
              <button
                type="button"
                className={'btn btn-sm btn-primary catn8-dirty-save' + (isDirty ? ' catn8-dirty-save--visible' : '')}
                onClick={save}
                disabled={busy || !isDirty}
                aria-label="Save"
                title={isDirty ? 'Save changes' : 'No changes to save'}
              >
                {saveSvg}
              </button>
              <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}
            <form onSubmit={save}>
              <div className="mb-3">
                <label className="form-label" htmlFor="smtp-host">SMTP Host</label>
                <input className="form-control" id="smtp-host" value={form.host} onChange={setField('host')} disabled={busy} />
              </div>
              <div className="row">
                <div className="col-md-6 mb-3">
                  <label className="form-label" htmlFor="smtp-port">Port</label>
                  <input className="form-control" id="smtp-port" type="number" value={form.port} onChange={setField('port')} disabled={busy} />
                </div>
                <div className="col-md-6 mb-3">
                  <label className="form-label" htmlFor="smtp-secure">Encryption</label>
                  <select className="form-select" id="smtp-secure" value={form.secure} onChange={setField('secure')} disabled={busy}>
                    <option value="tls">TLS</option>
                    <option value="ssl">SSL</option>
                    <option value="none">None</option>
                  </select>
                </div>
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="smtp-user">SMTP Username</label>
                <input className="form-control" id="smtp-user" value={form.user} onChange={setField('user')} disabled={busy} />
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="smtp-pass">SMTP Password</label>
                <input className="form-control" id="smtp-pass" type="password" value={form.pass} onChange={setField('pass')} disabled={busy} />
                <div className="form-text">Leave blank to keep the existing password.</div>
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="smtp-from-email">From Email</label>
                <input className="form-control" id="smtp-from-email" type="email" value={form.from_email} onChange={setField('from_email')} disabled={busy} />
              </div>
              <div className="mb-3">
                <label className="form-label" htmlFor="smtp-from-name">From Name</label>
                <input className="form-control" id="smtp-from-name" value={form.from_name} onChange={setField('from_name')} disabled={busy} />
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  );
}

function UserAccountsModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [users, setUsers] = useState([]);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  const load = () => {
    setBusy(true);
    setError('');
    ApiClient.get('/api/settings/users.php?action=list')
      .then((res) => setUsers(Array.isArray(res?.users) ? res.users : []))
      .catch((e) => setError(e?.message || 'Failed to load users'))
      .finally(() => setBusy(false));
  };

  useEffect(() => {
    if (open) load();
  }, [open]);

  const toggle = async (id, field, value) => {
    setBusy(true);
    setError('');
    try {
      await ApiClient.post('/api/settings/users.php?action=update', { id, field, value });
      load();
    } catch (e) {
      setError(e?.message || 'Update failed');
      setBusy(false);
    }
  };

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-lg">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">User Accounts</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            <div className="d-flex justify-content-end mb-2">
              <button type="button" className="btn btn-outline-secondary btn-sm" onClick={load} disabled={busy}>
                Refresh
              </button>
            </div>
            <div className="table-responsive">
              <table className="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Active</th>
                    <th>Admin</th>
                    <th>Verified</th>
                  </tr>
                </thead>
                <tbody>
                  {users.map((u) => (
                    <tr key={u.id}>
                      <td>{u.id}</td>
                      <td>{u.username}</td>
                      <td>{u.email}</td>
                      <td>
                        <button
                          type="button"
                          className={'btn btn-sm ' + (u.is_active ? 'btn-success' : 'btn-outline-secondary')}
                          onClick={() => toggle(u.id, 'is_active', u.is_active ? 0 : 1)}
                          disabled={busy}
                        >
                          {u.is_active ? 'Yes' : 'No'}
                        </button>
                      </td>
                      <td>
                        <button
                          type="button"
                          className={'btn btn-sm ' + (u.is_admin ? 'btn-success' : 'btn-outline-secondary')}
                          onClick={() => toggle(u.id, 'is_admin', u.is_admin ? 0 : 1)}
                          disabled={busy}
                        >
                          {u.is_admin ? 'Yes' : 'No'}
                        </button>
                      </td>
                      <td>{u.email_verified ? 'Yes' : 'No'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function GroupMembershipsModal({ open, onClose }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [message, setMessage] = useState('');

  const [users, setUsers] = useState([]);
  const [groupSlug, setGroupSlug] = useState('wordsearch-users');
  const [members, setMembers] = useState([]);
  const [addUserId, setAddUserId] = useState('');

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };
    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  const loadUsers = async () => {
    const res = await ApiClient.get('/api/settings/users.php?action=list');
    return Array.isArray(res?.users) ? res.users : [];
  };

  const loadMembers = async (slug) => {
    const res = await ApiClient.get('/api/settings/groups.php?action=list_members&group_slug=' + encodeURIComponent(String(slug)));
    return Array.isArray(res?.members) ? res.members : [];
  };

  const load = async (slug) => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      const list = await loadUsers();
      setUsers(list);
      const m = await loadMembers(slug);
      setMembers(m);
      const memberIds = new Set(m.map((u) => Number(u?.id || 0)));
      const pick = list.find((u) => !memberIds.has(Number(u?.id || 0)));
      setAddUserId(pick ? String(pick.id) : '');
    } catch (e) {
      setError(e?.message || 'Failed to load group memberships');
    } finally {
      setBusy(false);
    }
  };

  useEffect(() => {
    if (!open) return;
    load(groupSlug);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  useEffect(() => {
    if (!open) return;
    load(groupSlug);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [groupSlug]);

  const addMember = async (e) => {
    e.preventDefault();
    const uid = Number(addUserId);
    if (!uid) return;
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/settings/groups.php?action=add_member', { group_slug: groupSlug, user_id: uid });
      setMessage('Added.');
      await load(groupSlug);
    } catch (err) {
      setError(err?.message || 'Add failed');
    } finally {
      setBusy(false);
    }
  };

  const removeMember = async (uid) => {
    setBusy(true);
    setError('');
    setMessage('');
    try {
      await ApiClient.post('/api/settings/groups.php?action=remove_member', { group_slug: groupSlug, user_id: Number(uid) });
      setMessage('Removed.');
      await load(groupSlug);
    } catch (err) {
      setError(err?.message || 'Remove failed');
      setBusy(false);
    }
  };

  const memberIds = useMemo(() => new Set(members.map((m) => Number(m?.id || 0))), [members]);
  const availableUsers = useMemo(() => users.filter((u) => !memberIds.has(Number(u?.id || 0))), [users, memberIds]);

  return (
    <div className="modal fade" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-dialog-centered modal-lg">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Group Access</h5>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}
            {message ? <div className="alert alert-success" role="alert">{message}</div> : null}

            <div className="mb-3">
              <label className="form-label" htmlFor="group-access-group">Select group</label>
              <select
                id="group-access-group"
                className="form-select"
                value={groupSlug}
                onChange={(e) => setGroupSlug(e.target.value)}
                disabled={busy}
              >
                <option value="wordsearch-users">Wordsearch Users</option>
                <option value="mystery-game-users">Mystery Game Users</option>
              </select>
            </div>

            <form onSubmit={addMember} className="mb-3">
              <label className="form-label" htmlFor="group-access-add">Add user to group</label>
              <div className="d-flex gap-2">
                <select
                  id="group-access-add"
                  className="form-select"
                  value={addUserId}
                  onChange={(e) => setAddUserId(e.target.value)}
                  disabled={busy || !availableUsers.length}
                >
                  {availableUsers.map((u) => (
                    <option key={u.id} value={String(u.id)}>
                      {u.username} ({u.email})
                    </option>
                  ))}
                </select>
                <button type="submit" className="btn btn-primary" disabled={busy || !Number(addUserId)}>
                  Add
                </button>
                <button type="button" className="btn btn-outline-secondary" onClick={() => load(groupSlug)} disabled={busy}>
                  Refresh
                </button>
              </div>
            </form>

            <div className="table-responsive">
              <table className="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Admin</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {members.map((u) => (
                    <tr key={u.id}>
                      <td>{u.id}</td>
                      <td>{u.username}</td>
                      <td>{u.email}</td>
                      <td>{u.is_admin ? 'Yes' : 'No'}</td>
                      <td className="text-end">
                        <button type="button" className="btn btn-sm btn-outline-danger" onClick={() => removeMember(u.id)} disabled={busy}>
                          Remove
                        </button>
                      </td>
                    </tr>
                  ))}
                  {!members.length ? (
                    <tr>
                      <td colSpan={5} className="text-muted">
                        No members.
                      </td>
                    </tr>
                  ) : null}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

type SettingsPageProps = {
  viewer: any;
  onLoginClick: any;
  onLogout: any;
  onAccountClick: any;
  onOpenAiImageConfig: any;
  onOpenAiConfig: any;
  onOpenAiVoiceCommunication: any;
};

function SettingsPage({ viewer, onLoginClick, onLogout, onAccountClick, onOpenAiImageConfig, onOpenAiConfig, onOpenAiVoiceCommunication }: SettingsPageProps) {
  const [emailOpen, setEmailOpen] = useState(false);
  const [usersOpen, setUsersOpen] = useState(false);
  const [groupsOpen, setGroupsOpen] = useState(false);
  const [policyOpen, setPolicyOpen] = useState(false);
  const [appearanceOpen, setAppearanceOpen] = useState(false);
  const [wordsearchOpen, setWordsearchOpen] = useState(false);
  const [dbOpen, setDbOpen] = useState(false);

  return (
    <>
      <PageLayout page="settings" title="Settings" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
        <section className="section">
          <div className="container">
            <h1 className="section-title">Settings</h1>
            <p className="lead text-center mb-4">Configure site tools using modals.</p>
            <div className="d-flex flex-wrap gap-2 justify-content-center">
              <button type="button" className="btn btn-primary" onClick={() => setEmailOpen(true)}>
                Email Configuration
              </button>
              <button type="button" className="btn btn-primary" onClick={() => setUsersOpen(true)}>
                User Accounts
              </button>
              {Number(viewer?.is_admin || 0) === 1 ? (
                <button type="button" className="btn btn-primary" onClick={() => setGroupsOpen(true)}>
                  Group Access
                </button>
              ) : null}
              <button type="button" className="btn btn-primary" onClick={() => setPolicyOpen(true)}>
                Account Policy
              </button>
              <button type="button" className="btn btn-primary" onClick={() => setAppearanceOpen(true)}>
                Site Appearance
              </button>
              <button type="button" className="btn btn-primary" onClick={() => {
                if (typeof onOpenAiConfig === 'function') onOpenAiConfig();
              }}>
                AI Configuration
              </button>
              {Number(viewer?.is_admin || 0) === 1 ? (
                <button type="button" className="btn btn-primary" onClick={() => {
                  if (typeof onOpenAiVoiceCommunication === 'function') onOpenAiVoiceCommunication();
                }}>
                  AI Voice Configuration
                </button>
              ) : null}
              {Number(viewer?.is_admin || 0) === 1 ? (
                <button type="button" className="btn btn-primary" onClick={() => {
                  if (typeof onOpenAiImageConfig === 'function') onOpenAiImageConfig();
                }}>
                  AI Image Configuration
                </button>
              ) : null}
              <button type="button" className="btn btn-primary" onClick={() => setWordsearchOpen(true)}>
                Word Search Settings
              </button>
              <button type="button" className="btn btn-primary" onClick={() => setDbOpen(true)}>
                Database Connection
              </button>
            </div>
          </div>
        </section>
      </PageLayout>

      <EmailConfigModal open={emailOpen} onClose={() => setEmailOpen(false)} />
      <UserAccountsModal open={usersOpen} onClose={() => setUsersOpen(false)} />
      <GroupMembershipsModal open={groupsOpen} onClose={() => setGroupsOpen(false)} />
      <AuthPolicyModal open={policyOpen} onClose={() => setPolicyOpen(false)} />
      <SiteAppearanceModal open={appearanceOpen} onClose={() => setAppearanceOpen(false)} />
      <WordsearchSettingsModal open={wordsearchOpen} onClose={() => setWordsearchOpen(false)} />
      <DbConfigModal open={dbOpen} onClose={() => setDbOpen(false)} />
    </>
  );
}

function WordsearchPage({ viewer, onLoginClick, onLogout, onAccountClick }) {
  const isLoggedIn = Number(viewer?.id || 0) > 0;

  const [topics, setTopics] = useState([]);
  const [topicId, setTopicId] = useState('');
  const [topic, setTopic] = useState(null);
  const [settingsOpen, setSettingsOpen] = useState(false);
  const [topicsOpen, setTopicsOpen] = useState(false);
  const [puzzlesOpen, setPuzzlesOpen] = useState(false);
  const [managePuzzlesOpen, setManagePuzzlesOpen] = useState(false);
  const [printOpen, setPrintOpen] = useState(false);
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState('');
  const [puzzle, setPuzzle] = useState(null);
  const [isAdmin, setIsAdmin] = useState(0);

  const [puzzles, setPuzzles] = useState([]);
  const [puzzleId, setPuzzleId] = useState('');
  const [pages, setPages] = useState([]);
  const [pageId, setPageId] = useState('');

  const [printJobs, setPrintJobs] = useState([]);

  const openPrint = () => {
    setPrintOpen(true);
  };

  const buildPrintJobs = async (selectedPuzzleIds) => {
    const picked = (Array.isArray(selectedPuzzleIds) ? selectedPuzzleIds : []).map((id) => String(id));
    if (!picked.length) {
      throw new Error('Select at least one puzzle to print.');
    }

    const byId = new Map(puzzles.map((p) => [String(p.id), p]));
    const jobs = [];

    for (const pid of picked) {
      const p = byId.get(pid);
      if (!p) continue;
      const res = await ApiClient.get('/api/wordsearch/pages.php?action=list&puzzle_id=' + String(pid));
      const list = Array.isArray(res?.pages) ? res.pages : [];
      for (const pg of list) {
        jobs.push({ puzzle: p, page: pg });
      }
    }

    if (!jobs.length) {
      throw new Error('No pages found to print for the selected puzzles.');
    }

    setPrintJobs(jobs);
    await new Promise<void>((resolve) => window.requestAnimationFrame(() => resolve()));
    window.print();
  };

  const loadTopics = () => {
    setBusy(true);
    setError('');
    ApiClient.get('/api/wordsearch/topics.php?action=list')
      .then((res) => {
        const t = Array.isArray(res?.topics) ? res.topics : [];
        setTopics(t);
        if (!topicId && t.length) setTopicId(String(t[0].id));
      })
      .catch((e) => setError(e?.message || 'Failed to load topics'))
      .finally(() => setBusy(false));
  };

  const loadPuzzles = () => {
    setBusy(true);
    setError('');
    ApiClient.get('/api/wordsearch/puzzles.php?action=list')
      .then((res) => {
        const list = Array.isArray(res?.puzzles) ? res.puzzles : [];
        setPuzzles(list);
        if (!puzzleId && list.length) setPuzzleId(String(list[0].id));
        setIsAdmin(Number(res?.viewer?.is_admin || 0));
      })
      .catch((e) => setError(e?.message || 'Failed to load puzzles'))
      .finally(() => setBusy(false));
  };

  useEffect(() => {
    if (!isLoggedIn) return;
    loadTopics();
    loadPuzzles();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isLoggedIn]);

  useEffect(() => {
    if (!isLoggedIn) return;
    const id = Number(topicId);
    if (!id) return;
    setBusy(true);
    setError('');
    setTopic(null);
    setPuzzle(null);
    ApiClient.get('/api/wordsearch/topics.php?action=get&id=' + String(id))
      .then((res) => setTopic(res?.topic || null))
      .catch((e) => setError(e?.message || 'Failed to load topic'))
      .finally(() => setBusy(false));
  }, [topicId, isLoggedIn]);

  useEffect(() => {
    if (!isLoggedIn) return;
    const id = Number(puzzleId);
    if (!id) {
      setPages([]);
      setPageId('');
      setPuzzle(null);
      return;
    }

    setBusy(true);
    setError('');
    setPuzzle(null);
    setPages([]);
    setPageId('');

    ApiClient.get('/api/wordsearch/puzzles.php?action=get&id=' + String(id))
      .then((res) => {
        const p = res?.puzzle || null;
        setPuzzle(p);
        if (p && p.topic_id) setTopicId(String(p.topic_id));
      })
      .catch((e) => setError(e?.message || 'Failed to load puzzle'))
      .finally(() => setBusy(false));

    ApiClient.get('/api/wordsearch/pages.php?action=list&puzzle_id=' + String(id))
      .then((res) => {
        const list = Array.isArray(res?.pages) ? res.pages : [];
        setPages(list);
        if (list.length) setPageId(String(list[0].id));
      })
      .catch((e) => setError(e?.message || 'Failed to load pages'));
  }, [puzzleId, isLoggedIn]);

  const selectedPage = useMemo(() => {
    const id = Number(pageId);
    if (!id) return null;
    return pages.find((p) => Number(p.id) === id) || null;
  }, [pages, pageId]);

  const canEditPuzzle = useMemo(() => {
    const uid = Number(viewer?.id || 0);
    if (!uid) return false;
    if (Number(viewer?.is_admin || 0) === 1) return true;
    return Number(puzzle?.owner_user_id || 0) === uid;
  }, [viewer, puzzle]);

  const reloadPages = async (pid) => {
    const id = Number(pid);
    if (!id) return;
    try {
      const res = await ApiClient.get('/api/wordsearch/pages.php?action=list&puzzle_id=' + String(id));
      const list = Array.isArray(res?.pages) ? res.pages : [];
      setPages(list);
      if (list.length && !list.find((p) => String(p.id) === String(pageId))) {
        setPageId(String(list[0].id));
      }
    } catch (_e) {
    }
  };

  const generateAllPages = async () => {
    if (!canEditPuzzle || !puzzle || !topic) return;
    setBusy(true);
    setError('');
    try {
      const settingsRes = await ApiClient.get('/api/wordsearch/settings.php');
      const wsSettings = settingsRes?.settings || {};
      const wordsPerPage = Number(topic.words_per_page || 15);
      const baseSeed = (Date.now() ^ (Number(puzzle.id) * 1009)) >>> 0;
      const total = Number(puzzle.pages_count || 1);
      const limit = Math.min(Math.max(total, 1), 200);

      for (let pageNumber = 1; pageNumber <= limit; pageNumber += 1) {
        const seed = (baseSeed + (pageNumber * 7919)) >>> 0;
        const words = pickWordsForPage({ allWords: topic.words, count: wordsPerPage, gridSize: Number(puzzle.grid_size || 12), seed: seed + 17 });
        const out = buildWordSearch({ size: Number(puzzle.grid_size || 12), words, seed, difficulty: String(puzzle.difficulty || 'easy') });

        const qf = generateWordsearchQuickFacts({ topic, puzzleTitle: puzzle.title, pageNumber, words: out.words, settings: wsSettings });
        await ApiClient.post('/api/wordsearch/pages.php?action=upsert', {
          puzzle_id: puzzle.id,
          page_number: pageNumber,
          seed: String(seed),
          words: out.words,
          grid: out.grid,
          description: qf.description,
          summary: qf.summary,
        });
      }

      await reloadPages(puzzle.id);
    } catch (e) {
      setError(e?.message || 'Generate pages failed');
    } finally {
      setBusy(false);
    }
  };

  const regeneratePage = async () => {
    if (!canEditPuzzle || !puzzle || !selectedPage || !topic) return;
    setBusy(true);
    setError('');
    try {
      const settingsRes = await ApiClient.get('/api/wordsearch/settings.php');
      const wsSettings = settingsRes?.settings || {};
      const wordsPerPage = Number(topic.words_per_page || 15);
      const seed = (Date.now() ^ (Number(puzzle.id) * 1009) ^ (Number(selectedPage.page_number) * 7919)) >>> 0;
      const words = pickWordsForPage({ allWords: topic.words, count: wordsPerPage, gridSize: Number(puzzle.grid_size || 12), seed: seed + 17 });
      const out = buildWordSearch({ size: Number(puzzle.grid_size || 12), words, seed, difficulty: String(puzzle.difficulty || 'easy') });

      const qf = generateWordsearchQuickFacts({ topic, puzzleTitle: puzzle.title, pageNumber: selectedPage.page_number, words: out.words, settings: wsSettings });
      await ApiClient.post('/api/wordsearch/pages.php?action=upsert', {
        puzzle_id: puzzle.id,
        page_number: selectedPage.page_number,
        seed: String(seed),
        words: out.words,
        grid: out.grid,
        description: qf.description,
        summary: qf.summary,
      });
      await reloadPages(puzzle.id);
    } catch (e) {
      setError(e?.message || 'Regenerate failed');
    } finally {
      setBusy(false);
    }
  };

  const previewRegeneratePageJson = () => {
    if (!canEditPuzzle || !puzzle || !selectedPage || !topic) return;
    const wordsPerPage = Number(topic.words_per_page || 15);
    const seed = (Date.now() ^ (Number(puzzle.id) * 1009) ^ (Number(selectedPage.page_number) * 7919)) >>> 0;
    const words = pickWordsForPage({ allWords: topic.words, count: wordsPerPage, gridSize: Number(puzzle.grid_size || 12), seed: seed + 17 });
    const out = buildWordSearch({ size: Number(puzzle.grid_size || 12), words, seed, difficulty: String(puzzle.difficulty || 'easy') });
    const qf = generateWordsearchQuickFacts({ topic, puzzleTitle: puzzle.title, pageNumber: selectedPage.page_number, words: out.words, settings: {} });

    openJsonPreview({
      title: 'Wordsearch: pages.upsert (regenerate)',
      payload: {
        endpoint: '/api/wordsearch/pages.php?action=upsert',
        method: 'POST',
        body: {
          puzzle_id: puzzle.id,
          page_number: selectedPage.page_number,
          seed: String(seed),
          words: out.words,
          grid: out.grid,
          description: qf.description,
          summary: qf.summary,
        },
        note: 'Preview only. The live regenerate call fetches /api/wordsearch/settings.php to enrich quick facts.',
      },
    });
  };

  const deletePage = async () => {
    if (!canEditPuzzle || !selectedPage) return;
    setBusy(true);
    setError('');
    try {
      await ApiClient.post('/api/wordsearch/pages.php?action=delete', { id: selectedPage.id });
      await reloadPages(puzzle?.id);
    } catch (e) {
      setError(e?.message || 'Delete page failed');
    } finally {
      setBusy(false);
    }
  };

  const deletePuzzle = async () => {
    if (!puzzle || !canEditPuzzle) return;
    setBusy(true);
    setError('');
    try {
      await ApiClient.post('/api/wordsearch/puzzles.php?action=delete', { id: puzzle.id });
      await loadPuzzles();
      setPuzzleId('');
      setPages([]);
      setPageId('');
      setPuzzle(null);
    } catch (e) {
      setError(e?.message || 'Delete failed');
    } finally {
      setBusy(false);
    }
  };

  if (!isLoggedIn) {
    return (
      <PageLayout page="wordsearch" title="Word Search" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
        <section className="section">
          <div className="container">
            <h1 className="section-title">Word Search</h1>
            <div className="alert alert-warning" role="alert">
              <div className="fw-bold">Login required</div>
              <div className="mt-1">You must be logged in to access Word Search.</div>
              <button type="button" className="btn btn-primary mt-3" onClick={onLoginClick}>
                Log in
              </button>
            </div>
          </div>
        </section>
      </PageLayout>
    );
  }

  return (
    <>
      <PageLayout page="wordsearch" title="Word Search" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
        <section className="section">
          <div className="container">
            <h1 className="section-title">Word Search</h1>

            <div className="catn8-ws-toolbar">
              <div className="row g-2 align-items-end">
                <div className="col-md-6">
                  <label className="form-label" htmlFor="ws-puzzle">Puzzle</label>
                  <select
                    id="ws-puzzle"
                    className="form-select"
                    value={puzzleId}
                    onChange={(e) => setPuzzleId(e.target.value)}
                    disabled={busy}
                  >
                    {puzzles.map((p) => (
                      <option key={p.id} value={String(p.id)}>
                        {p.title}{p.owner_username ? `  ${p.owner_username}` : ''}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="col-md-6">
                  <div className="d-flex gap-2">
                    <button type="button" className="btn btn-primary flex-grow-1" onClick={() => setPuzzlesOpen(true)} disabled={busy}>
                      New Puzzle
                    </button>
                    <button type="button" className="btn btn-outline-secondary" onClick={() => setManagePuzzlesOpen(true)} disabled={busy}>
                      Manage
                    </button>
                    <button type="button" className="btn btn-outline-secondary" onClick={() => setSettingsOpen(true)}>
                      Settings
                    </button>
                    <button type="button" className="btn btn-outline-secondary" onClick={openPrint} disabled={busy}>
                      Print
                    </button>
                    {isAdmin ? (
                      <button type="button" className="btn btn-outline-secondary" onClick={() => setTopicsOpen(true)}>
                        Topics
                      </button>
                    ) : null}
                    {canEditPuzzle ? (
                      <button type="button" className="btn btn-outline-danger" onClick={deletePuzzle} disabled={busy || !puzzle}>
                        Delete
                      </button>
                    ) : null}
                  </div>
                </div>

                <div className="col-12">
                  <div className="row g-2">
                    <div className="col-md-6">
                      <label className="form-label" htmlFor="ws-page">Page</label>
                      <select
                        id="ws-page"
                        className="form-select"
                        value={pageId}
                        onChange={(e) => setPageId(e.target.value)}
                        disabled={busy}
                      >
                        {pages.map((p) => (
                          <option key={p.id} value={String(p.id)}>Page {p.page_number}</option>
                        ))}
                      </select>
                      <div className="d-flex gap-2 mt-2">
                        <button type="button" className="btn btn-outline-secondary" onClick={previewRegeneratePageJson} disabled={busy || !canEditPuzzle || !selectedPage}>
                          View JSON
                        </button>
                        <button type="button" className="btn btn-outline-secondary" onClick={regeneratePage} disabled={busy || !canEditPuzzle || !selectedPage}>
                          Regenerate page
                        </button>
                        <button type="button" className="btn btn-outline-danger" onClick={deletePage} disabled={busy || !canEditPuzzle || !selectedPage}>
                          Delete page
                        </button>
                      </div>
                    </div>

                    <div className="col-md-6">
                      <label className="form-label" htmlFor="ws-topic">Topic</label>
                      <select
                        id="ws-topic"
                        className="form-select"
                        value={topicId}
                        onChange={(e) => setTopicId(e.target.value)}
                        disabled={busy}
                      >
                        {topics.map((t) => (
                          <option key={t.id} value={String(t.id)}>{t.title}</option>
                        ))}
                      </select>
                      {topic?.description ? <div className="form-text">{topic.description}</div> : null}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {error ? <div className="alert alert-danger" role="alert">{error}</div> : null}

            {!selectedPage && puzzle && !busy && pages.length === 0 ? (
              <div className="alert alert-info" role="alert">
                <div className="fw-bold">No pages found for this puzzle.</div>
                <div className="mt-2 d-flex gap-2 flex-wrap">
                  <button
                    type="button"
                    className="btn btn-outline-secondary"
                    onClick={() => {
                      const wordsPerPage = Number(topic?.words_per_page || 15);
                      const total = Number(puzzle?.pages_count || 1);
                      openJsonPreview({
                        title: 'Wordsearch: generate pages (preview)',
                        payload: {
                          note: 'This generator loops and upserts each page; this is a preview of the computed inputs, not every per-page payload.',
                          endpoints: [
                            '/api/wordsearch/settings.php (GET)',
                            '/api/wordsearch/pages.php?action=upsert (POST, repeated)',
                          ],
                          inputs: {
                            puzzle_id: puzzle?.id,
                            topic_id: topic?.id,
                            grid_size: puzzle?.grid_size,
                            pages_count: total,
                            words_per_page: wordsPerPage,
                            difficulty: puzzle?.difficulty,
                          },
                        },
                      });
                    }}
                    disabled={!canEditPuzzle || !topic}
                  >
                    View JSON
                  </button>
                  <button type="button" className="btn btn-primary" onClick={generateAllPages} disabled={!canEditPuzzle || !topic}>
                    Generate pages
                  </button>
                  {!canEditPuzzle ? <div className="text-muted">Log in as the owner (or admin) to generate pages.</div> : null}
                  {canEditPuzzle && !topic ? <div className="text-muted">Select a topic to generate pages.</div> : null}
                </div>
              </div>
            ) : null}

            {selectedPage ? (
              <div className="mt-4">
                <div className="catn8-ws-legacy-header">
                  <h2 className="catn8-ws-legacy-title">{puzzle?.title || 'Puzzle'}</h2>
                  {selectedPage?.description ? (
                    <div className="catn8-ws-legacy-description">{selectedPage.description}</div>
                  ) : null}
                </div>

                {selectedPage?.summary ? (
                  <div className="catn8-ws-legacy-summary">{selectedPage.summary}</div>
                ) : null}

                <div className="catn8-ws-legacy-wordlist">
                  <div className="catn8-ws-legacy-words">
                    {(Array.isArray(selectedPage.words) ? selectedPage.words : []).map((w) => (
                      <span key={w} className="catn8-ws-legacy-word">{w}</span>
                    ))}
                  </div>
                </div>

                <div className="catn8-ws-grid-wrapper">
                  <div
                    className="catn8-ws-grid"
                    style={{
                      gridTemplateColumns: `repeat(${puzzle?.grid_size || 12}, 1fr)`,
                      gridTemplateRows: `repeat(${puzzle?.grid_size || 12}, 1fr)`,
                    }}
                    aria-label="Word search grid"
                  >
                    {(Array.isArray(selectedPage.grid) ? selectedPage.grid : []).flat().map((ch, idx) => (
                      <div
                        key={idx}
                        className="catn8-ws-cell"
                      >
                        {ch}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ) : null}
          </div>
        </section>
      </PageLayout>

      <div className="catn8-ws-print-root" style={{ display: 'none' }}>
        {printJobs.map((job, idx) => (
          <div key={`${job?.puzzle?.id || 'p'}-${job?.page?.id || 'pg'}-${idx}`}>
            <div className="catn8-ws-legacy-header">
              <h2 className="catn8-ws-legacy-title">{job?.puzzle?.title || 'Puzzle'}</h2>
              {job?.page?.description ? (
                <div className="catn8-ws-legacy-description">{job.page.description}</div>
              ) : null}
            </div>

            {job?.page?.summary ? (
              <div className="catn8-ws-legacy-summary">{job.page.summary}</div>
            ) : null}

            <div className="catn8-ws-legacy-wordlist">
              <div className="catn8-ws-legacy-words">
                {(Array.isArray(job?.page?.words) ? job.page.words : []).map((w) => (
                  <span key={w} className="catn8-ws-legacy-word">{w}</span>
                ))}
              </div>
            </div>

            <div className="catn8-ws-grid-wrapper">
              <div
                className="catn8-ws-grid"
                style={{
                  gridTemplateColumns: `repeat(${job?.puzzle?.grid_size || 12}, 1fr)`,
                  gridTemplateRows: `repeat(${job?.puzzle?.grid_size || 12}, 1fr)`,
                }}
                aria-label="Word search grid"
              >
                {(Array.isArray(job?.page?.grid) ? job.page.grid : []).flat().map((ch, cidx) => (
                  <div
                    key={cidx}
                    className="catn8-ws-cell"
                  >
                    {ch}
                  </div>
                ))}
              </div>
            </div>

            <div className="page-break"></div>
          </div>
        ))}
      </div>

      <WordsearchSettingsModal open={settingsOpen} onClose={() => setSettingsOpen(false)} />
      <WordsearchPrintModal
        open={printOpen}
        onClose={() => setPrintOpen(false)}
        puzzles={puzzles}
        defaultPuzzleId={puzzleId}
        onPrint={buildPrintJobs}
      />
      <TopicManagerModal
        open={topicsOpen}
        onClose={() => setTopicsOpen(false)}
        onChanged={loadTopics}
      />
      <PuzzleManagerModal
        open={puzzlesOpen}
        onClose={() => setPuzzlesOpen(false)}
        topics={topics}
        viewer={viewer}
        onCreated={async (newId) => {
          await loadPuzzles();
          setPuzzleId(String(newId));
          setPuzzlesOpen(false);
        }}
        onDeleted={async () => {
          await loadPuzzles();
        }}
      />
      <ManagePuzzlesModal
        open={managePuzzlesOpen}
        onClose={() => setManagePuzzlesOpen(false)}
        topics={topics}
        puzzles={puzzles}
        viewer={viewer}
        onChanged={async () => {
          await loadPuzzles();
          await reloadPages(puzzleId);
        }}
      />
    </>
  );

}

function PageLayout({ page, title, children, viewer, onLoginClick, onLogout, onAccountClick }: {
  page: any;
  title: any;
  children: any;
  viewer?: any;
  onLoginClick?: any;
  onLogout?: any;
  onAccountClick?: any;
}) {
  const pathname = (typeof window !== 'undefined' && window.location && window.location.pathname) ? window.location.pathname : '';
  const p = String(pathname || '').toLowerCase();
  const hideNav = (
    p === '/mystery.php'
    || p.startsWith('/mystery.php/')
    || p === '/mystery'
    || p.startsWith('/mystery/')
  );
  return (
    <div className="catn8-page" data-page={page} data-title={title || ''}>
      {hideNav ? null : <NavBar active={page} viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick} />}
      {children}
    </div>
  );
}

function StoryModal({ open, onClose, story }) {
  const modalRef = useRef(null);
  const modalApiRef = useRef(null);
  const [bootstrapTick, setBootstrapTick] = useState(0);

  useEffect(() => {
    const el = modalRef.current;
    if (!el) return;

    if (!isBootstrapModalReady()) {
      const t = window.setTimeout(() => setBootstrapTick((v) => v + 1), 50);
      return () => window.clearTimeout(t);
    }

    const modal = modalApiRef.current || createBootstrapModal(el);
    modalApiRef.current = modal;

    const onHidden = () => {
      if (typeof onClose === 'function') onClose();
    };

    el.addEventListener('hidden.bs.modal', onHidden);
    return () => {
      el.removeEventListener('hidden.bs.modal', onHidden);
    };
  }, [onClose, bootstrapTick]);

  useEffect(() => {
    const modal = modalApiRef.current;
    if (!modal) return;
    if (open) modal.show();
    else modal.hide();
  }, [open]);

  const title = String(story?.title || 'Story');
  const blocks = Array.isArray(story?.content) ? story.content : [];

  return (
    <div className="modal fade catn8-story-modal" tabIndex={-1} aria-hidden="true" ref={modalRef}>
      <div className="modal-dialog modal-lg">
        <div className="modal-content">
          <div className="modal-header">
            <h2 className="modal-title">{title}</h2>
            <button type="button" className="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div className="modal-body">
            <div className="catn8-story-content">
              {blocks.map((b, idx) => (
                <div key={`${b?.image || 'img'}-${idx}`} className="catn8-story-block">
                  {b?.image ? <img className="catn8-story-modal-image" src={b.image} alt={String(b.alt || '')} /> : null}
                  {b?.text ? <p className="catn8-story-modal-text">{b.text}</p> : null}
                </div>
              ))}
              {!blocks.length ? <div className="text-muted">Story content coming soon.</div> : null}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function StoriesPage({ viewer, onLoginClick, onLogout, onAccountClick }) {
  const [query, setQuery] = useState('');
  const [activeStoryId, setActiveStoryId] = useState(null);
  const [modalOpen, setModalOpen] = useState(false);
  const q = normalizeText(query);
  const filtered = useMemo(() => {
    if (!q) return stories;
    return stories.filter((s) => normalizeText(s.title).includes(q));
  }, [q]);

  const activeStory = useMemo(() => {
    const id = Number(activeStoryId || 0);
    if (!id) return null;
    return stories.find((s) => Number(s?.id || 0) === id) || null;
  }, [activeStoryId]);

  const openStory = (id) => {
    setActiveStoryId(Number(id || 0) || null);
    setModalOpen(true);
  };

  return (
    <PageLayout page="stories" title="Stories" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
      <section className="section">
        <div className="container">
          <h1 className="section-title">Stories</h1>
          <p className="lead text-center mb-4">Enjoy our collection of stories!</p>
          <FilterBar label="Stories" query={query} setQuery={setQuery} />
          <div className="row mt-4">
            {filtered.map((s) => (
              <div className="col-md-6" key={s.id}>
                <div
                  className="story-card"
                  role="button"
                  tabIndex={0}
                  onClick={() => openStory(s.id)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') openStory(s.id);
                  }}
                >
                  <div className="age-badge">{s.age}</div>
                  <div className="story-section">
                    <img src={s.image} alt={s.title} className="story-image" />
                    <h3 className="story-title">{s.title}</h3>
                    <p className="story-text">{s.excerpt}</p>
                    <div className="story-tags">
                      {s.tags.map((t) => (
                        <span className="story-tag" key={t}>
                          {t}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <StoryModal
            open={modalOpen}
            onClose={() => {
              setModalOpen(false);
            }}
            story={activeStory}
          />
        </div>
      </section>
    </PageLayout>
  );
}

function ArcadePage({ viewer, onLoginClick, onLogout, onAccountClick }) {
  const [query, setQuery] = useState('');
  const q = normalizeText(query);
  const filtered = useMemo(() => {
    if (!q) return arcade;
    return arcade.filter((g) => normalizeText(g.title).includes(q));
  }, [q]);

  return (
    <PageLayout page="arcade" title="Arcade" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
      <section className="section">
        <div className="container">
          <h1 className="section-title">Arcade</h1>
          <p className="lead text-center mb-4">Welcome to our arcade! Here you'll find fun and educational games to play.</p>
          <FilterBar label="Arcade Games" query={query} setQuery={setQuery} />
          <div className="row mt-4">
            {filtered.map((g) => (
              <div className="col-md-6" key={g.id}>
                <a className="game-card" href={g.href}>
                  <img src={g.image} alt={g.title} />
                  <div className="game-info">
                    <h3>{g.title}</h3>
                    <p className="mb-0">{g.description}</p>
                  </div>
                </a>
              </div>
            ))}
          </div>
        </div>
      </section>
    </PageLayout>
  );
}

function GamesPage({ viewer, onLoginClick, onLogout, onAccountClick }) {
  const [query, setQuery] = useState('');
  const q = normalizeText(query);

  const sections = useMemo(() => {
    if (!q) return games;
    return games
      .map((sec) => {
        const items = sec.items.filter((it) => normalizeText(it.title).includes(q));
        return { ...sec, items };
      })
      .filter((sec) => sec.items.length > 0);
  }, [q]);

  return (
    <PageLayout page="games" title="Games" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
      <section className="section">
        <div className="container">
          <h1 className="section-title">Fun Games for Everyone!</h1>
          <p className="lead text-center mb-4">Play and learn with our collection of exciting games!</p>
          <FilterBar label="Games" query={query} setQuery={setQuery} />
          {sections.map((sec) => (
            <div key={sec.section} className="mt-5">
              <h2 className="section-title section-title-sm">{sec.section}</h2>
              <div className="row">
                {sec.items.map((it) => (
                  <div className="col-md-6" key={it.title}>
                    <div className="game-card">
                      <img src={it.image} alt={it.title} />
                      <div className="game-card-content">
                        <h3>{it.title}</h3>
                        <p className="mb-0">{it.description}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </section>
    </PageLayout>
  );
}

function AboutPage({ viewer, onLoginClick, onLogout, onAccountClick }) {
  return (
    <PageLayout page="about" title="About" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
      <section className="hero">
        <div className="container hero-content">
          <div className="row justify-content-center">
            <div className="col-lg-9">
              <div className="welcome-message text-center">
                <h1>Our Philosophy</h1>
                <p className="lead">
                  At catn8.us, our name whispers our deepest aspiration: to catenate, to tenderly link together, not just ideas,
                  but hearts. Founded by Jon and Sarah Graves, our community is built on the foundation of family, love, and
                  connection.
                </p>
                <img className="catn8-hero-image" src="/images/homepage_family.jpg" alt="Family Connection" />
              </div>
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <div className="row g-4 align-items-center">
            <div className="col-lg-7">
              <h2 className="section-title section-title-sm text-start">Our Vision</h2>
              <p className="lead">
                We dream of a world where empathy is a universal language, where acts of kindness are as natural as breathing,
                and where communities are sanctuaries built upon unconditional love and unwavering mutual support.
              </p>
              <p>
                Through the example of our growing family  from Jon and Sarah to their children Trinity, Elijah, Mariah,
                Veronica, Reuel, and Ezra, and now to the next generation  we envision a future where every individual feels a
                deep sense of belonging.
              </p>
              <img className="catn8-inline-image" src="/images/homepage_kindness.jpg" alt="Community Vision" />
            </div>
            <div className="col-lg-5">
              <div className="catn8-quote">
                Family is not an important thing. Its everything.
                <div className="catn8-quote-attrib">- Michael J. Fox</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <h2 className="section-title">Our Core Values</h2>
          <div className="row g-4">
            <div className="col-md-4">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/about_family.jpg" alt="Family First" />
                <div className="catn8-value-icon"></div>
                <h3 className="story-title">Family First</h3>
                <p className="story-text">
                  Following Jon and Sarah's example, we believe in putting family at the heart of everything we do, creating
                  bonds that last through generations.
                </p>
              </div>
            </div>
            <div className="col-md-4">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/about_community.jpg" alt="Empathy in Action" />
                <div className="catn8-value-icon"></div>
                <h3 className="story-title">Empathy in Action</h3>
                <p className="story-text">
                  From Trinity and Elijah's parenting to Mariah and Veronica's community work, we see how empathy transforms
                  lives and builds stronger connections.
                </p>
              </div>
            </div>
            <div className="col-md-4">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/about_growth.jpg" alt="Gentle Growth" />
                <div className="catn8-value-icon"></div>
                <h3 className="story-title">Gentle Growth</h3>
                <p className="story-text">
                  Through Reuel and Ezra's unique perspectives, we've learned that growth comes in many forms, each beautiful
                  in its own way.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <h2 className="section-title">Our Journey</h2>
          <div className="row g-4">
            <div className="col-md-6">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/homepage_family.jpg" alt="The Beginning" />
                <h3 className="story-title">The Beginning</h3>
                <p className="story-text">
                  It all started with Jon and Sarah's vision of creating a space where family values and community connection
                  could flourish. Their commitment to kindness and love has been the foundation upon which everything else has
                  been built.
                </p>
              </div>
            </div>
            <div className="col-md-6">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/homepage_kindness.jpg" alt="Our Growth" />
                <h3 className="story-title">Our Growth</h3>
                <p className="story-text">
                  As the Graves family has grown, so has our understanding of what it means to truly connect. From Trinity and
                  Elijah's new roles as parents to the unique contributions of Mariah, Veronica, Reuel, and Ezra, each family
                  member has enriched our collective experience.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <h2 className="section-title">Our Team</h2>
          <div className="row g-4">
            <div className="col-md-4">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/homepage_friends.jpg" alt="Family Leaders" />
                <h3 className="story-title">Family Leaders</h3>
                <p className="story-text">
                  Jon and Sarah's vision and leadership continue to guide our community, while Trinity and Elijah bring their
                  experience as parents to help shape our future.
                </p>
              </div>
            </div>
            <div className="col-md-4">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/about_community.jpg" alt="Community Builders" />
                <h3 className="story-title">Community Builders</h3>
                <p className="story-text">
                  Mariah and Veronica's commitment to community service and connection helps us create meaningful experiences
                  for everyone.
                </p>
              </div>
            </div>
            <div className="col-md-4">
              <div className="catn8-card p-4 h-100">
                <img className="catn8-card-image" src="/images/about_growth.jpg" alt="Creative Minds" />
                <h3 className="story-title">Creative Minds</h3>
                <p className="story-text">
                  Reuel and Ezra's unique perspectives and creative approaches help us find new ways to express our values and
                  connect with others.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </PageLayout>
  );
}

function ActivitiesPage({ viewer, onLoginClick, onLogout, onAccountClick }) {
  const sections = [
    {
      title: 'Fun Activities for Everyone!',
      subtitle: 'Discover exciting activities to do together!',
      items: [
        { title: 'Starfall Reading Fun', description: 'Learn to read with fun interactive stories and activities!', image: '/images/starfall-reading-fun.jpg' },
        { title: 'Coloring Art Adventure', description: 'Express your creativity with fun coloring activities!', image: '/images/coloring-ws-art-adventure.jpg' },
        { title: 'PBS Kids Educational Play', description: 'Learn and play with your favorite PBS Kids characters!', image: '/images/pbs-kids-educational-play.jpg' },
        { title: 'Color by Numbers Art', description: 'Create beautiful art while learning numbers!', image: '/images/color-by-numbers-art.jpg' },
      ],
    },
    {
      title: 'Creative Activities',
      subtitle: 'Let your imagination run wild!',
      items: [
        { title: 'Puzzle Maker Learning', description: 'Create and solve your own puzzles!', image: '/images/puzzle-maker-learning.jpg' },
        { title: 'Crayola Crafts Creative', description: 'Make amazing crafts with Crayola!', image: '/images/crayola-crafts-creative.jpg' },
        { title: 'Khan Academy Interactive', description: 'Learn through fun interactive activities!', image: '/images/khan-academy-interactive.jpg' },
        { title: 'Music Theory Learning', description: 'Discover the joy of music through fun activities!', image: '/images/music-theory-learning.jpg' },
      ],
    },
    {
      title: 'Educational Activities',
      subtitle: 'Learn while having fun!',
      items: [
        { title: 'ABCya Educational Games', description: 'Play and learn with fun educational games!', image: '/images/abcya-educational-games.jpg' },
      ],
    },
  ];

  return (
    <PageLayout page="activities" title="Activities" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
      {sections.map((sec) => (
        <section className="section" key={sec.title}>
          <div className="container">
            <h1 className="section-title">{sec.title}</h1>
            <p className="lead text-center mb-4">{sec.subtitle}</p>
            <div className="row">
              {sec.items.map((it) => (
                <div className="col-md-6" key={it.title}>
                  <div className="game-card">
                    <img src={it.image} alt={it.title} />
                    <div className="game-card-content">
                      <h3>{it.title}</h3>
                      <p className="mb-0">{it.description}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>
      ))}
    </PageLayout>
  );
}

function HomePage({ viewer, onLoginClick, onLogout, onAccountClick }) {
  const cards = [
    { href: 'stories.php', title: 'Stories', text: 'Read our fun adventures!', image: '/images/homepage_friends.jpg' },
    { href: 'games.php', title: 'Games', text: 'Play and learn together!', image: '/images/homepage_growth.jpg' },
    { href: 'activities.php', title: 'Activities', text: 'Fun things to do!', image: '/images/homepage_kindness.jpg' },
  ];

  return (
    <PageLayout page="home" title="catn8.us" viewer={viewer} onLoginClick={onLoginClick} onLogout={onLogout} onAccountClick={onAccountClick}>
      <section className="hero">
        <div className="container hero-content">
          <div className="row align-items-center g-4">
            <div className="col-lg-6">
              <div className="welcome-message">
                <h1>Welcome to catn8.us!</h1>
                <p className="lead">Where Fun Meets Family!</p>
                <p>
                  Welcome to our magical corner of the internet! This is a special place where families come together to share
                  stories, play games, and create wonderful memories.
                </p>

                <div className="catn8-dictionary-entry mt-3">
                  <div className="row align-items-center g-3">
                    <div className="col-md-8">
                      <h3 className="catn8-dictionary-word">catenate</h3>
                      <div className="catn8-dictionary-pron">/katnt/</div>
                      <div className="catn8-dictionary-pos">
                        <strong>verb</strong> (used with object)
                      </div>
                      <div>1. to link together; form into a chain</div>
                    </div>
                    <div className="col-md-4 text-center">
                      <img className="catn8-dictionary-logo" src="/images/catn8_logo.svg" alt="catn8.us Logo" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div className="col-lg-6 text-center">
              <img className="catn8-hero-image" src="/images/catfamily.jpeg" alt="The Graves Family" />
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <div className="quick-access">
            {cards.map((c) => (
              <a className="quick-access-btn" href={c.href} key={c.href}>
                <img className="catn8-quick-access-image" src={c.image} alt={c.title} />
                <div className="quick-access-title">{c.title}</div>
                <div>{c.text}</div>
              </a>
            ))}
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <h2 className="section-title">What Makes Us Special</h2>
          <div className="featured-grid">
            <div className="featured-card">
              <img className="catn8-featured-image" src="/images/homepage_friends.jpg" alt="Making Friends" />
              <div className="featured-card-content">
                <h3>Making Friends</h3>
                <p>
                  We love making new friends and being kind to everyone! Here, we learn how to be good friends by sharing,
                  listening, and helping each other.
                </p>
              </div>
            </div>
            <div className="featured-card">
              <img className="catn8-featured-image" src="/images/homepage_kindness.jpg" alt="Spreading Joy" />
              <div className="featured-card-content">
                <h3>Spreading Joy</h3>
                <p>
                  Did you know that being kind is like spreading magic? Every time we do something nice, it makes someone else
                  happy, and that happiness grows and grows!
                </p>
              </div>
            </div>
            <div className="featured-card">
              <img className="catn8-featured-image" src="/images/homepage_growth.jpg" alt="Growing Together" />
              <div className="featured-card-content">
                <h3>Growing Together</h3>
                <p>
                  Just like plants need water and sunshine to grow, we need love and friendship to grow into our best selves!
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <div className="row align-items-center g-4">
            <div className="col-lg-6">
              <h2 className="section-title section-title-sm text-start">Ready for Adventure?</h2>
              <p className="lead">
                Every day is a new adventure waiting to happen! Whether we're exploring new stories, playing exciting games, or
                learning something new, we make sure it's always fun and full of surprises.
              </p>
              <p>Join us on this amazing journey where every moment is a chance to discover something wonderful!</p>
            </div>
            <div className="col-lg-6 text-center">
              <img className="catn8-hero-image" src="/images/homepage_adventure.jpg" alt="Adventure" />
            </div>
          </div>
        </div>
      </section>

      <section className="section">
        <div className="container">
          <div className="row justify-content-center">
            <div className="col-lg-10">
              <div className="welcome-message text-center">
                <h2 className="section-title mb-3">Join Our Family!</h2>
                <p className="lead">
                  Welcome to our special family circle! We're like a big, friendly tree where everyone can find a branch to sit
                  on.
                </p>
                <p>
                  Here at catn8.us, we believe that every family is unique and special. We're not just a website - we're a
                  community of friends who love to learn, play, and grow together. Our family tree keeps growing with new
                  friends who bring their own special magic to our circle.
                </p>
                <p>
                  What makes our family special? It's the way we care for each other, share our stories, and create memories
                  that last a lifetime. Whether you're reading our fun stories, playing our exciting games, or trying out our
                  creative activities, you're part of something wonderful.
                </p>
                <p>
                  New friends join us through invitations from our current members, making sure our tree grows with love and
                  care. It's like having a secret handshake that only special friends know about!
                </p>
                <p>
                  So, are you ready to be part of our growing family? We can't wait to share adventures, create memories, and
                  make new friends together. Remember, in our family, everyone is welcome, everyone is special, and everyone
                  belongs!
                </p>
                <img className="catn8-inline-image" src="/images/homepage_family.jpg" alt="Family fun" />
              </div>
            </div>
          </div>
        </div>
      </section>
    </PageLayout>
  );
}

function App({ page }) {
  const [loginOpen, setLoginOpen] = useState(page === 'login');
  const [accountOpen, setAccountOpen] = useState(false);
  const [viewer, setViewer] = useState(null);
  const [toast, setToast] = useState(null);
  const [aiImageOpen, setAiImageOpen] = useState(false);
  const [aiOpen, setAiOpen] = useState(false);
  const [aiVoiceOpen, setAiVoiceOpen] = useState(false);
  const openLogin = () => setLoginOpen(true);
  const closeLogin = () => setLoginOpen(false);
  const openAccount = () => setAccountOpen(true);
  const closeAccount = () => setAccountOpen(false);

  const showToast = (t) => {
    setToast(t || null);
  };

  const refreshViewer = async () => {
    try {
      const res = await ApiClient.get('/api/auth/me.php');
      const u = res?.user || null;
      setViewer(u);
      return u;
    } catch (_e) {
      setViewer(null);
      return null;
    }
  };

  useEffect(() => {
    refreshViewer();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const logout = async () => {
    try {
      await ApiClient.post('/api/auth/logout.php', {});
    } catch (_e) {
      // ignore
    } finally {
      setViewer(null);
    }
  };

  const layoutProps = { viewer, onLoginClick: openLogin, onLogout: logout, onAccountClick: openAccount };

  let content = <HomePage {...layoutProps} />;
  if (page === 'about') content = <AboutPage {...layoutProps} />;
  if (page === 'stories') content = <StoriesPage {...layoutProps} />;
  if (page === 'games') content = <GamesPage {...layoutProps} />;
  if (page === 'arcade') content = <ArcadePage {...layoutProps} />;
  if (page === 'activities') content = <ActivitiesPage {...layoutProps} />;
  if (page === 'login') content = <HomePage {...layoutProps} />;
  if (page === 'mystery') content = <MysteryPage {...layoutProps} onToast={showToast} onOpenAiImageConfig={() => setAiImageOpen(true)} onOpenAiConfig={() => setAiOpen(true)} onOpenAiVoiceConfig={() => setAiVoiceOpen(true)} />;
  if (page === 'settings') content = <SettingsPage {...layoutProps} onOpenAiImageConfig={() => setAiImageOpen(true)} onOpenAiConfig={() => setAiOpen(true)} onOpenAiVoiceCommunication={() => setAiVoiceOpen(true)} />;
  if (page === 'wordsearch') content = <WordsearchPage {...layoutProps} />;
  if (page === 'verify') content = <VerifyPage />;
  if (page === 'reset') content = <ResetPage />;

  return (
    <>
      {content}
      <LoginModal open={loginOpen} onClose={closeLogin} onLoggedIn={refreshViewer} onToast={showToast} />
      <AccountModal open={accountOpen} onClose={closeAccount} viewer={viewer} onChanged={refreshViewer} />
      <ToastOverlay toast={toast} onClose={() => setToast(null)} />
      <AIImageConfigModal open={aiImageOpen} onClose={() => setAiImageOpen(false)} />
      <AIConfigModal open={aiOpen} onClose={() => setAiOpen(false)} />
      <AIVoiceCommunicationModal open={aiVoiceOpen} onClose={() => setAiVoiceOpen(false)} />
    </>
  );
}

const mount = document.getElementById('catn8-app') as HTMLElement | null;
if (mount) {
  const page = mount.dataset.page || 'home';
  createRoot(mount).render(<App page={page} />);
}
